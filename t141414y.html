<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة السنافر - مشاهدة المسلسلات والأفلام</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Slick Carousel -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css">
    <!-- amCharts for visitor map -->
    <link rel="stylesheet" href="https://cdn.amcharts.com/lib/5/plugins/export/export.css">
    <style>
        /* متغيرات التصميم */
        :root {
            --primary-color: #E50914;
            --dark-color: #141414;
            --light-color: #f4f4f4;
            --secondary-color: #6D6D6D;
            --ad-color: #FFA500;
            --navbar-height: 70px;
            --transition-speed: 0.3s;
            --button-size: 1.5rem;
        }

        /* إعادة تعيين الأنماط */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--dark-color);
            color: var(--light-color);
            line-height: 1.6;
            padding-top: var(--navbar-height);
            transition: all var(--transition-speed);
        }

        /* شريط التنقل العلوي */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background-color: var(--dark-color);
            z-index: 1000;
            display: flex;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .navbar-container {
            width: 100%;
            max-width: 1600px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-img {
            height: 40px;
            width: auto;
            transition: transform var(--transition-speed);
        }

        .logo-img:hover {
            transform: scale(1.05);
        }

        .nav-menu {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-item {
            margin: 0 15px;
            position: relative;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            transition: color var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary-color);
        }

        .nav-link i {
            font-size: 0.9em;
        }

        .search-box {
            display: flex;
            align-items: center;
            position: relative;
            margin-left: 20px;
        }

        .search-box input {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            width: 200px;
            transition: width var(--transition-speed);
            font-size: 0.9rem;
        }

        .search-box input:focus {
            width: 300px;
            outline: none;
            background-color: rgba(255, 255, 255, 0.3);
        }

        .search-box button {
            background: none;
            border: none;
            color: white;
            margin-right: -35px;
            z-index: 1;
            cursor: pointer;
            transition: color var(--transition-speed);
        }

        .search-box button:hover {
            color: var(--primary-color);
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-left: 20px;
        }

        .auth-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-speed);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .auth-btn:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        .auth-btn.secondary {
            background-color: transparent;
            border: 1px solid var(--primary-color);
        }

        /* أقسام الصفحة */
        .page {
            display: none;
            padding: 20px 0;
            min-height: calc(100vh - var(--navbar-height));
        }

        .page.active {
            display: block;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* شريط البطل Netflix-style */
        .hero-slider {
            width: 100%;
            height: 70vh;
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .hero-slide {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex !important;
            align-items: center;
            padding: 0 60px;
        }

        .slide-content {
            max-width: 600px;
            z-index: 2;
            position: relative;
        }

        .slide-title {
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-weight: 700;
        }

        .slide-description {
            font-size: 1.2rem;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .slide-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .slide-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .slide-actions {
            display: flex;
            gap: 15px;
        }

        .slide-play-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all var(--transition-speed);
            font-weight: 600;
        }

        .slide-play-btn:hover {
            background-color: #f40612;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(229, 9, 20, 0.4);
        }

        .slide-info-btn {
            background-color: rgba(109, 109, 109, 0.7);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all var(--transition-speed);
            font-weight: 600;
        }

        .slide-info-btn:hover {
            background-color: rgba(109, 109, 109, 0.9);
        }

        .slide-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.2) 100%);
            z-index: 1;
        }

        /* صفحة تفاصيل المسلسل */
        .series-detail {
            width: 100%;
        }

        .series-backdrop {
            width: 100%;
            height: 70vh;
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            padding: 0 60px;
            align-items: center;
        }

        .backdrop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.2) 100%);
            z-index: 1;
        }

        .series-poster {
            position: relative;
            width: 300px;
            height: 450px;
            margin-left: 50px;
            z-index: 2;
            flex-shrink: 0;
        }

        .series-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        .series-poster .play-btn {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all var(--transition-speed);
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .series-poster .play-btn:hover {
            background-color: #f40612;
            transform: translateX(-50%) scale(1.05);
        }

        .series-info {
            z-index: 2;
            max-width: 600px;
        }

        .series-info h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .series-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .series-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .series-description {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .season-section {
            margin-top: 40px;
        }

        .season-section h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .other-seasons {
            margin-top: 40px;
        }

        .related-series {
            margin-top: 40px;
        }

          /* أنماط زر المفضلة */
#favouriteBtn {
    cursor: pointer;
    transition: all 0.3s ease;
}

#favouriteBtn.added {
    color: var(--primary-color);
    font-weight: bold;
}

#favouriteBtn i {
    margin-left: 5px;
}
        
        /* مشغل الفيديو */
        .player-section {
            width: 100%;
            background-color: #000;
            position: relative;
            display: none;
        }

        .video-container {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* نسبة 16:9 */
            position: relative;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* الإعلانات */
        .ad-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: none;
            z-index: 100;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .ad-content {
            width: 100%;
            height: 100%;
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .ad-skip {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 30;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            border: none;
            transition: all var(--transition-speed);
        }

        .ad-skip:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        .ad-countdown {
            position: absolute;
            bottom: 20px;
            left: 120px;
            color: white;
            font-size: 0.9rem;
        }

        .channel-logo {
            position: absolute;
            top: 20px;
            right: 20px;
            height: 50px;
            width: auto;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 5px;
        }

        /* إعلان شريطي */
        .banner-ad {
            width: 100%;
            height: 90px;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        /* معلومات التشغيل الحالي */
        .now-playing-info {
            padding: 20px 40px;
            background-color: rgba(20, 20, 20, 0.9);
            border-bottom: 1px solid #333;
            display: none;
        }

        .now-playing-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .badge {
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .imdb-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #FFD700;
            font-weight: bold;
        }

        .now-playing-meta {
            display: flex;
            gap: 15px;
            color: var(--secondary-color);
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .episode-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all var(--transition-speed);
            font-size: var(--button-size);
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .stat:hover {
            color: var(--primary-color);
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* أقسام المحتوى */
        .section {
            padding: 40px 0;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-tabs {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .tab-btn:hover, .tab-btn.active {
            background-color: var(--primary-color);
        }

        /* شبكات المحتوى */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .content-card {
            position: relative;
            cursor: pointer;
            transition: transform var(--transition-speed);
            border-radius: 5px;
            overflow: hidden;
            background-color: #222;
        }

        .content-card:hover {
            transform: scale(1.05);
            z-index: 2;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        .content-thumbnail {
            width: 100%;
            height: 0;
            padding-bottom: 150%;
            background-color: #333;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .episode-thumbnail {
            padding-bottom: 56.25%; /* نسبة 16:9 للحلقات */
        }

        .content-info {
            padding: 15px 10px;
            background-color: rgba(20, 20, 20, 0.9);
        }

        .content-title {
            font-size: 1rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: bold;
        }

        .content-meta {
            font-size: 0.8rem;
            color: var(--secondary-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .content-stats {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--secondary-color);
        }

        .progress-container {
            width: 100%;
            height: 3px;
            background-color: #444;
            margin-top: 8px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
        }

        .episode-number {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            border: 2px solid var(--primary-color);
        }

        .free-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* لوحة الإدارة */
        .admin-panel {
            background-color: rgba(0, 0, 0, 0.9);
            padding: 30px;
            margin: 20px;
            border-radius: 10px;
            display: none;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            overflow-y: auto;
            max-height: 90vh;
            position: fixed;
            top: var(--navbar-height);
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            flex-wrap: wrap;
        }

        .admin-tab {
            background: none;
            border: none;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: all var(--transition-speed);
        }

        .admin-tab:hover, .admin-tab.active {
            background-color: var(--primary-color);
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .admin-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .admin-label {
            font-size: 0.9rem;
            color: #ccc;
        }

        .admin-input {
            padding: 12px;
            background-color: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 5px;
            font-size: 1rem;
            transition: all var(--transition-speed);
        }

        .admin-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .admin-select {
            padding: 12px;
            background-color: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 5px;
            font-size: 1rem;
        }

        .admin-textarea {
            padding: 12px;
            background-color: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 5px;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
        }

        .admin-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: opacity var(--transition-speed);
            font-size: 1rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-btn:hover {
            opacity: 0.9;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
        }

        .stat-title {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-details {
            font-size: 0.9rem;
            color: #ccc;
        }

        .admin-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .admin-list-item {
            background-color: #444;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-item-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-item-thumb {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
        }

        .admin-item-actions {
            display: flex;
            gap: 10px;
        }

        .edit-btn {
            background-color: #4CAF50;
        }

        .delete-btn {
            background-color: #f44336;
        }

        /* زر تبديل الإدارة */
        .admin-toggle {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background-color: var(--primary-color);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform var(--transition-speed);
        }

        .admin-toggle:hover {
            transform: scale(1.1);
        }

        /* رسائل التحميل والأخطاء */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 2000;
            display: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .success-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 2000;
            display: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        /* صفحة الملف الشخصي */
        .profile-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .profile-email {
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 600px;
            margin-bottom: 30px;
        }

        .profile-stat {
            background-color: #222;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .profile-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .profile-stat-label {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .watch-history {
            width: 100%;
            max-width: 1000px;
        }

        /* تصميم متجاوب */
        @media (max-width: 1200px) {
            .content-grid, .episodes-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .slide-title {
                font-size: 2.5rem;
            }
            
            .series-poster {
                width: 250px;
                height: 375px;
            }
        }
        
        @media (max-width: 992px) {
            .navbar-container {
                flex-wrap: wrap;
                height: auto;
                padding: 10px;
            }
            
            .nav-menu {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .search-box {
                order: 2;
                width: 100%;
                margin: 10px 0;
            }
            
            .section, .now-playing-info {
                padding: 30px 20px;
            }
            
            .now-playing-title {
                font-size: 1.5rem;
            }
            
            .slide-title {
                font-size: 2rem;
            }
            
            .slide-description {
                font-size: 1rem;
            }
            
            .admin-panel {
                padding: 20px 15px;
                margin: 15px;
            }
            
            .admin-toggle {
                width: 50px;
                height: 50px;
                bottom: 20px;
                left: 20px;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .search-box input:focus {
                width: 100%;
            }
            
            .hero-slide, .series-backdrop {
                padding: 0 30px;
            }
            
            .series-poster {
                margin-left: 30px;
            }
        }
        
        @media (max-width: 768px) {
            .content-grid, .episodes-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .logo-img {
                height: 30px;
            }
            
            .channel-logo {
                height: 40px;
                top: 15px;
                right: 15px;
            }
            
            .now-playing-title {
                font-size: 1.3rem;
            }
            
            .now-playing-meta {
                flex-direction: column;
                gap: 5px;
                font-size: 0.9rem;
            }
            
            .section-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .ad-skip {
                bottom: 10px;
                left: 10px;
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            .ad-countdown {
                bottom: 10px;
                left: 90px;
                font-size: 0.8rem;
            }
            
            .stat {
                font-size: 1rem;
                padding: 8px 10px;
            }
            
            .hero-slide, .series-backdrop {
                padding: 0 20px;
                flex-direction: column;
                justify-content: center;
                text-align: center;
            }
            
            .slide-title {
                font-size: 1.5rem;
            }
            
            .slide-description {
                display: none;
            }
            
            .slide-play-btn {
                padding: 10px 15px;
                font-size: 1rem;
            }

            .profile-stats {
                grid-template-columns: 1fr;
            }
            
            .series-poster {
                margin-left: 0;
                margin-bottom: 20px;
                width: 200px;
                height: 300px;
            }
            
            .series-info {
                text-align: center;
            }
        }
        
        @media (max-width: 576px) {
            .content-grid, .episodes-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .logo-container {
                width: 100%;
                justify-content: center;
            }
            
            .search-box {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
            }
            
            .auth-buttons {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
            
            .hero-slider, .series-backdrop {
                height: 60vh;
            }
            
            .slide-content, .series-info {
                max-width: 100%;
            }
            
            .slide-meta, .series-meta {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* وضع النهار (تجريبي) */
        body.light-mode {
            background-color: #f5f5f5;
            color: #333;
        }

        body.light-mode .navbar {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body.light-mode .nav-link {
            color: #333;
        }

        body.light-mode .content-info,
        body.light-mode .content-list-item,
        body.light-mode .stat-card {
            background-color: #fff;
            color: #333;
        }

        body.light-mode .content-title,
        body.light-mode .content-list-title {
            color: #333;
        }
        .profile-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    overflow-x: auto;
    padding-bottom: 10px;
    width: 100%;
}

.profile-tab {
    background: #333;
    border: none;
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    white-space: nowrap;
}

.profile-tab.active {
    background: var(--primary-color);
}

.profile-tab-content {
    display: none;
    width: 100%;
}

.profile-tab-content.active {
    display: block;
}
        #profileNavItem {
    transition: all 0.3s ease;
}

#profileNavImage {
    border: 2px solid var(--primary-color);
    object-fit: cover;
    vertical-align: middle;
}

#profileLink {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
}
        .admin-toggle {
                display: none;
        }
    
       /* أنماط الكاروسيل الجديدة */
.content-carousel {
    display: flex;
    overflow-x: auto;
    gap: 15px;
    padding: 10px 0;
    scrollbar-width: none; /* لإخفاء شريط التمرير في Firefox */
}

.content-carousel::-webkit-scrollbar {
    display: none; /* لإخفاء شريط التمرير في Chrome/Safari */
}

.content-carousel .content-card {
    flex: 0 0 auto;
    width: 220px;
    transition: transform 0.3s ease;
}

.content-carousel .content-card:hover {
    transform: scale(1.05);
}

/* أنماط البادجات */
.top10-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: linear-gradient(135deg, #E50914 0%, #B00710 100%);
    color: white;
    font-weight: bold;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    z-index: 2;
}

.trending-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #E50914;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
} 
        @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-20px); }
}

#welcomeToast {
    animation: none; /* إعادة التعيين */
    transition: all 0.3s ease;
}
    </style>
    </head>
<body>
      
<!-- رسالة الترحيب -->
<div id="welcomeToast" style="display:none; position:fixed; top:70px; left:50%; transform:translateX(-50%); background-color:#E50914; color:white; padding:12px 24px; border-radius:4px; z-index:1000; box-shadow:0 3px 10px rgba(0,0,0,0.3); font-weight:bold;">
    مرحباً <span id="userName"></span>! تم تسجيل الدخول بنجاح
</div>

    
    <!-- شريط التنقل العلوي -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="logo-container">
                <img src="https://via.placeholder.com/150x50?text=SMURFS+LOGO" alt="سنافر" class="logo-img" loading="lazy">
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item"><a href="#" class="nav-link active" data-page="home"><i class="fas fa-home"></i>الرئيسية</a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="series"><i class="fas fa-tv"></i>المسلسلات</a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-page="movies"><i class="fas fa-film"></i>الأفلام</a></li>
                <li class="nav-item" id="profileNavItem">
    <a href="#" class="nav-link" data-page="profile" id="profileLink">
        <i class="fas fa-user-circle" style="font-size: 30px; color: #E50914;"></i>
        <span>بروفايل</span>
    </a>
</li>
            </ul>
            
            <div class="search-box">
                <input type="text" placeholder="ابحث عن مسلسل أو فيلم...">
                <button><i class="fas fa-search"></i></button>
            </div>
            
            <div class="auth-buttons" style="display:none;">
    <button id="signOutButton" class="auth-btn"><i class="fas fa-sign-out-alt"></i>تسجيل الخروج</button>
            </div>
        </div>
    </nav>

    <!-- الصفحة الرئيسية -->
    <div id="home-page" class="page active">
        <!-- شريط البطل Netflix-style -->
        <section class="hero-slider" id="heroSlider">
            <!-- سيتم تحميل العناصر ديناميكيًا -->
        </section>
        
        <!-- قسم المسلسلات -->
        <section class="section">
            <div class="container">
                <h3 class="section-title">
                    <span>احدث المسلسلات</span>
                </h3>
                <div class="content-grid" id="seriesGrid">
                    <!-- سيتم تحميل المسلسلات ديناميكيًا -->
                </div>
            </div>
        </section>
        
        <!-- قسم الأفلام -->
        <section class="section">
            <div class="container">
                <h3 class="section-title">
                    <span>احدث الأفلام</span>
                </h3>
                <div class="content-grid" id="moviesGrid">
                    <!-- سيتم تحميل الأفلام ديناميكيًا -->
                </div>
            </div>
        </section>
       <!-- Trending Series -->
<section class="section">
    <div class="container">
        <h3 class="section-title">
            <i class="fas fa-fire" style="color: #E50914; margin-left: 10px;"></i>
            <span>المسلسلات ترند</span>
        </h3>
        <div class="content-carousel" id="trendingSeriesCarousel"></div>
    </div>
</section>

<!-- Trending Movies -->
<section class="section">
    <div class="container">
        <h3 class="section-title">
            <i class="fas fa-bolt" style="color: #E50914; margin-left: 10px;"></i>
            <span>الأفلام ترند</span>
        </h3>
        <div class="content-carousel" id="trendingMoviesCarousel"></div>
    </div>
</section>
       <!-- Featured Series -->
<section class="section">
    <div class="container">
        <h3 class="section-title">
            <i class="fas fa-star" style="color: #FFD700; margin-left: 10px;"></i>
            <span>مسلسلات المختارة</span>
        </h3>
        <div class="content-carousel" id="featuredSeriesCarousel"></div>
    </div>
</section>

<!-- Featured Movies -->
<section class="section">
    <div class="container">
        <h3 class="section-title">
            <i class="fas fa-crown" style="color: #FFD700; margin-left: 10px;"></i>
            <span>الأفلام المختارة</span>
        </h3>
        <div class="content-carousel" id="featuredMoviesCarousel"></div>
    </div>
</section>

<!-- Box Office -->
<section class="section">
    <div class="container">
        <h3 class="section-title">
            <i class="fas fa-trophy" style="color: #E50914; margin-left: 10px;"></i>
            <span>بوكس اوفيس</span>
        </h3>
        <div class="content-carousel" id="boxOfficeCarousel"></div>
    </div>
</section>

       <!-- Latest Episodes -->
<section class="section">
    <div class="container">
        <h3 class="section-title">
            <i class="fas fa-clock" style="color: #E50914; margin-left: 10px;"></i>
            <span>احدث الحلقات</span>
        </h3>
        <div class="content-carousel" id="latestEpisodesCarousel"></div>
    </div>
</section>

<!-- Top 10 TV Shows -->
<section class="section">
    <div class="container">
        <h3 class="section-title">
            <i class="fas fa-medal" style="color: #FFD700; margin-left: 10px;"></i>
            <span id="top10Title">افضل 10 مسلسلات</span>
        </h3>
        <div class="content-carousel" id="top10Carousel"></div>
    </div>
</section> 
        
    </div>

    <!-- صفحة المسلسلات -->
    <div id="series-page" class="page">
        <section class="section">
            <div class="container">
                <h3 class="section-title">
                    <span>جميع المسلسلات</span>
                </h3>
                <div class="content-grid" id="allSeriesGrid">
                    <!-- سيتم تحميل جميع المسلسلات ديناميكيًا -->
                </div>
            </div>
        </section>
    </div>

    <!-- صفحة الأفلام -->
    <div id="movies-page" class="page">
        <section class="section">
            <div class="container">
                <h3 class="section-title">
                    <span>جميع الأفلام</span>
                </h3>
                <div class="content-grid" id="allMoviesGrid">
                    <!-- سيتم تحميل جميع الأفلام ديناميكيًا -->
                </div>
            </div>
        </section>
    </div>

    <!-- صفحة تفاصيل المسلسل -->
    <div id="series-detail-page" class="page" style="display: none;">
        <!-- سيتم تحميل محتوى تفاصيل المسلسل ديناميكيًا -->
    </div>

    <!-- صفحة الملف الشخصي -->
    <div id="profile-page" class="page">
        <div class="container profile-container">
            <div class="profile-avatar">
                <i class="fas fa-user"></i>
            </div>
            <h2 class="profile-name" id="profileName">زائر</h2>
            <p class="profile-email" id="profileEmail">يجب تسجيل الدخول لعرض المعلومات</p>
<div class="profile-tab-content active" id="historyTab">
    <div class="content-grid" id="watchHistoryGrid"></div>
</div>
            <div class="watch-history">
                <h3 class="section-title">
                    <span>سجل المشاهدة</span>
                </h3>
                <div class="content-grid" id="watchHistoryGrid">
                    <!-- سيتم تحميل سجل المشاهدة ديناميكيًا -->
                </div>
            </div>
        </div>
    </div>
    <section class="player-section" id="playerSection">
        <!-- إعلان ما قبل التشغيل -->
        <div class="ad-overlay" id="adOverlay">
            <div class="ad-content" id="adContent">
                <button class="ad-skip" id="adSkip">
                    <i class="fas fa-forward"></i> تخطي الإعلان
                </button>
                <div class="ad-countdown" id="adCountdown">الإعلان ينتهي بعد 5 ثواني</div>
            </div>
        </div>
        
        <div class="video-container">
            <iframe id="videoPlayer" src="" allowfullscreen></iframe>
            <img src="https://via.placeholder.com/100x50?text=قناة+السنافر" alt="قناة السنافر" class="channel-logo" loading="lazy">
        </div>
    </section>

    <!-- معلومات التشغيل الحالي -->
    <div class="now-playing-info" id="nowPlayingInfo">
        <h2 class="now-playing-title" id="nowPlayingTitle">
            <span id="nowPlayingTitleText">اختر حلقة للمشاهدة</span>
            <span class="badge">Free</span>
            <span class="imdb-rating">
                <i class="fas fa-star"></i>
                <span id="imdbRating">7.5</span>
            </span>
        </h2>
        <div class="now-playing-meta">
            <span id="nowPlayingNumber"></span>
            <span id="nowPlayingDuration"></span>
        </div>
        <div class="episode-stats">
            <div class="stat" id="viewsStat">
                <i class="fas fa-eye"></i>
                <span id="viewsCount">0</span> مشاهدة
            </div>
            <div class="stat interaction-btn" id="likesStat">
                <i class="fas fa-thumbs-up"></i>
                <span id="likesCount">0</span>
            </div>
            <div class="stat interaction-btn" id="dislikesStat">
                <i class="fas fa-thumbs-down"></i>
                <span id="dislikesCount">0</span>
            </div>
        </div>
    </div>

    <!-- لوحة الإدارة -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="series">إدارة المسلسلات</button>
            <button class="admin-tab" data-tab="episodes">إدارة الحلقات</button>
            <button class="admin-tab" data-tab="movies">إدارة الأفلام</button>
            <button class="admin-tab" data-tab="ads">إدارة الإعلانات</button>
            <button class="admin-tab" data-tab="stats">إحصائيات المشاهدات</button>
            <button class="admin-tab" data-tab="visitors">إحصائيات الزوار</button>
            <button class="admin-tab" data-tab="settings">الإعدادات</button>
        </div>
        
        <!-- تبويب إدارة المسلسلات -->
        <div class="admin-tab-content active" id="seriesTab">
            <h3 class="admin-title">إدارة المسلسلات</h3>
            <button id="addSeriesBtn" class="admin-btn"><i class="fas fa-plus"></i> إضافة مسلسل جديد</button>
            
            <div id="seriesForm" style="display: none; margin-top: 20px;">
                <div class="admin-controls">
                    <div class="admin-group">
                        <label class="admin-label">اسم المسلسل:</label>
                        <input type="text" id="seriesTitle" class="admin-input" placeholder="اسم المسلسل...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">قصة المسلسل:</label>
                        <textarea id="seriesDescription" class="admin-textarea" placeholder="قصة المسلسل..."></textarea>
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">صورة المصغرة:</label>
                        <input type="text" id="seriesThumb" class="admin-input" placeholder="رابط الصورة المصغرة...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">صورة الخلفية:</label>
                        <input type="text" id="seriesBackdrop" class="admin-input" placeholder="رابط صورة الخلفية...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">تقييم المسلسل:</label>
                        <input type="number" id="seriesRating" class="admin-input" placeholder="تقييم المسلسل..." min="0" max="10" step="0.1">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">نوع المسلسل:</label>
                        <input type="text" id="seriesGenre" class="admin-input" placeholder="نوع المسلسل...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">عدد الحلقات:</label>
                        <input type="number" id="seriesEpisodes" class="admin-input" placeholder="عدد الحلقات..." min="1">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">لغة المسلسل:</label>
                        <input type="text" id="seriesLanguage" class="admin-input" placeholder="لغة المسلسل...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">دولة المسلسل:</label>
                        <input type="text" id="seriesCountry" class="admin-input" placeholder="دولة المسلسل...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">رقم الموسم:</label>
                        <input type="number" id="seriesSeason" class="admin-input" placeholder="رقم الموسم..." min="1">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">حالة المسلسل:</label>
                        <select id="seriesStatus" class="admin-select">
                            <option value="new">جديد</option>
                            <option value="exclusive">حصري</option>
                            <option value="regular">عادي</option>
                        </select>
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">مميز:</label>
                        <select id="seriesFeatured" class="admin-select">
                            <option value="false">لا</option>
                            <option value="true">نعم</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button id="saveSeries" class="admin-btn"><i class="fas fa-save"></i> حفظ المسلسل</button>
                    <button id="cancelSeries" class="admin-btn" style="background-color: #666;"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </div>
            
            <div class="admin-title" style="margin-top: 30px;">قائمة المسلسلات</div>
            <div class="admin-list" id="seriesList">
                <!-- سيتم تحميل قائمة المسلسلات ديناميكيًا -->
            </div>
        </div>
        
        <!-- تبويب إدارة الحلقات -->
        <div class="admin-tab-content" id="episodesTab">
            <h3 class="admin-title">إدارة الحلقات</h3>
            <div class="admin-controls">
                <div class="admin-group">
                    <label class="admin-label">اختر مسلسل:</label>
                    <select id="episodeSeries" class="admin-select">
                        <option value="">اختر مسلسل...</option>
                        <!-- سيتم تحميل خيارات المسلسلات ديناميكيًا -->
                    </select>
                </div>
                <div class="admin-group">
                    <label class="admin-label">رقم الحلقة:</label>
                    <input type="number" id="episodeNumber" class="admin-input" placeholder="رقم الحلقة..." min="1">
                </div>
                <div class="admin-group">
                    <label class="admin-label">عنوان الحلقة:</label>
                    <input type="text" id="episodeTitle" class="admin-input" placeholder="عنوان الحلقة...">
                </div>
                <div class="admin-group">
                    <label class="admin-label">رابط الحلقة:</label>
                    <input type="text" id="episodeUrl" class="admin-input" placeholder="رابط الحلقة...">
                </div>
                <div class="admin-group">
                    <label class="admin-label">رابط الصورة المصغرة:</label>
                    <input type="text" id="episodeThumb" class="admin-input" placeholder="رابط الصورة المصغرة...">
                </div>
                <div class="admin-group">
                    <label class="admin-label">مدة الحلقة (دقائق):</label>
                    <input type="number" id="episodeDuration" class="admin-input" placeholder="مدة الحلقة..." min="1">
                </div>
                <div class="admin-group">
                    <label class="admin-label">رقم الموسم:</label>
                    <input type="number" id="episodeSeason" class="admin-input" placeholder="رقم الموسم..." min="1">
                </div>
            </div>
            <div class="btn-group">
                <button id="saveEpisode" class="admin-btn"><i class="fas fa-save"></i> حفظ الحلقة</button>
                <button id="closeAdmin" class="admin-btn" style="background-color: #666;"><i class="fas fa-times"></i> إغلاق اللوحة</button>
            </div>
            
            <div class="admin-title" style="margin-top: 30px;">قائمة الحلقات</div>
            <div class="admin-list" id="episodesList">
                <!-- سيتم تحميل قائمة الحلقات ديناميكيًا -->
            </div>
        </div>
        
        <!-- تبويب إدارة الأفلام -->
        <div class="admin-tab-content" id="moviesTab">
            <h3 class="admin-title">إدارة الأفلام</h3>
            <button id="addMovieBtn" class="admin-btn"><i class="fas fa-plus"></i> إضافة فيلم جديد</button>
            
            <div id="movieForm" style="display: none; margin-top: 20px;">
                <div class="admin-controls">
                    <div class="admin-group">
                        <label class="admin-label">عنوان الفيلم:</label>
                        <input type="text" id="movieTitle" class="admin-input" placeholder="عنوان الفيلم...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">قصة الفيلم:</label>
                        <textarea id="movieDescription" class="admin-textarea" placeholder="قصة الفيلم..."></textarea>
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">رابط الفيلم:</label>
                        <input type="text" id="movieUrl" class="admin-input" placeholder="رابط الفيلم...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">رابط الصورة المصغرة:</label>
                        <input type="text" id="movieThumb" class="admin-input" placeholder="رابط الصورة المصغرة...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">رابط صورة الخلفية:</label>
                        <input type="text" id="movieBackdrop" class="admin-input" placeholder="رابط صورة الخلفية...">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">مدة الفيلم (دقائق):</label>
                        <input type="number" id="movieDuration" class="admin-input" placeholder="مدة الفيلم..." min="1">
                    </div>
                    <div class="admin-group">
                        <label class="admin-label">مميز:</label>
                        <select id="movieFeatured" class="admin-select">
                            <option value="false">لا</option>
                            <option value="true">نعم</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button id="saveMovie" class="admin-btn"><i class="fas fa-save"></i> حفظ الفيلم</button>
                    <button id="cancelMovie" class="admin-btn" style="background-color: #666;"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </div>
            
            <div class="admin-title" style="margin-top: 30px;">قائمة الأفلام</div>
            <div class="admin-list" id="moviesList">
                <!-- سيتم تحميل قائمة الأفلام ديناميكيًا -->
            </div>
        </div>
        
        <!-- تبويب إدارة الإعلانات -->
        <div class="admin-tab-content" id="adsTab">
            <h3 class="admin-title">إدارة الإعلانات</h3>
            <div class="admin-controls">
                <div class="admin-group">
                    <label class="admin-label">مفتاح Adsterra:</label>
                    <input type="text" id="adsterraKey" class="admin-input" placeholder="أدخل مفتاح Adsterra...">
                </div>
                <div class="admin-group">
                    <label class="admin-label">مدة إعلان ما قبل التشغيل (ثواني):</label>
                    <input type="number" id="preRollDuration" class="admin-input" value="5" min="5">
                </div>
                <div class="admin-group">
                    <label class="admin-label">تمكين الإعلانات في منتصف التشغيل:</label>
                    <select id="midRollEnabled" class="admin-select">
                        <option value="true">نعم</option>
                        <option value="false">لا</option>
                    </select>
                </div>
                <div class="admin-group">
                    <label class="admin-label">مدة إعلان منتصف التشغيل (ثواني):</label>
                    <input type="number" id="midRollDuration" class="admin-input" value="10" min="5">
                </div>
                <div class="admin-group">
                    <label class="admin-label">تمكين الإعلانات بعد التشغيل:</label>
                    <select id="postRollEnabled" class="admin-select">
                        <option value="true">نعم</option>
                        <option value="false">لا</option>
                    </select>
                </div>
                <div class="admin-group">
                    <label class="admin-label">مدة إعلان بعد التشغيل (ثواني):</label>
                    <input type="number" id="postRollDuration" class="admin-input" value="10" min="5">
                </div>
                <div class="admin-group">
                    <label class="admin-label">تمكين الإعلان الشريطي:</label>
                    <select id="bannerAdEnabled" class="admin-select">
                        <option value="true">نعم</option>
                        <option value="false">لا</option>
                    </select>
                </div>
                <div class="admin-group">
                    <label class="admin-label">سعر الألف ظهور (CPM):</label>
                    <input type="number" id="adCpm" class="admin-input" value="0.001" step="0.001" min="0">
                </div>
            </div>
            <div class="btn-group">
                <button id="saveAdsSettings" class="admin-btn"><i class="fas fa-save"></i> حفظ إعدادات الإعلانات</button>
            </div>
            
            <div class="admin-title" style="margin-top: 30px;">إحصائيات الإعلانات</div>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">إجمالي عائد الإعلانات</div>
                    <div class="stat-value">$<span id="totalAdRevenue">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">إعلانات ما قبل التشغيل</div>
                    <div class="stat-value"><span id="preRollCount">0</span> مشاهدة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">إعلانات منتصف التشغيل</div>
                    <div class="stat-value"><span id="midRollCount">0</span> مشاهدة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">إعلانات بعد التشغيل</div>
                    <div class="stat-value"><span id="postRollCount">0</span> مشاهدة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">الإعلانات الشريطية</div>
                    <div class="stat-value"><span id="bannerAdCount">0</span> ظهور</div>
                </div>
            </div>
        </div>
        
        <!-- تبويب الإحصائيات -->
        <div class="admin-tab-content" id="statsTab">
            <h3 class="admin-title">إحصائيات المشاهدات</h3>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">إجمالي المشاهدات</div>
                    <div class="stat-value"><span id="totalViews">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">إجمالي الإعجابات</div>
                    <div class="stat-value"><span id="totalLikes">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">إجمالي عدم الإعجاب</div>
                    <div class="stat-value"><span id="totalDislikes">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">الحلقات الأكثر مشاهدة</div>
                    <div class="stat-value"><span id="topEpisode">-</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">الأفلام الأكثر مشاهدة</div>
                    <div class="stat-value"><span id="topMovie">-</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">متوسط وقت المشاهدة</div>
                    <div class="stat-value"><span id="avgWatchTime">0</span> دقيقة</div>
                </div>
            </div>
        </div>
        
        <!-- تبويب إحصائيات الزوار -->
        <div class="admin-tab-content" id="visitorsTab">
            <h3 class="admin-title">إحصائيات الزوار</h3>
            <div class="admin-controls">
                <div class="admin-group">
                    <label class="admin-label">الفترة الزمنية:</label>
                    <select id="visitorsTimeRange" class="admin-select">
                        <option value="day">اليوم</option>
                        <option value="week">الأسبوع</option>
                        <option value="month">الشهر</option>
                        <option value="year">السنة</option>
                    </select>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">إجمالي الزوار</div>
                    <div class="stat-value"><span id="totalVisitors">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">زوار جدد</div>
                    <div class="stat-value"><span id="newVisitors">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">زوار متكررون</div>
                    <div class="stat-value"><span id="returningVisitors">0</span></div>
                </div>
            </div>
            
            <div class="admin-title" style="margin-top: 30px;">مصادر الزوار</div>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">فيسبوك</div>
                    <div class="stat-value"><span id="facebookVisitors">0</span></div>
                    <div class="stat-details"><span id="facebookPercentage">0%</span> من إجمالي الزوار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">جوجل</div>
                    <div class="stat-value"><span id="googleVisitors">0</span></div>
                    <div class="stat-details"><span id="googlePercentage">0%</span> من إجمالي الزوار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">يوتيوب</div>
                    <div class="stat-value"><span id="youtubeVisitors">0</span></div>
                    <div class="stat-details"><span id="youtubePercentage">0%</span> من إجمالي الزوار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">تيك توك</div>
                    <div class="stat-value"><span id="tiktokVisitors">0</span></div>
                    <div class="stat-details"><span id="tiktokPercentage">0%</span> من إجمالي الزوار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">انستغرام</div>
                    <div class="stat-value"><span id="instagramVisitors">0</span></div>
                    <div class="stat-details"><span id="instagramPercentage">0%</span> من إجمالي الزوار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">مصادر أخرى</div>
                    <div class="stat-value"><span id="otherVisitors">0</span></div>
                    <div class="stat-details"><span id="otherPercentage">0%</span> من إجمالي الزوار</div>
                </div>
            </div>
            
            <div class="admin-title" style="margin-top: 30px;">أجهزة الزوار</div>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">هواتف</div>
                    <div class="stat-value"><span id="mobileVisitors">0</span></div>
                    <div class="stat-details"><span id="mobilePercentage">0%</span> من إجمالي الزوار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">حواسيب</div>
                    <div class="stat-value"><span id="desktopVisitors">0</span></div>
                    <div class="stat-details"><span id="desktopPercentage">0%</span> من إجمالي الزوار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">أجهزة لوحية</div>
                    <div class="stat-value"><span id="tabletVisitors">0</span></div>
                    <div class="stat-details"><span id="tabletPercentage">0%</span> من إجمالي الزوار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">تلفزيونات</div>
                    <div class="stat-value"><span id="tvVisitors">0</span></div>
                    <div class="stat-details"><span id="tvPercentage">0%</span> من إجمالي الزوار</div>
                </div>
            </div>
            
            <div class="admin-title" style="margin-top: 30px;">خريطة الزوار</div>
            <div id="visitorsMap" style="width: 100%; height: 400px; background-color: #333; border-radius: 5px; display: flex; justify-content: center; align-items: center; color: #ccc;">
                خريطة تفاعلية للزوار حسب البلدان
            </div>
        </div>
    <!-- زر تبديل الإدارة -->
    <div class="admin-toggle" id="adminToggle">
        <i class="fas fa-cog"></i>
    </div>
    <div class="error-message" id="errorMessage"></div>
    
    <div class="success-message" id="successMessage"></div>

    <!-- مكتبات JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <!-- amCharts for visitor map -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldHigh.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    
    <!-- تهيئة Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
 <script>
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDL7PaPWXH7gWbsFoCRZA8cKMov-xcY4bQ",
                authDomain: "turkify-movies.firebaseapp.com",
                projectId: "turkify-movies",
                storageBucket: "turkify-movies.appspot.com",
                messagingSenderId: "535487522663",
                appId: "1:535487522663:web:b11bc354d78f9ab388b1c2"
            };
            
            // Initialize Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            // كائنات Firebase
            const auth = firebase.auth();
            const db = firebase.firestore();
            
            // إعدادات التطبيق
            const APP_CONFIG = {
                ADMIN_PASSWORD_HASH: "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8", // sha256 لـ "password"
                DEFAULT_LANGUAGE: "en",
                SUPPORTED_LANGUAGES: ["ar", "en"],
                ADSTERRA_KEY: "", // سيتم جلبها من Firestore
                ADS_ENABLED: true,
                AD_CPM: 0.001 // دولار لكل 1000 ظهور
            };
            
            // إعدادات الإعلانات
            const AD_SETTINGS = {
                preRoll: {
                    enabled: true,
                    duration: 5, // ثواني
                    maxPerVideo: 1
                },
                midRoll: {
                    enabled: true,
                    duration: 10, // ثواني
                    interval: 1860, // ثانية (31 دقيقة)
                    maxPerVideo: 1
                },
                postRoll: {
                    enabled: true,
                    duration: 10, // ثواني
                    interval: 660, // ثانية (11 دقيقة)
                    maxPerVideo: 1
                },
                banner: {
                    enabled: true,
                    cpm: 0.001 // دولار لكل 1000 ظهور
                }
            };
            
            // حالة التطبيق
            const appState = {
                currentUser: null,
                series: [],
                episodes: [],
                movies: [],
                watchProgress: {},
                currentContent: null,
                isShowingAd: false,
                adStats: {
                    preRollShown: 0,
                    midRollShown: 0,
                    postRollShown: 0,
                    bannerShown: 0,
                    totalRevenue: 0
                },
                intervals: [] // لتخزين المؤقتات للتنظيف لاحقاً
            };
            
            // عناصر DOM
            const elements = {
                // شريط التنقل
                navLinks: document.querySelectorAll('.nav-link'),
                signInButton: document.getElementById('signInButton'),
                signOutButton: document.getElementById('signOutButton'),
                
                // الصفحات
                pages: {
                    home: document.getElementById('home-page'),
                    series: document.getElementById('series-page'),
                    movies: document.getElementById('movies-page'),
                    profile: document.getElementById('profile-page'),
                    seriesDetail: document.getElementById('series-detail-page')
                },
                
                // مشغل الفيديو
                playerSection: document.getElementById('playerSection'),
                videoPlayer: document.getElementById('videoPlayer'),
                nowPlayingInfo: document.getElementById('nowPlayingInfo'),
                nowPlayingTitle: document.getElementById('nowPlayingTitleText'),
                nowPlayingNumber: document.getElementById('nowPlayingNumber'),
                nowPlayingDuration: document.getElementById('nowPlayingDuration'),
                viewsCount: document.getElementById('viewsCount'),
                likesCount: document.getElementById('likesCount'),
                dislikesCount: document.getElementById('dislikesCount'),
                imdbRating: document.getElementById('imdbRating'),
                
                // الإعلانات
                adOverlay: document.getElementById('adOverlay'),
                adContent: document.getElementById('adContent'),
                adSkip: document.getElementById('adSkip'),
                adCountdown: document.getElementById('adCountdown'),
                
                // شريط البطل
                heroSlider: document.getElementById('heroSlider'),
                
                // الشبكات
                seriesGrid: document.getElementById('seriesGrid'),
                moviesGrid: document.getElementById('moviesGrid'),
                allSeriesGrid: document.getElementById('allSeriesGrid'),
                allMoviesGrid: document.getElementById('allMoviesGrid'),
                watchHistoryGrid: document.getElementById('watchHistoryGrid'),
                
                // الملف الشخصي
                profileName: document.getElementById('profileName'),
                profileEmail: document.getElementById('profileEmail'),
                watchedCount: document.getElementById('watchedCount'),
                favoritesCount: document.getElementById('favoritesCount'),
                watchlistCount: document.getElementById('watchlistCount'),
                
                // لوحة الإدارة
                adminPanel: document.getElementById('adminPanel'),
                adminToggle: document.getElementById('adminToggle'),
                
                // التحميل والأخطاء
                loadingOverlay: document.getElementById('loadingOverlay'),
                errorMessage: document.getElementById('errorMessage'),
                successMessage: document.getElementById('successMessage'),
                
                // البحث
                searchInput: document.querySelector('.search-box input'),
                searchButton: document.querySelector('.search-box button')
            };

            // التحقق من وجود العناصر الأساسية
            if (!elements.videoPlayer || !elements.loadingOverlay) {
                console.error('عناصر DOM الأساسية غير موجودة');
                return;
            }

            // تهيئة التطبيق
            initApp();
            
            // وظائف التطبيق الرئيسية
            async function initApp() {
                try {
                    // إعداد مستمعي الأحداث
                    setupEventListeners();
                    
                    // مراقبة حالة المصادقة
                    auth.onAuthStateChanged(async user => {
                        try {
                            if (user) {
                                appState.currentUser = user;
                                if (elements.signInButton) elements.signInButton.style.display = 'none';
                                if (elements.signOutButton) elements.signOutButton.style.display = 'block';
                                updateUserProfile(user);
                                await loadUserData(user.uid);
                                
                                const userDoc = await db.collection('users').doc(user.uid).get();
                                if (userDoc.exists && userDoc.data().isAdmin && elements.adminToggle) {
                                    elements.adminToggle.style.display = 'block';
                                } else if (elements.adminToggle) {
                                    elements.adminToggle.style.display = 'none';
                                }
                            } else {
                                appState.currentUser = null;
                                if (elements.signInButton) elements.signInButton.style.display = 'block';
                                if (elements.signOutButton) elements.signOutButton.style.display = 'none';
                                resetUserProfile();
                                if (elements.adminToggle) elements.adminToggle.style.display = 'none';
                            }
                        } catch (error) {
                            console.error('خطأ في تغيير حالة المصادقة:', error);
                            showError('حدث خطأ في تحميل بيانات المستخدم');
                        }
                    });
                    
                    // تحميل البيانات الأولية
                    await loadInitialData();
                    
                    // تحميل إعدادات الإعلانات
                    await loadAdSettings();
                    
                    // تحميل أقسام الصفحة الرئيسية
                    await loadHomePageSections();
                } catch (error) {
                    console.error('خطأ في تهيئة التطبيق:', error);
                    showError('حدث خطأ في تحميل التطبيق');
                }
            }
            
            function setupEventListeners() {
                try {
                    // شريط التنقل
                    if (elements.navLinks) {
                        elements.navLinks.forEach(link => {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                const page = this.dataset.page;
                                
                                if (page === 'profile' && !appState.currentUser) {
                                    showLoginModal();
                                    return false;
                                }
                                
                                showPage(page);
                            });
                        });
                    }
                    
                    // تسجيل الدخول والخروج
                    if (elements.signInButton) {
                        elements.signInButton.addEventListener('click', signInWithGoogle);
                    }
                    
                    if (elements.signOutButton) {
                        elements.signOutButton.addEventListener('click', signOut);
                    }
                    
                    // لوحة الإدارة
                    if (elements.adminToggle) {
                        elements.adminToggle.addEventListener('click', toggleAdminPanel);
                    }
                    
                    // البحث
                    if (elements.searchInput) {
                        elements.searchInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                searchContent(this.value);
                            }
                        });
                    }
                    
                    if (elements.searchButton) {
                        elements.searchButton.addEventListener('click', function() {
                            const query = elements.searchInput ? elements.searchInput.value : '';
                            searchContent(query);
                        });
                    }
                    
                    // إعداد تبويبات لوحة الإدارة
                    const adminTabs = document.querySelectorAll('.admin-tab');
                    if (adminTabs) {
                        adminTabs.forEach(tab => {
                            tab.addEventListener('click', function() {
                                const tabId = this.dataset.tab;
                                
                                // تحديث التبويب النشط
                                adminTabs.forEach(t => t.classList.remove('active'));
                                this.classList.add('active');
                                
                                // عرض المحتوى المناسب
                                const tabContents = document.querySelectorAll('.admin-tab-content');
                                tabContents.forEach(content => {
                                    content.classList.remove('active');
                                });
                                
                                const activeTab = document.getElementById(`${tabId}Tab`);
                                if (activeTab) activeTab.classList.add('active');
                                
                                // تحميل بيانات التبويب إذا لزم الأمر
                                if (tabId === 'visitors') {
                                    loadVisitorStats();
                                }
                            });
                        });
                    }
                    
                    // إدارة المسلسلات
                    const addSeriesBtn = document.getElementById('addSeriesBtn');
                    if (addSeriesBtn) {
                        addSeriesBtn.addEventListener('click', function() {
                            const seriesForm = document.getElementById('seriesForm');
                            if (seriesForm) seriesForm.style.display = 'block';
                        });
                    }
                    
                    const cancelSeries = document.getElementById('cancelSeries');
                    if (cancelSeries) {
                        cancelSeries.addEventListener('click', function() {
                            const seriesForm = document.getElementById('seriesForm');
                            if (seriesForm) seriesForm.style.display = 'none';
                        });
                    }
                    
                    const saveSeries = document.getElementById('saveSeries');
                    if (saveSeries) {
                        saveSeries.addEventListener('click', saveSeriesHandler);
                    }
                    
                    // إدارة الحلقات
                    const saveEpisode = document.getElementById('saveEpisode');
                    if (saveEpisode) {
                        saveEpisode.addEventListener('click', saveEpisodeHandler);
                    }
                    
                    // إدارة الأفلام
                    const addMovieBtn = document.getElementById('addMovieBtn');
                    if (addMovieBtn) {
                        addMovieBtn.addEventListener('click', function() {
                            const movieForm = document.getElementById('movieForm');
                            if (movieForm) movieForm.style.display = 'block';
                        });
                    }
                    
                    const cancelMovie = document.getElementById('cancelMovie');
                    if (cancelMovie) {
                        cancelMovie.addEventListener('click', function() {
                            const movieForm = document.getElementById('movieForm');
                            if (movieForm) movieForm.style.display = 'none';
                        });
                    }
                    
                    const saveMovie = document.getElementById('saveMovie');
                    if (saveMovie) {
                        saveMovie.addEventListener('click', saveMovieHandler);
                    }
                    
                    // إعدادات الإعلانات
                    const saveAdsSettings = document.getElementById('saveAdsSettings');
                    if (saveAdsSettings) {
                        saveAdsSettings.addEventListener('click', saveAdSettings);
                    }
                    
                    // إعدادات النظام
                    const saveSettings = document.getElementById('saveSettings');
                    if (saveSettings) {
                        saveSettings.addEventListener('click', saveAppSettings);
                    }
                    
                    // إغلاق لوحة الإدارة
                    const closeAdmin = document.getElementById('closeAdmin');
                    if (closeAdmin) {
                        closeAdmin.addEventListener('click', function() {
                            if (elements.adminPanel) elements.adminPanel.style.display = 'none';
                        });
                    }
                    
                    // تبويبات الملف الشخصي
                    const profileTabs = document.querySelectorAll('.profile-tab');
                    if (profileTabs) {
                        profileTabs.forEach(tab => {
                            tab.addEventListener('click', function() {
                                const tabId = this.dataset.tab;
                                
                                // إزالة التنشيط من جميع الأزرار
                                profileTabs.forEach(t => t.classList.remove('active'));
                                // تنشيط الزر الحالي
                                this.classList.add('active');
                                
                                // إخفاء جميع محتويات التبويبات
                                const profileTabContents = document.querySelectorAll('.profile-tab-content');
                                profileTabContents.forEach(content => {
                                    content.classList.remove('active');
                                });
                                
                                // إظهار المحتوى المطلوب
                                const activeTab = document.getElementById(`${tabId}Tab`);
                                if (activeTab) activeTab.classList.add('active');
                                
                                // تحميل المحتوى عند النقر
                                if (tabId === 'watchlater') {
                                    loadWatchLater();
                                } else if (tabId === 'continue') {
                                    loadContinueWatching();
                                } else if (tabId === 'favorites') {
                                    loadFavorites();
                                }
                            });
                        });
                    }
                    
                    // زر مشاهدة لاحقاً
                    const watchLaterBtn = document.getElementById('watchLaterBtn');
                    if (watchLaterBtn) {
                        watchLaterBtn.addEventListener('click', function() {
                            if (!appState.currentUser) {
                                showLoginModal();
                                return;
                            }
                            
                            if (!appState.currentContent) return;
                            
                            toggleWatchLater(appState.currentContent.data);
                        });
                    }
                    
                    // زر المفضلة
                    const favouriteBtn = document.getElementById('favouriteBtn');
                    if (favouriteBtn) {
                        favouriteBtn.addEventListener('click', function() {
                            if (!appState.currentUser) {
                                showLoginModal();
                                return;
                            }
                            
                            if (!appState.currentContent) return;
                            
                            toggleFavourite(appState.currentContent.data);
                        });
                    }
                } catch (error) {
                    console.error('خطأ في إعداد مستمعي الأحداث:', error);
                }
            }
            
            function showPage(page) {
                try {
                    // إخفاء جميع الصفحات
                    if (elements.pages) {
                        Object.values(elements.pages).forEach(pageElement => {
                            if (pageElement) pageElement.classList.remove('active');
                        });
                    }
                    
                    // إزالة التنشيط من جميع روابط التنقل
                    if (elements.navLinks) {
                        elements.navLinks.forEach(link => {
                            link.classList.remove('active');
                        });
                    }
                    
                    // تنشيط الصفحة المطلوبة
                    if (elements.pages && elements.pages[page]) {
                        elements.pages[page].classList.add('active');
                        const activeLink = document.querySelector(`.nav-link[data-page="${page}"]`);
                        if (activeLink) activeLink.classList.add('active');
                        
                        // تحميل محتوى الصفحة إذا لزم الأمر
                        if (page === 'series' && elements.allSeriesGrid) {
                            renderSeriesGrid(appState.series, elements.allSeriesGrid);
                        } else if (page === 'movies' && elements.allMoviesGrid) {
                            renderMoviesGrid(appState.movies, elements.allMoviesGrid);
                        } else if (page === 'profile' && appState.currentUser) {
                            loadUserData(appState.currentUser.uid);
                        }
                    }
                } catch (error) {
                    console.error('خطأ في عرض الصفحة:', error);
                }
            }
            
            // دالة عرض نافذة تسجيل الدخول
            function showLoginModal() {
                try {
                    // إزالة أي مودال موجود مسبقًا
                    const existingModal = document.getElementById('loginModal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    const modal = document.createElement('div');
                    modal.id = 'loginModal';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
                    modal.style.zIndex = '2000';
                    modal.style.display = 'flex';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';
                    
                    modal.innerHTML = `
                        <div style="background: #141414; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%; text-align: center;">
                            <h3 style="margin-bottom: 20px;">يجب تسجيل الدخول للمتابعة</h3>
                            <button id="modalGoogleSignIn" class="auth-btn" style="width: 100%; padding: 15px;">
                                <i class="fab fa-google"></i> تسجيل الدخول بحساب Google
                            </button>
                            <button id="closeLoginModal" style="margin-top: 15px; background: #333; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                                إغلاق
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // إضافة مستمعي الأحداث للأزرار الجديدة
                    const googleSignIn = document.getElementById('modalGoogleSignIn');
                    const closeModal = document.getElementById('closeLoginModal');
                    
                    if (googleSignIn) {
                        googleSignIn.addEventListener('click', signInWithGoogle);
                    }
                    
                    if (closeModal) {
                        closeModal.addEventListener('click', () => {
                            modal.remove();
                        });
                    }
                } catch (error) {
                    console.error('خطأ في عرض نافذة تسجيل الدخول:', error);
                }
            }
            
            async function signInWithGoogle() {
                try {
                    // 1. التحقق من توفر Firebase Auth
                    if (!firebase.auth) {
                        throw new Error('Firebase Auth غير معرّف');
                    }

                    // 2. إظهار مؤشر التحميل
                    showLoading();
                    
                    // 3. إنشاء موفر Google وتسجيل الدخول
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await firebase.auth().signInWithPopup(provider);
                    
                    // 4. إخفاء مؤشر التحميل
                    hideLoading();
                    
                    // 5. إغلاق نافذة تسجيل الدخول إن وجدت
                    const modal = document.getElementById('loginModal');
                    if (modal) modal.remove();
                    
                    // 6. عرض رسالة الترحيب
                    showWelcomeToast(result.user);
                    
                    // 7. تحديث حالة المستخدم في الواجهة
                    updateUserProfile(result.user);
                    
                    // 8. تحميل بيانات المستخدم
                    await loadUserData(result.user.uid);
                    
                    // 9. التحقق من صلاحيات الأدمن
                    await checkAdminStatus(result.user.uid);

                } catch (error) {
                    // معالجة الأخطاء بشكل شامل
                    handleAuthError(error);
                }
            }

            // دالة عرض رسالة الترحيب
            function showWelcomeToast(user) {
                try {
                    const welcomeToast = document.getElementById('welcomeToast');
                    const userNameSpan = document.getElementById('userName');
                    
                    if (!welcomeToast || !userNameSpan) {
                        console.warn('عناصر رسالة الترحيب غير موجودة في DOM');
                        return;
                    }
                    
                    // تعيين اسم المستخدم
                    userNameSpan.textContent = user.displayName || 'مستخدم';
                    
                    // إظهار الرسالة مع تأثير
                    welcomeToast.style.display = 'block';
                    welcomeToast.style.animation = 'fadeIn 0.5s ease-in-out';
                    
                    // إخفاء الرسالة بعد 5 ثواني مع تأثير
                    setTimeout(() => {
                        welcomeToast.style.animation = 'fadeOut 0.5s ease-in-out';
                        setTimeout(() => {
                            welcomeToast.style.display = 'none';
                        }, 500);
                    }, 5000);
                } catch (error) {
                    console.error('خطأ في عرض رسالة الترحيب:', error);
                }
            }

            // دالة معالجة أخطاء المصادقة
            function handleAuthError(error) {
                hideLoading();
                
                // تحسين رسائل الخطأ حسب نوع الخطأ
                let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
                
                switch(error.code) {
                    case 'auth/popup-closed-by-user':
                        errorMessage = 'تم إغلاق نافذة التسجيل قبل الإكمال';
                        break;
                    case 'auth/account-exists-with-different-credential':
                        errorMessage = 'هذا البريد مسجل بالفعل بطريقة أخرى';
                        break;
                    case 'auth/auth-domain-config-required':
                        errorMessage = 'مشكلة في إعدادات الدومين';
                        break;
                    default:
                        errorMessage += `: ${error.message}`;
                }
                
                showError(errorMessage);
                
                // تسجيل الخطأ للتحليل
                console.error('تفاصيل الخطأ:', error);
            }

            // دالة التحقق من صلاحيات الأدمن
            async function checkAdminStatus(userId) {
                try {
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists && userDoc.data().isAdmin && elements.adminToggle) {
                        elements.adminToggle.style.display = 'block';
                    }
                } catch (error) {
                    console.error('فشل في التحقق من صلاحيات الأدمن:', error);
                }
            }
            
            function signOut() {
                showLoading();
                auth.signOut()
                    .then(() => {
                        hideLoading();
                    })
                    .catch(error => {
                        hideLoading();
                        showError('حدث خطأ أثناء تسجيل الخروج: ' + error.message);
                    });
            }
            
            function updateUserProfile(user) {
                try {
                    // إظهار زر الملف الشخصي في الشريط العلوي
                    const profileNavItem = document.getElementById('profileNavItem');
                    if (!user) {
                        if (profileNavItem) profileNavItem.style.display = 'none';
                        return;
                    }
                    
                    if (profileNavItem) profileNavItem.style.display = 'block';
                    
                    // تحديث الصورة المصغرة
                    const profileNavImage = document.getElementById('profileNavImage');
                    if (profileNavImage) {
                        profileNavImage.src = user.photoURL || 'https://via.placeholder.com/30';
                    }
                    
                    // تحديث بيانات صفحة الملف الشخصي
                    if (elements.profileName) elements.profileName.textContent = user.displayName || 'مستخدم';
                    if (elements.profileEmail) elements.profileEmail.textContent = user.email || '';
                    
                    // تحديث صورة الملف الشخصي الرئيسية
                    const avatar = document.querySelector('.profile-avatar');
                    if (avatar) {
                        avatar.innerHTML = user.photoURL 
                            ? `<img src="${user.photoURL}" alt="صورة المستخدم">`
                            : '<i class="fas fa-user"></i>';
                    }
                    
                    // إخفاء زر تسجيل الدخول وإظهار زر الخروج
                    if (elements.signInButton) elements.signInButton.style.display = 'none';
                    if (elements.signOutButton) elements.signOutButton.style.display = 'block';
                } catch (error) {
                    console.error('خطأ في تحديث الملف الشخصي:', error);
                }
            }
            
            function resetUserProfile() {
                try {
                    // إخفاء زر الملف الشخصي في الشريط العلوي
                    const profileNavItem = document.getElementById('profileNavItem');
                    if (profileNavItem) profileNavItem.style.display = 'none';
                    
                    // إعادة تعيين صفحة الملف الشخصي
                    if (elements.profileName) elements.profileName.textContent = 'زائر';
                    if (elements.profileEmail) elements.profileEmail.textContent = 'يجب تسجيل الدخول لعرض المعلومات';
                    
                    const avatar = document.querySelector('.profile-avatar');
                    if (avatar) {
                        avatar.innerHTML = '<i class="fas fa-user"></i>';
                    }
                    
                    // إعادة تعيين أزرار التسجيل
                    if (elements.signInButton) elements.signInButton.style.display = 'block';
                    if (elements.signOutButton) elements.signOutButton.style.display = 'none';
                } catch (error) {
                    console.error('خطأ في إعادة تعيين الملف الشخصي:', error);
                }
            }
            
            async function loadUserData(userId) {
                showLoading();
                
                try {
                    // جلب بيانات المستخدم من Firestore
                    const userDoc = await db.collection('users').doc(userId).get();
                    
                    if (userDoc.exists) {
                        // جلب سجل المشاهدة
                        const snapshot = await db.collection('users').doc(userId)
                            .collection('watchHistory')
                            .orderBy('timestamp', 'desc')
                            .limit(10)
                            .get();
                        
                        const watchHistory = [];
                        snapshot.forEach(doc => {
                            watchHistory.push(doc.data());
                        });
                        
                        // عرض سجل المشاهدة
                        renderWatchHistory(watchHistory);
                        
                        // تحديث الإحصائيات
                        if (elements.watchedCount) elements.watchedCount.textContent = watchHistory.length;
                    }
                    
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    showError('حدث خطأ في تحميل بيانات المستخدم: ' + error.message);
                }
            }

            // دالة لعرض المحتوى في الشبكة
            function renderContentGrid(items, elementId) {
                const grid = document.getElementById(elementId);
                if (!grid) return;
                
                grid.innerHTML = '';
                
                items.forEach(item => {
                    const card = createContentCard(item, item.type || 'episode');
                    if (card) grid.appendChild(card);
                });
            }
            
            async function loadInitialData() {
                showLoading();
                
                try {
                    // جلب المسلسلات
                    const seriesSnapshot = await db.collection('series').where('featured', '==', true).limit(10).get();
                    appState.series = seriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // جلب الحلقات
                    const episodesSnapshot = await db.collection('episodes').limit(50).get();
                    appState.episodes = episodesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // جلب الأفلام
                    const moviesSnapshot = await db.collection('movies').where('featured', '==', true).limit(10).get();
                    appState.movies = moviesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // عرض البيانات
                    initHeroSlider();
                    if (elements.seriesGrid) renderSeriesGrid(appState.series, elements.seriesGrid);
                    if (elements.moviesGrid) renderMoviesGrid(appState.movies, elements.moviesGrid);
                    
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    showError('حدث خطأ في تحميل البيانات: ' + error.message);
                }
            }
            
            async function getUserCountry() {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    return data.country || 'Global';
                } catch {
                    return 'Global';
                }
            }
            
            async function loadHomePageSections() {
                try {
                    // Trending Series
                    await loadSectionContent('trendingSeries', 'series', 'trendingSeriesCarousel', true);
                    
                    // Trending Movies
                    await loadSectionContent('trendingMovies', 'movies', 'trendingMoviesCarousel', true);
                    
                    // Featured Series
                    await loadSectionContent('featuredSeries', 'series', 'featuredSeriesCarousel', false, true);
                    
                    // Featured Movies
                    await loadSectionContent('featuredMovies', 'movies', 'featuredMoviesCarousel', false, true);
                    
                    // Box Office
                    await loadSectionContent('boxOffice', 'movies', 'boxOfficeCarousel', false, false, 'boxOffice');
                    
                    // Latest Episodes
                    await loadLatestEpisodes();
                    
                    // Top 10 TV Shows
                    await loadTop10Shows();
                } catch (error) {
                    console.error('خطأ في تحميل أقسام الصفحة الرئيسية:', error);
                }
            }

            // دالة عامة لتحميل المحتوى
            async function loadSectionContent(collection, type, elementId, isTrending = false, isFeatured = false, sortField = 'views') {
                try {
                    let query = db.collection(collection).orderBy(sortField, 'desc').limit(10);
                    const snapshot = await query.get();
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    const carousel = document.getElementById(elementId);
                    if (!carousel) return;
                    
                    carousel.innerHTML = '';
                    
                    items.forEach((item, index) => {
                        const card = createContentCard(item, type);
                        if (!card) return;
                        
                        // إضافة البادجات حسب النوع
                        const thumbnail = card.querySelector('.content-thumbnail');
                        if (!thumbnail) return;
                        
                        if (isTrending) {
                            thumbnail.innerHTML += `
                                <div class="trending-badge">Trending</div>
                            `;
                        }
                        
                        if (isFeatured) {
                            thumbnail.innerHTML += `
                                <div class="trending-badge" style="background-color: #FFD700; color: #000;">Featured</div>
                            `;
                        }
                        
                        if (elementId === 'top10Carousel' && index < 10) {
                            thumbnail.innerHTML += `
                                <div class="top10-badge">${index + 1}</div>
                            `;
                        }
                        
                        carousel.appendChild(card);
                    });
                } catch (error) {
                    console.error(`خطأ في تحميل قسم ${elementId}:`, error);
                }
            }

            // دالة خاصة للحلقات الجديدة
            async function loadLatestEpisodes() {
                try {
                    const snapshot = await db.collection('episodes')
                        .orderBy('releaseDate', 'desc')
                        .limit(10)
                        .get();
                    
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCarousel(items, 'latestEpisodesCarousel', 'episode');
                } catch (error) {
                    console.error('خطأ في تحميل الحلقات الجديدة:', error);
                }
            }

            // دالة خاصة لأعلى 10 مسلسلات
            async function loadTop10Shows() {
                try {
                    // جلب بلد المستخدم
                    const country = await getUserCountry() || 'Global';
                    const top10Title = document.getElementById('top10Title');
                    if (top10Title) top10Title.textContent = `Top 10 TV Shows in ${country}`;
                    
                    const snapshot = await db.collection('series')
                        .where('countries', 'array-contains', country)
                        .orderBy('rating', 'desc')
                        .limit(10)
                        .get();
                    
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCarousel(items, 'top10Carousel', 'series', true);
                } catch (error) {
                    console.error('خطأ في تحميل أعلى 10 مسلسلات:', error);
                }
            }

            // دالة مساعدة لعرض الكاروسيل
            function renderCarousel(items, elementId, type, showBadges = false) {
                try {
                    if (!items || !Array.isArray(items)) {
                        console.error('عناصر الكاروسيل غير صالحة أو غير موجودة');
                        return;
                    }

                    const carousel = document.getElementById(elementId);
                    if (!carousel) {
                        console.error(`لا يمكن العثور على العنصر بالمعرف: ${elementId}`);
                        return;
                    }

                    // تفريغ الكاروسيل بطريقة آمنة
                    while (carousel.firstChild) {
                        carousel.removeChild(carousel.firstChild);
                    }

                    items.slice(0, 20).forEach((item, index) => {
                        if (!item || !item.id) {
                            console.warn('عنصر غير صالح في مصفوفة الكاروسيل', item);
                            return;
                        }

                        const card = createContentCard(item, type);
                        if (!card) {
                            console.warn('فشل في إنشاء بطاقة المحتوى', item);
                            return;
                        }

                        if (showBadges && index < 10) {
                            const thumbnail = card.querySelector('.content-thumbnail');
                            if (thumbnail) {
                                const badge = document.createElement('div');
                                badge.className = 'top10-badge';
                                badge.textContent = index + 1;
                                thumbnail.appendChild(badge);
                            }
                        }

                        carousel.appendChild(card);
                    });

                    if (items.length > 1 && typeof initCarouselEffects === 'function') {
                        initCarouselEffects(carousel);
                    }
                } catch (error) {
                    console.error('حدث خطأ أثناء عرض الكاروسيل:', error);
                    const carousel = document.getElementById(elementId);
                    if (carousel) {
                        carousel.innerHTML = '<p class="error-message">حدث خطأ في عرض المحتوى</p>';
                    }
                }
            }
            
            async function loadAdSettings() {
                try {
                    const doc = await db.collection('settings').doc('ads').get();
                    if (doc.exists) {
                        const settings = doc.data();
                        APP_CONFIG.ADSTERRA_KEY = settings.adsterraKey || '';
                        APP_CONFIG.ADS_ENABLED = true;
                        APP_CONFIG.AD_CPM = settings.cpm || 0.001;
                        
                        // تحديث واجهة المستخدم
                        const adsterraKeyInput = document.getElementById('adsterraKey');
                        if (adsterraKeyInput) adsterraKeyInput.value = settings.adsterraKey || '';
                        
                        const preRollDurationInput = document.getElementById('preRollDuration');
                        if (preRollDurationInput) preRollDurationInput.value = settings.preRollDuration || 5;
                        
                        const midRollEnabledInput = document.getElementById('midRollEnabled');
                        if (midRollEnabledInput) midRollEnabledInput.value = settings.midRollEnabled ? 'true' : 'false';
                        
                        const midRollDurationInput = document.getElementById('midRollDuration');
                        if (midRollDurationInput) midRollDurationInput.value = settings.midRollDuration || 10;
                        
                        const postRollEnabledInput = document.getElementById('postRollEnabled');
                        if (postRollEnabledInput) postRollEnabledInput.value = settings.postRollEnabled ? 'true' : 'false';
                        
                        const postRollDurationInput = document.getElementById('postRollDuration');
                        if (postRollDurationInput) postRollDurationInput.value = settings.postRollDuration || 10;
                        
                        const bannerAdEnabledInput = document.getElementById('bannerAdEnabled');
                        if (bannerAdEnabledInput) bannerAdEnabledInput.value = settings.bannerAdEnabled ? 'true' : 'false';
                        
                        const adCpmInput = document.getElementById('adCpm');
                        if (adCpmInput) adCpmInput.value = settings.cpm || 0.001;
                    }
                } catch (error) {
                    console.error('Error loading ad settings:', error);
                }
            }
            
            function initHeroSlider() {
                try {
                    const featured = [...appState.series, ...appState.movies]
                        .filter(item => item.isFeatured)
                        .sort((a, b) => b.rating - a.rating)
                        .slice(0, 10);
                    
                    const slider = document.createElement('div');
                    slider.className = 'hero-slider';
                    
                    featured.forEach(item => {
                        const slide = document.createElement('div');
                        slide.className = 'hero-slide';
                        slide.style.backgroundImage = `linear-gradient(to right, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%), url('${item.backdrop || item.thumb}')`;
                        
                        slide.innerHTML = `
                            <div class="slide-content">
                                <h1>${item.title}</h1>
                                <div class="slide-meta">
                                    <span>${item.rating} ⭐</span>
                                    <span>${item.year || ''}</span>
                                    <span>${item.genre || ''}</span>
                                </div>
                                <p class="slide-description">${item.description || ''}</p>
                                <div class="slide-actions">
                                    <button class="slide-play-btn" data-id="${item.id}" data-type="${item.number ? 'episode' : item.seriesId ? 'series' : 'movie'}">
                                        <i class="fas fa-play"></i> تشغيل
                                    </button>
                                    <button class="slide-info-btn" data-id="${item.id}" data-type="${item.number ? 'episode' : item.seriesId ? 'series' : 'movie'}">
                                        <i class="fas fa-info-circle"></i> تفاصيل
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        slider.appendChild(slide);
                    });
                    
                    if (elements.heroSlider) {
                        elements.heroSlider.innerHTML = '';
                        elements.heroSlider.appendChild(slider);
                        
                        // تهيئة Slick Slider
                        if (typeof $ === 'function') {
                            $(slider).slick({
                                dots: true,
                                infinite: true,
                                speed: 500,
                                slidesToShow: 1,
                                slidesToScroll: 1,
                                autoplay: true,
                                autoplaySpeed: 5000,
                                rtl: true,
                                arrows: true,
                                fade: true,
                                cssEase: 'linear'
                            });
                        }
                        
                        // إضافة مستمعي الأحداث للأزرار
                        document.querySelectorAll('.slide-play-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const id = this.dataset.id;
                                const type = this.dataset.type;
                                
                                if (type === 'series') {
                                    const series = appState.series.find(s => s.id === id);
                                    if (series) {
                                        const firstEpisode = appState.episodes.find(ep => ep.seriesId === id);
                                        if (firstEpisode) {
                                            playEpisode(firstEpisode);
                                        }
                                    }
                                } else if (type === 'movie') {
                                    const movie = appState.movies.find(m => m.id === id);
                                    if (movie) {
                                        playMovie(movie);
                                    }
                                } else if (type === 'episode') {
                                    const episode = appState.episodes.find(ep => ep.id === id);
                                    if (episode) {
                                        playEpisode(episode);
                                    }
                                }
                            });
                        });
                        
                        document.querySelectorAll('.slide-info-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const id = this.dataset.id;
                                const type = this.dataset.type;
                                
                                if (type === 'series') {
                                    const series = appState.series.find(s => s.id === id);
                                    if (series) {
                                        showSeriesDetails(series);
                                    }
                                } else if (type === 'movie') {
                                    const movie = appState.movies.find(m => m.id === id);
                                    if (movie) {
                                        // يمكنك إضافة صفحة تفاصيل الأفلام هنا
                                    }
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.error('خطأ في تهيئة شريط البطل:', error);
                }
            }
            
            function showSeriesDetails(series) {
                try {
                    // جلب حلقات المسلسل
                    const seriesEpisodes = appState.episodes.filter(ep => ep.seriesId === series.id);
                    
                    // إنشاء صفحة تفاصيل المسلسل
                    const seriesPage = document.getElementById('series-detail-page');
                    if (!seriesPage) return;
                    
                    seriesPage.innerHTML = `
                        <section class="series-detail">
                            <div class="series-backdrop" style="background-image: url('${series.backdrop || series.thumb}')">
                                <div class="backdrop-overlay"></div>
                                <div class="series-poster">
                                    <img src="${series.thumb}" alt="${series.title}">
                                    <button class="play-btn" data-series="${series.id}">
                                        <i class="fas fa-play"></i> تشغيل الحلقة 1
                                    </button>
                                </div>
                                <div class="series-info">
                                    <h1>${series.title}</h1>
                                    <div class="series-meta">
                                        <span>${series.rating} ⭐</span>
                                        <span>${series.year || ''}</span>
                                        <span>${series.genre || ''}</span>
                                        <span>${series.season || 1} مواسم</span>
                                    </div>
                                    <p class="series-description">${series.description || ''}</p>
                                </div>
                            </div>
                            
                            <div class="container">
                                <div class="season-section">
                                    <h2>الموسم ${series.season || 1}</h2>
                                    <div class="episodes-grid" id="episodesGrid"></div>
                                </div>
                                
                                ${series.seasons && series.seasons.length > 1 ? `
                                <div class="other-seasons">
                                    <h2>مواسم أخرى</h2>
                                    <div class="seasons-carousel" id="seasonsCarousel"></div>
                                </div>
                                ` : ''}
                                
                                <div class="related-series">
                                    <h2>مسلسلات مشابهة</h2>
                                    <div class="content-grid" id="relatedSeries"></div>
                                </div>
                            </div>
                        </section>
                    `;
                    
                    // عرض حلقات الموسم الحالي
                    renderEpisodesBySeason(series.id, series.season || 1);
                    
                    // إعداد زر التشغيل
                    const playBtn = document.querySelector('.series-poster .play-btn');
                    if (playBtn) {
                        playBtn.addEventListener('click', function() {
                            const seriesId = this.dataset.series;
                            const firstEpisode = appState.episodes.find(ep => 
                                ep.seriesId === seriesId && ep.season === (series.season || 1)
                            );
                            
                            if (firstEpisode) {
                                playEpisode(firstEpisode);
                            }
                        });
                    }
                    
                    // إخفاء جميع الصفحات وإظهار صفحة التفاصيل
                    if (elements.pages) {
                        Object.values(elements.pages).forEach(page => {
                            if (page) page.classList.remove('active');
                        });
                    }
                    seriesPage.style.display = 'block';
                } catch (error) {
                    console.error('خطأ في عرض تفاصيل المسلسل:', error);
                }
            }
            
            function renderEpisodesBySeason(seriesId, season) {
                try {
                    const episodes = appState.episodes.filter(ep => 
                        ep.seriesId === seriesId && ep.season === season
                    ).sort((a, b) => a.number - b.number);
                    
                    const grid = document.getElementById('episodesGrid');
                    if (!grid) return;
                    
                    grid.innerHTML = '';
                    
                    episodes.forEach(ep => {
                        const card = createContentCard(ep, 'episode');
                        if (card) grid.appendChild(card);
                    });
                } catch (error) {
                    console.error('خطأ في عرض حلقات الموسم:', error);
                }
            }
            
            function renderSeriesGrid(series, gridElement) {
                try {
                    if (!gridElement) return;
                    
                    gridElement.innerHTML = '';
                    
                    series.forEach(ser => {
                        const seriesCard = createContentCard(ser, 'series');
                        if (seriesCard) gridElement.appendChild(seriesCard);
                    });
                } catch (error) {
                    console.error('خطأ في عرض شبكة المسلسلات:', error);
                }
            }
            
            function renderMoviesGrid(movies, gridElement) {
                try {
                    if (!gridElement) return;
                    
                    gridElement.innerHTML = '';
                    
                    movies.forEach(movie => {
                        const movieCard = createContentCard(movie, 'movie');
                        if (movieCard) gridElement.appendChild(movieCard);
                    });
                } catch (error) {
                    console.error('خطأ في عرض شبكة الأفلام:', error);
                }
            }
            
            function renderWatchHistory(items) {
                try {
                    if (!elements.watchHistoryGrid) return;
                    
                    elements.watchHistoryGrid.innerHTML = '';
                    
                    items.forEach(item => {
                        const card = createContentCard(item, item.type || 'episode');
                        if (card) elements.watchHistoryGrid.appendChild(card);
                    });
                } catch (error) {
                    console.error('خطأ في عرض سجل المشاهدة:', error);
                }
            }
            
            function createContentCard(item, type) {
                try {
                    // 1. التحقق من صحة المدخلات
                    if (!item || !item.id) {
                        console.error('بيانات البطاقة غير صالحة');
                        return document.createElement('div');
                    }

                    // 2. إنشاء العناصر الأساسية
                    const card = document.createElement('div');
                    card.className = 'content-card';
                    card.dataset.id = item.id;
                    card.dataset.type = type;
                    
                    // 3. إنشاء صورة المصغرة مع التحقق من وجودها
                    const thumbnail = document.createElement('div');
                    thumbnail.className = type === 'episode' ? 'episode-thumbnail' : 'content-thumbnail';
                    thumbnail.style.backgroundImage = `url('${item.thumb || 'assets/default-thumbnail.jpg'}')`;
                    thumbnail.setAttribute('alt', item.title || 'صورة المحتوى');
                    
                    // 4. إنشاء منطقة المعلومات
                    const info = document.createElement('div');
                    info.className = 'content-info';
                    
                    // 5. إنشاء عنوان المحتوى
                    const title = document.createElement('div');
                    title.className = 'content-title';
                    title.textContent = item.title || 'بدون عنوان';
                    
                    // 6. إنشاء معلومات الميتا
                    const meta = document.createElement('div');
                    meta.className = 'content-meta';
                    
                    // 7. معالجة أنواع المحتوى المختلفة
                    switch(type) {
                        case 'episode':
                            if (item.number) {
                                const episodeNum = document.createElement('div');
                                episodeNum.className = 'episode-number';
                                episodeNum.textContent = item.number;
                                thumbnail.appendChild(episodeNum);
                            }
                            
                            meta.innerHTML = `
                                <span>${item.duration || 24} دقيقة</span>
                                <span>•</span>
                                <span>${item.imdb || '7.5'} <i class="fas fa-star" style="color: #FFD700;"></i></span>
                            `;
                            break;
                            
                        case 'series':
                            meta.innerHTML = `
                                <span>${item.rating || '7.5'} <i class="fas fa-star" style="color: #FFD700;"></i></span>
                                <span>•</span>
                                <span>${item.season || 1} موسم</span>
                            `;
                            break;
                            
                        case 'movie':
                            meta.innerHTML = `
                                <span>${item.duration || 90} دقيقة</span>
                                <span>•</span>
                                <span>${item.imdb || '7.5'} <i class="fas fa-star" style="color: #FFD700;"></i></span>
                            `;
                            break;
                            
                        default:
                            console.warn('نوع المحتوى غير معروف:', type);
                    }
                    
                    // 8. إضافة شارة Free
                    const freeBadge = document.createElement('div');
                    freeBadge.className = 'free-badge';
                    freeBadge.textContent = 'Free';
                    thumbnail.appendChild(freeBadge);
                    
                    // 9. إضافة الإحصائيات
                    const stats = document.createElement('div');
                    stats.className = 'content-stats';
                    stats.innerHTML = `
                        <span><i class="fas fa-eye"></i> ${item.views || 0}</span>
                        <span><i class="fas fa-thumbs-up"></i> ${item.likes || 0}</span>
                    `;
                    
                    // 10. شريط التقدم
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'progress-container';
                    
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    const progressPercent = appState.watchProgress[item.id]?.progress || 0;
                    progressBar.style.width = `${Math.min(Math.max(progressPercent, 0), 100)}%`;
                    progressContainer.appendChild(progressBar);
                    
                    // 11. تجميع العناصر
                    info.append(title, meta, stats, progressContainer);
                    card.append(thumbnail, info);
                    
                    // 12. إضافة حدث النقر
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.interaction-btn')) return;
                        
                        try {
                            switch(type) {
                                case 'episode':
                                    if (typeof playEpisode === 'function') playEpisode(item);
                                    break;
                                case 'series':
                                    if (typeof showSeriesDetails === 'function') showSeriesDetails(item);
                                    break;
                                case 'movie':
                                    if (typeof playMovie === 'function') playMovie(item);
                                    break;
                            }
                        } catch (error) {
                            console.error('خطأ في تنفيذ حدث النقر:', error);
                        }
                    });
                    
                    return card;
                } catch (error) {
                    console.error('خطأ في إنشاء بطاقة المحتوى:', error);
                    return document.createElement('div');
                }
            }
            
            function playEpisode(episode) {
                try {
                    // 1. التحقق من وجود بيانات الحلقة
                    if (!episode || !episode.id || !episode.url) {
                        showError('بيانات الحلقة غير كاملة أو غير صالحة');
                        return;
                    }

                    // 2. تحديث حالة التطبيق
                    appState.currentContent = {
                        type: 'episode',
                        data: episode
                    };
                    
                    // 3. تحديث واجهة المستخدم
                    updateNowPlayingInfo(episode);
                    
                    // 4. إدارة عرض العناصر
                    if (elements.pages) {
                        Object.values(elements.pages).forEach(page => {
                            if (page) page.classList.remove('active');
                        });
                    }
                    
                    if (elements.playerSection) elements.playerSection.style.display = 'block';
                    if (elements.heroSlider) elements.heroSlider.style.display = 'none';
                    
                    // 5. تشغيل الحلقة
                    playContent(episode.url, episode);
                    
                    // 6. إدارة زر "مشاهدة لاحقاً"
                    const watchLaterBtn = document.getElementById('watchLaterBtn');
                    if (appState.currentUser && watchLaterBtn) {
                        db.collection('users').doc(appState.currentUser.uid)
                            .collection('watchLater').doc(episode.id).get()
                            .then(doc => {
                                if (doc.exists) {
                                    watchLaterBtn.classList.add('added');
                                    watchLaterBtn.innerHTML = '<i class="fas fa-check"></i> في قائمتي';
                                } else {
                                    watchLaterBtn.classList.remove('added');
                                    watchLaterBtn.innerHTML = '<i class="far fa-clock"></i> مشاهدة لاحقاً';
                                }
                            })
                            .catch(error => {
                                console.error('خطأ في تحميل حالة المشاهدة لاحقاً:', error);
                                watchLaterBtn.innerHTML = '<i class="far fa-clock"></i> مشاهدة لاحقاً';
                            });
                        
                        // 7. حفظ سجل المشاهدة
                        saveWatchHistory(episode, 'episode');
                    } else if (watchLaterBtn) {
                        watchLaterBtn.classList.remove('added');
                        watchLaterBtn.innerHTML = '<i class="far fa-clock"></i> مشاهدة لاحقاً';
                    }
                    
                    // 8. إدارة زر المفضلة
                    const favouriteBtn = document.getElementById('favouriteBtn');
                    if (appState.currentUser && favouriteBtn) {
                        db.collection('users').doc(appState.currentUser.uid)
                            .collection('favorites').doc(episode.id).get()
                            .then(doc => {
                                if (doc.exists) {
                                    favouriteBtn.classList.add('added');
                                    favouriteBtn.innerHTML = '<i class="fas fa-heart"></i> في المفضلة';
                                } else {
                                    favouriteBtn.classList.remove('added');
                                    favouriteBtn.innerHTML = '<i class="far fa-heart"></i> إضافة للمفضلة';
                                }
                            })
                            .catch(error => {
                                console.error('خطأ في تحميل حالة المفضلة:', error);
                                favouriteBtn.innerHTML = '<i class="far fa-heart"></i> إضافة للمفضلة';
                            });
                    } else if (favouriteBtn) {
                        favouriteBtn.classList.remove('added');
                        favouriteBtn.innerHTML = '<i class="far fa-heart"></i> إضافة للمفضلة';
                    }
                    
                    // 9. إعداد أزرار التفاعل
                    setupInteractionButtons(episode);
                } catch (error) {
                    console.error('خطأ في تشغيل الحلقة:', error);
                    showError('حدث خطأ أثناء تشغيل الحلقة');
                }
            }
            
            function playMovie(movie) {
                try {
                    // 1. التحقق من صحة بيانات الفيلم
                    if (!movie || !movie.id || !movie.url) {
                        showError('بيانات الفيلم غير كاملة أو غير صالحة');
                        return;
                    }

                    // 2. تحديث حالة التطبيق
                    appState.currentContent = {
                        type: 'movie',
                        data: movie
                    };
                    
                    // 3. تحديث واجهة المستخدم
                    updateNowPlayingInfo(movie);
                    
                    // 4. إدارة عرض الصفحات
                    if (elements.pages) {
                        Object.values(elements.pages).forEach(page => {
                            if (page) page.classList.remove('active');
                        });
                    }
                    
                    if (elements.playerSection) elements.playerSection.style.display = 'block';
                    if (elements.heroSlider) elements.heroSlider.style.display = 'none';
                    
                    // 5. تشغيل الفيلم مع التحقق من الرابط
                    if (!movie.url) {
                        showError('لا يوجد رابط تشغيل متاح للفيلم');
                        return;
                    }
                    playContent(movie.url, movie);
                    
                    // 6. إدارة زر "مشاهدة لاحقاً"
                    const watchLaterBtn = document.getElementById('watchLaterBtn');
                    if (appState.currentUser && watchLaterBtn) {
                        db.collection('users').doc(appState.currentUser.uid)
                            .collection('watchLater').doc(movie.id).get()
                            .then(doc => {
                                if (doc.exists) {
                                    watchLaterBtn.classList.add('added');
                                    watchLaterBtn.innerHTML = '<i class="fas fa-check"></i> في قائمتي';
                                } else {
                                    watchLaterBtn.classList.remove('added');
                                    watchLaterBtn.innerHTML = '<i class="far fa-clock"></i> مشاهدة لاحقاً';
                                }
                            })
                            .catch(error => {
                                console.error('خطأ في تحميل حالة المشاهدة لاحقاً:', error);
                                watchLaterBtn.innerHTML = '<i class="far fa-clock"></i> مشاهدة لاحقاً';
                            });
                        
                        // 7. حفظ سجل المشاهدة
                        saveWatchHistory(movie, 'movie');
                    } else if (watchLaterBtn) {
                        watchLaterBtn.classList.remove('added');
                        watchLaterBtn.innerHTML = '<i class="far fa-clock"></i> مشاهدة لاحقاً';
                    }
                    
                    // 8. إدارة زر المفضلة
                    const favouriteBtn = document.getElementById('favouriteBtn');
                    if (appState.currentUser && favouriteBtn) {
                        db.collection('users').doc(appState.currentUser.uid)
                            .collection('favorites').doc(movie.id).get()
                            .then(doc => {
                                if (doc.exists) {
                                    favouriteBtn.classList.add('added');
                                    favouriteBtn.innerHTML = '<i class="fas fa-heart"></i> في المفضلة';
                                } else {
                                    favouriteBtn.classList.remove('added');
                                    favouriteBtn.innerHTML = '<i class="far fa-heart"></i> إضافة للمفضلة';
                                }
                            })
                            .catch(error => {
                                console.error('خطأ في تحميل حالة المفضلة:', error);
                                favouriteBtn.innerHTML = '<i class="far fa-heart"></i> إضافة للمفضلة';
                            });
                    } else if (favouriteBtn) {
                        favouriteBtn.classList.remove('added');
                        favouriteBtn.innerHTML = '<i class="far fa-heart"></i> إضافة للمفضلة';
                    }
                    
                    // 9. إعداد أزرار التفاعل
                    setupInteractionButtons(movie);
                } catch (error) {
                    console.error('خطأ في تشغيل الفيلم:', error);
                    showError('حدث خطأ أثناء تشغيل الفيلم');
                }
            }
            
            function playContent(url, content) {
                try {
                    // 1. التحقق من صحة المدخلات
                    if (!url || typeof url !== 'string') {
                        console.error('رابط الفيديو غير صالح');
                        showError('رابط الفيديو غير صالح');
                        return;
                    }

                    // التحقق من أن الرابط يبدأ بـ http أو https
                    if (!url.match(/^https?:\/\//i)) {
                        showError('رابط الفيديو يجب أن يبدأ بـ http:// أو https://');
                        return;
                    }
                    
                    if (!content || !content.id) {
                        console.error('بيانات المحتوى غير صالحة');
                        return;
                    }

                    // 2. التحقق من وجود مشغل الفيديو
                    if (!elements.videoPlayer) {
                        console.error('عنصر مشغل الفيديو غير موجود');
                        return;
                    }

                    // 3. إعداد وقت البدء
                    const startTime = appState.watchProgress[content.id] 
                        ? Math.max(0, Math.floor(appState.watchProgress[content.id].time)) 
                        : 0;

                    // 7. روابط مباشرة أخرى
                    else {
                        if (!url.startsWith('https://')) {
                            throw new Error('روابط التشغيل يجب أن تكون آمنة (HTTPS)');
                        }
                        elements.videoPlayer.src = url;
                    }

                    // 8. إعداد معالجة الأخطاء لمشغل الفيديو
                    elements.videoPlayer.onerror = () => {
                        console.error('حدث خطأ في تحميل الفيديو');
                        showError('حدث خطأ أثناء تحميل الفيديو، يرجى المحاولة لاحقاً');
                    };

                    // 9. إدارة الإعلانات
                    if (APP_CONFIG.ADS_ENABLED && AD_SETTINGS.preRoll.enabled) {
                        showAd('pre-roll', AD_SETTINGS.preRoll.duration);
                    } else if (elements.nowPlayingInfo) {
                        elements.nowPlayingInfo.style.display = 'block';
                        trackProgress(content);
                    }

                    // 10. تسجيل حدث التشغيل
                    logPlayEvent(content);

                } catch (error) {
                    console.error('حدث خطأ في تشغيل المحتوى:', error);
                    showError('عذراً، لا يمكن تشغيل هذا المحتوى');
                    if (elements.videoPlayer) elements.videoPlayer.src = '';
                }
            }

            // دالة مساعدة لتسجيل أحداث التشغيل
            function logPlayEvent(content) {
                try {
                    if (typeof analytics !== 'undefined') {
                        analytics.track('play', {
                            content_id: content.id,
                            content_type: content.type,
                            title: content.title
                        });
                    }
                } catch (error) {
                    console.error('خطأ في تسجيل حدث التشغيل:', error);
                }
            }
            
            function updateNowPlayingInfo(content) {
                try {
                    if (elements.nowPlayingTitle) elements.nowPlayingTitle.textContent = content.title;
                    if (elements.nowPlayingNumber) elements.nowPlayingNumber.textContent = content.number ? `الحلقة ${content.number}` : '';
                    if (elements.nowPlayingDuration) elements.nowPlayingDuration.textContent = content.duration ? `${content.duration} دقيقة` : '';
                    if (elements.viewsCount) elements.viewsCount.textContent = content.views || 0;
                    if (elements.likesCount) elements.likesCount.textContent = content.likes || 0;
                    if (elements.dislikesCount) elements.dislikesCount.textContent = content.dislikes || 0;
                    if (elements.imdbRating) elements.imdbRating.textContent = content.imdb || '7.5';
                    
                    if (elements.nowPlayingInfo) elements.nowPlayingInfo.style.display = 'block';
                    
                    // إعداد أزرار التفاعل
                    setupInteractionButtons(content);
                } catch (error) {
                    console.error('خطأ في تحديث معلومات التشغيل:', error);
                }
            }
            
            function setupInteractionButtons(content) {
                try {
                    const likesStat = document.getElementById('likesStat');
                    const dislikesStat = document.getElementById('dislikesStat');
                    
                    if (likesStat) {
                        likesStat.onclick = function() {
                            content.likes = (content.likes || 0) + 1;
                            updateNowPlayingInfo(content);
                            saveContentInteraction(content, 'like');
                        };
                    }
                    
                    if (dislikesStat) {
                        dislikesStat.onclick = function() {
                            content.dislikes = (content.dislikes || 0) + 1;
                            updateNowPlayingInfo(content);
                            saveContentInteraction(content, 'dislike');
                        };
                    }   
    
                }     
    
           }
            
            
            
            function trackProgress(content) {
                try {
                    // تنظيف أي مؤقتات سابقة
                    clearProgressIntervals();
                    
                    // في تطبيق حقيقي، ستحتاج إلى استخدام واجهة برمجة تطبيقات مشغل الفيديو
                    // لتتبع التقدم الفعلي للمشاهدة
                    
                    // هذا مثال مبسط يستخدم مؤقتًا
                    const duration = content.duration ? content.duration * 60 : 600; // تحويل الدقائق إلى ثواني
                    let progress = appState.watchProgress[content.id]?.progress || 0;
                    let lastMidRollTime = 0;
                    let lastPostRollTime = 0;
                    
                    const progressInterval = setInterval(() => {
                        progress = Math.min(progress + 0.5, 100);
                        const currentTime = (progress / 100) * duration;
                        
                        appState.watchProgress[content.id] = {
                            progress: progress,
                            time: currentTime,
                            timestamp: new Date().getTime()
                        };
                        
                        // تحديث شريط التقدم
                        const selector = `[data-id="${content.id}"] .progress-bar`;
                        const progressBar = document.querySelector(selector);
                        if (progressBar) {
                            progressBar.style.width = `${progress}%`;
                        }
                        
                        // إظهار إعلان منتصف التشغيل إذا لزم الأمر
                        if (APP_CONFIG.ADS_ENABLED && AD_SETTINGS.midRoll.enabled && 
                            currentTime - lastMidRollTime >= AD_SETTINGS.midRoll.interval && 
                            !content.midRollShown) {
                            showAd('mid-roll', AD_SETTINGS.midRoll.duration);
                            content.midRollShown = true;
                            lastMidRollTime = currentTime;
                        }
                        
                        // إظهار إعلان نهاية التشغيل إذا لزم الأمر
                        if (APP_CONFIG.ADS_ENABLED && AD_SETTINGS.postRoll.enabled && 
                            currentTime - lastPostRollTime >= AD_SETTINGS.postRoll.interval && 
                            !content.postRollShown) {
                            showAd('post-roll', AD_SETTINGS.postRoll.duration);
                            content.postRollShown = true;
                            lastPostRollTime = currentTime;
                        }
                        
                        if (progress >= 100) {
                            clearInterval(progressInterval);
                        }
                    }, 3000);
                    
                    // تخزين المؤقت للتنظيف لاحقاً
                    appState.intervals.push(progressInterval);
                } catch (error) {
                    console.error('خطأ في تتبع التقدم:', error);
                }
            }
            
            // دالة لتنظيف جميع المؤقتات
            function clearProgressIntervals() {
                appState.intervals.forEach(interval => clearInterval(interval));
                appState.intervals = [];
            }
            
            function showAd(adType, duration) {
                try {
                    if (!APP_CONFIG.ADS_ENABLED) {
                        console.log('الإعلانات معطلة في الإعدادات');
                        return;
                    }
                    
                    appState.isShowingAd = true;
                    if (elements.adOverlay) elements.adOverlay.style.display = 'flex';
                    if (elements.adSkip) elements.adSkip.style.display = 'flex';
                    if (elements.nowPlayingInfo) elements.nowPlayingInfo.style.display = 'none';
                    
                    if (elements.adCountdown) {
                        elements.adCountdown.textContent = `الإعلان ينتهي بعد ${duration} ثواني`;
                    }
                    
                    let seconds = duration;
                    const adTimer = setInterval(() => {
                        seconds--;
                        if (elements.adCountdown) {
                            elements.adCountdown.textContent = `الإعلان ينتهي بعد ${seconds} ثواني`;
                        }
                        
                        if (seconds <= 0) {
                            clearInterval(adTimer);
                            hideAd();
                        }
                    }, 1000);
                    
                    // تخزين المؤقت للتنظيف لاحقاً
                    appState.intervals.push(adTimer);
                    
                    // زر تخطي الإعلان
                    if (elements.adSkip) {
                        elements.adSkip.onclick = function() {
                            clearInterval(adTimer);
                            hideAd();
                        };
                    }
                    
                    // تحميل الإعلان
                    loadAd(adType);
                    
                    // تحديث إحصائيات الإعلانات
                    if (adType === 'pre-roll') {
                        appState.adStats.preRollShown++;
                    } else if (adType === 'mid-roll') {
                        appState.adStats.midRollShown++;
                    } else if (adType === 'post-roll') {
                        appState.adStats.postRollShown++;
                    }
                    
                    // حساب الإيرادات
                    appState.adStats.totalRevenue = (
                        (appState.adStats.preRollShown + 
                         appState.adStats.midRollShown + 
                         appState.adStats.postRollShown) * APP_CONFIG.AD_CPM
                    ) / 1000;
                    
                    // حفظ إحصائيات الإعلانات
                    saveAdStats();
                } catch (error) {
                    console.error('خطأ في عرض الإعلان:', error);
                    hideAd();
                }
            }
            
            function hideAd() {
                try {
                    appState.isShowingAd = false;
                    if (elements.adOverlay) elements.adOverlay.style.display = 'none';
                    if (elements.nowPlayingInfo) elements.nowPlayingInfo.style.display = 'block';
                } catch (error) {
                    console.error('خطأ في إخفاء الإعلان:', error);
                }
            }
            
            function loadAd(adType) {
                try {
                    // في تطبيق حقيقي، ستقوم بتحميل إعلان حقيقي هنا
                    if (elements.adContent) {
                        elements.adContent.innerHTML = `
                            <div style="color:white; font-size:1.5rem; text-align:center; width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
                                <div>
                                    <div style="margin-bottom:20px;">إعلان ${adType === 'pre-roll' ? 'ما قبل التشغيل' : adType === 'mid-roll' ? 'منتصف التشغيل' : 'بعد التشغيل'}</div>
                                    <div style="font-size:0.8rem; color:#aaa;">هذا مكان إعلان Adsterra</div>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('خطأ في تحميل الإعلان:', error);
                }
            }
            
            function saveAdStats() {
                try {
                    db.collection('stats').doc('ads').set({
                        preRollCount: appState.adStats.preRollShown,
                        midRollCount: appState.adStats.midRollShown,
                        postRollCount: appState.adStats.postRollShown,
                        bannerAdCount: appState.adStats.bannerShown,
                        totalRevenue: appState.adStats.totalRevenue,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true })
                    .catch(error => {
                        console.error('Error saving ad stats:', error);
                    });
                } catch (error) {
                    console.error('خطأ في حفظ إحصائيات الإعلانات:', error);
                }
            }
            
            function searchContent(query) {
                try {
                    if (!query || !query.trim()) return;
                    
                    showLoading();
                    
                    // البحث في المسلسلات
                    const seriesResults = appState.series.filter(s => 
                        s.title.toLowerCase().includes(query.toLowerCase()) || 
                        (s.description && s.description.toLowerCase().includes(query.toLowerCase()))
                    );
                    
                    // البحث في الأفلام
                    const movieResults = appState.movies.filter(m => 
                        m.title.toLowerCase().includes(query.toLowerCase()) || 
                        (m.description && m.description.toLowerCase().includes(query.toLowerCase()))
                    );
                    
                    // عرض النتائج
                    if (elements.allSeriesGrid && (seriesResults.length > 0 || movieResults.length > 0)) {
                        elements.allSeriesGrid.innerHTML = '';
                        
                        seriesResults.forEach(ser => {
                            const seriesCard = createContentCard(ser, 'series');
                            if (seriesCard) elements.allSeriesGrid.appendChild(seriesCard);
                        });
                        
                        movieResults.forEach(movie => {
                            const movieCard = createContentCard(movie, 'movie');
                            if (movieCard) elements.allSeriesGrid.appendChild(movieCard);
                        });
                        
                        showPage('series');
                    } else {
                        showError('لا توجد نتائج مطابقة للبحث');
                    }
                    
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    console.error('خطأ في البحث:', error);
                }
            }
            
            async function saveWatchHistory(content, type) {
                try {
                    // 1. التحقق من صحة المدخلات
                    if (!appState.currentUser || !appState.currentUser.uid) {
                        console.warn('لا يوجد مستخدم مسجل لحفظ سجل المشاهدة');
                        return;
                    }

                    if (!content || !content.id || typeof type !== 'string') {
                        console.error('بيانات المحتوى غير صالحة للحفظ');
                        return;
                    }

                    // 2. التحقق من أنواع المحتوى المسموح بها
                    const allowedTypes = ['episode', 'movie'];
                    if (!allowedTypes.includes(type)) {
                        console.error('نوع المحتوى غير مدعوم:', type);
                        return;
                    }

                    // 3. إعداد بيانات سجل المشاهدة
                    const watchData = {
                        contentId: content.id,
                        title: content.title || 'بدون عنوان',
                        thumb: content.thumb || 'default-thumbnail.jpg',
                        type: type,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        progress: Math.min(Math.max(appState.watchProgress[content.id]?.progress || 0, 0), 100),
                        duration: content.duration || (type === 'movie' ? 90 : 24),
                        userId: appState.currentUser.uid
                    };

                    // 4. حفظ سجل المشاهدة مع دمج البيانات
                    const userRef = db.collection('users').doc(appState.currentUser.uid);
                    await userRef.collection('watchHistory').doc(content.id).set(watchData, { merge: true });

                    // 5. تحديث إحصائيات المشاهدة
                    const updateData = {
                        views: firebase.firestore.FieldValue.increment(1),
                        lastWatched: firebase.firestore.FieldValue.serverTimestamp(),
                        lastWatchedBy: appState.currentUser.uid
                    };

                    const collectionName = type === 'episode' ? 'episodes' : 'movies';
                    await db.collection(collectionName).doc(content.id).update(updateData);

                    // 6. تحديث حالة التطبيق
                    if (!appState.watchHistory) {
                        appState.watchHistory = {};
                    }
                    appState.watchHistory[content.id] = watchData;

                } catch (error) {
                    console.error('فشل في حفظ سجل المشاهدة:', error);
                    
                    try {
                        await db.collection('errorLogs').add({
                            error: 'Failed to save watch history',
                            contentId: content.id,
                            userId: appState.currentUser?.uid,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            errorDetails: error.message
                        });
                    } catch (logError) {
                        console.error('فشل في تسجيل الخطأ:', logError);
                    }
                }
            }
            
            function saveContentInteraction(content, interactionType) {
                try {
                    if (!appState.currentUser) return;
                    
                    const updateData = {};
                    if (interactionType === 'like') {
                        updateData.likes = firebase.firestore.FieldValue.increment(1);
                    } else if (interactionType === 'dislike') {
                        updateData.dislikes = firebase.firestore.FieldValue.increment(1);
                    }
                    
                    let collectionName = '';
                    if (content.seriesId) {
                        collectionName = 'episodes';
                    } else if (content.number) {
                        collectionName = 'episodes';
                    } else {
                        collectionName = 'movies';
                    }
                    
                    db.collection(collectionName).doc(content.id).update(updateData)
                        .catch(error => {
                            console.error('Error saving interaction:', error);
                        });
                } catch (error) {
                    console.error('خطأ في حفظ تفاعل المحتوى:', error);
                }
            }
            
            async function toggleAdminPanel() {
                try {
                    // 1. التحقق من وجود مستخدم مسجل أولاً
                    if (!appState.currentUser) {
                        showLoginModal();
                        return;
                    }

                    // 2. جلب بيانات المستخدم من Firestore
                    const userDoc = await db.collection('users').doc(appState.currentUser.uid).get();
                    
                    // 3. التحقق من وجود المستند وبياناته
                    if (!userDoc.exists) {
                        throw new Error('بيانات المستخدم غير موجودة');
                    }

                    const userData = userDoc.data();

                    // 4. التحقق من صلاحية الأدمن
                    if (!userData.isAdmin) {
                        throw new Error('ليست لديك صلاحيات الأدمن');
                    }

                    // 5. تبديل حالة لوحة الإدارة
                    const isVisible = elements.adminPanel && elements.adminPanel.style.display === 'block';
                    if (elements.adminPanel) {
                        elements.adminPanel.style.display = isVisible ? 'none' : 'block';
                    }

                    // 6. تحميل بيانات الأدمن إذا كانت اللوحة ظاهرة
                    if (!isVisible) {
                        await loadAdminData();
                    }

                } catch (error) {
                    console.error('خطأ في لوحة الإدارة:', error);
                    showError(error.message);
                }
            }
            
            async function loadAdminData() {
                try {
                    // جلب أحدث الإحصائيات
                    const statsDoc = await db.collection('stats').doc('views').get();
                    if (statsDoc.exists) {
                        const stats = statsDoc.data();
                        
                        const totalViews = document.getElementById('totalViews');
                        if (totalViews) totalViews.textContent = stats.totalViews || 0;
                        
                        const totalLikes = document.getElementById('totalLikes');
                        if (totalLikes) totalLikes.textContent = stats.totalLikes || 0;
                        
                        const totalDislikes = document.getElementById('totalDislikes');
                        if (totalDislikes) totalDislikes.textContent = stats.totalDislikes || 0;
                        
                        const topEpisode = document.getElementById('topEpisode');
                        if (topEpisode) topEpisode.textContent = stats.topEpisode || '-';
                        
                        const topMovie = document.getElementById('topMovie');
                        if (topMovie) topMovie.textContent = stats.topMovie || '-';
                        
                        const avgWatchTime = document.getElementById('avgWatchTime');
                        if (avgWatchTime) avgWatchTime.textContent = stats.avgWatchTime || 0;
                    }
                    
                    // جلب إحصائيات الإعلانات
                    const adsDoc = await db.collection('stats').doc('ads').get();
                    if (adsDoc.exists) {
                        const stats = adsDoc.data();
                        
                        const totalAdRevenue = document.getElementById('totalAdRevenue');
                        if (totalAdRevenue) totalAdRevenue.textContent = stats.totalRevenue?.toFixed(2) || '0';
                        
                        const preRollCount = document.getElementById('preRollCount');
                        if (preRollCount) preRollCount.textContent = stats.preRollCount || 0;
                        
                        const midRollCount = document.getElementById('midRollCount');
                        if (midRollCount) midRollCount.textContent = stats.midRollCount || 0;
                        
                        const postRollCount = document.getElementById('postRollCount');
                        if (postRollCount) postRollCount.textContent = stats.postRollCount || 0;
                        
                        const bannerAdCount = document.getElementById('bannerAdCount');
                        if (bannerAdCount) bannerAdCount.textContent = stats.bannerAdCount || 0;
                    }
                    
                    // جلب قائمة المسلسلات
                    const seriesSnapshot = await db.collection('series').orderBy('title').get();
                    const seriesList = document.getElementById('seriesList');
                    if (seriesList) {
                        seriesList.innerHTML = '';
                        
                        seriesSnapshot.forEach(doc => {
                            const series = doc.data();
                            const item = createAdminListItem(series, doc.id, 'series');
                            if (item) seriesList.appendChild(item);
                        });
                    }
                    
                    // جلب قائمة الأفلام
                    const moviesSnapshot = await db.collection('movies').orderBy('title').get();
                    const moviesList = document.getElementById('moviesList');
                    if (moviesList) {
                        moviesList.innerHTML = '';
                        
                        moviesSnapshot.forEach(doc => {
                            const movie = doc.data();
                            const item = createAdminListItem(movie, doc.id, 'movie');
                            if (item) moviesList.appendChild(item);
                        });
                    }
                    
                    // جلب خيارات المسلسلات للحلقات
                    const seriesOptions = await db.collection('series').orderBy('title').get();
                    const select = document.getElementById('episodeSeries');
                    if (select) {
                        select.innerHTML = '<option value="">اختر مسلسل...</option>';
                        
                        seriesOptions.forEach(doc => {
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = doc.data().title;
                            select.appendChild(option);
                        });
                    }
                    
                    // جلب قائمة الحلقات
                    await loadEpisodesList();
                } catch (error) {
                    console.error('خطأ في تحميل بيانات الأدمن:', error);
                    showError('حدث خطأ في تحميل بيانات الأدمن');
                }
            }
            
            async function loadEpisodesList() {
                try {
                    const snapshot = await db.collection('episodes').orderBy('seriesId').orderBy('season').orderBy('number').get();
                    const episodesList = document.getElementById('episodesList');
                    if (episodesList) {
                        episodesList.innerHTML = '';
                        
                        snapshot.forEach(doc => {
                            const episode = doc.data();
                            const item = createAdminListItem(episode, doc.id, 'episode');
                            if (item) episodesList.appendChild(item);
                        });
                    }
                } catch (error) {
                    console.error('خطأ في تحميل قائمة الحلقات:', error);
                }
            }
            
            function createAdminListItem(item, id, type) {
                try {
                    const listItem = document.createElement('div');
                    listItem.className = 'admin-list-item';
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'admin-item-info';
                    
                    const thumbImg = document.createElement('img');
                    thumbImg.className = 'admin-item-thumb';
                    thumbImg.src = item.thumb || 'https://via.placeholder.com/80x120?text=No+Image';
                    thumbImg.alt = item.title;
                    
                    const detailsDiv = document.createElement('div');
                    detailsDiv.innerHTML = `
                        <div style="font-weight: bold;">${item.title}</div>
                        <div style="font-size: 0.8rem; color: #ccc; margin-top: 5px;">
                            ${type === 'episode' ? `الحلقة ${item.number} - الموسم ${item.season}` : ''}
                            ${type === 'movie' ? `فيلم - ${item.duration || 90} دقيقة` : ''}
                            ${type === 'series' ? `مسلسل - ${item.season || 1} مواسم` : ''}
                        </div>
                        <div style="font-size: 0.8rem; color: #ccc; margin-top: 5px;">
                            المشاهدات: ${item.views || 0} | الإعجابات: ${item.likes || 0}
                        </div>
                    `;
                    
                    infoDiv.appendChild(thumbImg);
                    infoDiv.appendChild(detailsDiv);
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'admin-item-actions';
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'admin-btn edit-btn';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i> تعديل';
                    editBtn.onclick = () => editItem(id, type);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'admin-btn delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i> حذف';
                    deleteBtn.onclick = () => deleteItem(id, type);
                    
                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(deleteBtn);
                    
                    listItem.appendChild(infoDiv);
                    listItem.appendChild(actionsDiv);
                    
                    return listItem;
                } catch (error) {
                    console.error('خطأ في إنشاء عنصر القائمة:', error);
                    return document.createElement('div');
                }
            }
            
            function editItem(id, type) {
                try {
                    if (type === 'series') {
                        // تحميل بيانات المسلسل في النموذج
                        db.collection('series').doc(id).get()
                            .then(doc => {
                                if (doc.exists) {
                                    const series = doc.data();
                                    
                                    const seriesTitle = document.getElementById('seriesTitle');
                                    if (seriesTitle) seriesTitle.value = series.title;
                                    
                                    const seriesDescription = document.getElementById('seriesDescription');
                                    if (seriesDescription) seriesDescription.value = series.description || '';
                                    
                                    const seriesThumb = document.getElementById('seriesThumb');
                                    if (seriesThumb) seriesThumb.value = series.thumb || '';
                                    
                                    const seriesBackdrop = document.getElementById('seriesBackdrop');
                                    if (seriesBackdrop) seriesBackdrop.value = series.backdrop || '';
                                    
                                    const seriesRating = document.getElementById('seriesRating');
                                    if (seriesRating) seriesRating.value = series.rating || '';
                                    
                                    const seriesGenre = document.getElementById('seriesGenre');
                                    if (seriesGenre) seriesGenre.value = series.genre || '';
                                    
                                    const seriesEpisodes = document.getElementById('seriesEpisodes');
                                    if (seriesEpisodes) seriesEpisodes.value = series.episodes || '';
                                    
                                    const seriesLanguage = document.getElementById('seriesLanguage');
                                    if (seriesLanguage) seriesLanguage.value = series.language || '';
                                    
                                    const seriesCountry = document.getElementById('seriesCountry');
                                    if (seriesCountry) seriesCountry.value = series.country || '';
                                    
                                    const seriesSeason = document.getElementById('seriesSeason');
                                    if (seriesSeason) seriesSeason.value = series.season || 1;
                                    
                                    const seriesStatus = document.getElementById('seriesStatus');
                                    if (seriesStatus) seriesStatus.value = series.status || 'new';
                                    
                                    const seriesFeatured = document.getElementById('seriesFeatured');
                                    if (seriesFeatured) seriesFeatured.value = series.featured ? 'true' : 'false';
                                    
                                    const seriesForm = document.getElementById('seriesForm');
                                    if (seriesForm) seriesForm.style.display = 'block';
                                    
                                    const saveSeries = document.getElementById('saveSeries');
                                    if (saveSeries) saveSeries.dataset.id = id;
                                }
                            });
                    } else if (type === 'episode') {
                        // تحميل بيانات الحلقة في النموذج
                        db.collection('episodes').doc(id).get()
                            .then(doc => {
                                if (doc.exists) {
                                    const episode = doc.data();
                                    
                                    const episodeSeries = document.getElementById('episodeSeries');
                                    if (episodeSeries) episodeSeries.value = episode.seriesId;
                                    
                                    const episodeNumber = document.getElementById('episodeNumber');
                                    if (episodeNumber) episodeNumber.value = episode.number;
                                    
                                    const episodeTitle = document.getElementById('episodeTitle');
                                    if (episodeTitle) episodeTitle.value = episode.title;
                                    
                                    const episodeUrl = document.getElementById('episodeUrl');
                                    if (episodeUrl) episodeUrl.value = episode.url;
                                    
                                    const episodeThumb = document.getElementById('episodeThumb');
                                    if (episodeThumb) episodeThumb.value = episode.thumb;
                                    
                                    const episodeDuration = document.getElementById('episodeDuration');
                                    if (episodeDuration) episodeDuration.value = episode.duration;
                                    
                                    const episodeImdb = document.getElementById('episodeImdb');
                                    if (episodeImdb) episodeImdb.value = episode.imdb;
                                    
                                    const episodeSeason = document.getElementById('episodeSeason');
                                    if (episodeSeason) episodeSeason.value = episode.season;
                                    
                                    const saveEpisode = document.getElementById('saveEpisode');
                                    if (saveEpisode) saveEpisode.dataset.id = id;
                                }
                            });
                    } else if (type === 'movie') {
                        // تحميل بيانات الفيلم في النموذج
                        db.collection('movies').doc(id).get()
                            .then(doc => {
                                if (doc.exists) {
                                    const movie = doc.data();
                                    
                                    const movieTitle = document.getElementById('movieTitle');
                                    if (movieTitle) movieTitle.value = movie.title;
                                    
                                    const movieDescription = document.getElementById('movieDescription');
                                    if (movieDescription) movieDescription.value = movie.description || '';
                                    
                                    const movieUrl = document.getElementById('movieUrl');
                                    if (movieUrl) movieUrl.value = movie.url || '';
                                    
                                    const movieThumb = document.getElementById('movieThumb');
                                    if (movieThumb) movieThumb.value = movie.thumb || '';
                                    
                                    const movieBackdrop = document.getElementById('movieBackdrop');
                                    if (movieBackdrop) movieBackdrop.value = movie.backdrop || '';
                                    
                                    const movieDuration = document.getElementById('movieDuration');
                                    if (movieDuration) movieDuration.value = movie.duration || '';
                                    
                                    const movieImdb = document.getElementById('movieImdb');
                                    if (movieImdb) movieImdb.value = movie.imdb || '';
                                    
                                    const movieFeatured = document.getElementById('movieFeatured');
                                    if (movieFeatured) movieFeatured.value = movie.featured ? 'true' : 'false';
                                    
                                    const movieForm = document.getElementById('movieForm');
                                    if (movieForm) movieForm.style.display = 'block';
                                    
                                    const saveMovie = document.getElementById('saveMovie');
                                    if (saveMovie) saveMovie.dataset.id = id;
                                }
                            });
                    }
                } catch (error) {
                    console.error('خطأ في تحرير العنصر:', error);
                    showError('حدث خطأ أثناء تحميل بيانات العنصر');
                }
            }
            
            async function deleteItem(id, type) {
                try {
                    if (!confirm('هل أنت متأكد من حذف هذا العنصر؟ لا يمكن التراجع عن هذه العملية.')) {
                        return;
                    }

                    showLoading();
                    
                    let collectionName = '';
                    if (type === 'series') {
                        collectionName = 'series';
                    } else if (type === 'episode') {
                        collectionName = 'episodes';
                    } else if (type === 'movie') {
                        collectionName = 'movies';
                    }
                    
                    await db.collection(collectionName).doc(id).delete();
                    
                    hideLoading();
                    showSuccess('تم حذف العنصر بنجاح');
                    loadAdminData(); // تحديث القائمة
                } catch (error) {
                    hideLoading();
                    showError('حدث خطأ أثناء حذف العنصر: ' + error.message);
                }
            }
            
            async function saveSeriesHandler() {
                try {
                    const id = this.dataset.id;
                    const seriesData = {
                        title: document.getElementById('seriesTitle').value,
                        description: document.getElementById('seriesDescription').value,
                        thumb: document.getElementById('seriesThumb').value,
                        backdrop: document.getElementById('seriesBackdrop').value,
                        rating: parseFloat(document.getElementById('seriesRating').value) || 0,
                        genre: document.getElementById('seriesGenre').value,
                        episodes: parseInt(document.getElementById('seriesEpisodes').value) || 0,
                        language: document.getElementById('seriesLanguage').value,
                        country: document.getElementById('seriesCountry').value,
                        season: parseInt(document.getElementById('seriesSeason').value) || 1,
                        status: document.getElementById('seriesStatus').value,
                        featured: document.getElementById('seriesFeatured').value === 'true',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    showLoading();
                    
                    if (id) {
                        // تحديث مسلسل موجود
                        await db.collection('series').doc(id).update(seriesData);
                        showSuccess('تم تحديث المسلسل بنجاح');
                    } else {
                        // إضافة مسلسل جديد
                        seriesData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        seriesData.views = 0;
                        seriesData.likes = 0;
                        seriesData.dislikes = 0;
                        
                        await db.collection('series').add(seriesData);
                        showSuccess('تم إضافة المسلسل بنجاح');
                    }
                    
                    const seriesForm = document.getElementById('seriesForm');
                    if (seriesForm) seriesForm.style.display = 'none';
                    loadAdminData(); // تحديث القائمة
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    showError('حدث خطأ أثناء حفظ المسلسل: ' + error.message);
                }
            }
            
            async function saveEpisodeHandler() {
                try {
                    const id = this.dataset.id;
                    const episodeData = {
                        seriesId: document.getElementById('episodeSeries').value,
                        number: parseInt(document.getElementById('episodeNumber').value) || 1,
                        title: document.getElementById('episodeTitle').value,
                        url: document.getElementById('episodeUrl').value,
                        thumb: document.getElementById('episodeThumb').value,
                        duration: parseInt(document.getElementById('episodeDuration').value) || 24,
                        imdb: parseFloat(document.getElementById('episodeImdb').value) || 0,
                        season: parseInt(document.getElementById('episodeSeason').value) || 1,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (!episodeData.seriesId) {
                        showError('يجب اختيار مسلسل للحلقة');
                        return;
                    }
                    
                    showLoading();
                    
                    if (id) {
                        // تحديث حلقة موجودة
                        await db.collection('episodes').doc(id).update(episodeData);
                        showSuccess('تم تحديث الحلقة بنجاح');
                    } else {
                        // إضافة حلقة جديدة
                        episodeData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        episodeData.views = 0;
                        episodeData.likes = 0;
                        episodeData.dislikes = 0;
                        
                        await db.collection('episodes').add(episodeData);
                        showSuccess('تم إضافة الحلقة بنجاح');
                    }
                    
                    loadEpisodesList(); // تحديث قائمة الحلقات
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    showError('حدث خطأ أثناء حفظ الحلقة: ' + error.message);
                }
            }
            
            async function saveMovieHandler() {
                try {
                    const id = this.dataset.id;
                    const movieData = {
                        title: document.getElementById('movieTitle').value,
                        description: document.getElementById('movieDescription').value,
                        url: document.getElementById('movieUrl').value,
                        thumb: document.getElementById('movieThumb').value,
                        backdrop: document.getElementById('movieBackdrop').value,
                        duration: parseInt(document.getElementById('movieDuration').value) || 90,
                        imdb: parseFloat(document.getElementById('movieImdb').value) || 0,
                        featured: document.getElementById('movieFeatured').value === 'true',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    showLoading();
                    
                    if (id) {
                        // تحديث فيلم موجود
                        await db.collection('movies').doc(id).update(movieData);
                        showSuccess('تم تحديث الفيلم بنجاح');
                    } else {
                        // إضافة فيلم جديد
                        movieData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        movieData.views = 0;
                        movieData.likes = 0;
                        movieData.dislikes = 0;
                        
                        await db.collection('movies').add(movieData);
                        showSuccess('تم إضافة الفيلم بنجاح');
                    }
                    
                    const movieForm = document.getElementById('movieForm');
                    if (movieForm) movieForm.style.display = 'none';
                    loadAdminData(); // تحديث القائمة
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    showError('حدث خطأ أثناء حفظ الفيلم: ' + error.message);
                }
            }
            
            async function saveAdSettings() {
                try {
                    const settings = {
                        adsterraKey: document.getElementById('adsterraKey').value,
                        preRollDuration: parseInt(document.getElementById('preRollDuration').value) || 5,
                        midRollEnabled: document.getElementById('midRollEnabled').value === 'true',
                        midRollDuration: parseInt(document.getElementById('midRollDuration').value) || 10,
                        postRollEnabled: document.getElementById('postRollEnabled').value === 'true',
                        postRollDuration: parseInt(document.getElementById('postRollDuration').value) || 10,
                        bannerAdEnabled: document.getElementById('bannerAdEnabled').value === 'true',
                        cpm: parseFloat(document.getElementById('adCpm').value) || 0.001,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    showLoading();
                    
                    await db.collection('settings').doc('ads').set(settings, { merge: true });
                    
                    // تحديث إعدادات التطبيق
                    APP_CONFIG.ADSTERRA_KEY = settings.adsterraKey;
                    APP_CONFIG.AD_CPM = settings.cpm;
                    AD_SETTINGS.preRoll.enabled = true;
                    AD_SETTINGS.preRoll.duration = settings.preRollDuration;
                    AD_SETTINGS.midRoll.enabled = settings.midRollEnabled;
                    AD_SETTINGS.midRoll.duration = settings.midRollDuration;
                    AD_SETTINGS.postRoll.enabled = settings.postRollEnabled;
                    AD_SETTINGS.postRoll.duration = settings.postRollDuration;
                    AD_SETTINGS.banner.enabled = settings.bannerAdEnabled;
                    AD_SETTINGS.banner.cpm = settings.cpm;
                    
                    hideLoading();
                    showSuccess('تم حفظ إعدادات الإعلانات بنجاح');
                } catch (error) {
                    hideLoading();
                    showError('حدث خطأ أثناء حفظ إعدادات الإعلانات: ' + error.message);
                }
            }
            
            async function saveAppSettings() {
                try {
                    const settings = {
                        siteTitle: document.getElementById('siteTitle').value,
                        siteLogo: document.getElementById('siteLogo').value,
                        channelLogo: document.getElementById('channelLogo').value,
                        primaryColor: document.getElementById('primaryColor').value,
                        siteMode: document.getElementById('siteMode').value,
                        adminPassword: sha256(document.getElementById('adminPassword').value),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    showLoading();
                    
                    await db.collection('settings').doc('app').set(settings, { merge: true });
                    
                    // تحديث إعدادات التطبيق
                    APP_CONFIG.ADMIN_PASSWORD_HASH = settings.adminPassword;
                    
                    // تطبيق التغييرات الفورية
                    document.documentElement.style.setProperty('--primary-color', settings.primaryColor);
                    
                    if (settings.siteMode === 'light') {
                        document.body.classList.add('light-mode');
                    } else {
                        document.body.classList.remove('light-mode');
                    }
                    
                    // تحديث الشعار
                    const logoImg = document.querySelector('.logo-img');
                    if (logoImg) logoImg.src = settings.siteLogo;
                    
                    const channelLogo = document.querySelector('.channel-logo');
                    if (channelLogo) channelLogo.src = settings.channelLogo;
                    
                    hideLoading();
                    showSuccess('تم حفظ إعدادات النظام بنجاح');
                } catch (error) {
                    hideLoading();
                    showError('حدث خطأ أثناء حفظ إعدادات النظام: ' + error.message);
                }
            }
            
            function loadVisitorStats() {
                try {
                    // هذه وظيفة تجميلية فقط في هذا المثال
                    // في تطبيق حقيقي، ستقوم بجلب البيانات من Firebase أو خدمة التحليلات
                    
                    // إحصائيات الزوار
                    const totalVisitors = document.getElementById('totalVisitors');
                    if (totalVisitors) totalVisitors.textContent = '1,245';
                    
                    const newVisitors = document.getElementById('newVisitors');
                    if (newVisitors) newVisitors.textContent = '856';
                    
                    const returningVisitors = document.getElementById('returningVisitors');
                    if (returningVisitors) returningVisitors.textContent = '389';
                    
                    // مصادر الزوار
                    const facebookVisitors = document.getElementById('facebookVisitors');
                    if (facebookVisitors) facebookVisitors.textContent = '420';
                    
                    const facebookPercentage = document.getElementById('facebookPercentage');
                    if (facebookPercentage) facebookPercentage.textContent = '34%';
                    
                    const googleVisitors = document.getElementById('googleVisitors');
                    if (googleVisitors) googleVisitors.textContent = '380';
                    
                    const googlePercentage = document.getElementById('googlePercentage');
                    if (googlePercentage) googlePercentage.textContent = '31%';
                    
                    const youtubeVisitors = document.getElementById('youtubeVisitors');
                    if (youtubeVisitors) youtubeVisitors.textContent = '210';
                    
                    const youtubePercentage = document.getElementById('youtubePercentage');
                    if (youtubePercentage) youtubePercentage.textContent = '17%';
                    
                    const tiktokVisitors = document.getElementById('tiktokVisitors');
                    if (tiktokVisitors) tiktokVisitors.textContent = '120';
                    
                    const tiktokPercentage = document.getElementById('tiktokPercentage');
                    if (tiktokPercentage) tiktokPercentage.textContent = '10%';
                    
                    const instagramVisitors = document.getElementById('instagramVisitors');
                    if (instagramVisitors) instagramVisitors.textContent = '85';
                    
                    const instagramPercentage = document.getElementById('instagramPercentage');
                    if (instagramPercentage) instagramPercentage.textContent = '7%';
                    
                    const otherVisitors = document.getElementById('otherVisitors');
                    if (otherVisitors) otherVisitors.textContent = '30';
                    
                    const otherPercentage = document.getElementById('otherPercentage');
                    if (otherPercentage) otherPercentage.textContent = '2%';
                    
                    // أجهزة الزوار
                    const mobileVisitors = document.getElementById('mobileVisitors');
                    if (mobileVisitors) mobileVisitors.textContent = '720';
                    
                    const mobilePercentage = document.getElementById('mobilePercentage');
                    if (mobilePercentage) mobilePercentage.textContent = '58%';
                    
                    const desktopVisitors = document.getElementById('desktopVisitors');
                    if (desktopVisitors) desktopVisitors.textContent = '380';
                    
                    const desktopPercentage = document.getElementById('desktopPercentage');
                    if (desktopPercentage) desktopPercentage.textContent = '31%';
                    
                    const tabletVisitors = document.getElementById('tabletVisitors');
                    if (tabletVisitors) tabletVisitors.textContent = '120';
                    
                    const tabletPercentage = document.getElementById('tabletPercentage');
                    if (tabletPercentage) tabletPercentage.textContent = '10%';
                    
                    const tvVisitors = document.getElementById('tvVisitors');
                    if (tvVisitors) tvVisitors.textContent = '25';
                    
                    const tvPercentage = document.getElementById('tvPercentage');
                    if (tvPercentage) tvPercentage.textContent = '2%';
                    
                    // تهيئة خريطة الزوار (amCharts)
                    initVisitorMap();
                } catch (error) {
                    console.error('خطأ في تحميل إحصائيات الزوار:', error);
                }
            }
            
            function initVisitorMap() {
                try {
                    // هذا مثال تجميلي فقط
                    const mapElement = document.getElementById('visitorsMap');
                    if (mapElement) {
                        mapElement.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 1.2rem; margin-bottom: 10px;">خريطة تفاعلية للزوار حسب البلدان</div>
                                <div style="font-size: 0.9rem; color: #aaa;">
                                    هذه خريطة تجميلية توضح توزيع الزوار حسب البلدان<br>
                                    في تطبيق حقيقي، ستستخدم مكتبة amCharts لعرض البيانات الفعلية
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('خطأ في تهيئة خريطة الزوار:', error);
                }
            }
            
            function showLoading() {
                if (elements.loadingOverlay) {
                    elements.loadingOverlay.style.display = 'flex';
                }
            }
            
            function hideLoading() {
                if (elements.loadingOverlay) {
                    elements.loadingOverlay.style.display = 'none';
                }
            }
            
            function showError(message) {
                if (elements.errorMessage) {
                    elements.errorMessage.textContent = message;
                    elements.errorMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        if (elements.errorMessage) {
                            elements.errorMessage.style.display = 'none';
                        }
                    }, 5000);
                }
            }
            
            function showSuccess(message) {
                if (elements.successMessage) {
                    elements.successMessage.textContent = message;
                    elements.successMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        if (elements.successMessage) {
                            elements.successMessage.style.display = 'none';
                        }
                    }, 5000);
                }
            }
            
            // تنظيف المؤقتات عند إغلاق الصفحة
            window.addEventListener('beforeunload', () => {
                clearProgressIntervals();
            });
        });
    </script>
    </body>
</html> 
