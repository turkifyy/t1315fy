<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="منصة فيديوهات قصيرة مع استوديو منشئ المحتوى">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>قصير - منصة الفيديوهات القصيرة</title>
    
    <!-- Bootstrap 5.3 RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.webmanifest">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
    
    <style>
    :root {
        --primary-color: #FE2C55;
        --secondary-color: #25F4EE;
        --text-color: #161823;
        --text-secondary: #8A8B91;
        --bg-color: #FFFFFF;
        --card-bg: #FFFFFF;
        --border-color: #E3E3E4;
        --error-color: #FF4757;
        --transition-speed: 0.3s;
    }

    .dark-theme {
        --primary-color: #FE2C55;
        --secondary-color: #25F4EE;
        --text-color: #FFFFFF;
        --text-secondary: #A8A8A8;
        --bg-color: #121212;
        --card-bg: #1E1E1E;
        --border-color: #3D3D3D;
        --error-color: #FF6B81;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Tajawal', sans-serif;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color var(--transition-speed) ease;
    }

    /* Auth Container (Shown before login) */
    .auth-container {
        display: flex;
        min-height: 100vh;
        background-color: var(--bg-color);
    }

    .auth-illustration {
        flex: 1;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    .auth-illustration::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path fill="rgba(255,255,255,0.05)" d="M0,0 L100,0 L100,100 L0,100 Z"></path></svg>');
        background-size: 50px 50px;
        opacity: 0.3;
        transform: rotate(45deg);
    }

    .auth-illustration-content {
        max-width: 500px;
        color: white;
        z-index: 1;
        text-align: center;
    }

    .auth-illustration h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .auth-illustration p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 2rem;
    }

    .auth-illustration img {
        max-width: 80%;
        height: auto;
        margin-top: 2rem;
    }

    .auth-form-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        background-color: var(--card-bg);
    }

    .auth-form-wrapper {
        width: 100%;
        max-width: 400px;
        text-align: center;
    }

    .auth-logo {
        text-align: center;
        margin-bottom: 2rem;
    }

    .auth-logo img {
        height: 50px;
    }

    .auth-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        color: var(--text-color);
    }

    .auth-description {
        color: var(--text-secondary);
        margin-bottom: 2rem;
        font-size: 1rem;
    }

    .auth-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin-bottom: 1rem;
    }

    .auth-btn-google {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        font-size: 1rem;
    }

    .auth-btn-google:hover {
        background-color: var(--bg-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .auth-btn-google i {
        margin-left: 10px;
        color: #4285F4;
        font-size: 1.2rem;
    }

    .auth-error {
        color: var(--error-color);
        font-size: 0.9rem;
        margin-top: 0.5rem;
        display: none;
    }

    .auth-error.show {
        display: block;
    }

    .auth-loading {
        display: none;
        text-align: center;
        margin: 1rem 0;
    }

    .auth-loading.show {
        display: block;
    }

    .auth-loading-spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid var(--primary-color);
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Main App Styles */
    .app-container {
        display: none;
        position: relative;
        max-width: 100vw;
        overflow-x: hidden;
        min-height: 100vh;
        background-color: var(--bg-color);
    }

    /* Header Styles */
    .app-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 15px;
        background-color: var(--card-bg);
        z-index: 1000;
        box-shadow: 0 1px 10px rgba(0, 0, 0, 0.1);
    }

    .header-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background-color 0.2s;
    }

    .header-btn:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .feed-switcher {
        display: flex;
        gap: 20px;
    }

    .feed-tab {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-weight: 500;
        cursor: pointer;
        position: relative;
        padding: 5px 0;
    }

    .feed-tab.active {
        color: var(--text-color);
    }

    .feed-tab.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        left: 0;
        height: 3px;
        background: var(--primary-color);
    }

    /* Main Content Styles */
    .main-content {
        padding-top: 60px;
        padding-bottom: 70px;
        min-height: 100vh;
    }

    .video-feed {
        display: flex;
        flex-direction: column;
    }

    .video-container {
        position: relative;
        width: 100%;
        height: calc(100vh - 130px);
        background: #000;
        overflow: hidden;
    }

    #videoPlayer {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        padding: 15px;
        display: flex;
        flex-direction: column;
        z-index: 10;
    }

    .progress-container {
        width: 100%;
        height: 3px;
        background: rgba(255,255,255,0.3);
        margin-bottom: 10px;
        cursor: pointer;
    }

    #progressBar {
        height: 100%;
        background: var(--primary-color);
        width: 0%;
        transition: width 0.1s;
    }

    .video-info {
        color: white;
        padding: 10px;
    }

    .video-title {
        margin: 0 0 5px 0;
        font-size: 16px;
    }

    .video-author, .video-stats {
        margin: 0;
        font-size: 13px;
        color: #ddd;
    }

    .video-actions {
        display: flex;
        justify-content: flex-end;
        flex-direction: column;
        align-items: flex-end;
        gap: 20px;
        position: absolute;
        right: 15px;
        bottom: 100px;
    }

    .action-btn {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .action-btn i {
        margin-bottom: 5px;
        font-size: 24px;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .action-btn span {
        font-size: 12px;
        color: white;
    }

    .action-btn i.active {
        color: var(--primary-color);
    }

    /* Bottom Navigation */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 70px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        background-color: var(--card-bg);
        border-top: 1px solid var(--border-color);
        z-index: 1000;
    }

    .nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--text-secondary);
        font-size: 0.8rem;
        padding: 5px;
    }

    .nav-btn.active {
        color: var(--primary-color);
    }

    .nav-icon {
        font-size: 1.5rem;
        margin-bottom: 3px;
    }

    .upload-btn {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
        margin-top: -20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    /* Comments Section */
    .comments-section {
        position: fixed;
        bottom: 70px;
        left: 0;
        right: 0;
        height: 40vh;
        background-color: var(--card-bg);
        border-top: 1px solid var(--border-color);
        z-index: 999;
        transform: translateY(100%);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .comments-section.show {
        transform: translateY(0);
    }

    .comment-input-container {
        display: flex;
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    #commentInput {
        flex: 1;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 8px 15px;
        margin-left: 10px;
        background-color: var(--bg-color);
        color: var(--text-color);
    }

    #postCommentBtn {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 8px 15px;
        cursor: pointer;
    }

    .comment-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .comment {
        display: flex;
        margin-bottom: 15px;
    }

    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-left: 10px;
    }

    .comment-content {
        flex: 1;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }

    .comment-author {
        font-weight: bold;
        font-size: 14px;
        color: var(--text-color);
    }

    .comment-time {
        color: var(--text-secondary);
        font-size: 12px;
    }

    .comment-text {
        margin: 0;
        font-size: 14px;
        color: var(--text-color);
    }

    .no-comments {
        text-align: center;
        color: var(--text-secondary);
        padding: 20px 0;
    }

    /* Toast Notifications */
    .toast-message {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        z-index: 1100;
        animation: fadeInOut 3s;
    }

    .toast-message.error {
        background: rgba(255,71,87,0.9);
    }

    @keyframes fadeInOut {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; }
    }

    /* Notification Panel */
    .notification-panel {
        position: fixed;
        top: 60px;
        right: 20px;
        width: 350px;
        max-height: 500px;
        overflow-y: auto;
        background: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: none;
        border: 1px solid var(--border-color);
    }

    .notification-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .notification-header h3 {
        margin: 0;
        font-size: 16px;
        color: var(--text-color);
    }

    .mark-all-read {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 12px;
    }

    .notification-list {
        padding: 0;
    }

    .notification-item {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
    }

    .notification-item.unread {
        background-color: rgba(254, 44, 85, 0.1);
    }

    .notification-item:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .notification-icon {
        margin-left: 10px;
        color: var(--primary-color);
        font-size: 18px;
    }

    .notification-content {
        flex: 1;
    }

    .notification-content h4 {
        margin: 0 0 5px 0;
        font-size: 14px;
        color: var(--text-color);
    }

    .notification-content p {
        margin: 0;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .notification-content small {
        color: var(--text-secondary);
        font-size: 11px;
    }

    .no-notifications {
        text-align: center;
        padding: 20px;
        color: var(--text-secondary);
    }

    /* Connection Banner */
    .connection-banner {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        background-color: #ff4757;
        color: white;
        padding: 10px;
        text-align: center;
        z-index: 1000;
        display: none;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
        .auth-container {
            flex-direction: column;
        }
        
        .auth-illustration {
            padding: 1.5rem;
        }
        
        .auth-form-container {
            padding: 1.5rem;
        }

        .video-container {
            height: calc(100vh - 130px);
        }

        .video-actions {
            bottom: 120px;
        }

        .comments-section {
            height: 50vh;
        }
    }

    @media (max-width: 576px) {
        .auth-illustration h1 {
            font-size: 2rem;
        }
        
        .auth-illustration p {
            font-size: 1rem;
        }

        .feed-tab {
            font-size: 0.9rem;
        }

        .video-title {
            font-size: 14px;
        }

        .video-author, .video-stats {
            font-size: 12px;
        }

        .action-btn i {
            font-size: 20px;
            width: 36px;
            height: 36px;
        }

        .action-btn span {
            font-size: 10px;
        }
    }
    </style>
</head>
<body>
    <!-- Auth Container (Shown before login) -->
    <div class="auth-container" id="authContainer">
        <!-- الجانب الرسومي -->
        <div class="auth-illustration">
            <div class="auth-illustration-content">
                <h1>مرحباً بك في قصير</h1>
                <p>منصة الفيديوهات القصيرة الرائدة في العالم العربي</p>
                <img src="assets/short-video-illustration.svg" alt="Video Illustration">
            </div>
        </div>
        
        <!-- خيارات المصادقة -->
        <div class="auth-form-container">
            <div class="auth-form-wrapper">
                <div class="auth-logo">
                    <img src="assets/logo.svg" alt="قصير">
                </div>
                <h2 class="auth-title">ابدأ رحلتك الآن</h2>
                <p class="auth-description">سجل الدخول أو أنشئ حسابًا للبدء</p>
                
                <!-- زر تسجيل الدخول بجوجل -->
                <button id="googleAuthBtn" class="auth-btn auth-btn-google">
                    <i class="fab fa-google"></i>
                    <span>متابعة باستخدام Google</span>
                </button>
                
                <!-- رابط "نسيت كلمة المرور" -->
                <div class="auth-footer">
                    <button id="forgotPasswordBtn" class="text-btn">نسيت كلمة المرور؟</button>
                </div>
                
                <div id="authError" class="auth-error"></div>
                
                <div id="authLoading" class="auth-loading">
                    <div class="auth-loading-spinner"></div>
                    جاري التحضير...
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container (Hidden before login) -->
    <div class="app-container" id="appContainer">
        <!-- Connection Banner -->
        <div class="connection-banner" id="connectionBanner">
            <i class="fas fa-wifi"></i>
            <span>تم فقدان الاتصال بالإنترنت</span>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Header -->
        <header class="app-header">
            <button class="header-btn" id="searchBtn" aria-label="بحث">
                <i class="fas fa-search"></i>
            </button>
            
            <div class="feed-switcher">
                <button class="feed-tab active" data-feed="forYou">من أجلك</button>
                <button class="feed-tab" data-feed="following">المتابَعون</button>
            </div>
            
            <button class="header-btn" id="themeToggle" aria-label="تبديل الوضع الليلي">
                <i class="fas fa-moon"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Video Feed -->
            <div class="video-feed" id="videoFeed">
                <!-- Video Container -->
                <div class="video-container">
                    <video id="videoPlayer" loop></video>
                    <div class="video-controls">
                        <div class="progress-container">
                            <div id="progressBar"></div>
                        </div>
                        <div class="video-info">
                            <h3 id="videoTitle"></h3>
                            <p id="videoAuthor"></p>
                            <p id="videoStats"></p>
                        </div>
                        <div class="video-actions">
                            <button id="likeBtn" class="action-btn">
                                <i class="far fa-heart"></i>
                                <span id="likeCount">0</span>
                            </button>
                            <button id="commentBtn" class="action-btn">
                                <i class="far fa-comment"></i>
                                <span id="commentCount">0</span>
                            </button>
                            <button id="shareBtn" class="action-btn">
                                <i class="fas fa-share"></i>
                                <span>مشاركة</span>
                            </button>
                            <button id="followBtn" class="action-btn">
                                <i class="fas fa-user-plus"></i>
                                <span>متابعة</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Comments Section -->
        <div id="commentsSection" class="comments-section">
            <div class="comment-input-container">
                <input type="text" id="commentInput" placeholder="أضف تعليقًا..." dir="rtl">
                <button id="postCommentBtn">إرسال</button>
            </div>
            <div id="commentList" class="comment-list">
                <div class="no-comments">لا توجد تعليقات بعد</div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-btn active" id="homeBtn" aria-label="الصفحة الرئيسية">
                <i class="fas fa-home nav-icon"></i>
                <span>الرئيسية</span>
            </a>
            <a href="#" class="nav-btn" id="discoverBtn" aria-label="اكتشف">
                <i class="fas fa-compass nav-icon"></i>
                <span>اكتشف</span>
            </a>
            <button class="upload-btn" id="uploadBtn" aria-label="رفع فيديو">
                <i class="fas fa-plus"></i>
            </button>
            <a href="#" class="nav-btn" id="notificationsBtn" aria-label="الإشعارات">
                <i class="fas fa-bell nav-icon"></i>
                <span>الإشعارات</span>
            </a>
            <a href="#" class="nav-btn" id="profileBtn" aria-label="حسابي">
                <i class="fas fa-user nav-icon"></i>
                <span>حسابي</span>
            </a>
        </nav>

        <!-- Notification Panel -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h3>الإشعارات</h3>
                <button class="mark-all-read" id="markAllReadBtn">تحديد الكل كمقروء</button>
            </div>
            <ul class="notification-list" id="notificationList">
                <li class="no-notifications">لا توجد إشعارات جديدة</li>
            </ul>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgotPasswordModal">
        <div class="auth-modal">
            <button class="close-auth-modal" id="closeForgotModal">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="auth-modal-logo">
                <img src="assets/logo.svg" alt="قصير">
            </div>
            
            <h2 class="auth-modal-title">إعادة تعيين كلمة المرور</h2>
            <p class="auth-modal-description">أدخل بريدك الإلكتروني المرتبط بحساب Google</p>
            
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <input type="email" id="forgotEmail" placeholder="البريد الإلكتروني" required dir="rtl">
                </div>
                <button type="submit" class="auth-btn primary-btn">
                    <span>إرسال رابط التعيين</span>
                </button>
            </form>
            
            <div id="forgotError" class="auth-error"></div>
            <div id="forgotSuccess" class="auth-success"></div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

     <!-- Initialize the app -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDxAsJt7qc0jJgi2k4mvXDGWKY34wGm60k",
                authDomain: "turkify-afa2f.firebaseapp.com",
                projectId: "turkify-afa2f",
                storageBucket: "turkify-afa2f.firebasestorage.app",
                messagingSenderId: "387845497284",
                appId: "1:387845497284:web:ff1d1022e8eac9db374491"
            };
            
            firebase.initializeApp(firebaseConfig);
            
            // Handle Google Authentication
            document.getElementById('googleAuthBtn').addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                document.getElementById('authLoading').style.display = 'flex';
                
                firebase.auth().signInWithPopup(provider)
                    .then((result) => {
                        // User signed in successfully
                        document.getElementById('authContainer').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'block';
                        initApp();
                    })
                    .catch((error) => {
                        document.getElementById('authError').textContent = error.message;
                        document.getElementById('authLoading').style.display = 'none';
                    });
            });
            
            // Handle Forgot Password
            document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
                document.getElementById('forgotPasswordModal').style.display = 'flex';
            });
            
            document.getElementById('closeForgotModal').addEventListener('click', () => {
                document.getElementById('forgotPasswordModal').style.display = 'none';
            });
            
            document.getElementById('forgotPasswordForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('forgotEmail').value;
                
                firebase.auth().sendPasswordResetEmail(email)
                    .then(() => {
                        document.getElementById('forgotSuccess').textContent = 'تم إرسال رابط التعيين إلى بريدك الإلكتروني';
                    })
                    .catch((error) => {
                        document.getElementById('forgotError').textContent = error.message;
                    });
            });
            
            // Check auth state
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    initApp();
                } else {
                    document.getElementById('authContainer').style.display = 'flex';
                    document.getElementById('appContainer').style.display = 'none';
                }
            });
            
            // Initialize app functions
            function initApp() {
                // Load videos and other app functionalities
                console.log('App initialized for user');
            }
            
            // Handle interaction when not logged in
            document.addEventListener('click', (e) => {
                if (e.target.closest('.upload-btn, .like-btn, .comment-btn, .share-btn')) {
                    if (!firebase.auth().currentUser) {
                        e.preventDefault();
                        document.getElementById('authContainer').style.display = 'flex';
                        document.getElementById('appContainer').style.display = 'none';
                    }
                }
            });
        });
    </script>
    <script>
    // App Configuration
const APP_CONFIG = {
    maxRetries: 3,
    retryDelay: 1000,
    pageSize: 5,
    videoBuffer: 2,
    maxVisibleVideos: 5,
    maxVideoDuration: 300, // 5 minutes in seconds
    defaultThumbnail: 'https://via.placeholder.com/300x500/161616/AAAAAA?text=قصير',
    youtubeApiKey: 'AIzaSyDaeQ66IuSda11Mo5Bbte56uG_wOPflNAY',
    tiktokApiKey: 'YOUR_TIKTOK_API_KEY',
    aiEndpoint: 'https://api.example.com/ai',
    maxOfflineVideos: 20,
    notificationInterval: 30000 // 30 seconds
};

// App State
const APP_STATE = {
    currentUser: null,
    videos: [],
    forYouVideos: [],
    followingVideos: [],
    visibleVideos: [],
    likedVideos: [],
    savedVideos: [],
    watchedVideos: [],
    currentVideoIndex: 0,
    isLoading: false,
    videoPlayers: {},
    observers: [],
    hasMoreVideos: true,
    isDarkMode: localStorage.getItem('darkMode') !== 'false',
    muted: true,
    retryCount: 0,
    connectionStatus: 'online',
    userPreferences: {
        videoQuality: 'auto',
        autoplay: true,
        dataSaver: false,
        language: 'ar',
        notificationEnabled: true
    },
    pendingLocalStorageUpdates: {},
    localStorageTimer: null,
    isCreator: false,
    currentTab: 'home',
    currentFeed: 'forYou',
    uploadedVideos: [],
    videoComments: [],
    analyticsData: null,
    currentEditingVideo: null,
    currentCategory: null,
    trendingVideos: [],
    popularCreators: [],
    searchResults: {
        videos: [],
        users: [],
        sounds: []
    },
    notifications: [],
    unseenNotifications: 0,
    notificationTimer: null,
    aiCategories: [],
    aiSentiments: {},
    offlineVideos: [],
    isOfflineMode: false
};

// DOM Elements
const DOM = {
    appContainer: document.getElementById('appContainer'),
    videoFeed: document.getElementById('videoFeed'),
    themeToggle: document.getElementById('themeToggle'),
    authModal: document.getElementById('authModal'),
    importModal: document.getElementById('importModal'),
    profileBtn: document.getElementById('profileBtn'),
    uploadBtn: document.getElementById('uploadBtn'),
    homeBtn: document.getElementById('homeBtn'),
    discoverBtn: document.getElementById('discoverBtn'),
    notificationsBtn: document.getElementById('notificationsBtn'),
    loadMoreBtn: document.getElementById('loadMoreBtn'),
    connectionBanner: document.getElementById('connectionBanner'),
    toastContainer: document.getElementById('toastContainer'),
    searchView: document.getElementById('searchView'),
    searchInput: document.getElementById('searchInput'),
    clearSearch: document.getElementById('clearSearch'),
    cancelSearch: document.getElementById('cancelSearch'),
    searchResults: document.getElementById('searchResults'),
    resultTabs: document.querySelectorAll('.result-tab'),
    discoverView: document.getElementById('discoverView'),
    categoriesContainer: document.getElementById('categoriesGrid'),
    trendingVideos: document.getElementById('trendingVideos'),
    popularCreators: document.getElementById('popularCreators'),
    profileView: document.getElementById('profileView'),
    notificationsView: document.getElementById('notificationsView'),
    watchLaterView: document.getElementById('watchLaterView'),
    feedTabs: document.querySelectorAll('.feed-tab'),
    creatorStudio: document.getElementById('creatorStudio'),
    playerModal: document.getElementById('playerModal'),
    commentsModal: document.getElementById('commentsModal'),
    body: document.body
};

// Initialize the app
function initApp() {
    // Set initial theme
    setTheme(APP_STATE.isDarkMode);
    
    // Initialize Firebase services
    initFirebase();
    
    // Initialize auth state listener
    initAuthStateListener();
    
    // Initialize network monitoring
    initNetworkMonitor();
    
    // Load initial videos
    loadVideos();
    
    // Initialize event listeners
    initEventListeners();
    
    // Initialize service worker for PWA
    initServiceWorker();
    
    // Load user data if already logged in
    if (APP_STATE.currentUser) {
        loadUserData();
    }
    
    // Initialize AI services
    initAIServices();
    
    // Start notification polling
    startNotificationPolling();
}

// Initialize Firebase services
function initFirebase() {
    // Firebase is already initialized in the main script
    // Initialize additional services here if needed
    APP_STATE.db = firebase.firestore();
    APP_STATE.auth = firebase.auth();
    APP_STATE.storage = firebase.storage();
    APP_STATE.messaging = firebase.messaging();
    APP_STATE.functions = firebase.functions();
    
    // Use Firebase emulators in development
    if (window.location.hostname === 'localhost') {
        APP_STATE.db.useEmulator('localhost', 8080);
        APP_STATE.functions.useEmulator('localhost', 5001);
    }
}

// Initialize auth state listener
function initAuthStateListener() {
    APP_STATE.auth.onAuthStateChanged(async (user) => {
        if (user) {
            // User is signed in
            APP_STATE.currentUser = {
                id: user.uid,
                name: user.displayName || 'مستخدم جديد',
                email: user.email,
                avatar: user.photoURL || `https://i.pravatar.cc/150?img=${Math.floor(Math.random() * 70)}`,
                phone: user.phoneNumber,
                emailVerified: user.emailVerified
            };
            
            // Check if user is a creator
            await checkCreatorStatus();
            
            // Load user data
            await loadUserData();
            
            // Update UI
            updateAuthUI();
            
            showToast(`مرحباً ${APP_STATE.currentUser.name}`, 'success');
            
            // Request notification permission
            requestNotificationPermission();
        } else {
            // User is signed out
            APP_STATE.currentUser = null;
            APP_STATE.isCreator = false;
            updateAuthUI();
        }
    });
}

// Check if user is a content creator
async function checkCreatorStatus() {
    if (!APP_STATE.currentUser) return;
    
    try {
        const userDoc = await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            APP_STATE.isCreator = userData.isCreator || false;
            
            // Update UI if user is creator
            if (APP_STATE.isCreator) {
                document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-film"></i>';
                document.getElementById('uploadBtn').setAttribute('aria-label', 'استوديو المنشئ');
            }
        }
    } catch (error) {
        console.error('Error checking creator status:', error);
        showToast('حدث خطأ أثناء تحميل بيانات المستخدم', 'error');
    }
}

// Load user data (preferences, videos, etc.)
async function loadUserData() {
    if (!APP_STATE.currentUser) return;
    
    try {
        // Load user preferences
        const userDoc = await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id).get();
        if (userDoc.exists) {
            const data = userDoc.data();
            APP_STATE.userPreferences = data.preferences || APP_STATE.userPreferences;
            APP_STATE.likedVideos = data.likedVideos || [];
            APP_STATE.savedVideos = data.savedVideos || [];
            APP_STATE.watchedVideos = data.watchedVideos || [];
            
            // Apply preferences
            if (APP_STATE.userPreferences.darkMode !== undefined) {
                setTheme(APP_STATE.userPreferences.darkMode);
            }
            
            // Update language
            if (APP_STATE.userPreferences.language) {
                setLanguage(APP_STATE.userPreferences.language);
            }
        }
        
        // If user is creator, load creator data
        if (APP_STATE.isCreator) {
            await loadCreatorVideos();
            await loadCreatorAnalytics();
        }
        
        // Load saved videos for watch later
        await loadSavedVideos();
        
        // Load offline videos
        await loadOfflineVideos();
        
        // Load notifications
        await loadNotifications();
        
        // Update notification badge
        updateNotificationBadge();
    } catch (error) {
        console.error('Error loading user data:', error);
        showToast('حدث خطأ أثناء تحميل بيانات المستخدم', 'error');
    }
}

// Update UI based on auth state
function updateAuthUI() {
    const profileBtn = document.getElementById('profileBtn');
    if (APP_STATE.currentUser) {
        // User is logged in
        profileBtn.querySelector('span').textContent = 'حسابي';
        
        // Update profile image if available
        if (APP_STATE.currentUser.avatar) {
            profileBtn.innerHTML = `<img src="${APP_STATE.currentUser.avatar}" class="profile-nav-img" alt="Profile">`;
        }
    } else {
        // User is logged out
        profileBtn.innerHTML = '<i class="fas fa-user nav-icon"></i><span>حسابي</span>';
    }
}

// Request notification permission
function requestNotificationPermission() {
    if (!APP_STATE.currentUser || !APP_STATE.userPreferences.notificationEnabled) return;
    
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            console.log('Notification permission granted.');
            // Get FCM token
            getFCMToken();
        }
    });
}

// Get FCM token
function getFCMToken() {
    APP_STATE.messaging.getToken({ vapidKey: 'YOUR_VAPID_KEY' }).then((currentToken) => {
        if (currentToken) {
            // Send token to server
            saveFCMToken(currentToken);
        } else {
            console.log('No registration token available. Request permission to generate one.');
        }
    }).catch((err) => {
        console.log('An error occurred while retrieving token. ', err);
    });
}

// Save FCM token to Firestore
function saveFCMToken(token) {
    if (!APP_STATE.currentUser) return;
    
    APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id).update({
        fcmToken: token,
        fcmTokenUpdated: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(error => {
        console.error('Error saving FCM token:', error);
    });
}

// Start notification polling
function startNotificationPolling() {
    if (APP_STATE.notificationTimer) {
        clearInterval(APP_STATE.notificationTimer);
    }
    
    // Check for new notifications immediately
    checkNewNotifications();
    
    // Then set up interval
    APP_STATE.notificationTimer = setInterval(() => {
        checkNewNotifications();
    }, APP_CONFIG.notificationInterval);
}

// Check for new notifications
async function checkNewNotifications() {
    if (!APP_STATE.currentUser || !navigator.onLine) return;
    
    try {
        const lastSeen = APP_STATE.notifications.length > 0 ? 
            APP_STATE.notifications[0].timestamp : firebase.firestore.Timestamp.fromDate(new Date(0));
        
        const snapshot = await APP_STATE.db.collection('users')
            .doc(APP_STATE.currentUser.id)
            .collection('notifications')
            .where('timestamp', '>', lastSeen)
            .orderBy('timestamp', 'desc')
            .get();
        
        if (!snapshot.empty) {
            const newNotifications = [];
            snapshot.forEach(doc => {
                newNotifications.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            // Add new notifications to the beginning of the array
            APP_STATE.notifications = [...newNotifications, ...APP_STATE.notifications];
            
            // Update unseen count
            APP_STATE.unseenNotifications += newNotifications.length;
            updateNotificationBadge();
            
            // Show notifications to user
            newNotifications.forEach(notification => {
                showNotification(notification);
            });
        }
    } catch (error) {
        console.error('Error checking notifications:', error);
    }
}

// Update notification badge
function updateNotificationBadge() {
    const notificationBtn = document.getElementById('notificationsBtn');
    const badge = notificationBtn.querySelector('.notification-badge') || 
        document.createElement('span');
    
    if (APP_STATE.unseenNotifications > 0) {
        badge.className = 'notification-badge';
        badge.textContent = APP_STATE.unseenNotifications > 9 ? '9+' : APP_STATE.unseenNotifications;
        
        if (!notificationBtn.querySelector('.notification-badge')) {
            notificationBtn.appendChild(badge);
        }
    } else {
        if (notificationBtn.querySelector('.notification-badge')) {
            notificationBtn.removeChild(badge);
        }
    }
}

// Show notification to user
function showNotification(notification) {
    // Show in-app notification
    const toast = document.createElement('div');
    toast.className = 'toast info';
    
    toast.innerHTML = `
        <i class="fas fa-bell toast-icon"></i>
        <span>${notification.message}</span>
        <button class="toast-close" aria-label="إغلاق">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    DOM.toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 5000);
    
    toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    });
    
    // Show browser notification if permission granted
    if (Notification.permission === 'granted' && APP_STATE.userPreferences.notificationEnabled) {
        const notif = new Notification('قصير', {
            body: notification.message,
            icon: '/assets/img/logo.png'
        });
        
        notif.onclick = () => {
            window.focus();
            
            // Handle notification click (e.g., open relevant video)
            if (notification.videoId) {
                openVideoById(notification.videoId);
            }
        };
    }
}

// Load videos from Firestore
async function loadVideos() {
    try {
        if (APP_STATE.isLoading) return;
        
        APP_STATE.isLoading = true;
        showLoading();
        
        // Load different feeds based on current selection
        if (APP_STATE.currentFeed === 'forYou') {
            await loadForYouVideos();
        } else {
            await loadFollowingVideos();
        }
        
        APP_STATE.retryCount = 0;
        APP_STATE.isLoading = false;
        
        if (APP_STATE.videos.length >= APP_CONFIG.pageSize) {
            DOM.loadMoreContainer.style.display = 'flex';
        }
     } catch (error) {
        console.error('Error loading videos:', error);
        showToast('حدث خطأ أثناء تحميل الفيديوهات', 'error');
        APP_STATE.isLoading = false;
        
        // Retry if offline
        if (APP_STATE.connectionStatus === 'offline' && APP_STATE.retryCount < APP_CONFIG.maxRetries) {
            APP_STATE.retryCount++;
            setTimeout(() => loadVideos(), APP_CONFIG.retryDelay);
        }
    }
}

// Load "For You" feed videos
async function loadForYouVideos() {
    let videosQuery = APP_STATE.db.collection('videos')
        .where('isPublic', '==', true)
        .orderBy('createdAt', 'desc')
        .limit(APP_CONFIG.pageSize);
    
    // Filter by category if selected
    if (APP_STATE.currentCategory) {
        videosQuery = videosQuery.where('category', '==', APP_STATE.currentCategory);
    }
    
    const videosSnapshot = await videosQuery.get();
    
    if (videosSnapshot.empty) {
        showError('لا توجد فيديوهات متاحة حالياً');
        return;
    }
    
    APP_STATE.videos = [];
    videosSnapshot.forEach(doc => {
        const videoData = doc.data();
        APP_STATE.videos.push({
            id: doc.id,
            title: videoData.title,
            description: videoData.description,
            videoId: generateVideoId(),
            url: videoData.url,
            author: {
                id: videoData.authorId,
                name: videoData.authorName,
                avatar: videoData.authorAvatar
            },
            likes: videoData.likes,
            comments: videoData.comments,
            views: videoData.views,
            music: videoData.music || "الصوت الأصلي",
            category: videoData.category || "عام",
            duration: videoData.duration || 0,
            thumbnail: videoData.thumbnail || APP_CONFIG.defaultThumbnail,
            createdAt: videoData.createdAt?.toDate() || new Date()
        });
    });
    
    // Apply AI recommendations if available
    if (APP_STATE.currentUser && APP_STATE.aiCategories.length > 0) {
        sortVideosByAIRecommendations();
    }
    
    renderVideos();
}

// Load "Following" feed videos
async function loadFollowingVideos() {
    if (!APP_STATE.currentUser) {
        showAuthModal();
        return;
    }
    
    // Get list of followed users
    const followingSnapshot = await APP_STATE.db.collection('users')
        .doc(APP_STATE.currentUser.id)
        .collection('following')
        .get();
    
    if (followingSnapshot.empty) {
        showEmptyFollowingState();
        return;
    }
    
    const followingIds = followingSnapshot.docs.map(doc => doc.id);
    
    // Get videos from followed users
    let videosQuery = APP_STATE.db.collection('videos')
        .where('authorId', 'in', followingIds)
        .where('isPublic', '==', true)
        .orderBy('createdAt', 'desc')
        .limit(APP_CONFIG.pageSize);
    
    const videosSnapshot = await videosQuery.get();
    
    if (videosSnapshot.empty) {
        showEmptyFollowingState();
        return;
    }
    
    APP_STATE.videos = [];
    videosSnapshot.forEach(doc => {
        const videoData = doc.data();
        APP_STATE.videos.push({
            id: doc.id,
            title: videoData.title,
            description: videoData.description,
            videoId: generateVideoId(),
            url: videoData.url,
            author: {
                id: videoData.authorId,
                name: videoData.authorName,
                avatar: videoData.authorAvatar
            },
            likes: videoData.likes,
            comments: videoData.comments,
            views: videoData.views,
            music: videoData.music || "الصوت الأصلي",
            category: videoData.category || "عام",
            duration: videoData.duration || 0,
            thumbnail: videoData.thumbnail || APP_CONFIG.defaultThumbnail,
            createdAt: videoData.createdAt?.toDate() || new Date()
        });
    });
    
    renderVideos();
}

// Show empty state for following feed
function showEmptyFollowingState() {
    DOM.videoFeed.innerHTML = `
        <div class="empty-state">
            <i class="fas fa-user-friends" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
            <h3>لا توجد فيديوهات متاحة</h3>
            <p>ابدأ بمتابعة بعض المنشئين لرؤية فيديوهاتهم هنا</p>
            <button class="primary-btn" id="discoverCreators">اكتشف منشئين جدد</button>
        </div>
    `;
    
    document.getElementById('discoverCreators').addEventListener('click', () => {
        switchTab('discover');
    });
}

// Sort videos by AI recommendations
function sortVideosByAIRecommendations() {
    if (!APP_STATE.aiCategories || APP_STATE.aiCategories.length === 0) return;
    
    // Sort videos based on user's preferred categories
    APP_STATE.videos.sort((a, b) => {
        const aScore = APP_STATE.aiCategories.includes(a.category) ? 1 : 0;
        const bScore = APP_STATE.aiCategories.includes(b.category) ? 1 : 0;
        return bScore - aScore;
    });
}

// Load more videos
async function loadMoreVideos() {
    try {
        if (APP_STATE.isLoading || !APP_STATE.hasMoreVideos) return;
        
        APP_STATE.isLoading = true;
        DOM.loadMoreBtn.disabled = true;
        DOM.loadMoreBtn.textContent = 'جاري التحميل...';
        
        const lastVideo = APP_STATE.videos[APP_STATE.videos.length - 1];
        const lastVideoDoc = await APP_STATE.db.collection('videos').doc(lastVideo.id).get();
        
        let videosQuery = APP_STATE.db.collection('videos')
            .where('isPublic', '==', true)
            .orderBy('createdAt', 'desc')
            .startAfter(lastVideoDoc)
            .limit(APP_CONFIG.pageSize);
        
        // Filter by category if selected
        if (APP_STATE.currentCategory) {
            videosQuery = videosQuery.where('category', '==', APP_STATE.currentCategory);
        }
        
        const videosSnapshot = await videosQuery.get();
        
        if (videosSnapshot.empty) {
            APP_STATE.hasMoreVideos = false;
            DOM.loadMoreContainer.style.display = 'none';
            return;
        }
        
        const newVideos = [];
        videosSnapshot.forEach(doc => {
            const videoData = doc.data();
            newVideos.push({
                id: doc.id,
                title: videoData.title,
                description: videoData.description,
                videoId: generateVideoId(),
                url: videoData.url,
                author: {
                    id: videoData.authorId,
                    name: videoData.authorName,
                    avatar: videoData.authorAvatar
                },
                likes: videoData.likes,
                comments: videoData.comments,
                views: videoData.views,
                music: videoData.music || "الصوت الأصلي",
                category: videoData.category || "عام",
                duration: videoData.duration || 0,
                thumbnail: videoData.thumbnail || APP_CONFIG.defaultThumbnail,
                createdAt: videoData.createdAt?.toDate() || new Date()
            });
        });
        
        APP_STATE.videos = [...APP_STATE.videos, ...newVideos];
        renderVideos();
        
        APP_STATE.retryCount = 0;
        APP_STATE.isLoading = false;
        DOM.loadMoreBtn.disabled = false;
        DOM.loadMoreBtn.textContent = 'تحميل المزيد';
        
        if (newVideos.length < APP_CONFIG.pageSize) {
            APP_STATE.hasMoreVideos = false;
            DOM.loadMoreContainer.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading more videos:', error);
        DOM.loadMoreBtn.disabled = false;
        DOM.loadMoreBtn.textContent = 'تحميل المزيد';
        APP_STATE.isLoading = false;
        showToast('حدث خطأ أثناء تحميل الفيديوهات', 'error');
    }
}

// Generate random video ID for demo
function generateVideoId() {
    return Math.random().toString(36).substring(2, 15);
}

// Render videos to the feed
function renderVideos() {
    if (APP_STATE.videos.length === 0) {
        showError('لا توجد فيديوهات متاحة حالياً');
        return;
    }
    
    const startIndex = Math.max(0, APP_STATE.currentVideoIndex - 2);
    const endIndex = Math.min(APP_STATE.videos.length, APP_STATE.currentVideoIndex + 3);
    
    const videosToRemove = APP_STATE.visibleVideos.filter(videoId => {
        const videoIndex = APP_STATE.videos.findIndex(v => v.id === videoId);
        return videoIndex < startIndex || videoIndex >= endIndex;
    });
    
    videosToRemove.forEach(videoId => {
        const videoElement = document.querySelector(`.video-item[data-video-id="${videoId}"]`);
        if (videoElement) {
            const iframe = videoElement.querySelector('.video-player');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
            }
            videoElement.remove();
        }
        
        APP_STATE.visibleVideos = APP_STATE.visibleVideos.filter(id => id !== videoId);
    });
    
    for (let i = startIndex; i < endIndex; i++) {
        const video = APP_STATE.videos[i];
        
        if (APP_STATE.visibleVideos.includes(video.id)) continue;
        
        const isLiked = APP_STATE.likedVideos.includes(video.id);
        const isSaved = APP_STATE.savedVideos.includes(video.id);
        
        const videoElement = document.createElement('div');
        videoElement.className = 'video-item';
        videoElement.dataset.videoId = video.id;
        videoElement.dataset.index = i;
        
        videoElement.innerHTML = `
            <div class="video-container">
                <div class="video-wrapper">
                    <div class="video-placeholder">
                        <div class="loading-spinner" style="width: 30px; height: 30px;"></div>
                        <p class="loader-text">جاري تحميل الفيديو...</p>
                    </div>
                    <iframe 
                        src="https://www.youtube.com/embed/${video.videoId}?autoplay=0&mute=1&controls=0&modestbranding=1&rel=0&enablejsapi=1" 
                        class="video-player"
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        loading="lazy"
                        style="display: none;">
                    </iframe>
                </div>
                
                <button class="sound-control" data-video-id="${video.id}">
                    <i class="fas fa-volume-mute"></i>
                </button>
                
                <div class="video-actions">
                    <button class="action-btn like-btn ${isLiked ? 'active' : ''}" data-video-id="${video.id}" aria-label="إعجاب">
                        <div class="action-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <span class="action-text">${formatNumber(video.likes)}</span>
                    </button>
                    <button class="action-btn comment-btn" data-video-id="${video.id}" aria-label="تعليقات">
                        <div class="action-icon">
                            <i class="fas fa-comment"></i>
                        </div>
                        <span class="action-text">${formatNumber(video.comments)}</span>
                    </button>
                    <button class="action-btn save-btn ${isSaved ? 'active' : ''}" data-video-id="${video.id}" aria-label="حفظ">
                        <div class="action-icon">
                            <i class="fas fa-bookmark"></i>
                        </div>
                        <span class="action-text">حفظ</span>
                    </button>
                    <button class="action-btn share-btn" data-video-id="${video.id}" aria-label="مشاركة">
                        <div class="action-icon">
                            <i class="fas fa-share"></i>
                        </div>
                        <span class="action-text">مشاركة</span>
                    </button>
                </div>
                
                <div class="video-info">
                    <div class="video-author">
                        <img src="${video.author.avatar}" alt="${video.author.name}" class="author-avatar" loading="lazy">
                        <span class="author-name">${video.author.name}</span>
                        <button class="follow-btn">متابعة</button>
                    </div>
                    <p class="video-title">${video.title}</p>
                    <div class="video-music">
                        <i class="fas fa-music music-note"></i>
                        <span>${video.music}</span>
                    </div>
                </div>
            </div>
        `;
        
        const nextVideo = document.querySelector(`.video-item[data-index="${i+1}"]`);
        if (nextVideo) {
            DOM.videoFeed.insertBefore(videoElement, nextVideo);
        } else {
            DOM.videoFeed.appendChild(videoElement);
        }
        
        initYouTubePlayer(videoElement, video.videoId);
        
        const likeBtn = videoElement.querySelector('.like-btn');
        const commentBtn = videoElement.querySelector('.comment-btn');
        const saveBtn = videoElement.querySelector('.save-btn');
        const shareBtn = videoElement.querySelector('.share-btn');
        const followBtn = videoElement.querySelector('.follow-btn');
        const soundControl = videoElement.querySelector('.sound-control');
        
        likeBtn.addEventListener('click', () => toggleLike(video.id));
        commentBtn.addEventListener('click', () => showComments(video.id));
        saveBtn.addEventListener('click', () => toggleSave(video.id));
        shareBtn.addEventListener('click', () => shareVideo(video.id));
        followBtn.addEventListener('click', () => followUser(video.author.id));
        soundControl.addEventListener('click', () => toggleSound(video.id));
        
        APP_STATE.visibleVideos.push(video.id);
    }
    
    initIntersectionObserver();
}

// Initialize YouTube player
function initYouTubePlayer(videoElement, videoId) {
    const iframe = videoElement.querySelector('.video-player');
    const placeholder = videoElement.querySelector('.video-placeholder');
    
    iframe.onerror = () => {
        placeholder.innerHTML = `
            <i class="fas fa-exclamation-triangle error-icon"></i>
            <p>تعذر تحميل الفيديو</p>
            <button class="retry-btn" onclick="retryLoadVideo('${videoId}')">إعادة المحاولة</button>
        `;
    };
    
    iframe.onload = () => {
        placeholder.style.display = 'none';
        iframe.style.display = 'block';
        APP_STATE.videoPlayers[videoId] = iframe;
    };
}

// Initialize intersection observer for auto-play
function initIntersectionObserver() {
    APP_STATE.observers.forEach(obs => {
        if (obs.observer) obs.observer.disconnect();
    });
    APP_STATE.observers = [];
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const videoId = entry.target.dataset.videoId;
                const videoIndex = parseInt(entry.target.dataset.index);
                const videoElement = entry.target;
                
                APP_STATE.currentVideoIndex = videoIndex;
                
                document.querySelectorAll('.video-player').forEach(iframe => {
                    if (iframe !== videoElement.querySelector('.video-player')) {
                        iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
                    }
                });
                
                const currentIframe = videoElement.querySelector('.video-player');
                if (currentIframe && currentIframe.contentWindow) {
                    currentIframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
                }
                
                if (!APP_STATE.watchedVideos.includes(videoId)) {
                    APP_STATE.watchedVideos.push(videoId);
                    scheduleLocalStorageUpdate('watchedVideos', APP_STATE.watchedVideos);
                    saveUserPreferences();
                    
                    // Record view in Firestore
                    recordVideoView(videoId);
                }
                
                if (videoIndex >= APP_STATE.videos.length - APP_CONFIG.videoBuffer && 
                    !APP_STATE.isLoading && 
                    APP_STATE.hasMoreVideos) {
                    loadMoreVideos();
                }
            }
        });
    }, { 
        threshold: 0.8,
        rootMargin: '0px 0px 100px 0px'
    });
    
    document.querySelectorAll('.video-item').forEach(item => {
        observer.observe(item);
        APP_STATE.observers.push({ observer, element: item });
    });
}

// Record video view in Firestore
async function recordVideoView(videoId) {
    if (!APP_STATE.currentUser || !navigator.onLine) return;
    
    try {
        const videoRef = APP_STATE.db.collection('videos').doc(videoId);
        
        // Increment view count
        await videoRef.update({
            views: firebase.firestore.FieldValue.increment(1),
            lastViewedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Record view in user's history
        await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id)
            .collection('history')
            .doc(videoId)
            .set({
                videoId: videoId,
                viewedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
        // Update AI recommendations based on view
        updateAIRecommendations(videoId);
    } catch (error) {
        console.error('Error recording view:', error);
    }
}

// Update AI recommendations based on viewed video
async function updateAIRecommendations(videoId) {
    if (!APP_STATE.currentUser || !navigator.onLine) return;
    
    try {
        const videoDoc = await APP_STATE.db.collection('videos').doc(videoId).get();
        if (!videoDoc.exists) return;
        
        const videoData = videoDoc.data();
        const category = videoData.category || 'general';
        
        // Call AI service to update user preferences
        const updateRecommendations = APP_STATE.functions.httpsCallable('updateRecommendations');
        await updateRecommendations({
            userId: APP_STATE.currentUser.id,
            category: category,
            action: 'view'
        });
        
        // Refresh AI categories
        await loadAICategories();
    } catch (error) {
        console.error('Error updating AI recommendations:', error);
    }
}

// Toggle like on a video
async function toggleLike(videoId) {
    if (!APP_STATE.currentUser) {
        showAuthModal();
        return;
    }
    
    const video = APP_STATE.videos.find(v => v.id === videoId);
    if (!video) return;
    
    const likeIndex = APP_STATE.likedVideos.indexOf(videoId);
    const isLiked = likeIndex !== -1;
    
    try {
        const videoRef = APP_STATE.db.collection('videos').doc(videoId);
        const likeRef = videoRef.collection('likes').doc(APP_STATE.currentUser.id);
        
        if (isLiked) {
            // Unlike
            await likeRef.delete();
            await videoRef.update({
                likes: firebase.firestore.FieldValue.increment(-1)
            });
            
            video.likes--;
            APP_STATE.likedVideos.splice(likeIndex, 1);
        } else {
            // Like
            await likeRef.set({
                userId: APP_STATE.currentUser.id,
                likedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await videoRef.update({
                likes: firebase.firestore.FieldValue.increment(1)
            });
            
            video.likes++;
            APP_STATE.likedVideos.push(videoId);
            
            // Update AI recommendations based on like
            updateAIRecommendations(videoId);
        }
        
        // Update UI
        document.querySelectorAll(`.like-btn[data-video-id="${videoId}"]`).forEach(btn => {
            btn.classList.toggle('active', !isLiked);
            btn.querySelector('.action-text').textContent = formatNumber(video.likes);
            btn.querySelector('.action-icon').classList.add('pulse');
            setTimeout(() => {
                btn.querySelector('.action-icon').classList.remove('pulse');
            }, 300);
        });
        
        // Save to localStorage and Firestore
        scheduleLocalStorageUpdate('likedVideos', APP_STATE.likedVideos);
        saveUserPreferences();
        
        // Show notification to creator
        if (!isLiked && video.author.id !== APP_STATE.currentUser.id) {
            await APP_STATE.db.collection('users').doc(video.author.id)
                .collection('notifications')
                .add({
                    message: `${APP_STATE.currentUser.name} أعجب بفيديو "${video.title}"`,
                    type: 'like',
                    videoId: videoId,
                    read: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
        }
    } catch (error) {
        console.error('Error toggling like:', error);
        showToast('حدث خطأ أثناء تسجيل الإعجاب', 'error');
    }
}

// Toggle save video (watch later)
async function toggleSave(videoId) {
    if (!APP_STATE.currentUser) {
        showAuthModal();
        return;
    }
    
    const video = APP_STATE.videos.find(v => v.id === videoId);
    if (!video) return;
    
    const saveIndex = APP_STATE.savedVideos.indexOf(videoId);
    const isSaved = saveIndex !== -1;
    
    try {
        if (isSaved) {
            // Remove from saved
            await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id)
                .collection('savedVideos')
                .doc(videoId)
                .delete();
            
            APP_STATE.savedVideos.splice(saveIndex, 1);
        } else {
            // Add to saved
            await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id)
                .collection('savedVideos')
                .doc(videoId)
                .set({
                    videoId: videoId,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    videoData: {
                        title: video.title,
                        thumbnail: video.thumbnail,
                        author: video.author,
                        views: video.views,
                        likes: video.likes
                    }
                });
            
            APP_STATE.savedVideos.push(videoId);
        }
        
        // Update UI
        document.querySelectorAll(`.save-btn[data-video-id="${videoId}"]`).forEach(btn => {
            btn.classList.toggle('active', !isSaved);
            btn.querySelector('.action-icon').classList.add('pulse');
            setTimeout(() => {
                btn.querySelector('.action-icon').classList.remove('pulse');
            }, 300);
        });
        
        // Save to localStorage and Firestore
        scheduleLocalStorageUpdate('savedVideos', APP_STATE.savedVideos);
        saveUserPreferences();
        
        showToast(isSaved ? 'تمت إزالة الفيديو من المحفوظات' : 'تم حفظ الفيديو للمشاهدة لاحقاً', 'success');
    } catch (error) {
        console.error('Error toggling save:', error);
        showToast('حدث خطأ أثناء حفظ الفيديو', 'error');
    }
}

// Load saved videos (watch later)
async function loadSavedVideos() {
    if (!APP_STATE.currentUser) return;
    
    try {
        const savedSnapshot = await APP_STATE.db.collection('users')
            .doc(APP_STATE.currentUser.id)
            .collection('savedVideos')
            .orderBy('savedAt', 'desc')
            .get();
        
        APP_STATE.savedVideos = [];
        savedSnapshot.forEach(doc => {
            APP_STATE.savedVideos.push(doc.id);
        });
    } catch (error) {
        console.error('Error loading saved videos:', error);
    }
}

// Show watch later view
async function showWatchLaterView() {
    if (!APP_STATE.currentUser) {
        showAuthModal();
        return;
    }
    
    DOM.watchLaterView.innerHTML = `
        <div class="watch-later-header">
            <h2 class="watch-later-title">المشاهدة لاحقاً</h2>
            <button class="text-btn watch-later-clear">مسح الكل</button>
        </div>
        <div class="watch-later-grid" id="watchLaterGrid">
            <!-- Saved videos will be loaded here -->
        </div>
    `;
    
    // Load saved videos from Firestore
    try {
        const savedSnapshot = await APP_STATE.db.collection('users')
            .doc(APP_STATE.currentUser.id)
            .collection('savedVideos')
            .orderBy('savedAt', 'desc')
            .get();
        
        const watchLaterGrid = document.getElementById('watchLaterGrid');
        watchLaterGrid.innerHTML = '';
        
        if (savedSnapshot.empty) {
            watchLaterGrid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                    <i class="fas fa-bookmark" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                    <p>لا توجد فيديوهات محفوظة</p>
                </div>
            `;
            return;
        }
        
        savedSnapshot.forEach(doc => {
            const videoData = doc.data().videoData;
            const videoItem = document.createElement('div');
            videoItem.className = 'watch-later-item';
            videoItem.innerHTML = `
                <img src="${videoData.thumbnail}" class="watch-later-thumbnail" alt="${videoData.title}">
                <div class="watch-later-info">
                    <div class="watch-later-title">${videoData.title}</div>
                    <div class="watch-later-author">
                        <img src="${videoData.author.avatar}" class="author-avatar-small" alt="${videoData.author.name}">
                        <span>${videoData.author.name}</span>
                    </div>
                </div>
                <button class="watch-later-remove" data-video-id="${doc.id}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            videoItem.addEventListener('click', () => {
                openVideoById(doc.id);
            });
            
            watchLaterGrid.appendChild(videoItem);
            
            // Add remove button event
            videoItem.querySelector('.watch-later-remove').addEventListener('click', (e) => {
                e.stopPropagation();
                removeFromWatchLater(doc.id);
            });
        });
    } catch (error) {
        console.error('Error loading watch later videos:', error);
        showToast('حدث خطأ أثناء تحميل الفيديوهات المحفوظة', 'error');
    }
    
    // Add clear all button event
    document.querySelector('.watch-later-clear').addEventListener('click', clearWatchLater);
    
    // Show the view
    DOM.videoFeed.style.display = 'none';
    DOM.discoverView.style.display = 'none';
    DOM.creatorStudio.style.display = 'none';
    DOM.profileView.style.display = 'none';
    DOM.notificationsView.style.display = 'none';
    DOM.watchLaterView.style.display = 'block';
    
    // Update navigation
    DOM.homeBtn.classList.remove('active');
    DOM.discoverBtn.classList.remove('active');
    document.querySelector(`.nav-btn[aria-label="حسابي"]`).classList.remove('active');
}

// Remove video from watch later
async function removeFromWatchLater(videoId) {
    try {
        await APP_STATE.db.collection('users')
            .doc(APP_STATE.currentUser.id)
            .collection('savedVideos')
            .doc(videoId)
            .delete();
        
        // Update UI
        const videoItem = document.querySelector(`.watch-later-item button[data-video-id="${videoId}"]`)?.closest('.watch-later-item');
        if (videoItem) {
            videoItem.classList.add('fade-out');
            setTimeout(() => {
                videoItem.remove();
            }, 300);
        }
        
        // Update state
        const index = APP_STATE.savedVideos.indexOf(videoId);
        if (index !== -1) {
            APP_STATE.savedVideos.splice(index, 1);
        }
        
        // Update save buttons in feed
        document.querySelectorAll(`.save-btn[data-video-id="${videoId}"]`).forEach(btn => {
            btn.classList.remove('active');
        });
        
        showToast('تمت إزالة الفيديو من المحفوظات', 'success');
    } catch (error) {
        console.error('Error removing from watch later:', error);
        showToast('حدث خطأ أثناء إزالة الفيديو', 'error');
    }
}

// Clear all watch later videos
async function clearWatchLater() {
    try {
        const batch = APP_STATE.db.batch();
        const savedRef = APP_STATE.db.collection('users')
            .doc(APP_STATE.currentUser.id)
            .collection('savedVideos');
        
        const snapshot = await savedRef.get();
        snapshot.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        // Update UI
        document.getElementById('watchLaterGrid').innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <i class="fas fa-bookmark" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                <p>لا توجد فيديوهات محفوظة</p>
            </div>
        `;
        
        // Update state
        APP_STATE.savedVideos = [];
        
        // Update save buttons in feed
        document.querySelectorAll('.save-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        showToast('تم مسح جميع الفيديوهات المحفوظة', 'success');
    } catch (error) {
        console.error('Error clearing watch later:', error);
        showToast('حدث خطأ أثناء مسح الفيديوهات المحفوظة', 'error');
    }
}

// Follow a user
async function followUser(userId) {
    if (!APP_STATE.currentUser) {
        showAuthModal();
        return;
    }
    
    if (userId === APP_STATE.currentUser.id) {
        showToast('لا يمكنك متابعة نفسك', 'warning');
        return;
    }
    
    try {
        const followRef = APP_STATE.db.collection('users')
            .doc(userId)
            .collection('followers')
            .doc(APP_STATE.currentUser.id);
        
        const followDoc = await followRef.get();
        
        if (followDoc.exists) {
            // Unfollow
            await followRef.delete();
            showToast('تم إلغاء المتابعة', 'info');
            
            // Update follow button in all videos by this user
            document.querySelectorAll(`.video-author[data-user-id="${userId}"] .follow-btn`).forEach(btn => {
                btn.textContent = 'متابعة';
            });
        } else {
            // Follow
            await followRef.set({
                followerId: APP_STATE.currentUser.id,
                followerName: APP_STATE.currentUser.name,
                followerAvatar: APP_STATE.currentUser.avatar,
                followedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showToast('تمت المتابعة بنجاح', 'success');
            
            // Update follow button in all videos by this user
            document.querySelectorAll(`.video-author[data-user-id="${userId}"] .follow-btn`).forEach(btn => {
                btn.textContent = 'متابَع';
            });
            
            // Send notification to the user being followed
            await APP_STATE.db.collection('users').doc(userId)
                .collection('notifications')
                .add({
                    message: `${APP_STATE.currentUser.name} قام بمتابعتك`,
                    type: 'follow',
                    read: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
              // Update AI recommendations based on follow
            updateAIRecommendations(userId, 'follow');
        }
    } catch (error) {
        console.error('Error following user:', error);
        showToast('حدث خطأ أثناء محاولة المتابعة', 'error');
    }
}

// Show comments for a video
function showComments(videoId) {
    if (!APP_STATE.currentUser) {
        showAuthModal();
        return;
    }
    
    const video = APP_STATE.videos.find(v => v.id === videoId);
    if (!video) return;
    
    // Open comments modal
    openCommentsModal(videoId);
}

// Open comments modal
async function openCommentsModal(videoId) {
    const video = APP_STATE.videos.find(v => v.id === videoId);
    if (!video) return;
    
    DOM.commentsModal.innerHTML = `
        <div class="comments-header">
            <h3 class="comments-title">التعليقات (${formatNumber(video.comments)})</h3>
            <button class="close-comments" id="closeCommentsModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="comments-list" id="commentsList">
            <!-- Comments will be loaded here -->
        </div>
        <div class="comment-input-container">
            <input type="text" class="comment-input" id="commentInput" placeholder="أضف تعليقاً...">
            <button class="comment-submit" id="submitComment">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    `;
    
    // Load comments
    try {
        const commentsSnapshot = await APP_STATE.db.collection('videos')
            .doc(videoId)
            .collection('comments')
            .orderBy('timestamp', 'desc')
            .limit(50)
            .get();
        
        const commentsList = document.getElementById('commentsList');
        commentsList.innerHTML = '';
        
        if (commentsSnapshot.empty) {
            commentsList.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-comment-slash" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                    <p>لا توجد تعليقات حتى الآن</p>
                </div>
            `;
        } else {
            commentsSnapshot.forEach(doc => {
                const comment = doc.data();
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `
                    <img src="${comment.userAvatar || 'https://i.pravatar.cc/150?img=3'}" class="comment-avatar" alt="${comment.userName}">
                    <div class="comment-content">
                        <div class="comment-author">${comment.userName}</div>
                        <p class="comment-text">${comment.text}</p>
                        <div class="comment-actions">
                            <button class="comment-action like-comment" data-comment-id="${doc.id}">
                                <i class="fas fa-heart"></i> ${formatNumber(comment.likes || 0)}
                            </button>
                            <button class="comment-action reply-comment" data-comment-id="${doc.id}">
                                <i class="fas fa-reply"></i> رد
                            </button>
                            ${comment.userId === APP_STATE.currentUser.id ? `
                            <button class="comment-action delete-comment" data-comment-id="${doc.id}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Add like comment event
                commentItem.querySelector('.like-comment').addEventListener('click', () => {
                    likeComment(videoId, doc.id);
                });
                
                // Add delete comment event (if owner)
                if (comment.userId === APP_STATE.currentUser.id) {
                    commentItem.querySelector('.delete-comment').addEventListener('click', () => {
                        deleteComment(videoId, doc.id);
                    });
                }
                
                commentsList.appendChild(commentItem);
            });
        }
    } catch (error) {
        console.error('Error loading comments:', error);
        showToast('حدث خطأ أثناء تحميل التعليقات', 'error');
    }
    
    // Add comment submission event
    document.getElementById('submitComment').addEventListener('click', () => {
        addComment(videoId);
    });
    
    // Add Enter key event for comment input
    document.getElementById('commentInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            addComment(videoId);
        }
    });
    
    // Add close modal event
    document.getElementById('closeCommentsModal').addEventListener('click', closeCommentsModal);
    
    // Show modal
    DOM.commentsModal.classList.add('active');
}

// Add a comment
async function addComment(videoId) {
    const input = document.getElementById('commentInput');
    const text = input.value.trim();
    
    if (!text) {
        showToast('الرجاء إدخال نص التعليق', 'warning');
        return;
    }
    
    try {
        const commentRef = await APP_STATE.db.collection('videos')
            .doc(videoId)
            .collection('comments')
            .add({
                text: text,
                userId: APP_STATE.currentUser.id,
                userName: APP_STATE.currentUser.name,
                userAvatar: APP_STATE.currentUser.avatar,
                likes: 0,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        // Increment comment count
        await APP_STATE.db.collection('videos')
            .doc(videoId)
            .update({
                comments: firebase.firestore.FieldValue.increment(1)
            });
        
        // Update video in state
        const videoIndex = APP_STATE.videos.findIndex(v => v.id === videoId);
        if (videoIndex !== -1) {
            APP_STATE.videos[videoIndex].comments++;
            
            // Update comment count in UI
            document.querySelectorAll(`.comment-btn[data-video-id="${videoId}"] .action-text`).forEach(span => {
                span.textContent = formatNumber(APP_STATE.videos[videoIndex].comments);
            });
        }
        
        // Clear input
        input.value = '';
        
        // Show success message
        showToast('تم إضافة التعليق بنجاح', 'success');
        
        // Send notification to video author
        const video = APP_STATE.videos.find(v => v.id === videoId);
        if (video && video.author.id !== APP_STATE.currentUser.id) {
            await APP_STATE.db.collection('users')
                .doc(video.author.id)
                .collection('notifications')
                .add({
                    message: `${APP_STATE.currentUser.name} علّق على فيديوك "${video.title}"`,
                    type: 'comment',
                    videoId: videoId,
                    commentId: commentRef.id,
                    read: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
        }
        
        // Reload comments
        openCommentsModal(videoId);
    } catch (error) {
        console.error('Error adding comment:', error);
        showToast('حدث خطأ أثناء إضافة التعليق', 'error');
    }
}

// Like a comment
async function likeComment(videoId, commentId) {
    if (!APP_STATE.currentUser) {
        showAuthModal();
        return;
    }
    
    try {
        const likeRef = APP_STATE.db.collection('videos')
            .doc(videoId)
            .collection('comments')
            .doc(commentId)
            .collection('likes')
            .doc(APP_STATE.currentUser.id);
        
        const likeDoc = await likeRef.get();
        
        if (likeDoc.exists) {
            // Unlike
            await likeRef.delete();
            await APP_STATE.db.collection('videos')
                .doc(videoId)
                .collection('comments')
                .doc(commentId)
                .update({
                    likes: firebase.firestore.FieldValue.increment(-1)
                });
            
            // Update UI
            const likeBtn = document.querySelector(`.like-comment[data-comment-id="${commentId}"]`);
            if (likeBtn) {
                const icon = likeBtn.querySelector('i');
                const count = parseInt(likeBtn.textContent.trim().split(' ')[0]) || 0;
                likeBtn.innerHTML = `<i class="fas fa-heart"></i> ${formatNumber(count - 1)}`;
                likeBtn.classList.remove('active');
            }
        } else {
            // Like
            await likeRef.set({
                userId: APP_STATE.currentUser.id,
                likedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await APP_STATE.db.collection('videos')
                .doc(videoId)
                .collection('comments')
                .doc(commentId)
                .update({
                    likes: firebase.firestore.FieldValue.increment(1)
                });
            
            // Update UI
            const likeBtn = document.querySelector(`.like-comment[data-comment-id="${commentId}"]`);
            if (likeBtn) {
                const icon = likeBtn.querySelector('i');
                const count = parseInt(likeBtn.textContent.trim().split(' ')[0]) || 0;
                likeBtn.innerHTML = `<i class="fas fa-heart"></i> ${formatNumber(count + 1)}`;
                likeBtn.classList.add('active');
            }
            
            // Send notification to comment author
            const commentDoc = await APP_STATE.db.collection('videos')
                .doc(videoId)
                .collection('comments')
                .doc(commentId)
                .get();
            
            if (commentDoc.exists) {
                const comment = commentDoc.data();
                if (comment.userId !== APP_STATE.currentUser.id) {
                    await APP_STATE.db.collection('users')
                        .doc(comment.userId)
                        .collection('notifications')
                        .add({
                            message: `${APP_STATE.currentUser.name} أعجب بتعليقك`,
                            type: 'commentLike',
                            videoId: videoId,
                            commentId: commentId,
                            read: false,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                }
            }
        }
    } catch (error) {
        console.error('Error liking comment:', error);
        showToast('حدث خطأ أثناء تسجيل الإعجاب بالتعليق', 'error');
    }
}

// Delete a comment
async function deleteComment(videoId, commentId) {
    try {
        // Delete comment
        await APP_STATE.db.collection('videos')
            .doc(videoId)
            .collection('comments')
            .doc(commentId)
            .delete();
        
        // Decrement comment count
        await APP_STATE.db.collection('videos')
            .doc(videoId)
            .update({
                comments: firebase.firestore.FieldValue.increment(-1)
            });
        
        // Update video in state
        const videoIndex = APP_STATE.videos.findIndex(v => v.id === videoId);
        if (videoIndex !== -1) {
            APP_STATE.videos[videoIndex].comments--;
            
            // Update comment count in UI
            document.querySelectorAll(`.comment-btn[data-video-id="${videoId}"] .action-text`).forEach(span => {
                span.textContent = formatNumber(APP_STATE.videos[videoIndex].comments);
            });
        }
        
        // Remove comment from UI
        const commentItem = document.querySelector(`.comment-item button[data-comment-id="${commentId}"]`)?.closest('.comment-item');
        if (commentItem) {
            commentItem.classList.add('fade-out');
            setTimeout(() => {
                commentItem.remove();
            }, 300);
        }
        
        showToast('تم حذف التعليق بنجاح', 'success');
    } catch (error) {
        console.error('Error deleting comment:', error);
        showToast('حدث خطأ أثناء حذف التعليق', 'error');
    }
}

// Close comments modal
function closeCommentsModal() {
    DOM.commentsModal.classList.remove('active');
}

// Share a video
function shareVideo(videoId) {
    const video = APP_STATE.videos.find(v => v.id === videoId);
    if (!video) return;
    
    const shareData = {
        title: video.title,
        text: 'شاهد هذا الفيديو الرائع على منصة قصير',
        url: `https://example.com/video/${video.id}`
    };
    
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => console.log('Shared successfully'))
            .catch(err => {
                console.log('Error sharing:', err);
                fallbackShare(video);
            });
    } else {
        fallbackShare(video);
    }
}

// Fallback share method
function fallbackShare(video) {
    navigator.clipboard.writeText(`https://example.com/video/${video.id}`)
        .then(() => {
            showToast('تم نسخ رابط الفيديو', 'success');
        })
        .catch(() => {
            window.open(`https://wa.me/?text=${encodeURIComponent(`شاهد هذا الفيديو: https://example.com/video/${video.id}`)}`, '_blank');
        });
}

// Toggle sound for a video
function toggleSound(videoId) {
    const videoElement = document.querySelector(`.video-item[data-video-id="${videoId}"]`);
    if (!videoElement) return;
    
    const iframe = videoElement.querySelector('.video-player');
    const soundControl = videoElement.querySelector('.sound-control');
    
    if (!iframe || !iframe.contentWindow) return;
    
    APP_STATE.muted = !APP_STATE.muted;
    
    if (APP_STATE.muted) {
        iframe.contentWindow.postMessage('{"event":"command","func":"mute","args":""}', '*');
        soundControl.innerHTML = '<i class="fas fa-volume-mute"></i>';
    } else {
        iframe.contentWindow.postMessage('{"event":"command","func":"unMute","args":""}', '*');
        soundControl.innerHTML = '<i class="fas fa-volume-up"></i>';
    }
}

// Open video by ID
async function openVideoById(videoId) {
    try {
        // Check if video is already loaded
        const existingVideo = APP_STATE.videos.find(v => v.id === videoId);
        if (existingVideo) {
            const index = APP_STATE.videos.indexOf(existingVideo);
            APP_STATE.currentVideoIndex = index;
            scrollToVideo(index);
            return;
        }
        
        // If not, load the video
        const videoDoc = await APP_STATE.db.collection('videos').doc(videoId).get();
        if (!videoDoc.exists) {
            showToast('الفيديو غير موجود', 'error');
            return;
        }
        
        const videoData = videoDoc.data();
        const video = {
            id: videoDoc.id,
            title: videoData.title,
            description: videoData.description,
            videoId: generateVideoId(),
            url: videoData.url,
            author: {
                id: videoData.authorId,
                name: videoData.authorName,
                avatar: videoData.authorAvatar
            },
            likes: videoData.likes,
            comments: videoData.comments,
            views: videoData.views,
            music: videoData.music || "الصوت الأصلي",
            category: videoData.category || "عام",
            duration: videoData.duration || 0,
            thumbnail: videoData.thumbnail || APP_CONFIG.defaultThumbnail,
            createdAt: videoData.createdAt?.toDate() || new Date()
        };
        
        // Add to videos array and set as current
        APP_STATE.videos.unshift(video);
        APP_STATE.currentVideoIndex = 0;
        
        // Render videos
        renderVideos();
        
        // Scroll to top
        scrollToVideo(0);
    } catch (error) {
        console.error('Error loading video:', error);
        showToast('حدث خطأ أثناء تحميل الفيديو', 'error');
    }
}

// Scroll to video by index
function scrollToVideo(index) {
    const video = document.querySelector(`.video-item[data-index="${index}"]`);
    if (video) {
        video.scrollIntoView({ behavior: 'smooth' });
        
        if (!('scrollBehavior' in document.documentElement.style)) {
            window.scrollTo({
                top: video.offsetTop,
                behavior: 'auto'
            });
        }
    }
}

// Initialize network monitoring
function initNetworkMonitor() {
    window.addEventListener('online', () => {
        APP_STATE.connectionStatus = 'online';
        hideConnectionBanner();
        showToast('تم استعادة الاتصال بالإنترنت', 'success');
        
        // Sync any pending changes
        syncPendingChanges();
        
        // Reload videos if empty
        if (APP_STATE.videos.length === 0) {
            loadVideos();
        }
    });

    window.addEventListener('offline', () => {
        APP_STATE.connectionStatus = 'offline';
        showConnectionBanner('تم فقدان الاتصال بالإنترنت');
        showToast('تم فقدان الاتصال بالإنترنت', 'error');
        
        // Switch to offline mode
        switchToOfflineMode();
    });

    // Check connection speed periodically
    setInterval(() => {
        checkConnectionSpeed();
    }, 10000);
}

// Sync pending changes when back online
async function syncPendingChanges() {
    if (!APP_STATE.currentUser) return;
    
    // Sync liked videos
    const likedVideos = JSON.parse(localStorage.getItem('likedVideos') || '[]');
    for (const videoId of likedVideos) {
        try {
                        const likeRef = APP_STATE.db.collection('videos')
                .doc(videoId)
                .collection('likes')
                .doc(APP_STATE.currentUser.id);
            
            await likeRef.set({
                userId: APP_STATE.currentUser.id,
                likedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await APP_STATE.db.collection('videos')
                .doc(videoId)
                .update({
                    likes: firebase.firestore.FieldValue.increment(1)
                });
        } catch (error) {
            console.error(`Error syncing like for video ${videoId}:`, error);
        }
    }
    
    // Sync saved videos
    const savedVideos = JSON.parse(localStorage.getItem('savedVideos') || '[]');
    for (const videoId of savedVideos) {
        try {
            const videoDoc = await APP_STATE.db.collection('videos').doc(videoId).get();
            if (videoDoc.exists) {
                const videoData = videoDoc.data();
                
                await APP_STATE.db.collection('users')
                    .doc(APP_STATE.currentUser.id)
                    .collection('savedVideos')
                    .doc(videoId)
                    .set({
                        videoId: videoId,
                        savedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        videoData: {
                            title: videoData.title,
                            thumbnail: videoData.thumbnail,
                            author: videoData.author,
                            views: videoData.views,
                            likes: videoData.likes
                        }
                    });
            }
        } catch (error) {
            console.error(`Error syncing saved video ${videoId}:`, error);
        }
    }
    
    // Sync watched videos
    const watchedVideos = JSON.parse(localStorage.getItem('watchedVideos') || [];
    for (const videoId of watchedVideos) {
        try {
            await APP_STATE.db.collection('users')
                .doc(APP_STATE.currentUser.id)
                .collection('history')
                .doc(videoId)
                .set({
                    videoId: videoId,
                    viewedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
        } catch (error) {
            console.error(`Error syncing watched video ${videoId}:`, error);
        }
    }
    
    // Clear pending changes from localStorage
    localStorage.removeItem('likedVideos');
    localStorage.removeItem('savedVideos');
    localStorage.removeItem('watchedVideos');
    
    showToast('تم مزامنة جميع التغييرات المعلقة', 'success');
}

// Check connection speed
function checkConnectionSpeed() {
    if (!navigator.onLine) return;
    
    const startTime = Date.now();
    const testImage = new Image();
    const testUrl = `https://httpbin.org/image/jpeg?rand=${startTime}`;
    let fileSize = 0;
    
    testImage.onload = function() {
        const endTime = Date.now();
        fileSize = 10000; // Approximate size of test image in bytes
        const speedKbps = Math.round((fileSize * 8) / (endTime - startTime));
        
        if (speedKbps < 500) { // Less than 500 Kbps
            APP_STATE.userPreferences.videoQuality = 'low';
            showToast('جودة الفيديو تم ضبطها تلقائياً للوضع المنخفض بسبب سرعة الإنترنت البطيئة', 'info');
        } else if (speedKbps < 1500) { // Less than 1.5 Mbps
            APP_STATE.userPreferences.videoQuality = 'medium';
        } else {
            APP_STATE.userPreferences.videoQuality = 'high';
        }
        
        saveUserPreferences();
    };
    
    testImage.onerror = function() {
        console.log('Connection speed test failed');
    };
    
    testImage.src = testUrl;
}

// Switch to offline mode
function switchToOfflineMode() {
    APP_STATE.isOfflineMode = true;
    
    // Load offline videos if any
    if (APP_STATE.offlineVideos.length > 0) {
        APP_STATE.videos = APP_STATE.offlineVideos;
        renderVideos();
    } else {
        showError('لا يوجد اتصال بالإنترنت ولا توجد فيديوهات متاحة للعرض دون اتصال');
    }
}

// Load offline videos
async function loadOfflineVideos() {
    try {
        const offlineVideos = await caches.match('/api/offline-videos');
        if (offlineVideos) {
            const videos = await offlineVideos.json();
            APP_STATE.offlineVideos = videos.slice(0, APP_CONFIG.maxOfflineVideos);
        }
    } catch (error) {
        console.error('Error loading offline videos:', error);
    }
}

// Show connection banner
function showConnectionBanner(message) {
    DOM.connectionBanner.textContent = message;
    DOM.connectionBanner.style.display = 'block';
    setTimeout(() => {
        DOM.connectionBanner.style.opacity = '1';
    }, 10);
}

// Hide connection banner
function hideConnectionBanner() {
    DOM.connectionBanner.style.opacity = '0';
    setTimeout(() => {
        DOM.connectionBanner.style.display = 'none';
    }, 300);
}

// Initialize event listeners
function initEventListeners() {
    // Theme toggle
    DOM.themeToggle.addEventListener('click', () => {
        APP_STATE.isDarkMode = !APP_STATE.isDarkMode;
        setTheme(APP_STATE.isDarkMode);
        localStorage.setItem('darkMode', APP_STATE.isDarkMode);
        
        if (APP_STATE.currentUser) {
            APP_STATE.userPreferences.darkMode = APP_STATE.isDarkMode;
            saveUserPreferences();
        }
    });
    
    // Navigation buttons
    DOM.homeBtn.addEventListener('click', () => switchTab('home'));
    DOM.discoverBtn.addEventListener('click', () => switchTab('discover'));
    DOM.profileBtn.addEventListener('click', () => switchTab('profile'));
    DOM.notificationsBtn.addEventListener('click', () => switchTab('notifications'));
    DOM.uploadBtn.addEventListener('click', () => {
        if (APP_STATE.isCreator) {
            switchTab('creator');
        } else {
            showUploadModal();
        }
    });
    
    // Search functionality
    DOM.searchInput.addEventListener('input', debounce(handleSearch, 300));
    DOM.clearSearch.addEventListener('click', () => {
        DOM.searchInput.value = '';
        DOM.clearSearch.style.display = 'none';
    });
    DOM.cancelSearch.addEventListener('click', () => {
        DOM.searchView.style.display = 'none';
        DOM.videoFeed.style.display = 'block';
    });
    
    // Load more videos
    DOM.loadMoreBtn.addEventListener('click', loadMoreVideos);
    
    // Feed tabs
    DOM.feedTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const feed = tab.dataset.feed;
            APP_STATE.currentFeed = feed;
            
            // Update active tab
            DOM.feedTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Load appropriate feed
            loadVideos();
        });
    });
    
    // Result tabs
    DOM.resultTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const type = tab.dataset.type;
            
            // Update active tab
            DOM.resultTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Show appropriate results
            document.querySelectorAll('.result-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`${type}Results`).style.display = 'block';
        });
    });
    
    // Window events
    window.addEventListener('scroll', throttle(handleScroll, 100));
    window.addEventListener('resize', throttle(handleResize, 200));
}

// Switch between app tabs
function switchTab(tab) {
    // Hide all views
    DOM.videoFeed.style.display = 'none';
    DOM.discoverView.style.display = 'none';
    DOM.profileView.style.display = 'none';
    DOM.notificationsView.style.display = 'none';
    DOM.creatorStudio.style.display = 'none';
    DOM.watchLaterView.style.display = 'none';
    DOM.searchView.style.display = 'none';
    
    // Update active nav button
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    switch (tab) {
        case 'home':
            DOM.videoFeed.style.display = 'block';
            DOM.homeBtn.classList.add('active');
            loadVideos();
            break;
            
        case 'discover':
            DOM.discoverView.style.display = 'block';
            DOM.discoverBtn.classList.add('active');
            loadDiscoverContent();
            break;
            
        case 'profile':
            if (APP_STATE.currentUser) {
                DOM.profileView.style.display = 'block';
                DOM.profileBtn.classList.add('active');
                loadProfile();
            } else {
                showAuthModal();
            }
            break;
            
        case 'notifications':
            if (APP_STATE.currentUser) {
                DOM.notificationsView.style.display = 'block';
                DOM.notificationsBtn.classList.add('active');
                loadNotifications();
            } else {
                showAuthModal();
            }
            break;
            
        case 'creator':
            if (APP_STATE.currentUser && APP_STATE.isCreator) {
                DOM.creatorStudio.style.display = 'block';
                loadCreatorStudio();
            } else {
                showAuthModal();
            }
            break;
            
        default:
            DOM.videoFeed.style.display = 'block';
            DOM.homeBtn.classList.add('active');
            loadVideos();
    }
}

// Load discover content (categories, trending, creators)
async function loadDiscoverContent() {
    try {
        // Load categories
        const categoriesSnapshot = await APP_STATE.db.collection('categories')
            .orderBy('order')
            .limit(12)
            .get();
        
        DOM.categoriesContainer.innerHTML = '';
        categoriesSnapshot.forEach(doc => {
            const category = doc.data();
            const categoryEl = document.createElement('div');
            categoryEl.className = 'category-card';
            categoryEl.innerHTML = `
                <img src="${category.image}" alt="${category.name}" loading="lazy">
                <span>${category.name}</span>
            `;
            categoryEl.addEventListener('click', () => {
                APP_STATE.currentCategory = category.id;
                switchTab('home');
                loadVideos();
            });
            DOM.categoriesContainer.appendChild(categoryEl);
        });
        
        // Load trending videos
        const trendingSnapshot = await APP_STATE.db.collection('videos')
            .where('isPublic', '==', true)
            .orderBy('views', 'desc')
            .limit(6)
            .get();
        
        DOM.trendingVideos.innerHTML = '';
        trendingSnapshot.forEach(doc => {
            const video = doc.data();
            const videoEl = document.createElement('div');
            videoEl.className = 'trending-video';
            videoEl.innerHTML = `
                <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
                <div class="trending-info">
                    <h4>${video.title}</h4>
                    <p>${video.authorName}</p>
                    <span>${formatNumber(video.views)} مشاهدات</span>
                </div>
            `;
            videoEl.addEventListener('click', () => openVideoById(doc.id));
            DOM.trendingVideos.appendChild(videoEl);
        });
        
        // Load popular creators
        const creatorsSnapshot = await APP_STATE.db.collection('users')
            .where('isCreator', '==', true)
            .orderBy('followersCount', 'desc')
            .limit(8)
            .get();
        
        DOM.popularCreators.innerHTML = '';
        creatorsSnapshot.forEach(doc => {
            const creator = doc.data();
            const creatorEl = document.createElement('div');
            creatorEl.className = 'creator-card';
            creatorEl.innerHTML = `
                <img src="${creator.avatar}" alt="${creator.name}" class="creator-avatar">
                <span>${creator.name}</span>
                <button class="follow-btn" data-user-id="${doc.id}">متابعة</button>
            `;
            
            const followBtn = creatorEl.querySelector('.follow-btn');
            followBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                followUser(doc.id);
            });
            
            creatorEl.addEventListener('click', () => {
                showCreatorProfile(doc.id);
            });
            
            DOM.popularCreators.appendChild(creatorEl);
        });
    } catch (error) {
        console.error('Error loading discover content:', error);
        showToast('حدث خطأ أثناء تحميل المحتوى', 'error');
    }
}

// Show creator profile
async function showCreatorProfile(userId) {
    try {
        const userDoc = await APP_STATE.db.collection('users').doc(userId).get();
        if (!userDoc.exists) {
            showToast('المنشئ غير موجود', 'error');
            return;
        }
        
        const userData = userDoc.data();
        const videosSnapshot = await APP_STATE.db.collection('videos')
            .where('authorId', '==', userId)
            .where('isPublic', '==', true)
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
        
        const videos = [];
        videosSnapshot.forEach(doc => {
            const video = doc.data();
            videos.push({
                id: doc.id,
                title: video.title,
                thumbnail: video.thumbnail,
                views: video.views,
                likes: video.likes,
                createdAt: video.createdAt.toDate()
            });
        });
        
        DOM.profileView.innerHTML = `
            <div class="profile-header">
                <div class="profile-cover">
                    <img src="${userData.coverImage || 'https://via.placeholder.com/800x200/161616/AAAAAA?text=قصير'}" alt="Cover" loading="lazy">
                </div>
                <div class="profile-info">
                    <img src="${userData.avatar}" alt="${userData.name}" class="profile-avatar">
                    <h2 class="profile-name">${userData.name}</h2>
                    <p class="profile-bio">${userData.bio || 'لا يوجد وصف'}</p>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(videos.length)}</span>
                            <span class="stat-label">فيديوهات</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(userData.followersCount || 0)}</span>
                            <span class="stat-label">متابعون</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(userData.likesCount || 0)}</span>
                            <span class="stat-label">إعجابات</span>
                        </div>
                    </div>
                    <button class="follow-btn large" id="profileFollowBtn" data-user-id="${userId}">
                        ${APP_STATE.currentUser?.following?.includes(userId) ? 'متابَع' : 'متابعة'}
                    </button>
                </div>
            </div>
            <div class="profile-videos">
                <h3 class="section-title">فيديوهات ${userData.name}</h3>
                <div class="video-grid" id="creatorVideosGrid">
                    ${videos.map(video => `
                        <div class="video-grid-item" data-video-id="${video.id}">
                            <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
                            <div class="video-overlay">
                                <span class="video-views">${formatNumber(video.views)} مشاهدات</span>
                                <span class="video-likes">${formatNumber(video.likes)} إعجاب</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        // Add follow button event
        document.getElementById('profileFollowBtn').addEventListener('click', () => {
            followUser(userId);
        });
        
        // Add video click events
        document.querySelectorAll('.video-grid-item').forEach(item => {
            item.addEventListener('click', () => {
                openVideoById(item.dataset.videoId);
            });
        });
        
        // Show profile view
        switchTab('profile');
    } catch (error) {
        console.error('Error loading creator profile:', error);
        showToast('حدث خطأ أثناء تحميل الملف الشخصي', 'error');
    }
}

// Load user profile
async function loadProfile() {
    if (!APP_STATE.currentUser) return;
    
    try {
        const userDoc = await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id).get();
        if (!userDoc.exists) return;
        
        const userData = userDoc.data();
        const videosSnapshot = await APP_STATE.db.collection('videos')
            .where('authorId', '==', APP_STATE.currentUser.id)
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
            
            const videos = [];
        videosSnapshot.forEach(doc => {
            const video = doc.data();
            videos.push({
                id: doc.id,
                title: video.title,
                thumbnail: video.thumbnail,
                views: video.views,
                likes: video.likes,
                isPublic: video.isPublic,
                createdAt: video.createdAt.toDate()
            });
        });
        
        DOM.profileView.innerHTML = `
            <div class="profile-header">
                <div class="profile-cover">
                    <img src="${userData.coverImage || 'https://via.placeholder.com/800x200/161616/AAAAAA?text=قصير'}" alt="Cover" loading="lazy">
                    <button class="edit-profile-btn" id="editProfileBtn">
                        <i class="fas fa-pencil-alt"></i> تعديل الملف
                    </button>
                </div>
                <div class="profile-info">
                    <div class="avatar-edit">
                        <img src="${userData.avatar}" alt="${userData.name}" class="profile-avatar">
                        <button class="edit-avatar-btn" id="editAvatarBtn">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <h2 class="profile-name">${userData.name}</h2>
                    <p class="profile-bio">${userData.bio || 'لا يوجد وصف'}</p>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(videos.length)}</span>
                            <span class="stat-label">فيديوهات</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(userData.followersCount || 0)}</span>
                            <span class="stat-label">متابعون</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">${formatNumber(userData.likesCount || 0)}</span>
                            <span class="stat-label">إعجابات</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="profile-tabs">
                <button class="profile-tab active" data-tab="videos">الفيديوهات</button>
                <button class="profile-tab" data-tab="liked">الإعجابات</button>
                <button class="profile-tab" data-tab="saved">المحفوظات</button>
                ${APP_STATE.isCreator ? `<button class="profile-tab" data-tab="analytics">التحليلات</button>` : ''}
            </div>
            <div class="profile-content">
                <div class="tab-content active" id="videosTab">
                    <div class="video-grid" id="userVideosGrid">
                        ${videos.map(video => `
                            <div class="video-grid-item" data-video-id="${video.id}">
                                <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
                                <div class="video-overlay">
                                    <span class="video-views">${formatNumber(video.views)} مشاهدات</span>
                                    <span class="video-likes">${formatNumber(video.likes)} إعجاب</span>
                                    ${!video.isPublic ? `<span class="video-private"><i class="fas fa-lock"></i> خاص</span>` : ''}
                                </div>
                                <button class="video-edit-btn" data-video-id="${video.id}">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="tab-content" id="likedTab">
                    <div class="loading-spinner"></div>
                </div>
                <div class="tab-content" id="savedTab">
                    <div class="loading-spinner"></div>
                </div>
                ${APP_STATE.isCreator ? `
                <div class="tab-content" id="analyticsTab">
                    <div class="loading-spinner"></div>
                </div>
                ` : ''}
            </div>
        `;
        
        // Add tab switching
        document.querySelectorAll('.profile-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.profile-tab').forEach(t => {
                    t.classList.remove('active');
                });
                tab.classList.add('active');
                
                // Show appropriate content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Tab`).classList.add('active');
                
                // Load content if not loaded
                if (tabName === 'liked' && document.getElementById('likedTab').innerHTML.includes('loading-spinner')) {
                    loadLikedVideos();
                } else if (tabName === 'saved' && document.getElementById('savedTab').innerHTML.includes('loading-spinner')) {
                    showWatchLaterView();
                } else if (tabName === 'analytics' && document.getElementById('analyticsTab').innerHTML.includes('loading-spinner')) {
                    loadCreatorAnalytics();
                }
            });
        });
        
        // Add video click events
        document.querySelectorAll('.video-grid-item').forEach(item => {
            item.addEventListener('click', () => {
                openVideoById(item.dataset.videoId);
            });
        });
        
        // Add edit buttons events
        document.getElementById('editProfileBtn').addEventListener('click', showEditProfileModal);
        document.getElementById('editAvatarBtn').addEventListener('click', showAvatarUpload);
        
        // Add video edit buttons events
        document.querySelectorAll('.video-edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showVideoOptions(btn.dataset.videoId);
            });
        });
    } catch (error) {
        console.error('Error loading profile:', error);
        showToast('حدث خطأ أثناء تحميل الملف الشخصي', 'error');
    }
}

// Load liked videos for profile
async function loadLikedVideos() {
    try {
        const likedSnapshot = await APP_STATE.db.collection('users')
            .doc(APP_STATE.currentUser.id)
            .collection('likedVideos')
            .orderBy('likedAt', 'desc')
            .limit(20)
            .get();
        
        const likedTab = document.getElementById('likedTab');
        likedTab.innerHTML = '';
        
        if (likedSnapshot.empty) {
            likedTab.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-heart" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                    <p>لا توجد فيديوهات معجبة</p>
                </div>
            `;
            return;
        }
        
        const videoGrid = document.createElement('div');
        videoGrid.className = 'video-grid';
        
        for (const doc of likedSnapshot.docs) {
            const videoData = doc.data();
            const videoDoc = await APP_STATE.db.collection('videos').doc(doc.id).get();
            
            if (videoDoc.exists) {
                const video = videoDoc.data();
                const videoItem = document.createElement('div');
                videoItem.className = 'video-grid-item';
                videoItem.dataset.videoId = doc.id;
                videoItem.innerHTML = `
                    <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
                    <div class="video-overlay">
                        <span class="video-views">${formatNumber(video.views)} مشاهدات</span>
                        <span class="video-likes">${formatNumber(video.likes)} إعجاب</span>
                    </div>
                `;
                videoItem.addEventListener('click', () => openVideoById(doc.id));
                videoGrid.appendChild(videoItem);
            }
        }
        
        likedTab.appendChild(videoGrid);
    } catch (error) {
        console.error('Error loading liked videos:', error);
        document.getElementById('likedTab').innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>حدث خطأ أثناء تحميل الفيديوهات المعجبة</p>
                <button class="retry-btn" onclick="loadLikedVideos()">إعادة المحاولة</button>
            </div>
        `;
    }
}

// Show video options menu
function showVideoOptions(videoId) {
    const video = APP_STATE.videos.find(v => v.id === videoId);
    if (!video) return;
    
    const optionsMenu = document.createElement('div');
    optionsMenu.className = 'video-options-menu';
    optionsMenu.innerHTML = `
        <button class="option-btn" data-action="edit" data-video-id="${videoId}">
            <i class="fas fa-edit"></i> تعديل
        </button>
        <button class="option-btn" data-action="delete" data-video-id="${videoId}">
            <i class="fas fa-trash"></i> حذف
        </button>
        <button class="option-btn" data-action="privacy" data-video-id="${videoId}">
            <i class="fas fa-lock"></i> ${video.isPublic ? 'جعل خاص' : 'جعل عام'}
        </button>
        <button class="option-btn" data-action="stats" data-video-id="${videoId}">
            <i class="fas fa-chart-bar"></i> الإحصائيات
        </button>
        <button class="option-btn" data-action="cancel">
            <i class="fas fa-times"></i> إلغاء
        </button>
    `;
    
    document.body.appendChild(optionsMenu);
    
    // Position menu near the button
    const btn = document.querySelector(`.video-edit-btn[data-video-id="${videoId}"]`);
    const rect = btn.getBoundingClientRect();
    optionsMenu.style.top = `${rect.bottom + window.scrollY}px`;
    optionsMenu.style.left = `${rect.left + rect.width - optionsMenu.offsetWidth + window.scrollX}px`;
    
    // Add event listeners
    optionsMenu.querySelector('[data-action="edit"]').addEventListener('click', () => {
        editVideo(videoId);
        optionsMenu.remove();
    });
    
    optionsMenu.querySelector('[data-action="delete"]').addEventListener('click', () => {
        confirmDeleteVideo(videoId);
        optionsMenu.remove();
    });
    
    optionsMenu.querySelector('[data-action="privacy"]').addEventListener('click', () => {
        toggleVideoPrivacy(videoId);
        optionsMenu.remove();
    });
    
    optionsMenu.querySelector('[data-action="stats"]').addEventListener('click', () => {
        showVideoStats(videoId);
        optionsMenu.remove();
    });
    
    optionsMenu.querySelector('[data-action="cancel"]').addEventListener('click', () => {
        optionsMenu.remove();
    });
    
    // Close menu when clicking outside
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            if (!optionsMenu.contains(e.target) && e.target !== btn) {
                optionsMenu.remove();
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 10);
}

// Edit video details
async function editVideo(videoId) {
    try {
        const videoDoc = await APP_STATE.db.collection('videos').doc(videoId).get();
        if (!videoDoc.exists) {
            showToast('الفيديو غير موجود', 'error');
            return;
        }
        
        const video = videoDoc.data();
        APP_STATE.currentEditingVideo = {
            id: videoId,
            title: video.title,
            description: video.description,
            category: video.category,
            isPublic: video.isPublic,
            thumbnail: video.thumbnail
        };
        
        // Show edit modal
        showEditVideoModal();
    } catch (error) {
        console.error('Error editing video:', error);
        showToast('حدث خطأ أثناء تحميل بيانات الفيديو', 'error');
    }
}

// Confirm video deletion
function confirmDeleteVideo(videoId) {
    const confirmDialog = document.createElement('div');
    confirmDialog.className = 'confirm-dialog';
    confirmDialog.innerHTML = `
        <div class="confirm-content">
            <h3>حذف الفيديو</h3>
            <p>هل أنت متأكد أنك تريد حذف هذا الفيديو؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="confirm-buttons">
                <button class="cancel-btn" id="cancelDelete">إلغاء</button>
                <button class="delete-btn" id="confirmDelete" data-video-id="${videoId}">حذف</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmDialog);
    
    document.getElementById('cancelDelete').addEventListener('click', () => {
        confirmDialog.remove();
    });
    
    document.getElementById('confirmDelete').addEventListener('click', async () => {
        try {
            await deleteVideo(document.getElementById('confirmDelete').dataset.videoId);
            confirmDialog.remove();
        } catch (error) {
            console.error('Error deleting video:', error);
            showToast('حدث خطأ أثناء حذف الفيديو', 'error');
        }
    });
}

// Delete video
async function deleteVideo(videoId) {
    try {
        // Delete video document
        await APP_STATE.db.collection('videos').doc(videoId).delete();
        
        // Delete video file from storage
        await APP_STATE.storage.ref(`videos/${videoId}`).delete();
        
        // Delete thumbnail if not default
        const video = APP_STATE.uploadedVideos.find(v => v.id === videoId);
        if (video && video.thumbnail !== APP_CONFIG.defaultThumbnail) {
            await APP_STATE.storage.refFromURL(video.thumbnail).delete();
        }
        
        // Remove from uploaded videos
        APP_STATE.uploadedVideos = APP_STATE.uploadedVideos.filter(v => v.id !== videoId);
        
        // Remove from videos array if exists
        APP_STATE.videos = APP_STATE.videos.filter(v => v.id !== videoId);
        
        // Update UI
        document.querySelector(`.video-grid-item[data-video-id="${videoId}"]`)?.remove();
        
        showToast('تم حذف الفيديو بنجاح', 'success');
    } catch (error) {
        console.error('Error deleting video:', error);
        throw error;
    }
}

// Toggle video privacy
async function toggleVideoPrivacy(videoId) {
    try {
        const videoDoc = await APP_STATE.db.collection('videos').doc(videoId).get();
        if (!videoDoc.exists) return;
        
        const currentPrivacy = videoDoc.data().isPublic;
        
        await APP_STATE.db.collection('videos').doc(videoId).update({
            isPublic: !currentPrivacy
        });
        
        // Update UI
        const privacyBadge = document.querySelector(`.video-grid-item[data-video-id="${videoId}"] .video-private`);
        if (currentPrivacy) {
            if (!privacyBadge) {
                const overlay = document.querySelector(`.video-grid-item[data-video-id="${videoId}"] .video-overlay`);
                if (overlay) {
                    const badge = document.createElement('span');
                    badge.className = 'video-private';
                    badge.innerHTML = '<i class="fas fa-lock"></i> خاص';
                    overlay.appendChild(badge);
                }
            }
        } else {
            privacyBadge?.remove();
        }
        
        showToast(`تم جعل الفيديو ${currentPrivacy ? 'خاص' : 'عام'}`, 'success');
    } catch (error) {
        console.error('Error toggling video privacy:', error);
        showToast('حدث خطأ أثناء تغيير خصوصية الفيديو', 'error');
    }
}

// Show video statistics
async function showVideoStats(videoId) {
    try {
        const videoDoc = await APP_STATE.db.collection('videos').doc(videoId).get();
        if (!videoDoc.exists) {
            showToast('الفيديو غير موجود', 'error');
            return;
        }
        
        const video = videoDoc.data();
        
        // Get analytics data
        const statsDoc = await APP_STATE.db.collection('videoAnalytics').doc(videoId).get();
        const stats = statsDoc.exists ? statsDoc.data() : {};
        
        // Show stats modal
        const statsModal = document.createElement('div');
        statsModal.className = 'stats-modal';
        statsModal.innerHTML = `
            <div class="stats-content">
                <div class="stats-header">
                    <h3>إحصائيات الفيديو</h3>
                    <button class="close-stats" id="closeStatsModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="stats-body">
                    <div class="stats-overview">
                        <div class="stat-card">
                            <span class="stat-number">${formatNumber(video.views)}</span>
                            <span class="stat-label">مشاهدات</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${formatNumber(video.likes)}</span>
                            <span class="stat-label">إعجابات</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${formatNumber(video.comments)}</span>
                            <span class="stat-label">تعليقات</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${formatNumber(stats.shares || 0)}</span>
                            <span class="stat-label">مشاركات</span>
                        </div>
                    </div>
                    <div class="stats-charts">
                        <div class="chart-container">
                            <h4>المشاهدات حسب الوقت</h4>
                            <canvas id="viewsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>المشاهدات حسب المنطقة</h4>
                            <canvas id="regionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(statsModal);
        
        // Close modal
        document.getElementById('closeStatsModal').addEventListener('click', () => {
            statsModal.remove();
        });
        
        // Render charts
        renderVideoCharts(videoId, stats);
    } catch (error) {
        console.error('Error showing video stats:', error);
        showToast('حدث خطأ أثناء تحميل إحصائيات الفيديو', 'error');
    }
}

// Render video analytics charts
function renderVideoCharts(videoId, stats) {
    // Views over time chart
    const viewsCtx = document.getElementById('viewsChart').getContext('2d');
    const viewsChart = new Chart(viewsCtx, {
        type: 'line',
        data: {
            labels: stats.viewsOverTime?.labels || ['اليوم 1', 'اليوم 2', 'اليوم 3', 'اليوم 4', 'اليوم 5', 'اليوم 6', 'اليوم 7'],
            datasets: [{
                label: 'المشاهدات',
                data: stats.viewsOverTime?.data || [10, 20, 35, 50, 45, 60, 75],
                borderColor: '#ff4757',
                backgroundColor: 'rgba(255, 71, 87, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Regions chart
    const regionCtx = document.getElementById('regionChart').getContext('2d');
    const regionChart = new Chart(regionCtx, {
        type: 'doughnut',
        data: {
            labels: stats.regions?.labels || ['المملكة', 'مصر', 'الجزائر', 'العراق', 'دول أخرى'],
            datasets: [{
                data: stats.regions?.data || [45, 20, 15, 10, 10],
                backgroundColor: [
                    '#ff4757',
                    '#ff6b81',
                    '#ff8d9e',
                    '#ffb0bb',
                    '#ffd3d9'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Show edit profile modal
function showEditProfileModal() {
    const modal = document.createElement('div');
    modal.className = 'edit-profile-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>تعديل الملف الشخصي</h3>
                <button class="close-modal" id="closeEditProfileModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="profileName">الاسم</label>
                    <input type="text" id="profileName" value="${APP_STATE.currentUser.name}">
                </div>
                <div class="form-group">
                    <label for="profileBio">الوصف</label>
                    <textarea id="profileBio">${APP_STATE.currentUser.bio || ''}</textarea>
                </div>
                <div class="form-group">
                    <label for="profileCover">صورة الغلاف</label>
                    <input type="file" id="profileCover" accept="image/*">
                </div>
                <div class="form-actions">
                    <button class="cancel-btn" id="cancelEditProfile">إلغاء</button>
                    <button class="save-btn" id="saveProfile">حفظ التغييرات</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal
    document.getElementById('closeEditProfileModal').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelEditProfile').addEventListener('click', () => {
        modal.remove();
    });
    
    // Save profile
    document.getElementById('saveProfile').addEventListener('click', async () => {
        const name = document.getElementById('profileName').value.trim();
        const bio = document.getElementById('profileBio').value.trim();
        
        if (!name) {
            showToast('الرجاء إدخال الاسم', 'warning');
            return;
        }
        
        try {
            // Update profile in Firestore
            await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id).update({
                name: name,
                bio: bio || firebase.firestore.FieldValue.delete(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update cover image if selected
            const coverFile = document.getElementById('profileCover').files[0];
            if (coverFile) {
                const coverRef = APP_STATE.storage.ref(`users/${APP_STATE.currentUser.id}/cover`);
                await coverRef.put(coverFile);
                const coverUrl = await coverRef.getDownloadURL();
                
                await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id).update({
                    coverImage: coverUrl
                });
                
                APP_STATE.currentUser.coverImage = coverUrl;
            }
            
            // Update current user in state
            APP_STATE.currentUser.name = name;
            APP_STATE.currentUser.bio = bio || null;
            
            // Update UI
            updateAuthUI();
            loadProfile();
            
            showToast('تم تحديث الملف الشخصي بنجاح', 'success');
            modal.remove();
        } catch (error) {
            console.error('Error updating profile:', error);
            showToast('حدث خطأ أثناء تحديث الملف الشخصي', 'error');
        }
    });
}

// Show avatar upload dialog
function showAvatarUpload() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.click();
    
    input.addEventListener('change', async () => {
        if (!input.files.length) return;
        
        const file = input.files[0];
        if (!file.type.match('image.*')) {
            showToast('الرجاء اختيار صورة صالحة', 'warning');
            return;
        }
        
        try {
            showLoading('جاري تحديث الصورة...');
            
            // Upload new avatar
            const avatarRef = APP_STATE.storage.ref(`users/${APP_STATE.currentUser.id}/avatar`);
            await avatarRef.put(file);
            const avatarUrl = await avatarRef.getDownloadURL();
            
            // Update user document
            await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id).update({
                avatar: avatarUrl,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update current user in state
            APP_STATE.currentUser.avatar = avatarUrl;
            
            // Update UI
            updateAuthUI();
            loadProfile();
            
            hideLoading();
            showToast('تم تحديث الصورة بنجاح', 'success');
        } catch (error) {
            console.error('Error updating avatar:', error);
            hideLoading();
            showToast('حدث خطأ أثناء تحديث الصورة', 'error');
        }
    });
}

// Show edit video modal
function showEditVideoModal() {
    if (!APP_STATE.currentEditingVideo) return;
    
    const modal = document.createElement('div');
    modal.className = 'edit-video-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>تعديل الفيديو</h3>
                <button class="close-modal" id="closeEditVideoModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="video-preview">
                    <img src="${APP_STATE.currentEditingVideo.thumbnail}" alt="Video thumbnail">
                </div>
                <div class="form-group">
                    <label for="videoTitle">عنوان الفيديو</label>
                    <input type="text" id="videoTitle" value="${APP_STATE.currentEditingVideo.title}">
                </div>
                <div class="form-group">
                    <label for="videoDescription">وصف الفيديو</label>
                    <textarea id="videoDescription">${APP_STATE.currentEditingVideo.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label for="videoCategory">التصنيف</label>
                    <select id="videoCategory">
                        <option value="comedy" ${APP_STATE.currentEditingVideo.category === 'comedy' ? 'selected' : ''}>كوميديا</option>
                        <option value="music" ${APP_STATE.currentEditingVideo.category === 'music' ? 'selected' : ''}>موسيقى</option>
                        <option value="education" ${APP_STATE.currentEditingVideo.category === 'education' ? 'selected' : ''}>تعليمي</option>
                        <option value="gaming" ${APP_STATE.currentEditingVideo.category === 'gaming' ? 'selected' : ''}>ألعاب</option>
                        <option value="sports" ${APP_STATE.currentEditingVideo.category === 'sports' ? 'selected' : ''}>رياضة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="videoThumbnail">صورة مصغرة جديدة</label>
                    <input type="file" id="videoThumbnail" accept="image/*">
                </div>
                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="videoPublic" ${APP_STATE.currentEditingVideo.isPublic ? 'checked' : ''}>
                        <span class="checkmark"></span>
                        فيديو عام (يمكن للجميع مشاهدته)
                    </label>
                </div>
                <div class="form-actions">
                    <button class="cancel-btn" id="cancelEditVideo">إلغاء</button>
                    <button class="save-btn" id="saveVideoChanges">حفظ التغييرات</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal
    document.getElementById('closeEditVideoModal').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelEditVideo').addEventListener('click', () => {
        modal.remove();
    });
    
    // Save video changes
    document.getElementById('saveVideoChanges').addEventListener('click', async () => {
        const title = document.getElementById('videoTitle').value.trim();
        const description = document.getElementById('videoDescription').value.trim();
        const category = document.getElementById('videoCategory').value;
        const isPublic = document.getElementById('videoPublic').checked;
        const thumbnailFile = document.getElementById('videoThumbnail').files[0];
        
        if (!title) {
            showToast('الرجاء إدخال عنوان الفيديو', 'warning');
            return;
        }
        
        try {
            showLoading('جاري حفظ التغييرات...');
            
            const updates = {
                title: title,
                description: description || firebase.firestore.FieldValue.delete(),
                category: category,
                isPublic: isPublic,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Upload new thumbnail if selected
            if (thumbnailFile) {
                const thumbnailRef = APP_STATE.storage.ref(`videos/${APP_STATE.currentEditingVideo.id}/thumbnail`);
                await thumbnailRef.put(thumbnailFile);
                const thumbnailUrl = await thumbnailRef.getDownloadURL();
                updates.thumbnail = thumbnailUrl;
                
                // Delete old thumbnail if not default
                if (APP_STATE.currentEditingVideo.thumbnail !== APP_CONFIG.defaultThumbnail) {
                    try {
                        await APP_STATE.storage.refFromURL(APP_STATE.currentEditingVideo.thumbnail).delete();
                    } catch (error) {
                        console.error('Error deleting old thumbnail:', error);
                    }
                }
            }
            
            // Update video document
            await APP_STATE.db.collection('videos').doc(APP_STATE.currentEditingVideo.id).update(updates);
            
            // Update video in state if exists
            const videoIndex = APP_STATE.videos.findIndex(v => v.id === APP_STATE.currentEditingVideo.id);
            if (videoIndex !== -1) {
                APP_STATE.videos[videoIndex].title = title;
                APP_STATE.videos[videoIndex].description = description || '';
                APP_STATE.videos[videoIndex].category = category;
                APP_STATE.videos[videoIndex].isPublic = isPublic;
                if (thumbnailFile) {
                    APP_STATE.videos[videoIndex].thumbnail = updates.thumbnail;
                }
            }
            
            // Update uploaded videos if exists
            const uploadedIndex = APP_STATE.uploadedVideos.findIndex(v => v.id === APP_STATE.currentEditingVideo.id);
            if (uploadedIndex !== -1) {
                APP_STATE.uploadedVideos[uploadedIndex].title = title;
                APP_STATE.uploadedVideos[uploadedIndex].description = description || '';
                APP_STATE.uploadedVideos[uploadedIndex].category = category;
                APP_STATE.uploadedVideos[uploadedIndex].isPublic = isPublic;
                if (thumbnailFile) {
                    APP_STATE.uploadedVideos[uploadedIndex].thumbnail = updates.thumbnail;
                }
            }
            
            // Update UI
            loadProfile();
            
            hideLoading();
            showToast('تم تحديث الفيديو بنجاح', 'success');
            modal.remove();
        } catch (error) {
            console.error('Error updating video:', error);
            hideLoading();
            showToast('حدث خطأ أثناء تحديث الفيديو', 'error');
        }
    });
}

// Load creator studio
async function loadCreatorStudio() {
    try {
        // Load creator videos
        const videosSnapshot = await APP_STATE.db.collection('videos')
            .where('authorId', '==', APP_STATE.currentUser.id)
            .orderBy('createdAt', 'desc')
            .get();
        
        APP_STATE.uploadedVideos = [];
        videosSnapshot.forEach(doc => {
            const video = doc.data();
            APP_STATE.uploadedVideos.push({
                id: doc.id,
                title: video.title,
                thumbnail: video.thumbnail,
                views: video.views,
                likes: video.likes,
                comments: video.comments,
                isPublic: video.isPublic,
                createdAt: video.createdAt.toDate()
            });
        });
        
        // Load analytics data
        await loadCreatorAnalytics();
        
        // Render creator studio
        DOM.creatorStudio.innerHTML = `
            <div class="creator-header">
                <h2>استوديو المنشئ</h2>
                <button class="upload-video-btn" id="uploadVideoBtn">
                    <i class="fas fa-plus"></i> رفع فيديو جديد
                </button>
            </div>
            <div class="creator-tabs">
                <button class="creator-tab active" data-tab="videos">فيديوهاتي</button>
                <button class="creator-tab" data-tab="analytics">التحليلات</button>
                <button class="creator-tab" data-tab="earnings">الأرباح</button>
                <button class="creator-tab" data-tab="settings">الإعدادات</button>
            </div>
            <div class="creator-content">
                <div class="tab-content active" id="videosTab">
                    <div class="video-grid" id="creatorVideosGrid">
                        ${APP_STATE.uploadedVideos.map(video => `
                            <div class="video-grid-item" data-video-id="${video.id}">
                                <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
                                <div class="video-overlay">
                                    <span class="video-views">${formatNumber(video.views)} مشاهدات</span>
                                    <span class="video-likes">${formatNumber(video.likes)} إعجاب</span>
                                    ${!video.isPublic ? `<span class="video-private"><i class="fas fa-lock"></i> خاص</span>` : ''}
                                </div>
                                <button class="video-edit-btn" data-video-id="${video.id}">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="tab-content" id="analyticsTab">
                    <div class="analytics-overview">
                        <div class="analytics-card">
                            <span class="analytics-number">${formatNumber(APP_STATE.analyticsData?.totalViews || 0)}</span>
                            <span class="analytics-label">إجمالي المشاهدات</span>
                        </div>
                        <div class="analytics-card">
                            <span class="analytics-number">${formatNumber(APP_STATE.analyticsData?.totalLikes || 0)}</span>
                            <span class="analytics-label">إجمالي الإعجابات</span>
                        </div>
                        <div class="analytics-card">
                            <span class="analytics-number">${formatNumber(APP_STATE.analyticsData?.totalFollowers || 0)}</span>
                            <span class="analytics-label">إجمالي المتابعين</span>
                        </div>
                        <div class="analytics-card">
                            <span class="analytics-number">${formatNumber(APP_STATE.analyticsData?.engagementRate || 0)}%</span>
                            <span class="analytics-label">معدل التفاعل</span>
                        </div>
                    </div>
                    <div class="analytics-chart">
                        <canvas id="viewsChart"></canvas>
                    </div>
                </div>
                <div class="tab-content" id="earningsTab">
                    <div class="earnings-card">
                        <div class="earnings-header">
                            <h3>أرباح هذا الشهر</h3>
                            <span class="earnings-amount">${APP_STATE.analyticsData?.earnings?.currentMonth || 0} ر.س</span>
                        </div>
                        <div class="earnings-stats">
                            <div class="stat-item">
                                <span class="stat-number">${APP_STATE.analyticsData?.earnings?.lastMonth || 0} ر.س</span>
                                <span class="stat-label">الشهر الماضي</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">${APP_STATE.analyticsData?.earnings?.total || 0} ر.س</span>
                                <span class="stat-label">الإجمالي</span>
                            </div>
                        </div>
                        <div class="earnings-chart">
                            <canvas id="earningsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="settingsTab">
                    <div class="settings-form">
                        <h3>إعدادات المنشئ</h3>
                        <div class="form-group">
                            <label for="creatorName">اسم القناة</label>
                            <input type="text" id="creatorName" value="${APP_STATE.currentUser.name}">
                        </div>
                        <div class="form-group">
                            <label for="creatorBio">وصف القناة</label>
                            <textarea id="creatorBio">${APP_STATE.currentUser.bio || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="creatorCategory">تصنيف المحتوى</label>
                            <select id="creatorCategory">
                                <option value="comedy" ${APP_STATE.currentUser.creatorCategory === 'comedy' ? 'selected' : ''}>كوميديا</option>
                                <option value="music" ${APP_STATE.currentUser.creatorCategory === 'music' ? 'selected' : ''}>موسيقى</option>
                                <option value="education" ${APP_STATE.currentUser.creatorCategory === 'education' ? 'selected' : ''}>تعليمي</option>
                                <option value="gaming" ${APP_STATE.currentUser.creatorCategory === 'gaming' ? 'selected' : ''}>ألعاب</option>
                                <option value="sports" ${APP_STATE.currentUser.creatorCategory === 'sports' ? 'selected' : ''}>رياضة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="creatorPaypal">بريد PayPal للإيرادات</label>
                            <input type="email" id="creatorPaypal" value="${APP_STATE.currentUser.paypalEmail || ''}">
                        </div>
                        <div class="form-actions">
                            <button class="save-btn" id="saveCreatorSettings">حفظ الإعدادات</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add tab switching
        document.querySelectorAll('.creator-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.creator-tab').forEach(t => {
                    t.classList.remove('active');
                });
                tab.classList.add('active');
                
                // Show appropriate content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Tab`).classList.add('active');
            });
        });
        
        // Add video click events
        document.querySelectorAll('.video-grid-item').forEach(item => {
            item.addEventListener('click', () => {
                openVideoById(item.dataset.videoId);
            });
        });
        
        // Add video edit buttons events
        document.querySelectorAll('.video-edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showVideoOptions(btn.dataset.videoId);
            });
        });
        
        // Add upload video button event
        document.getElementById('uploadVideoBtn').addEventListener('click', showUploadModal);
        
        // Add save settings event
        document.getElementById('saveCreatorSettings').addEventListener('click', saveCreatorSettings);
        
        // Render charts
        renderCreatorCharts();
    } catch (error) {
        console.error('Error loading creator studio:', error);
        showToast('حدث خطأ أثناء تحميل استوديو المنشئ', 'error');
    }
}

// Load creator analytics
async function loadCreatorAnalytics() {
    try {
        const analyticsDoc = await APP_STATE.db.collection('creatorAnalytics').doc(APP_STATE.currentUser.id).get();
        if (analyticsDoc.exists) {
            APP_STATE.analyticsData = analyticsDoc.data();
        } else {
            APP_STATE.analyticsData = {
                totalViews: 0,
                totalLikes: 0,
                totalFollowers: 0,
                engagementRate: 0,
                earnings: {
                    currentMonth: 0,
                    lastMonth: 0,
                    total: 0
                }
            };
        }
    } catch (error) {
        console.error('Error loading creator analytics:', error);
        APP_STATE.analyticsData = null;
    }
}

// Render creator analytics charts
function renderCreatorCharts() {
    if (!APP_STATE.analyticsData) return;
    
    // Views chart
    const viewsCtx = document.getElementById('viewsChart')?.getContext('2d');
    if (viewsCtx) {
        new Chart(viewsCtx, {
            type: 'line',
            data: {
                labels: APP_STATE.analyticsData.viewsOverTime?.labels || ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو'],
                datasets: [{
                    label: 'المشاهدات',
                    data: APP_STATE.analyticsData.viewsOverTime?.data || [100, 200, 350, 500, 450, 600, 750],
                    borderColor: '#ff4757',
                    backgroundColor: 'rgba(255, 71, 87, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Earnings chart
    const earningsCtx = document.getElementById('earningsChart')?.getContext('2d');
    if (earningsCtx) {
        new Chart(earningsCtx, {
            type: 'bar',
            data: {
                labels: APP_STATE.analyticsData.earnings?.months || ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                datasets: [{
                    label: 'الأرباح',
                    data: APP_STATE.analyticsData.earnings?.monthlyData || [50, 75, 100, 125, 150, 175],
                    backgroundColor: '#ff4757',
                    borderColor: '#ff4757',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

// Save creator settings
async function saveCreatorSettings() {
    const name = document.getElementById('creatorName').value.trim();
    const bio = document.getElementById('creatorBio').value.trim();
    const category = document.getElementById('creatorCategory').value;
    const paypalEmail = document.getElementById('creatorPaypal').value.trim();
    
    if (!name) {
        showToast('الرجاء إدخال اسم القناة', 'warning');
        return;
    }
    
    try {
        await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id).update({
            name: name,
            bio: bio || firebase.firestore.FieldValue.delete(),
            creatorCategory: category,
            paypalEmail: paypalEmail || firebase.firestore.FieldValue.delete(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update current user in state
        APP_STATE.currentUser.name = name;
        APP_STATE.currentUser.bio = bio || null;
        APP_STATE.currentUser.creatorCategory = category;
        APP_STATE.currentUser.paypalEmail = paypalEmail || null;
        
        // Update UI
        updateAuthUI();
        
        showToast('تم حفظ إعدادات المنشئ بنجاح', 'success');
    } catch (error) {
        console.error('Error saving creator settings:', error);
        showToast('حدث خطأ أثناء حفظ الإعدادات', 'error');
    }
}

// Show upload modal
function showUploadModal() {
    if (!APP_STATE.currentUser) {
        showAuthModal();
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'upload-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>رفع فيديو جديد</h3>
                <button class="close-modal" id="closeUploadModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="upload-dropzone" id="uploadDropzone">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>اسحب وأسقط ملف الفيديو هنا أو</p>
                    <button class="browse-btn" id="browseFiles">تصفح الملفات</button>
                    <input type="file" id="videoFile" accept="video/*" style="display: none;">
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar" id="progressBar"></div>
                        <span class="progress-text" id="progressText">0%</span>
                    </div>
                </div>
                <div class="upload-form" id="uploadForm" style="display: none;">
                    <div class="video-preview">
                        <video id="videoPreview" controls></video>
                        <div class="thumbnail-selector">
                            <h4>اختر صورة مصغرة</h4>
                            <div class="thumbnail-options" id="thumbnailOptions"></div>
                            <button class="custom-thumbnail-btn" id="customThumbnailBtn">
                                <i class="fas fa-image"></i> اختيار صورة مخصصة
                            </button>
                            <input type="file" id="customThumbnail" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="videoTitle">عنوان الفيديو</label>
                        <input type="text" id="videoTitle" placeholder="أدخل عنواناً جذاباً">
                    </div>
                    <div class="form-group">
                        <label for="videoDescription">وصف الفيديو</label>
                        <textarea id="videoDescription" placeholder="أضف وصفاً للفيديو (اختياري)"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="videoCategory">تصنيف الفيديو</label>
                        <select id="videoCategory">
                            <option value="comedy">كوميديا</option>
                            <option value="music">موسيقى</option>
                            <option value="education">تعليمي</option>
                            <option value="gaming">ألعاب</option>
                            <option value="sports">رياضة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="videoPublic" checked>
                            <span class="checkmark"></span>
                            فيديو عام (يمكن للجميع مشاهدته)
                        </label>
                    </div>
                    <div class="form-actions">
                        <button class="cancel-btn" id="cancelUpload">إلغاء</button>
                        <button class="publish-btn" id="publishVideo">نشر الفيديو</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal
    document.getElementById('closeUploadModal').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelUpload').addEventListener('click', () => {
        modal.remove();
    });
    
    // Browse files
    document.getElementById('browseFiles').addEventListener('click', () => {
        document.getElementById('videoFile').click();
    });
    
    // File selection
    document.getElementById('videoFile').addEventListener('change', handleFileSelect);
    
    // Custom thumbnail
    document.getElementById('customThumbnailBtn').addEventListener('click', () => {
        document.getElementById('customThumbnail').click();
    });
    
    document.getElementById('customThumbnail').addEventListener('change', handleCustomThumbnail);
    
    // Drag and drop
    const dropzone = document.getElementById('uploadDropzone');
    
    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });
    
    dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
    });
    
    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        
        if (e.dataTransfer.files.length) {
            document.getElementById('videoFile').files = e.dataTransfer.files;
            handleFileSelect({ target: document.getElementById('videoFile') });
        }
    });
}

// Handle video file selection
function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Check file type
    if (!file.type.startsWith('video/')) {
        showToast('الرجاء اختيار ملف فيديو صالح', 'error');
        return;
    }
    
    // Check file size (max 100MB)
    if (file.size > 100 * 1024 * 1024) {
        showToast('حجم الفيديو يجب أن يكون أقل من 100MB', 'error');
        return;
    }
    
    // Show upload progress
    document.getElementById('uploadProgress').style.display = 'block';
    
    // Create video preview
    const videoPreview = document.getElementById('videoPreview');
    videoPreview.src = URL.createObjectURL(file);
    
    // Generate thumbnails
    generateThumbnails(videoPreview);
    
    // Show upload form
    document.getElementById('uploadForm').style.display = 'block';
    
    // Upload file to storage
    uploadVideoFile(file);
}

// Generate video thumbnails
function generateThumbnails(video) {
    const thumbnailOptions = document.getElementById('thumbnailOptions');
    thumbnailOptions.innerHTML = '';
    
    // Generate 3 thumbnails at different points in the video
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 160;
    canvas.height = 90;
    
    // Capture at 10%, 50%, and 90% of video duration
    video.addEventListener('loadedmetadata', () => {
        const duration = video.duration;
        const capturePoints = [duration * 0.1, duration * 0.5, duration * 0.9];
        
        capturePoints.forEach((time, index) => {
            video.currentTime = time;
            
            video.addEventListener('seeked', function capture() {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const thumbnailUrl = canvas.toDataURL('image/jpeg');
                
                const thumbnailOption = document.createElement('div');
                thumbnailOption.className = 'thumbnail-option';
                thumbnailOption.dataset.thumbnail = thumbnailUrl;
                thumbnailOption.innerHTML = `
                    <img src="${thumbnailUrl}" alt="Thumbnail ${index + 1}">
                    <div class="thumbnail-check"><i class="fas fa-check"></i></div>
                `;
                
                // Select first thumbnail by default
                if (index === 0) {
                    thumbnailOption.classList.add('selected');
                    APP_STATE.currentThumbnail = thumbnailUrl;
                }
                
                thumbnailOption.addEventListener('click', () => {
                    document.querySelectorAll('.thumbnail-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    thumbnailOption.classList.add('selected');
                    APP_STATE.currentThumbnail = thumbnailUrl;
                });
                
                thumbnailOptions.appendChild(thumbnailOption);
                
                // Remove event listener after capture
                video.removeEventListener('seeked', capture);
            });
        });
    });
}

// Handle custom thumbnail selection
function handleCustomThumbnail(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showToast('الرجاء اختيار صورة صالحة', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(event) {
        const thumbnailOptions = document.getElementById('thumbnailOptions');
        thumbnailOptions.innerHTML = '';
        
        const thumbnailOption = document.createElement('div');
        thumbnailOption.className = 'thumbnail-option selected';
        thumbnailOption.dataset.thumbnail = event.target.result;
        thumbnailOption.innerHTML = `
            <img src="${event.target.result}" alt="Custom thumbnail">
            <div class="thumbnail-check"><i class="fas fa-check"></i></div>
        `;
        
        thumbnailOption.addEventListener('click', () => {
            document.querySelectorAll('.thumbnail-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            thumbnailOption.classList.add('selected');
            APP_STATE.currentThumbnail = event.target.result;
        });
        
        thumbnailOptions.appendChild(thumbnailOption);
        APP_STATE.currentThumbnail = event.target.result;
    };
    reader.readAsDataURL(file);
}

// Upload video file to storage
function uploadVideoFile(file) {
    const storageRef = APP_STATE.storage.ref(`videos/${APP_STATE.currentUser.id}/${Date.now()}_${file.name}`);
    const uploadTask = storageRef.put(file);
    
    uploadTask.on('state_changed',
        (snapshot) => {
            // Upload progress
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
        },
        (error) => {
            // Upload error
            console.error('Upload error:', error);
            showToast('حدث خطأ أثناء رفع الفيديو', 'error');
            document.getElementById('uploadProgress').style.display = 'none';
        },
        () => {
            // Upload complete
            uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                APP_STATE.currentVideoUrl = downloadURL;
                document.getElementById('uploadProgress').style.display = 'none';
                showToast('تم رفع الفيديو بنجاح', 'success');
            });
        }
    );
}

// Publish video
async function publishVideo() {
    const title = document.getElementById('videoTitle').value.trim();
    const description = document.getElementById('videoDescription').value.trim();
    const category = document.getElementById('videoCategory').value;
    const isPublic = document.getElementById('videoPublic').checked;
    
    if (!title) {
        showToast('الرجاء إدخال عنوان الفيديو', 'warning');
        return;
    }
    
    if (!APP_STATE.currentVideoUrl) {
           showToast('الرجاء الانتظار حتى يكتمل رفع الفيديو', 'warning');
        return;
    }
    
    try {
        showLoading('جاري نشر الفيديو...');
        
        // Upload thumbnail if custom was selected
        let thumbnailUrl = APP_CONFIG.defaultThumbnail;
        if (APP_STATE.currentThumbnail && !APP_STATE.currentThumbnail.startsWith('data:')) {
            // Thumbnail is a URL (from generated thumbnails)
            thumbnailUrl = APP_STATE.currentThumbnail;
        } else if (APP_STATE.currentThumbnail) {
            // Thumbnail is a data URL (custom uploaded)
            const thumbnailBlob = dataURLtoBlob(APP_STATE.currentThumbnail);
            const thumbnailRef = APP_STATE.storage.ref(`thumbnails/${APP_STATE.currentUser.id}/${Date.now()}_thumbnail.jpg`);
            await thumbnailRef.put(thumbnailBlob);
            thumbnailUrl = await thumbnailRef.getDownloadURL();
        }
        
        // Create video document
        const videoRef = await APP_STATE.db.collection('videos').add({
            title: title,
            description: description || '',
            url: APP_STATE.currentVideoUrl,
            thumbnail: thumbnailUrl,
            authorId: APP_STATE.currentUser.id,
            authorName: APP_STATE.currentUser.name,
            authorAvatar: APP_STATE.currentUser.avatar,
            category: category,
            isPublic: isPublic,
            views: 0,
            likes: 0,
            comments: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Add to uploaded videos
        APP_STATE.uploadedVideos.unshift({
            id: videoRef.id,
            title: title,
            thumbnail: thumbnailUrl,
            views: 0,
            likes: 0,
            comments: 0,
            isPublic: isPublic,
            createdAt: new Date()
        });
        
        // Update UI
        loadCreatorStudio();
        
        hideLoading();
        showToast('تم نشر الفيديو بنجاح', 'success');
        document.querySelector('.upload-modal')?.remove();
    } catch (error) {
        console.error('Error publishing video:', error);
        hideLoading();
        showToast('حدث خطأ أثناء نشر الفيديو', 'error');
    }
}

// Convert data URL to Blob
function dataURLtoBlob(dataURL) {
    const arr = dataURL.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    
    return new Blob([u8arr], { type: mime });
}

// Initialize AI services
function initAIServices() {
    if (!APP_STATE.currentUser) return;
    
    // Load AI categories
    loadAICategories();
    
    // Load AI sentiments
    loadAISentiments();
}

// Load AI recommended categories
async function loadAICategories() {
    try {
        const recommendationsDoc = await APP_STATE.db.collection('aiRecommendations')
            .doc(APP_STATE.currentUser.id)
            .get();
        
        if (recommendationsDoc.exists) {
            const data = recommendationsDoc.data();
            APP_STATE.aiCategories = data.categories || [];
            
            // Sort videos by recommendations if videos are loaded
            if (APP_STATE.videos.length > 0) {
                sortVideosByAIRecommendations();
            }
        }
    } catch (error) {
        console.error('Error loading AI categories:', error);
    }
}

// Load AI sentiment analysis
async function loadAISentiments() {
    try {
        const sentimentsDoc = await APP_STATE.db.collection('aiSentiments')
            .doc(APP_STATE.currentUser.id)
            .get();
        
        if (sentimentsDoc.exists) {
            APP_STATE.aiSentiments = sentimentsDoc.data() || {};
        }
    } catch (error) {
        console.error('Error loading AI sentiments:', error);
    }
}

// Initialize service worker
function initServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('ServiceWorker registration successful');
                
                // Check for updates periodically
                setInterval(() => {
                    registration.update();
                }, 60 * 60 * 1000); // Check every hour
            })
            .catch(error => {
                console.log('ServiceWorker registration failed:', error);
            });
    }
}

// Set app theme
function setTheme(isDark) {
    if (isDark) {
        DOM.body.classList.add('dark-theme');
        DOM.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    } else {
        DOM.body.classList.remove('dark-theme');
        DOM.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
    }
}

// Set app language
function setLanguage(lang) {
    document.documentElement.lang = lang;
    // Here you would typically load language strings and update the UI
}

// Show loading state
function showLoading(message = 'جاري التحميل...') {
    const loading = document.createElement('div');
    loading.className = 'fullscreen-loading';
    loading.id = 'appLoading';
    loading.innerHTML = `
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>${message}</p>
        </div>
    `;
    DOM.body.appendChild(loading);
}

// Hide loading state
function hideLoading() {
    document.getElementById('appLoading')?.remove();
}

// Show error state
function showError(message) {
    DOM.videoFeed.innerHTML = `
        <div class="error-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>${message}</p>
            <button class="retry-btn" onclick="loadVideos()">إعادة المحاولة</button>
        </div>
    `;
}

// Show toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'} toast-icon"></i>
        <span>${message}</span>
        <button class="toast-close" aria-label="إغلاق">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    DOM.toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 5000);
    
    toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    });
}

// Show auth modal
function showAuthModal() {
    DOM.authModal.classList.add('active');
    
    // Initialize auth UI if not already initialized
    if (!window.authUI) {
        window.authUI = new firebaseui.auth.AuthUI(firebase.auth());
        
        const uiConfig = {
            signInSuccessUrl: '/',
            signInOptions: [
                firebase.auth.EmailAuthProvider.PROVIDER_ID,
                firebase.auth.PhoneAuthProvider.PROVIDER_ID,
                {
                    provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                    customParameters: {
                        prompt: 'select_account'
                    }
                },
                {
                    provider: firebase.auth.FacebookAuthProvider.PROVIDER_ID,
                    scopes: ['public_profile', 'email']
                }
            ],
            tosUrl: '/terms',
            privacyPolicyUrl: '/privacy',
            credentialHelper: firebaseui.auth.CredentialHelper.NONE,
            signInFlow: 'popup',
            callbacks: {
                signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                    // Handle successful sign-in
                    DOM.authModal.classList.remove('active');
                    return false;
                },
                uiShown: function() {
                    // The widget is rendered
                }
            }
        };
        
        window.authUI.start('#authUIContainer', uiConfig);
    }
}

// Show import modal
function showImportModal() {
    DOM.importModal.classList.add('active');
}

// Close all modals
function closeAllModals() {
    DOM.authModal.classList.remove('active');
    DOM.importModal.classList.remove('active');
    DOM.playerModal.classList.remove('active');
    DOM.commentsModal.classList.remove('active');
}

// Format large numbers
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            func.apply(context, args);
        }, wait);
    };
}

// Throttle function
function throttle(func, limit) {
    let inThrottle;
    return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => (inThrottle = false), limit);
        }
    };
}

// Schedule localStorage update (batches frequent updates)
function scheduleLocalStorageUpdate(key, value) {
    APP_STATE.pendingLocalStorageUpdates[key] = value;
    
    if (APP_STATE.localStorageTimer) {
        clearTimeout(APP_STATE.localStorageTimer);
    }
    
    APP_STATE.localStorageTimer = setTimeout(() => {
        for (const [key, value] of Object.entries(APP_STATE.pendingLocalStorageUpdates)) {
            localStorage.setItem(key, JSON.stringify(value));
        }
        APP_STATE.pendingLocalStorageUpdates = {};
    }, 1000);
}

// Save user preferences to Firestore
async function saveUserPreferences() {
    if (!APP_STATE.currentUser) return;
    
    try {
        await APP_STATE.db.collection('users').doc(APP_STATE.currentUser.id).update({
            preferences: APP_STATE.userPreferences,
            likedVideos: APP_STATE.likedVideos,
            savedVideos: APP_STATE.savedVideos,
            watchedVideos: APP_STATE.watchedVideos,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error saving user preferences:', error);
    }
}

// Handle scroll events
function handleScroll() {
    // Implement scroll-based logic here
    // For example, hide/show header based on scroll direction
}

// Handle resize events
function handleResize() {
    // Implement responsive layout adjustments here
}

// Handle search
function handleSearch() {
    const query = DOM.searchInput.value.trim();
    DOM.clearSearch.style.display = query ? 'block' : 'none';
    
    if (query.length > 2) {
        performSearch(query);
    } else {
        DOM.searchResults.innerHTML = '';
    }
}

// Perform search
async function performSearch(query) {
    try {
        // Search videos
        const videosQuery = APP_STATE.db.collection('videos')
            .where('title', '>=', query)
            .where('title', '<=', query + '\uf8ff')
            .limit(5);
        
        const videosSnapshot = await videosQuery.get();
        APP_STATE.searchResults.videos = [];
        videosSnapshot.forEach(doc => {
            const video = doc.data();
            APP_STATE.searchResults.videos.push({
                id: doc.id,
                title: video.title,
                thumbnail: video.thumbnail,
                author: video.authorName
            });
        });
        
        // Search users
        const usersQuery = APP_STATE.db.collection('users')
            .where('name', '>=', query)
            .where('name', '<=', query + '\uf8ff')
            .limit(5);
        
        const usersSnapshot = await usersQuery.get();
        APP_STATE.searchResults.users = [];
        usersSnapshot.forEach(doc => {
            const user = doc.data();
            APP_STATE.searchResults.users.push({
                id: doc.id,
                name: user.name,
                avatar: user.avatar,
                isCreator: user.isCreator || false
            });
        });
        
        // Search sounds (music)
        const soundsQuery = APP_STATE.db.collection('sounds')
            .where('name', '>=', query)
            .where('name', '<=', query + '\uf8ff')
            .limit(5);
        
        const soundsSnapshot = await soundsQuery.get();
        APP_STATE.searchResults.sounds = [];
        soundsSnapshot.forEach(doc => {
            const sound = doc.data();
            APP_STATE.searchResults.sounds.push({
                id: doc.id,
                name: sound.name,
                author: sound.author,
                cover: sound.cover
            });
        });
        
        // Render search results
        renderSearchResults();
    } catch (error) {
        console.error('Error performing search:', error);
        showToast('حدث خطأ أثناء البحث', 'error');
    }
}

// Render search results
function renderSearchResults() {
    DOM.searchResults.innerHTML = '';
    
    // Videos results
    const videosSection = document.createElement('div');
    videosSection.className = 'result-section active';
    videosSection.id = 'videosResults';
    
    if (APP_STATE.searchResults.videos.length > 0) {
        videosSection.innerHTML = `
            <h4 class="result-title">الفيديوهات</h4>
            <div class="result-grid">
                ${APP_STATE.searchResults.videos.map(video => `
                    <div class="result-item video-result" data-video-id="${video.id}">
                        <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
                        <div class="result-info">
                            <h5>${video.title}</h5>
                            <p>${video.author}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        videosSection.innerHTML = `
            <div class="empty-results">
                <i class="fas fa-film"></i>
                <p>لا توجد فيديوهات مطابقة</p>
            </div>
        `;
    }
    
    // Users results
    const usersSection = document.createElement('div');
    usersSection.className = 'result-section';
    usersSection.id = 'usersResults';
    
    if (APP_STATE.searchResults.users.length > 0) {
        usersSection.innerHTML = `
            <h4 class="result-title">المستخدمون</h4>
            <div class="result-grid">
                ${APP_STATE.searchResults.users.map(user => `
                    <div class="result-item user-result" data-user-id="${user.id}">
                        <img src="${user.avatar}" alt="${user.name}" class="user-avatar" loading="lazy">
                        <div class="result-info">
                            <h5>${user.name}</h5>
                            <p>${user.isCreator ? 'منشئ محتوى' : 'مستخدم'}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        usersSection.innerHTML = `
            <div class="empty-results">
                <i class="fas fa-user"></i>
                <p>لا توجد مستخدمون مطابقون</p>
            </div>
        `;
    }
    
    // Sounds results
    const soundsSection = document.createElement('div');
    soundsSection.className = 'result-section';
    soundsSection.id = 'soundsResults';
    
    if (APP_STATE.searchResults.sounds.length > 0) {
        soundsSection.innerHTML = `
            <h4 class="result-title">الموسيقى</h4>
            <div class="result-grid">
                ${APP_STATE.searchResults.sounds.map(sound => `
                    <div class="result-item sound-result" data-sound-id="${sound.id}">
                        <img src="${sound.cover}" alt="${sound.name}" class="sound-cover" loading="lazy">
                        <div class="result-info">
                            <h5>${sound.name}</h5>
                            <p>${sound.author}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        soundsSection.innerHTML = `
            <div class="empty-results">
                <i class="fas fa-music"></i>
                <p>لا توجد موسيقى مطابقة</p>
            </div>
        `;
    }
    
    DOM.searchResults.appendChild(videosSection);
    DOM.searchResults.appendChild(usersSection);
    DOM.searchResults.appendChild(soundsSection);
    
    // Add click events
    document.querySelectorAll('.video-result').forEach(item => {
        item.addEventListener('click', () => {
            openVideoById(item.dataset.videoId);
            DOM.searchView.style.display = 'none';
            DOM.videoFeed.style.display = 'block';
        });
    });
    
    document.querySelectorAll('.user-result').forEach(item => {
        item.addEventListener('click', () => {
            showCreatorProfile(item.dataset.userId);
            DOM.searchView.style.display = 'none';
        });
    });
    
    document.querySelectorAll('.sound-result').forEach(item => {
        item.addEventListener('click', () => {
            // TODO: Implement sound playback
            showToast('جاري تشغيل الصوت: ' + item.querySelector('h5').textContent, 'info');
        });
    });
    
    // Show search view
    DOM.searchView.style.display = 'block';
    DOM.videoFeed.style.display = 'none';
}

// Load notifications
async function loadNotifications() {
    if (!APP_STATE.currentUser) return;
    
    try {
        const notificationsSnapshot = await APP_STATE.db.collection('users')
            .doc(APP_STATE.currentUser.id)
            .collection('notifications')
            .orderBy('timestamp', 'desc')
            .limit(50)
            .get();
        
        APP_STATE.notifications = [];
        notificationsSnapshot.forEach(doc => {
            APP_STATE.notifications.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        // Mark all as read
        APP_STATE.unseenNotifications = 0;
        updateNotificationBadge();
        
        // Render notifications
        renderNotifications();
    } catch (error) {
        console.error('Error loading notifications:', error);
        showToast('حدث خطأ أثناء تحميل الإشعارات', 'error');
    }
}

// Render notifications
function renderNotifications() {
    DOM.notificationsView.innerHTML = `
        <div class="notifications-header">
            <h2>الإشعارات</h2>
            <button class="text-btn" id="clearNotifications">مسح الكل</button>
        </div>
        <div class="notifications-list" id="notificationsList">
            ${APP_STATE.notifications.length > 0 ? 
                APP_STATE.notifications.map(notification => `
                    <div class="notification-item ${notification.read ? '' : 'unread'}" data-notification-id="${notification.id}">
                        <img src="${notification.senderAvatar || 'https://i.pravatar.cc/150?img=3'}" class="notification-avatar" alt="Sender">
                        <div class="notification-content">
                            <p class="notification-message">${notification.message}</p>
                            <span class="notification-time">${formatTime(notification.timestamp?.toDate())}</span>
                        </div>
                        ${notification.videoId ? `<img src="${notification.videoThumbnail || APP_CONFIG.defaultThumbnail}" class="notification-thumbnail" alt="Video">` : ''}
                    </div>
                `).join('') : `
                <div class="empty-notifications">
                    <i class="fas fa-bell-slash"></i>
                    <p>لا توجد إشعارات</p>
                </div>
            `}
        </div>
    `;
    
    // Add clear notifications button event
    document.getElementById('clearNotifications')?.addEventListener('click', clearAllNotifications);
    
    // Add notification click events
    document.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', () => {
            const notificationId = item.dataset.notificationId;
            const notification = APP_STATE.notifications.find(n => n.id === notificationId);
            
            // Mark as read
            markNotificationAsRead(notificationId);
            
            // Handle notification action
            if (notification.videoId) {
                openVideoById(notification.videoId);
            }
        });
    });
}

// Mark notification as read
async function markNotificationAsRead(notificationId) {
    try {
        await APP_STATE.db.collection('users')
            .doc(APP_STATE.currentUser.id)
            .collection('notifications')
            .doc(notificationId)
            .update({
                read: true
            });
        
        // Update in state
        const notification = APP_STATE.notifications.find(n => n.id === notificationId);
        if (notification) {
            notification.read = true;
        }
        
        // Update UI
        document.querySelector(`.notification-item[data-notification-id="${notificationId}"]`)?.classList.remove('unread');
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

// Clear all notifications
async function clearAllNotifications() {
    try {
        const batch = APP_STATE.db.batch();
        const notificationsRef = APP_STATE.db.collection('users')
            .doc(APP_STATE.currentUser.id)
            .collection('notifications');
        
        const snapshot = await notificationsRef.get();
        snapshot.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        // Update state
        APP_STATE.notifications = [];
        APP_STATE.unseenNotifications = 0;
        
        // Update UI
        renderNotifications();
        updateNotificationBadge();
        
        showToast('تم مسح جميع الإشعارات', 'success');
    } catch (error) {
        console.error('Error clearing notifications:', error);
        showToast('حدث خطأ أثناء مسح الإشعارات', 'error');
    }
}

// Format time (e.g., "منذ ساعة")
function formatTime(date) {
    if (!date) return '';
    
    const now = new Date();
    const diff = now - date;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) {
        return `منذ ${days} يوم`;
    } else if (hours > 0) {
        return `منذ ${hours} ساعة`;
    } else if (minutes > 0) {
        return `منذ ${minutes} دقيقة`;
    }
    return 'الآن';
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
 </script>
 <script>
 // auth.js - منطق المصادقة باستخدام Google فقط

// تهيئة Firebase
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// تهيئة Firebase
firebase.initializeApp(firebaseConfig);

// العناصر DOM
const DOM = {
    authContainer: document.getElementById('authContainer'),
    googleLoginBtn: document.getElementById('googleLoginBtn'),
    authError: document.getElementById('authError'),
    authLoading: document.getElementById('authLoading')
};

// تهيئة المصادقة
function initAuth() {
    // تعيين معالج الأحداث
    setupEventListeners();
    
    // التحقق من حالة المصادقة
    checkAuthState();
}

// تعيين معالج الأحداث
function setupEventListeners() {
    // المصادقة باستخدام جوجل
    DOM.googleLoginBtn.addEventListener('click', loginWithGoogle);
}

// المصادقة باستخدام جوجل
function loginWithGoogle() {
    // إظهار شاشة التحميل
    showLoading();
    
    // إنشاء مزود جوجل
    const provider = new firebase.auth.GoogleAuthProvider();
    
    // إضافة نطاقات إضافية إذا لزم الأمر
    provider.addScope('profile');
    provider.addScope('email');
    
    // تسجيل الدخول
    firebase.auth().signInWithPopup(provider)
        .then((result) => {
            // تسجيل الدخول الناجح
            handleSuccessfulAuth(result.user);
            
            // حفظ معلومات إضافية إذا كان المستخدم جديداً
            if (result.additionalUserInfo?.isNewUser) {
                saveAdditionalUserData(result.user.uid, {
                    name: result.user.displayName,
                    email: result.user.email,
                    photoURL: result.user.photoURL,
                    provider: 'google.com',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        })
        .catch((error) => {
            // معالجة الأخطاء
            handleAuthError(error);
        })
        .finally(() => {
            // إخفاء شاشة التحميل
            hideLoading();
        });
}

// حفظ بيانات إضافية للمستخدم في Firestore
function saveAdditionalUserData(userId, data) {
    return firebase.firestore().collection('users').doc(userId).set(data, { merge: true });
}

// التحقق من حالة المصادقة
function checkAuthState() {
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // المستخدم مسجل الدخول
            handleSuccessfulAuth(user);
        } else {
            // لا يوجد مستخدم مسجل الدخول
            handleSignOut();
        }
    });
}

// معالجة تسجيل الدخول الناجح
function handleSuccessfulAuth(user) {
    // إخفاء رسائل الخطأ
    hideError();
    
    // حفظ بيانات الجلسة
    sessionStorage.setItem('authUser', JSON.stringify({
        uid: user.uid,
        name: user.displayName,
        email: user.email,
        photoURL: user.photoURL,
        provider: user.providerData[0].providerId
    }));
    
    // التوجيه إلى الصفحة الرئيسية
    window.location.href = '/dashboard';
}

// معالجة تسجيل الخروج
function handleSignOut() {
    // مسح بيانات الجلسة
    sessionStorage.removeItem('authUser');
}

// معالجة أخطاء المصادقة
function handleAuthError(error) {
    let errorMessage = 'حدث خطأ أثناء المصادقة';
    
    switch (error.code) {
        case 'auth/popup-closed-by-user':
            errorMessage = 'تم إغلاق نافذة المصادقة';
            break;
        case 'auth/cancelled-popup-request':
            errorMessage = 'تم إلغاء طلب المصادقة';
            break;
        case 'auth/popup-blocked':
            errorMessage = 'تم حظر نافذة المصادقة، الرجاء السماح بالنوافذ المنبثقة';
            break;
        case 'auth/account-exists-with-different-credential':
            errorMessage = 'يوجد حساب آخر بنفس البريد الإلكتروني';
            break;
        default:
            errorMessage = error.message || 'حدث خطأ غير متوقع';
    }
    
    showError(errorMessage);
}

// إظهار رسالة خطأ
function showError(message) {
    DOM.authError.textContent = message;
    DOM.authError.classList.add('show');
}

// إخفاء رسالة الخطأ
function hideError() {
    DOM.authError.classList.remove('show');
}

// إظهار شاشة التحميل
function showLoading() {
    DOM.authLoading.classList.add('show');
    DOM.googleLoginBtn.disabled = true;
}

// إخفاء شاشة التحميل
function hideLoading() {
    DOM.authLoading.classList.remove('show');
    DOM.googleLoginBtn.disabled = false;
}

// تسجيل الخروج
function signOut() {
    firebase.auth().signOut().then(() => {
        handleSignOut();
        window.location.href = '/login';
    }).catch((error) => {
        console.error('Error signing out:', error);
    });
}

// تهيئة المصادقة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', initAuth);

// تصدير الدوال اللازمة للاستخدام في ملفات أخرى
export {
    signOut,
    checkAuthState,
    getCurrentUser: () => JSON.parse(sessionStorage.getItem('authUser'))
};
 </script>
 <script>
 // assets/js/notifications.js

// 1. تهيئة نظام الإشعارات
class NotificationSystem {
    constructor() {
        this.notifications = [];
        this.unreadCount = 0;
        this.notificationSound = new Audio('/assets/sounds/notification.mp3');
        this.init();
    }

    // 2. تهيئة النظام
    async init() {
        this.setupUI();
        await this.checkPermission();
        this.setupFirebase();
        this.loadNotifications();
        this.setupEventListeners();
    }

    // 3. إعداد واجهة المستخدم
    setupUI() {
        this.notificationBell = document.getElementById('notificationsBtn');
        this.notificationBadge = document.createElement('span');
        this.notificationBadge.className = 'notification-badge';
        this.notificationBell.appendChild(this.notificationBadge);
        
        this.notificationPanel = document.createElement('div');
        this.notificationPanel.className = 'notification-panel';
        this.notificationPanel.innerHTML = `
            <div class="notification-header">
                <h3>الإشعارات</h3>
                <button class="mark-all-read">تعيين الكل كمقروء</button>
            </div>
            <div class="notification-list"></div>
        `;
        document.body.appendChild(this.notificationPanel);
    }

    // 4. التحقق من أذونات الإشعارات
    async checkPermission() {
        if (!('Notification' in window)) {
            console.warn('هذا المتصفح لا يدعم إشعارات الويب');
            return false;
        }

        if (Notification.permission === 'granted') {
            return true;
        } else if (Notification.permission !== 'denied') {
            const permission = await Notification.requestPermission();
            return permission === 'granted';
        }
        return false;
    }

    // 5. إعداد Firebase Cloud Messaging
    setupFirebase() {
        if (!firebase.messaging.isSupported()) return;

        const messaging = firebase.messaging();
        
        // تسجيل الخدمة
        messaging.getToken({ vapidKey: 'YOUR_VAPID_KEY' }).then((currentToken) => {
            if (currentToken) {
                this.saveToken(currentToken);
            } else {
                console.log('لا يوجد رمز، تحتاج إلى طلب الإذن');
            }
        }).catch((err) => {
            console.log('حدث خطأ أثناء استرجاع الرمز:', err);
        });

        // معالجة الرسائل الواردة
        messaging.onMessage((payload) => {
            this.handleIncomingNotification(payload.notification);
        });

        // تحديث الرمز عند التغيير
        messaging.onTokenRefresh(() => {
            messaging.getToken().then((refreshedToken) => {
                this.saveToken(refreshedToken);
            }).catch((err) => {
                console.log('حدث خطأ أثناء تحديث الرمز:', err);
            });
        });
    }

    // 6. حفظ رمز الجهاز
    saveToken(token) {
        const userId = firebase.auth().currentUser?.uid;
        if (!userId) return;

        firebase.firestore().collection('users').doc(userId).update({
            fcmTokens: firebase.firestore.FieldValue.arrayUnion(token)
        }).catch(() => {
            firebase.firestore().collection('users').doc(userId).set({
                fcmTokens: [token]
            });
        });
    }

    // 7. تحميل الإشعارات
    async loadNotifications() {
        const userId = firebase.auth().currentUser?.uid;
        if (!userId) return;

        try {
            const snapshot = await firebase.firestore()
                .collection('notifications')
                .doc(userId)
                .collection('userNotifications')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();

            this.notifications = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    timestamp: data.timestamp.toDate()
                };
            });

            this.updateUnreadCount();
            this.renderNotifications();
        } catch (error) {
            console.error('حدث خطأ أثناء تحميل الإشعارات:', error);
        }
    }

    // 8. معالجة الإشعارات الواردة
    handleIncomingNotification(notification) {
        const newNotification = {
            id: `push-${Date.now()}`,
            title: notification.title,
            body: notification.body,
            type: notification.type || 'general',
            read: false,
            timestamp: new Date(),
            data: notification.data || {}
        };

        this.notifications.unshift(newNotification);
        this.updateUnreadCount();
        this.renderNotifications();
        this.playNotificationSound();

        // عرض إشعار نظام إذا كانت الصفحة غير نشطة
        if (document.visibilityState !== 'visible') {
            this.showSystemNotification(newNotification);
        }
    }

    // 9. عرض إشعار النظام
    showSystemNotification(notification) {
        if (!('Notification' in window)) return;

        const options = {
            body: notification.body,
            icon: '/assets/icons/icon-192x192.png',
            data: notification.data
        };

        new Notification(notification.title, options).onclick = (event) => {
            this.handleNotificationClick(notification.data);
            event.target.close();
        };
    }

    // 10. تشغيل صوت الإشعار
    playNotificationSound() {
        if (this.notificationSound) {
            this.notificationSound.currentTime = 0;
            this.notificationSound.play().catch(e => console.log('تعذر تشغيل صوت الإشعار:', e));
        }
    }

    // 11. تحديث عداد الإشعارات غير المقروءة
    updateUnreadCount() {
        this.unreadCount = this.notifications.filter(n => !n.read).length;
        this.notificationBadge.textContent = this.unreadCount > 0 ? this.unreadCount : '';
        this.notificationBadge.style.display = this.unreadCount > 0 ? 'block' : 'none';
    }

    // 12. عرض الإشعارات في الواجهة
    renderNotifications() {
        const list = this.notificationPanel.querySelector('.notification-list');
        list.innerHTML = '';

        if (this.notifications.length === 0) {
            list.innerHTML = '<p class="no-notifications">لا توجد إشعارات جديدة</p>';
            return;
        }

        this.notifications.forEach(notification => {
            const notificationElement = document.createElement('div');
            notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
            notificationElement.dataset.id = notification.id;
            
            notificationElement.innerHTML = `
                <div class="notification-icon">
                    ${this.getNotificationIcon(notification.type)}
                </div>
                <div class="notification-content">
                    <h4>${notification.title}</h4>
                    <p>${notification.body}</p>
                    <small>${this.formatTime(notification.timestamp)}</small>
                </div>
            `;
            
            notificationElement.addEventListener('click', () => {
                this.handleNotificationClick(notification.data);
                if (!notification.read) {
                    this.markAsRead(notification.id);
                }
            });
            
            list.appendChild(notificationElement);
        });
    }

    // 13. الحصول على أيقونة حسب نوع الإشعار
    getNotificationIcon(type) {
        const icons = {
            'like': '<i class="fas fa-heart"></i>',
            'comment': '<i class="fas fa-comment"></i>',
            'follow': '<i class="fas fa-user-plus"></i>',
            'mention': '<i class="fas fa-at"></i>',
            'system': '<i class="fas fa-bell"></i>',
            'default': '<i class="fas fa-bell"></i>'
        };
        return icons[type] || icons['default'];
    }

    // 14. تنسيق الوقت
    formatTime(date) {
        const now = new Date();
        const diff = now - date;
        
        const minute = 60 * 1000;
        const hour = minute * 60;
        const day = hour * 24;
        
        if (diff < minute) return 'الآن';
        if (diff < hour) return `${Math.floor(diff / minute)} دقيقة مضت`;
        if (diff < day) return `${Math.floor(diff / hour)} ساعة مضت`;
        return `${Math.floor(diff / day)} يوم مضى`;
    }

    // 15. معالجة النقر على الإشعار
    handleNotificationClick(data) {
        if (data.videoId) {
            // افتح الفيديو المحدد
            window.location.href = `/video.html?id=${data.videoId}`;
        } else if (data.userId) {
            // افتح صفحة المستخدم
            window.location.href = `/profile.html?id=${data.userId}`;
        }
        // يمكن إضافة المزيد من الإجراءات حسب الحاجة
    }

    // 16. تعليم الإشعار كمقروء
    async markAsRead(notificationId) {
        const notification = this.notifications.find(n => n.id === notificationId);
        if (!notification || notification.read) return;

        notification.read = true;
        this.updateUnreadCount();
        this.renderNotifications();

        // تحديث في Firestore إذا كان إشعارًا مخزنًا
        if (!notificationId.startsWith('push-')) {
            const userId = firebase.auth().currentUser?.uid;
            if (!userId) return;

            try {
                await firebase.firestore()
                    .collection('notifications')
                    .doc(userId)
                    .collection('userNotifications')
                    .doc(notificationId)
                    .update({ read: true });
            } catch (error) {
                console.error('حدث خطأ أثناء تحديث حالة الإشعار:', error);
            }
        }
    }

    // 17. تعليم الكل كمقروء
    async markAllAsRead() {
        this.notifications.forEach(n => n.read = true);
        this.updateUnreadCount();
        this.renderNotifications();

        const userId = firebase.auth().currentUser?.uid;
        if (!userId) return;

        try {
            const batch = firebase.firestore().batch();
            const notificationsRef = firebase.firestore()
                .collection('notifications')
                .doc(userId)
                .collection('userNotifications')
                .where('read', '==', false);

            const snapshot = await notificationsRef.get();
            snapshot.forEach(doc => {
                batch.update(doc.ref, { read: true });
            });

            await batch.commit();
        } catch (error) {
            console.error('حدث خطأ أثناء تحديث جميع الإشعارات:', error);
        }
    }

    // 18. إعداد مستمعي الأحداث
    setupEventListeners() {
        // فتح/إغلاق لوحة الإشعارات
        this.notificationBell.addEventListener('click', (e) => {
            e.stopPropagation();
            this.notificationPanel.style.display = 
                this.notificationPanel.style.display === 'block' ? 'none' : 'block';
        });

        // إغلاق لوحة الإشعارات عند النقر خارجها
        document.addEventListener('click', (e) => {
            if (!this.notificationPanel.contains(e.target) {
                this.notificationPanel.style.display = 'none';
            }
        });

        // تعليم الكل كمقروء
        this.notificationPanel.querySelector('.mark-all-read').addEventListener('click', () => {
            this.markAllAsRead();
        });

        // تحديث الإشعارات عند تسجيل الدخول
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                this.loadNotifications();
            } else {
                this.notifications = [];
                this.unreadCount = 0;
                this.updateUnreadCount();
                this.renderNotifications();
            }
        });
    }
}

// 19. تهيئة النظام عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('notificationsBtn')) {
        const notificationSystem = new NotificationSystem();
        
        // جعل النظام متاحًا عالميًا للاستخدام من ملفات أخرى
        window.NotificationSystem = notificationSystem;
    }
});

// 20. دالة مساعدة لإرسال إشعارات (للاستخدام في أجزاء أخرى من التطبيق)
export async function sendNotification(toUserId, notificationData) {
    try {
        await firebase.firestore()
            .collection('notifications')
            .doc(toUserId)
            .collection('userNotifications')
            .add({
                ...notificationData,
                read: false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        return true;
    } catch (error) {
        console.error('حدث خطأ أثناء إرسال الإشعار:', error);
        return false;
    }
}
 </script>
 <script>
 // assets/js/ai.js

class AISystem {
    constructor() {
        this.userPreferences = {};
        this.watchHistory = [];
        this.interactionHistory = [];
        this.recommendations = [];
        this.isInitialized = false;
    }

    async init() {
        if (this.isInitialized) return;

        await this.loadUserData();
        this.setupEventListeners();
        this.isInitialized = true;
        
        // تحميل نموذج الذكاء الاصطناعي عند الحاجة
        if (this.shouldLoadAIModel()) {
            await this.loadAIModel();
        }
    }

    async loadUserData() {
        try {
            const userId = firebase.auth().currentUser?.uid;
            if (!userId) return;

            // تحميل تفضيلات المستخدم
            const userPrefs = await firebase.firestore()
                .collection('users')
                .doc(userId)
                .get();
            
            this.userPreferences = userPrefs.data()?.preferences || {};
            
            // تحميل سجل المشاهدة
            const watchSnap = await firebase.firestore()
                .collection('users')
                .doc(userId)
                .collection('watchHistory')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get();
            
            this.watchHistory = watchSnap.docs.map(doc => doc.data());
            
            // تحميل سجل التفاعلات
            const interactSnap = await firebase.firestore()
                .collection('users')
                .doc(userId)
                .collection('interactions')
                .orderBy('timestamp', 'desc')
                .limit(200)
                .get();
            
            this.interactionHistory = interactSnap.docs.map(doc => doc.data());
            
            console.log('تم تحميل بيانات المستخدم للذكاء الاصطناعي');
        } catch (error) {
            console.error('حدث خطأ أثناء تحميل بيانات المستخدم:', error);
        }
    }

    setupEventListeners() {
        // تتبع مشاهدات الفيديو
        document.addEventListener('videoPlay', (e) => {
            this.recordVideoWatch(e.detail.videoId, e.detail.duration);
        });

        // تتبع التفاعلات
        document.addEventListener('videoLike', (e) => {
            this.recordInteraction({
                type: 'like',
                videoId: e.detail.videoId,
                value: e.detail.isLiked ? 1 : -1
            });
        });

        document.addEventListener('videoShare', (e) => {
            this.recordInteraction({
                type: 'share',
                videoId: e.detail.videoId
            });
        });

        document.addEventListener('commentPosted', (e) => {
            this.recordInteraction({
                type: 'comment',
                videoId: e.detail.videoId,
                text: e.detail.text
            });
        });
    }

    async loadAIModel() {
        try {
            // هنا يمكنك تحميل نماذج TensorFlow.js أو استخدام واجهات برمجة التطبيقات الخارجية
            console.log('جاري تحميل نموذج الذكاء الاصطناعي...');
            
            // مثال: تحميل نموذج توصية
            // this.model = await tf.loadLayersModel('/models/recommendation/model.json');
            
            console.log('تم تحميل نموذج الذكاء الاصطناعي بنجاح');
            return true;
        } catch (error) {
            console.error('حدث خطأ أثناء تحميل نموذج الذكاء الاصطناعي:', error);
            return false;
        }
    }

    shouldLoadAIModel() {
        // يمكنك إضافة شروط محددة لتحميل النموذج عند الحاجة
        return this.watchHistory.length > 5;
    }

    async recordVideoWatch(videoId, duration) {
        const userId = firebase.auth().currentUser?.uid;
        if (!userId) return;

        try {
            // تسجيل المشاهدة محليًا
            this.watchHistory.unshift({
                videoId,
                duration,
                timestamp: new Date()
            });

            // تسجيل المشاهدة في Firestore
            await firebase.firestore()
                .collection('users')
                .doc(userId)
                .collection('watchHistory')
                .add({
                    videoId,
                    duration,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

            // تحديث التوصيات
            this.updateRecommendations();
        } catch (error) {
            console.error('حدث خطأ أثناء تسجيل مشاهدة الفيديو:', error);
        }
    }

    async recordInteraction(interaction) {
        const userId = firebase.auth().currentUser?.uid;
        if (!userId) return;

        try {
            // تسجيل التفاعل محليًا
            this.interactionHistory.unshift({
                ...interaction,
                timestamp: new Date()
            });

            // تسجيل التفاعل في Firestore
            await firebase.firestore()
                .collection('users')
                .doc(userId)
                .collection('interactions')
                .add({
                    ...interaction,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

            // تحديث التوصيات بناءً على التفاعل الجديد
            this.updateRecommendations();
        } catch (error) {
            console.error('حدث خطأ أثناء تسجيل التفاعل:', error);
        }
    }

    async updateRecommendations() {
        try {
            // الحصول على توصيات من السحابة (Firebase Functions)
            const getRecommendations = firebase.functions().httpsCallable('getRecommendations');
            const response = await getRecommendations({
                userId: firebase.auth().currentUser?.uid,
                history: this.watchHistory.slice(0, 20),
                interactions: this.interactionHistory.slice(0, 50)
            });

            this.recommendations = response.data.recommendations;
            this.triggerRecommendationsUpdate();
        } catch (error) {
            console.error('حدث خطأ أثناء تحديث التوصيات:', error);
            
            // استخدام خوارزمية بديلة إذا فشل الاتصال
            this.generateLocalRecommendations();
        }
    }

    generateLocalRecommendations() {
        // خوارزمية توصية مبسطة تعمل على الجهاز
        const watchedCategories = this.getTopCategories();
        const likedCreators = this.getTopCreators();
        
        // هنا يمكنك إضافة منطق التوصية المحلي
        // هذا مثال مبسط فقط
        this.recommendations = [
            {videoId: 'rec1', score: 0.9, reason: 'بناءً على مشاهداتك السابقة'},
            {videoId: 'rec2', score: 0.85, reason: 'من صناع المحتوى الذين تتابعهم'},
            {videoId: 'rec3', score: 0.8, reason: 'الأكثر شهرة اليوم'}
        ];
        
        this.triggerRecommendationsUpdate();
    }

    getTopCategories(limit = 3) {
        const categoryCounts = {};
        
        this.watchHistory.forEach(item => {
            const category = item.category || 'general';
            categoryCounts[category] = (categoryCounts[category] || 0) + 1;
        });
        
        return Object.entries(categoryCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, limit)
            .map(item => item[0]);
    }

    getTopCreators(limit = 5) {
        const creatorCounts = {};
        
        this.interactionHistory.forEach(item => {
            if (item.creatorId) {
                creatorCounts[item.creatorId] = (creatorCounts[item.creatorId] || 0) + 
                    (item.type === 'like' ? (item.value > 0 ? 2 : -1) : 1);
            }
        });
        
        return Object.entries(creatorCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, limit)
            .map(item => item[0]);
    }

    triggerRecommendationsUpdate() {
        const event = new CustomEvent('recommendationsUpdated', {
            detail: { recommendations: this.recommendations }
        });
        document.dispatchEvent(event);
    }

    async analyzeVideoContent(videoUrl) {
        try {
            // استخدام واجهة برمجة التطبيقات لتحليل محتوى الفيديو
            const analyzeVideo = firebase.functions().httpsCallable('analyzeVideo');
            const response = await analyzeVideo({ videoUrl });
            
            return response.data;
        } catch (error) {
            console.error('حدث خطأ أثناء تحليل محتوى الفيديو:', error);
            return this.basicVideoAnalysis(videoUrl);
        }
    }

    basicVideoAnalysis(videoUrl) {
        // تحليل أساسي يعمل على الجهاز
        return {
            safe: true,
            categories: ['general'],
            tags: [],
            thumbnail: this.generateThumbnail(videoUrl)
        };
    }

    generateThumbnail(videoUrl) {
        // إنشاء ثومبنييل من الفيديو (هذا مثال فقط)
        return videoUrl.replace('.mp4', '.jpg');
    }

    async generateCaptions(videoUrl) {
        try {
            // استخدام خدمة توليد الترجمة
            const generateCaptions = firebase.functions().httpsCallable('generateCaptions');
            const response = await generateCaptions({ videoUrl });
            
            return response.data.captions;
        } catch (error) {
            console.error('حدث خطأ أثناء توليد الترجمة:', error);
            return [];
        }
    }

    async moderateContent(text) {
        try {
            // استخدام خدمة التحقق من المحتوى
            const moderateText = firebase.functions().httpsCallable('moderateText');
            const response = await moderateText({ text });
            
            return response.data;
        } catch (error) {
            console.error('حدث خطأ أثناء مراجعة المحتوى:', error);
            return { safe: true, reasons: [] };
        }
    }

    async personalizeForYouFeed() {
        if (this.recommendations.length === 0) {
            await this.updateRecommendations();
        }
        
        // ترتيب الفيديوهات بناءً على التوصيات
        return this.recommendations
            .sort((a, b) => b.score - a.score)
            .map(item => item.videoId);
    }

    async getTrendingVideos() {
        try {
            const response = await firebase.functions().httpsCallable('getTrendingVideos')({
                userId: firebase.auth().currentUser?.uid,
                preferences: this.userPreferences
            });
            
            return response.data.videos;
        } catch (error) {
            console.error('حدث خطأ أثناء جلب الفيديوهات الرائجة:', error);
            return [];
        }
    }

    async suggestFollows() {
        const topCreators = this.getTopCreators();
        
        try {
            const response = await firebase.functions().httpsCallable('suggestFollows')({
                userId: firebase.auth().currentUser?.uid,
                likedCreators: topCreators
            });
            
            return response.data.suggestions;
        } catch (error) {
            console.error('حدث خطأ أثناء اقتراح المتابعات:', error);
            return [];
        }
    }
}

// تهيئة نظام الذكاء الاصطناعي
const aiSystem = new AISystem();

// تصدير الدوال للاستخدام في ملفات أخرى
export {
    aiSystem,
    AISystem
};

// تهيئة النظام عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            aiSystem.init();
        }
    });
});
 </script>
 <script>
 // assets/js/offline.js

// 1. تسجيل Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('ServiceWorker registered:', registration.scope);
            })
            .catch(error => {
                console.log('ServiceWorker registration failed:', error);
            });
    });
}

// 2. إعداد كاش التطبيق
const CACHE_NAME = 'qasir-offline-v1';
const OFFLINE_URL = '/offline.html';
const ASSETS_TO_CACHE = [
    '/',
    '/index.html',
    '/app.html',
    '/assets/css/main.css',
    '/assets/css/auth.css',
    '/assets/js/app.js',
    '/assets/js/auth.js',
    '/assets/js/video.js',
    '/assets/images/logo.svg',
    '/assets/images/offline-illustration.svg',
    '/manifest.webmanifest'
];

// 3. تنصيب Service Worker
self.addEventListener('install', event => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then(cache => {
                console.log('Caching assets for offline use');
                return cache.addAll(ASSETS_TO_CACHE);
            })
            .then(() => self.skipWaiting())
    );
});

// 4. تفعيل Service Worker
self.addEventListener('activate', event => {
    event.waitUntil(
        caches.keys().then(cacheNames => {
            return Promise.all(
                cacheNames.map(cacheName => {
                    if (cacheName !== CACHE_NAME) {
                        console.log('Deleting old cache:', cacheName);
                        return caches.delete(cacheName);
                    }
                })
            );
        })
    );
    event.waitUntil(self.clients.claim());
});

// 5. إستراتيجية التخزين المؤقت (Cache First with Network Fallback)
self.addEventListener('fetch', event => {
    // تجاهل طلبات POST وطلبات أخرى غير GET
    if (event.request.method !== 'GET') return;

    // معالجة طلبات الصفحات
    if (event.request.mode === 'navigate') {
        event.respondWith(
            fetch(event.request)
                .catch(() => caches.match(OFFLINE_URL))
        );
        return;
    }

    // معالجة طلبات الأصول الأخرى
    event.respondWith(
        caches.match(event.request)
            .then(cachedResponse => {
                const fetchPromise = fetch(event.request)
                    .then(networkResponse => {
                        // تحديث الكاش مع النسخة الجديدة من المورد
                        caches.open(CACHE_NAME)
                            .then(cache => cache.put(event.request, networkResponse.clone()));
                        return networkResponse;
                    })
                    .catch(() => {
                        // إذا فشل الاتصال بالإنترنت
                        if (cachedResponse) {
                            return cachedResponse;
                        }
                    });
                return cachedResponse || fetchPromise;
            })
    );
});

// 6. اكتشاف حالة الاتصال
const updateOnlineStatus = () => {
    const connectionBanner = document.getElementById('connectionBanner');
    if (navigator.onLine) {
        connectionBanner.style.display = 'none';
        console.log('Connection restored');
    } else {
        connectionBanner.style.display = 'flex';
        console.log('Connection lost - Offline mode activated');
    }
};

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// 7. تخزين الفيديوهات مؤقتًا للعرض بدون اتصال
const videoCache = {
    init: async () => {
        this.cache = await caches.open('videos-cache');
    },

    storeVideo: async (videoId, videoData) => {
        const url = `/api/videos/${videoId}`;
        const response = new Response(JSON.stringify(videoData), {
            headers: { 'Content-Type': 'application/json' }
        });
        await this.cache.put(url, response);
    },

    getVideo: async (videoId) => {
        const url = `/api/videos/${videoId}`;
        const response = await this.cache.match(url);
        return response ? response.json() : null;
    },

    getAllVideos: async () => {
        const keys = await this.cache.keys();
        const videoRequests = keys.filter(request => request.url.includes('/api/videos/'));
        return Promise.all(videoRequests.map(request => this.cache.match(request).then(res => res.json())));
    }
};

// 8. تهيئة التطبيق للعمل بدون اتصال
const initOfflineMode = () => {
    // التحقق من حالة الاتصال عند التحميل
    updateOnlineStatus();
    
    // تهيئة كاش الفيديوهات
    videoCache.init();
    
    // اعتراض طلبات API للعمل بدون اتصال
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
            if (registration.active) {
                console.log('Service Worker ready for offline use');
            }
        });
    }
    
    // عرض رسالة عند محاولة رفع فيديو بدون اتصال
    document.getElementById('importBtn').addEventListener('click', () => {
        if (!navigator.onLine) {
            alert('لا يمكن استيراد الفيديوهات بدون اتصال بالإنترنت');
            return false;
        }
    });
};

// 9. تصدير الدوال للاستخدام في الملفات الأخرى
export { initOfflineMode, videoCache };
 </script>
 <script>
 // assets/js/linkValidation.js

class LinkValidator {
    constructor() {
        this.allowedDomains = [
            'youtube.com',
            'youtu.be',
            'vimeo.com',
            'dailymotion.com',
            'tiktok.com',
            'instagram.com',
            'example.com' // استبدله بالنطاقات المسموحة في تطبيقك
        ];
        
        this.whitelist = [];
        this.blacklist = [];
        this.suspiciousPatterns = [
            /(?:phishing|malware|scam|spam)/i,
            /\.exe$|\.js$|\.jar$|\.bat$/i,
            /[\u0590-\u05FF]/ // حروف عبرية للكشف عن روابط احتيالية
        ];
        
        this.init();
    }

    async init() {
        await this.loadDomainLists();
        this.setupEventListeners();
    }

    async loadDomainLists() {
        try {
            // تحميل القوائم من Firestore أو ملف محلي
            const snapshot = await firebase.firestore()
                .collection('securitySettings')
                .doc('linkValidation')
                .get();
            
            const data = snapshot.data();
            this.whitelist = data?.whitelist || [];
            this.blacklist = data?.blacklist || [];
            
            console.log('تم تحميل قوائم التحقق من الروابط');
        } catch (error) {
            console.error('حدث خطأ أثناء تحميل قوائم التحقق:', error);
        }
    }

    setupEventListeners() {
        // التحقق من الروابط عند إدخالها في النماذج
        document.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                this.detectAndValidateLinks(e.target);
            }
        });

        // التحقق من الروابط قبل إرسال النماذج
        document.addEventListener('submit', (e) => {
            const links = this.extractLinksFromForm(e.target);
            const validation = this.validateMultipleLinks(links);
            
            if (!validation.allValid) {
                e.preventDefault();
                this.showLinkValidationAlert(validation);
            }
        });
    }

    detectAndValidateLinks(element) {
        const text = element.value;
        const links = this.extractLinks(text);
        
        links.forEach(link => {
            const result = this.validateLink(link);
            if (!result.valid) {
                this.highlightInvalidLink(element, link, result.reason);
            }
        });
    }

    extractLinksFromForm(form) {
        const links = [];
        const inputs = form.querySelectorAll('input, textarea');
        
        inputs.forEach(input => {
            links.push(...this.extractLinks(input.value));
        });
        
        return links;
    }

    extractLinks(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.match(urlRegex) || [];
    }

    validateMultipleLinks(links) {
        const results = {
            allValid: true,
            invalidLinks: []
        };
        
        links.forEach(link => {
            const validation = this.validateLink(link);
            if (!validation.valid) {
                results.allValid = false;
                results.invalidLinks.push({
                    link,
                    reason: validation.reason
                });
            }
        });
        
        return results;
    }

    validateLink(url) {
        try {
            // 1. التحقق من الشكل العام للرابط
            const parsedUrl = new URL(url);
            
            // 2. التحقق من النطاقات المسموحة
            const domainValid = this.allowedDomains.some(domain => 
                parsedUrl.hostname.includes(domain)
            );
            
            if (!domainValid) {
                return {
                    valid: false,
                    reason: 'النطاق غير مسموح به',
                    domain: parsedUrl.hostname
                };
            }
            
            // 3. التحقق من القائمة السوداء
            if (this.blacklist.some(blackDomain => 
                parsedUrl.hostname.includes(blackDomain))
            ) {
                return {
                    valid: false,
                    reason: 'النطاق محظور',
                    domain: parsedUrl.hostname
                };
            }
            
            // 4. التحقق من الأنماط المشبوهة
            const suspicious = this.suspiciousPatterns.some(pattern => 
                pattern.test(url)
            );
            
            if (suspicious) {
                return {
                    valid: false,
                    reason: 'الرابط يحتوي على أنماط مشبوهة',
                    domain: parsedUrl.hostname
                };
            }
            
            // 5. التحقق من القائمة البيضاء (إذا كانت غير فارغة)
            if (this.whitelist.length > 0 && !this.whitelist.some(whiteDomain => 
                parsedUrl.hostname.includes(whiteDomain))
            ) {
                return {
                    valid: false,
                    reason: 'النطاق غير موجود في القائمة البيضاء',
                    domain: parsedUrl.hostname
                };
            }
            
            // 6. التحقق من HTTPS (اختياري)
            if (parsedUrl.protocol !== 'https:') {
                return {
                    valid: false,
                    reason: 'يجب استخدام رابط آمن (HTTPS)',
                    domain: parsedUrl.hostname
                };
            }
            
            return { valid: true };
            
        } catch (e) {
            return {
                valid: false,
                reason: 'رابط غير صالح',
                domain: ''
            };
        }
    }

    highlightInvalidLink(element, link, reason) {
        // يمكنك تخصيص هذه الدالة لتظهر تحذيرات في الواجهة
        const errorSpan = document.createElement('span');
        errorSpan.className = 'link-validation-error';
        errorSpan.textContent = `تحذير: ${reason} - ${link}`;
        errorSpan.style.color = 'red';
        errorSpan.style.display = 'block';
        errorSpan.style.fontSize = '12px';
        
        element.parentNode.insertBefore(errorSpan, element.nextSibling);
        
        // إزالة التحذير بعد 5 ثواني
        setTimeout(() => {
            errorSpan.remove();
        }, 5000);
    }

    showLinkValidationAlert(validation) {
        const alertBox = document.createElement('div');
        alertBox.className = 'link-validation-alert';
        alertBox.style.position = 'fixed';
        alertBox.style.top = '20px';
        alertBox.style.right = '20px';
        alertBox.style.backgroundColor = '#ffebee';
        alertBox.style.border = '1px solid #f44336';
        alertBox.style.borderRadius = '4px';
        alertBox.style.padding = '15px';
        alertBox.style.zIndex = '10000';
        alertBox.style.maxWidth = '400px';
        
        let alertContent = `
            <h3 style="margin-top: 0; color: #d32f2f;">تحذير: روابط غير صالحة</h3>
            <p>يحتوي النموذج على الروابط التالية التي لا تلبي شروط الأمان:</p>
            <ul style="padding-left: 20px;">
        `;
        
        validation.invalidLinks.forEach(item => {
            alertContent += `<li><strong>${item.link}</strong>: ${item.reason}</li>`;
        });
        
        alertContent += `
            </ul>
            <p>الرجاء إزالة أو تصحيح هذه الروابط قبل الإرسال.</p>
            <button id="dismissAlert" style="
                background: #d32f2f;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
            ">حسنًا</button>
        `;
        
        alertBox.innerHTML = alertContent;
        document.body.appendChild(alertBox);
        
        alertBox.querySelector('#dismissAlert').addEventListener('click', () => {
            alertBox.remove();
        });
    }

    async checkLinkSafety(url) {
        try {
            // استخدام Safe Browsing API من Google (يتطلب مفتاح API)
            const apiKey = 'YOUR_GOOGLE_API_KEY'; // استبدله بمفتاحك
            const apiUrl = `https://safebrowsing.googleapis.com/v4/threatMatches:find?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client: {
                        clientId: "your-app-id",
                        clientVersion: "1.0"
                    },
                    threatInfo: {
                        threatTypes: ["MALWARE", "SOCIAL_ENGINEERING", "UNWANTED_SOFTWARE"],
                        platformTypes: ["ANY_PLATFORM"],
                        threatEntryTypes: ["URL"],
                        threatEntries: [{url}]
                    }
                })
            });
            
            const data = await response.json();
            return data.matches ? {safe: false, threats: data.matches} : {safe: true};
            
        } catch (error) {
            console.error('Error checking link safety:', error);
            return {safe: false, error: 'Failed to check link'};
        }
    }

    async shortenLink(url) {
        try {
            // تقصير الروابط باستخدام Firebase Dynamic Links
            const shortenUrl = firebase.functions().httpsCallable('shortenUrl');
            const result = await shortenUrl({url});
            return result.data.shortUrl;
        } catch (error) {
            console.error('Error shortening URL:', error);
            return url; // إرجاع الرابط الأصلي في حالة الخطأ
        }
    }

    extractDomain(url) {
        try {
            const parsed = new URL(url);
            return parsed.hostname.replace('www.', '');
        } catch {
            return null;
        }
    }

    isInternalLink(url) {
        const domain = this.extractDomain(url);
        return domain && (domain === window.location.hostname);
    }
}

// تهيئة النظام عند تحميل الصفحة
const linkValidator = new LinkValidator();

// تصدير الدوال للاستخدام في ملفات أخرى
export {
    linkValidator,
    LinkValidator
};
 </script> 
 <script>
 // assets/js/video.js

class VideoSystem {
    constructor() {
        this.currentVideo = null;
        this.videoPlayer = null;
        this.comments = [];
        this.likesCount = 0;
        this.isLiked = false;
        this.isFollowing = false;
        this.videoList = [];
        this.currentIndex = 0;
        this.init();
    }

    async init() {
        this.setupElements();
        this.setupEventListeners();
        await this.loadVideos();
        this.setupVideoPlayer();
    }

    setupElements() {
        this.videoPlayer = document.getElementById('videoPlayer');
        this.videoContainer = document.querySelector('.video-container');
        this.likeBtn = document.getElementById('likeBtn');
        this.commentBtn = document.getElementById('commentBtn');
        this.shareBtn = document.getElementById('shareBtn');
        this.followBtn = document.getElementById('followBtn');
        this.commentInput = document.getElementById('commentInput');
        this.commentList = document.getElementById('commentList');
        this.videoTitle = document.getElementById('videoTitle');
        this.videoAuthor = document.getElementById('videoAuthor');
        this.videoStats = document.getElementById('videoStats');
        this.progressBar = document.getElementById('progressBar');
    }

    setupEventListeners() {
        this.likeBtn.addEventListener('click', () => this.toggleLike());
        this.commentBtn.addEventListener('click', () => this.toggleComments());
        this.shareBtn.addEventListener('click', () => this.shareVideo());
        this.followBtn.addEventListener('click', () => this.toggleFollow());
        this.commentInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.postComment();
        });
        
        this.videoPlayer.addEventListener('timeupdate', () => this.updateProgressBar());
        this.videoPlayer.addEventListener('ended', () => this.playNextVideo());
        
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') this.togglePlayPause();
            if (e.code === 'ArrowRight') this.skipForward();
            if (e.code === 'ArrowLeft') this.skipBackward();
        });
        
        // Swipe events for mobile
        this.videoContainer.addEventListener('touchstart', this.handleTouchStart.bind(this), {passive: true});
        this.videoContainer.addEventListener('touchend', this.handleTouchEnd.bind(this), {passive: true});
    }

    handleTouchStart(e) {
        this.touchStartX = e.changedTouches[0].screenX;
        this.touchStartY = e.changedTouches[0].screenY;
    }

    handleTouchEnd(e) {
        const diffX = e.changedTouches[0].screenX - this.touchStartX;
        const diffY = e.changedTouches[0].screenY - this.touchStartY;
        
        // Horizontal swipe (min 50px difference and less vertical movement)
        if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
            if (diffX > 0) {
                this.playPreviousVideo();
            } else {
                this.playNextVideo();
            }
        }
    }

    async loadVideos() {
        try {
            const snapshot = await firebase.firestore()
                .collection('videos')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();
            
            this.videoList = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    timestamp: data.timestamp.toDate()
                };
            });
            
            if (this.videoList.length > 0) {
                this.loadVideo(this.videoList[0]);
            }
        } catch (error) {
            console.error('Error loading videos:', error);
            this.showError('حدث خطأ أثناء تحميل الفيديوهات');
        }
    }

    loadVideo(video) {
        this.currentVideo = video;
        this.videoPlayer.src = video.videoUrl;
        this.videoTitle.textContent = video.title;
        this.videoAuthor.textContent = `@${video.author.username}`;
        this.videoStats.textContent = this.formatVideoStats(video);
        
        this.updateLikeStatus();
        this.updateFollowStatus();
        this.loadComments();
        
        // Preload next video
        if (this.currentIndex < this.videoList.length - 1) {
            const nextVideo = this.videoList[this.currentIndex + 1];
            const preloadLink = document.createElement('link');
            preloadLink.rel = 'preload';
            preloadLink.as = 'video';
            preloadLink.href = nextVideo.videoUrl;
            document.head.appendChild(preloadLink);
        }
    }

    formatVideoStats(video) {
        const views = this.formatNumber(video.views);
        const likes = this.formatNumber(video.likes);
        const date = this.formatDate(video.timestamp);
        return `${views} مشاهدة · ${likes} إعجاب · ${date}`;
    }

    formatNumber(num) {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        }
        if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    }

    formatDate(date) {
        const now = new Date();
        const diff = now - date;
        const day = 24 * 60 * 60 * 1000;
        
        if (diff < day) return 'اليوم';
        if (diff < 2 * day) return 'أمس';
        if (diff < 7 * day) return 'هذا الأسبوع';
        
        return date.toLocaleDateString('ar-EG', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    togglePlayPause() {
        if (this.videoPlayer.paused) {
            this.videoPlayer.play();
        } else {
            this.videoPlayer.pause();
        }
    }

    skipForward() {
        this.videoPlayer.currentTime += 5;
    }

    skipBackward() {
        this.videoPlayer.currentTime -= 5;
    }

    updateProgressBar() {
        const percent = (this.videoPlayer.currentTime / this.videoPlayer.duration) * 100;
        this.progressBar.style.width = `${percent}%`;
    }

    playNextVideo() {
        if (this.currentIndex < this.videoList.length - 1) {
            this.currentIndex++;
            this.loadVideo(this.videoList[this.currentIndex]);
            this.videoPlayer.play();
        }
    }

    playPreviousVideo() {
        if (this.currentIndex > 0) {
            this.currentIndex--;
            this.loadVideo(this.videoList[this.currentIndex]);
            this.videoPlayer.play();
        }
    }

    async toggleLike() {
        if (!firebase.auth().currentUser) {
            alert('يجب تسجيل الدخول للإعجاب بالفيديوهات');
            return;
        }

        try {
            const videoRef = firebase.firestore().collection('videos').doc(this.currentVideo.id);
            
            if (this.isLiked) {
                await videoRef.update({
                    likes: firebase.firestore.FieldValue.increment(-1),
                    likedBy: firebase.firestore.FieldValue.arrayRemove(firebase.auth().currentUser.uid)
                });
                this.isLiked = false;
                this.likesCount--;
            } else {
                await videoRef.update({
                    likes: firebase.firestore.FieldValue.increment(1),
                    likedBy: firebase.firestore.FieldValue.arrayUnion(firebase.auth().currentUser.uid)
                });
                this.isLiked = true;
                this.likesCount++;
                
                // Send notification to video owner
                if (firebase.auth().currentUser.uid !== this.currentVideo.author.uid) {
                    await sendNotification(this.currentVideo.author.uid, {
                        title: 'إعجاب جديد',
                        body: `أعجب ${firebase.auth().currentUser.displayName} بفيديوك "${this.currentVideo.title}"`,
                        type: 'like',
                        data: {
                            videoId: this.currentVideo.id,
                            userId: firebase.auth().currentUser.uid
                        }
                    });
                }
            }
            
            this.updateLikeStatus();
        } catch (error) {
            console.error('Error toggling like:', error);
            this.showError('حدث خطأ أثناء تحديث الإعجاب');
        }
    }

    updateLikeStatus() {
        const userId = firebase.auth().currentUser?.uid;
        this.isLiked = userId && this.currentVideo.likedBy?.includes(userId);
        this.likesCount = this.currentVideo.likes || 0;
        
        this.likeBtn.innerHTML = `
            <i class="fas fa-heart ${this.isLiked ? 'active' : ''}"></i>
            <span>${this.formatNumber(this.likesCount)}</span>
        `;
    }

    async toggleFollow() {
        if (!firebase.auth().currentUser) {
            alert('يجب تسجيل الدخول لمتابعة المستخدمين');
            return;
        }

        try {
            const userRef = firebase.firestore().collection('users').doc(this.currentVideo.author.uid);
            
            if (this.isFollowing) {
                await userRef.update({
                    followers: firebase.firestore.FieldValue.arrayRemove(firebase.auth().currentUser.uid)
                });
                this.isFollowing = false;
            } else {
                await userRef.update({
                    followers: firebase.firestore.FieldValue.arrayUnion(firebase.auth().currentUser.uid)
                });
                this.isFollowing = true;
                
                // Send notification to user
                await sendNotification(this.currentVideo.author.uid, {
                    title: 'متابعة جديدة',
                    body: `تابعك ${firebase.auth().currentUser.displayName}`,
                    type: 'follow',
                    data: {
                        userId: firebase.auth().currentUser.uid
                    }
                });
            }
            
            this.updateFollowStatus();
        } catch (error) {
            console.error('Error toggling follow:', error);
            this.showError('حدث خطأ أثناء تحديث المتابعة');
        }
    }

    updateFollowStatus() {
        const userId = firebase.auth().currentUser?.uid;
        this.isFollowing = userId && this.currentVideo.author.followers?.includes(userId);
        
        this.followBtn.textContent = this.isFollowing ? 'متابَع' : 'متابعة';
        this.followBtn.className = this.isFollowing ? 'following' : '';
    }

    toggleComments() {
        const commentsSection = document.getElementById('commentsSection');
        commentsSection.style.display = commentsSection.style.display === 'block' ? 'none' : 'block';
        
        if (commentsSection.style.display === 'block') {
            this.commentInput.focus();
        }
    }

    async loadComments() {
        try {
            const snapshot = await firebase.firestore()
                .collection('videos')
                .doc(this.currentVideo.id)
                .collection('comments')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();
            
            this.comments = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    timestamp: data.timestamp.toDate()
                };
            });
            
            this.renderComments();
        } catch (error) {
            console.error('Error loading comments:', error);
            this.showError('حدث خطأ أثناء تحميل التعليقات');
        }
    }

    renderComments() {
        this.commentList.innerHTML = '';
        
        if (this.comments.length === 0) {
            this.commentList.innerHTML = '<p class="no-comments">لا توجد تعليقات بعد</p>';
            return;
        }
        
        this.comments.forEach(comment => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.innerHTML = `
                <img src="${comment.author.photoURL || '/assets/default-avatar.jpg'}" alt="${comment.author.username}" class="comment-avatar">
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">@${comment.author.username}</span>
                        <span class="comment-time">${this.formatTime(comment.timestamp)}</span>
                    </div>
                    <p class="comment-text">${comment.text}</p>
                </div>
            `;
            this.commentList.appendChild(commentElement);
        });
    }

    async postComment() {
        const commentText = this.commentInput.value.trim();
        if (!commentText) return;
        
        if (!firebase.auth().currentUser) {
            alert('يجب تسجيل الدخول لإضافة تعليق');
            return;
        }

        try {
            const user = firebase.auth().currentUser;
            const commentData = {
                text: commentText,
                author: {
                    uid: user.uid,
                    username: user.displayName,
                    photoURL: user.photoURL
                },
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const commentRef = await firebase.firestore()
                .collection('videos')
                .doc(this.currentVideo.id)
                .collection('comments')
                .add(commentData);
            
            // Add comment to local list
            this.comments.unshift({
                id: commentRef.id,
                ...commentData,
                timestamp: new Date()
            });
            
            this.renderComments();
            this.commentInput.value = '';
            
            // Send notification to video owner
            if (user.uid !== this.currentVideo.author.uid) {
                await sendNotification(this.currentVideo.author.uid, {
                    title: 'تعليق جديد',
                    body: `علق ${user.displayName} على فيديوك "${this.currentVideo.title}"`,
                    type: 'comment',
                    data: {
                        videoId: this.currentVideo.id,
                        userId: user.uid
                    }
                });
            }
        } catch (error) {
            console.error('Error posting comment:', error);
            this.showError('حدث خطأ أثناء نشر التعليق');
        }
    }

    shareVideo() {
        if (navigator.share) {
            navigator.share({
                title: this.currentVideo.title,
                text: `شاهد هذا الفيديو على قصير: ${this.currentVideo.title}`,
                url: `${window.location.origin}/video.html?id=${this.currentVideo.id}`
            }).catch(error => {
                console.log('Error sharing:', error);
                this.copyVideoLink();
            });
        } else {
            this.copyVideoLink();
        }
    }

    copyVideoLink() {
        const link = `${window.location.origin}/video.html?id=${this.currentVideo.id}`;
        navigator.clipboard.writeText(link).then(() => {
            this.showToast('تم نسخ رابط الفيديو');
        }).catch(error => {
            console.error('Error copying link:', error);
            this.showError('حدث خطأ أثناء مشاركة الفيديو');
        });
    }

    showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    showError(message) {
        const errorToast = document.createElement('div');
        errorToast.className = 'toast-message error';
        errorToast.textContent = message;
        document.body.appendChild(errorToast);
        
        setTimeout(() => {
            errorToast.remove();
        }, 3000);
    }

    formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minute = 60 * 1000;
        const hour = minute * 60;
        const day = hour * 24;
        
        if (diff < minute) return 'الآن';
        if (diff < hour) return `${Math.floor(diff / minute)} دقيقة`;
        if (diff < day) return `${Math.floor(diff / hour)} ساعة`;
        return `${Math.floor(diff / day)} يوم`;
    }
}

// Initialize Video System
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('videoPlayer')) {
        const videoSystem = new VideoSystem();
        window.VideoSystem = videoSystem;
    }
});

// Helper function to format duration (e.g. 125 -> 2:05)
export function formatDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}
 </script>
</body>
</html>   