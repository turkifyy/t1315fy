<div id="onesignal-widget-container" style="position: fixed; z-index: 99999;">
  <!-- سيتم إضافة زر الاشتراك هنا تلقائياً -->
</div>

<script>
  // دالة لتحميل OneSignal بطريقة غير متزامنة محسنة
  function loadOneSignal() {
    // التحقق مما إذا تم تحميل OneSignal مسبقاً
    if (window.OneSignal) return;
    
    // إنشاء عنصر script لـ OneSignal SDK مع تحسينات الأداء
    const oneSignalScript = document.createElement('script');
    oneSignalScript.src = 'https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js';
    oneSignalScript.crossOrigin = 'anonymous';
    oneSignalScript.integrity = 'sha384-+X2z5Z5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5J5';
    oneSignalScript.defer = true;
    oneSignalScript.async = true;
    
    // معالجة الأخطاء أثناء التحميل
    oneSignalScript.onerror = function() {
      console.error('Failed to load OneSignal SDK');
      // يمكنك إضافة بديل هنا إذا لزم الأمر
    };
    
    // إضافة العنصر إلى body
    document.body.appendChild(oneSignalScript);
    
    // تهيئة OneSignal بعد تحميل SDK مع تحسينات إضافية
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      try {
        // إعدادات محسنة مع خيارات إضافية
        await OneSignal.init({
          appId: "9925d3a5-a4d6-4d93-a93a-072629ac557d",
          allowLocalhostAsSecureOrigin: true,
          subdomainName: null,
          safari_web_id: null,
          notifyButton: {
            enable: false // سنستخدم slidedown بدلاً من notify button
          },
          promptOptions: {
            slidedown: {
              enabled: true,
              autoPrompt: true,
              timeDelay: 3,
              pageViews: 1,
              force: true,
              isInUpdateModeForCurrentUser: false,
              position: 'center',
              actionMessage: "اشترك للحصول على آخر التحديثات مباشرة",
              acceptButtonText: "موافق",
              cancelButtonText: "لاحقاً",
              showCredit: false
            }
          }
        });
        
        // تحسينات متقدمة للواجهة
        customizeOneSignalUI();
        
        // تتبع الأحداث لتحليل الأداء
        trackOneSignalEvents();
        
      } catch (error) {
        console.error('Error initializing OneSignal:', error);
        // يمكنك إضافة معالجة الأخطاء الإضافية هنا
      }
    });
  }
  
  // دالة متقدمة لتخصيص واجهة OneSignal
  function customizeOneSignalUI() {
    const style = document.createElement('style');
    style.textContent = `
      /* التنسيقات الأساسية المحسنة */
      .onesignal-slidedown-container {
        z-index: 0 !important;
        max-width: 100% !important;
        border-radius: 16px !important;
        box-shadow: 0 8px 32px rgba(0,0,0,0.28) !important;
        animation: slideIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) !important;
        font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
        border: 1px solid rgba(0,0,0,0.08) !important;
        overflow: hidden !important;
      }
      
      .onesignal-slidedown-dialog {
        padding: 24px !important;
        text-align: center !important;
      }
      
      .onesignal-slidedown-message {
        font-size: 16px !important;
        line-height: 1.5 !important;
        margin-bottom: 20px !important;
        color: #212529 !important;
      }
      
      .onesignal-slidedown-button {
        border-radius: 8px !important;
        padding: 12px 24px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        border: none !important;
        cursor: pointer !important;
        font-size: 15px !important;
        margin: 8px !important;
        flex: 1 !important;
      }
      
      .onesignal-slidedown-button.onesignal-slidedown-allow-button {
        background: #2563eb !important;
        color: white !important;
      }
      
      .onesignal-slidedown-button.onesignal-slidedown-allow-button:hover {
        background: #1d4ed8 !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3) !important;
      }
      
      .onesignal-slidedown-button.onesignal-slidedown-denial-button {
        background: transparent !important;
        color: #2563eb !important;
        border: 1px solid #d1d5db !important;
      }
      
      .onesignal-slidedown-button.onesignal-slidedown-denial-button:hover {
        background: #f3f4f6 !important;
        border-color: #9ca3af !important;
      }
      
      .onesignal-slidedown-button-container {
        display: flex !important;
        flex-direction: row !important;
        justify-content: center !important;
        gap: 12px !important;
        margin-top: 16px !important;
      }
      
      .onesignal-slidedown-close-button {
        top: 12px !important;
        right: 12px !important;
        width: 24px !important;
        height: 24px !important;
        opacity: 0.6 !important;
        transition: opacity 0.2s ease !important;
      }
      
      .onesignal-slidedown-close-button:hover {
        opacity: 1 !important;
      }
      
      /* تحسينات للهواتف - شاشات حتى 767px */
      @media (max-width: 767px) {
        .onesignal-slidedown-container {
          width: calc(100% - 32px) !important;
          left: 16px !important;
          right: 16px !important;
          bottom: auto !important;
          top: 50% !important;
          transform: translateY(-50%) !important;
          margin: 0 auto !important;
          max-height: 90vh !important;
          overflow-y: auto !important;
        }
        
        .onesignal-slidedown-dialog {
          padding: 20px 16px !important;
        }
        
        .onesignal-slidedown-button-container {
          flex-direction: column !important;
          gap: 8px !important;
        }
        
        .onesignal-slidedown-button {
          width: 100% !important;
          margin: 0 !important;
        }
      }
      
      /* تحسينات للأجهزة اللوحية - شاشات من 768px إلى 1023px */
      @media (min-width: 768px) and (max-width: 1023px) {
        .onesignal-slidedown-container {
          width: 80% !important;
          max-width: 600px !important;
          left: 50% !important;
          right: auto !important;
          bottom: 40px !important;
          top: auto !important;
          transform: translateX(-50%) !important;
        }
      }
      
      /* تحسينات لأجهزة الكمبيوتر - شاشات 1024px فأكبر */
      @media (min-width: 1024px) {
        .onesignal-slidedown-container {
          width: 420px !important;
          left: auto !important;
          right: 40px !important;
          bottom: 40px !important;
          top: auto !important;
          transform: none !important;
        }
      }
      
      /* تأثيرات الحركة */
      @keyframes slideIn {
        from { 
          opacity: 0; 
          transform: translateY(20px) scale(0.98); 
        }
        to { 
          opacity: 1; 
          transform: translateY(0) scale(1); 
        }
      }
      
      /* تحسينات للوضع الداكن */
      @media (prefers-color-scheme: dark) {
        .onesignal-slidedown-container {
          background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
          border-color: rgba(255,255,255,0.08) !important;
        }
        
        .onesignal-slidedown-message {
          color: #e2e8f0 !important;
        }
        
        .onesignal-slidedown-button.onesignal-slidedown-denial-button {
          background: rgba(255,255,255,0.05) !important;
          color: #e2e8f0 !important;
          border-color: rgba(255,255,255,0.1) !important;
        }
        
        .onesignal-slidedown-button.onesignal-slidedown-denial-button:hover {
          background: rgba(255,255,255,0.1) !important;
        }
      }
      
      /* إصلاحات للتشوهات */
      .onesignal-slidedown-container * {
        box-sizing: border-box !important;
        margin: 0 !important;
      }
      
      .onesignal-slidedown-container a, 
      .onesignal-slidedown-container button {
        text-decoration: none !important;
        outline: none !important;
      }
    `;
    document.head.appendChild(style);
  }
  
  // دالة لتتبع أحداث OneSignal
  function trackOneSignalEvents() {
    if (window.OneSignal) {
      OneSignal.on('notificationPermissionChange', function(permissionChange) {
        console.log('Permission changed:', permissionChange);
        // يمكنك إضافة تتبع التحليلات هنا
      });
      
      OneSignal.on('subscriptionChange', function(isSubscribed) {
        console.log('Subscription changed:', isSubscribed);
        // يمكنك إضافة تتبع التحليلات هنا
      });
    }
  }
  
  // تحميل OneSignal مع تحسينات الأداء
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(loadOneSignal, 1000); // تأخير بسيط لتحسين الأداء
  } else {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(loadOneSignal, 1000);
    });
    window.addEventListener('load', loadOneSignal);
  }
</script>
