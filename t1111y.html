<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidFlow - Smart Short Videos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary-color: #fe2c55;
            --secondary-color: #25f4ee;
            --dark-color: #121212;
            --light-color: #ffffff;
            --gray-color: #808080;
            --nav-height: 60px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-color);
            color: var(--light-color);
            overflow-x: hidden;
        }

        .app-container {
            max-width: 100vw;
            min-height: 100vh;
            position: relative;
            padding-top: var(--nav-height);
        }

        /* Top Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background-color: var(--dark-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0 15px;
        }

        .nav-logo {
            height: 30px;
        }

        .nav-items {
            display: flex;
            flex-grow: 1;
            justify-content: center;
            gap: 30px;
        }

        .nav-item {
            color: var(--gray-color);
            font-size: 20px;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nav-item.active {
            color: var(--light-color);
        }

        /* Video Feed */
        .video-feed {
            width: 100%;
            height: calc(100vh - var(--nav-height));
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
        }

        .video-container {
            width: 100%;
            height: 100vh;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-info {
            position: absolute;
            bottom: 100px;
            left: 15px;
            z-index: 10;
            max-width: 70%;
        }

        .video-creator {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .creator-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid var(--primary-color);
        }

        .video-caption {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .video-music {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--light-color);
        }

        .video-actions {
            position: absolute;
            right: 15px;
            bottom: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .channel-follow {
            position: relative;
            margin-bottom: 15px;
        }

        .channel-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--light-color);
        }

        .follow-button {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            border: 2px solid var(--dark-color);
        }

        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            color: var(--light-color);
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
        }

        .action-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            font-size: 20px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .action-count {
            font-size: 12px;
        }

        /* Tap Effect */
        .tap-effect {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            transform: scale(0);
            opacity: 0;
            z-index: 100;
        }

        .tap-effect.active {
            animation: tapAnimation 0.6s ease-out;
        }

        @keyframes tapAnimation {
            0% { transform: scale(0); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* Tabs */
        .tabs-container {
            position: fixed;
            top: var(--nav-height);
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            background-color: var(--dark-color);
            z-index: 999;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 15px 20px;
            font-weight: 600;
            color: var(--gray-color);
            cursor: pointer;
        }

        .tab.active {
            color: var(--light-color);
            border-bottom: 3px solid var(--primary-color);
        }

        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .auth-content {
            background-color: var(--dark-color);
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .auth-title {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .auth-message {
            margin-bottom: 30px;
        }

        .g_id_signin {
            margin: 0 auto;
        }

        /* Onboarding */
        .onboarding-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--dark-color);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .onboarding-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 30px;
        }

        .skip-button {
            color: var(--light-color);
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }

        .onboarding-title {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
        }

        .channels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .channel-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .channel-avatar-lg {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            object-fit: cover;
        }

        .channel-name {
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }

        .follow-button-lg {
            padding: 5px 15px;
            border-radius: 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
        }

        .follow-button-lg.following {
            background-color: var(--gray-color);
        }

        /* Ads */
        .ad-container {
            width: 100%;
            height: 100vh;
            scroll-snap-align: start;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #222;
        }

        .ad-label {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10;
        }

        /* Loading */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-items">
                <a href="#" class="nav-item active" data-tab="for-you">
                    <i class="fas fa-home"></i>
                </a>
                <a href="#" class="nav-item" data-tab="discover">
                    <i class="fas fa-compass"></i>
                </a>
                <a href="#" class="nav-item" data-tab="search">
                    <i class="fas fa-search"></i>
                </a>
                <a href="#" class="nav-item" data-tab="profile">
                    <i class="fas fa-user"></i>
                </a>
            </div>
            <img src="https://via.placeholder.com/100x30?text=VidFlow" alt="Logo" class="nav-logo">
        </nav>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tab active" data-tab="for-you">For You</div>
            <div class="tab" data-tab="following" id="following-tab">Following</div>
        </div>

        <!-- Video Feed -->
        <div class="video-feed" id="videoFeed">
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Auth Modal -->
        <div class="auth-modal" id="authModal" style="display: none;">
            <div class="auth-content">
                <h2 class="auth-title">Join VidFlow</h2>
                <p class="auth-message">Sign in to like, comment, and follow creators</p>
                <div id="g_id_onload"
                    data-client_id="YOUR_GOOGLE_CLIENT_ID"
                    data-context="signin"
                    data-ux_mode="popup"
                    data-callback="handleGoogleSignIn"
                    data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                    data-type="standard"
                    data-shape="pill"
                    data-theme="filled_blue"
                    data-text="signin_with"
                    data-size="large"
                    data-logo_alignment="left">
                </div>
            </div>
        </div>

        <!-- Onboarding Screen -->
        <div class="onboarding-screen" id="onboardingScreen" style="display: none;">
            <div class="onboarding-header">
                <button class="skip-button" id="skipButton">Skip</button>
            </div>
            <h2 class="onboarding-title">Select channels to follow</h2>
            <div class="channels-grid" id="channelsGrid">
                <!-- Channels will be added here dynamically -->
            </div>
            <button class="btn btn-primary mt-4" id="continueButton" style="display: none;">Continue</button>
        </div>
    </div>

    <!-- Firebase and other JS libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <!-- Main App JavaScript -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDxAsJt7qc0jJgi2k4mvXDGWKY34wGm60k",
            authDomain: "turkify-afa2f.firebaseapp.com",
            projectId: "turkify-afa2f",
            storageBucket: "turkify-afa2f.firebasestorage.app",
            messagingSenderId: "387845497284",
            appId: "1:387845497284:web:ff1d1022e8eac9db374491"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // YouTube API configuration
        const YOUTUBE_API_KEY = 'AIzaSyAre88KKhL_izC0nJjbWSakvmIOPSleGhs';
        const CHANNEL_IDS = [
            'UC_x5XG1OV2P6uZZ5FSM9Ttw', // Google Developers
            'UCsooa4yRKGN_zEE8iknghZA', // TED-Ed
            'UCXuqSBlHAE6Xw-yeJA0Tunw'   // Linus Tech Tips
        ];

        // Adsterra configuration
        const ADSTERRA_AD_IDS = {
            native: '<script async="async" data-cfasync="false" src="//pl25372229.profitableratecpm.com/53939e3f5d28bafcb406a3405f25bc47/invoke.js"></script>
<div id="container-53939e3f5d28bafcb406a3405f25bc47"></div>',
            banner: '<script type="text/javascript">
	atOptions = {
		'key' : '800594911b2de4933f0831772747abf8',
		'format' : 'iframe',
		'height' : 250,
		'width' : 300,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/800594911b2de4933f0831772747abf8/invoke.js"></script>'
        };

        // App state
        const appState = {
            currentUser: null,
            currentTab: 'for-you',
            videoCount: 0,
            followedChannels: [],
            country: 'US' // Default, will be detected
        };

        // Main function to initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Detect user country
            detectUserCountry();
            
            // Set up auth state listener
            auth.onAuthStateChanged(handleAuthStateChange);
            
            // Set up UI event listeners
            setupEventListeners();
            
            // Start video import system (check every 3 minutes)
            checkForNewVideos();
            setInterval(checkForNewVideos, 180000);
            
            // Load initial videos
            loadVideosForTab(appState.currentTab);
        });

        // Detect user country
        function detectUserCountry() {
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    appState.country = data.country || 'US';
                    console.log('Detected country:', appState.country);
                })
                .catch(error => {
                    console.error('Error detecting country:', error);
                });
        }

        // Check for new videos from YouTube
        async function checkForNewVideos() {
            try {
                console.log('Checking for new videos...');
                
                // Get the last update time from Firestore
                const configDoc = await db.collection('config').doc('youtubeImport').get();
                const lastUpdate = configDoc.exists ? configDoc.data().lastUpdate : null;
                
                // For each channel, fetch new videos
                for (const channelId of CHANNEL_IDS) {
                    await fetchVideosFromChannel(channelId, lastUpdate);
                }
                
                // Update last update time
                await db.collection('config').doc('youtubeImport').set({
                    lastUpdate: new Date().toISOString()
                });
                
                console.log('Video check completed');
            } catch (error) {
                console.error('Error checking for new videos:', error);
            }
        }

        // Fetch videos from a YouTube channel
        async function fetchVideosFromChannel(channelId, publishedAfter = null) {
            try {
                let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&maxResults=20&order=date&type=video&key=${YOUTUBE_API_KEY}`;
                
                if (publishedAfter) {
                    url += `&publishedAfter=${publishedAfter}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    for (const item of data.items) {
                        // Get video details to check duration
                        const details = await getYouTubeVideoDetails(item.id.videoId);
                        
                        // Only process short videos (< 2 minutes) with high engagement
                        if (isShortVideo(details.duration) && hasHighEngagement(details.viewCount)) {
                            await processYouTubeVideo(item, details);
                        }
                    }
                }
            } catch (error) {
                console.error(`Error fetching videos from channel ${channelId}:`, error);
            }
        }

        // Check if video is short (< 2 minutes)
        function isShortVideo(duration) {
            // YouTube duration format: PT#M#S
            const match = duration.match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
            const minutes = parseInt(match[1] || '0');
            const seconds = parseInt(match[2] || '0');
            return minutes < 2 || (minutes === 2 && seconds === 0);
        }

        // Check if video has high engagement
        function hasHighEngagement(viewCount) {
            const views = parseInt(viewCount || '0');
            return views > 10000; // Adjust threshold as needed
        }

        // Process YouTube video and store in Firestore
        async function processYouTubeVideo(youtubeItem, videoDetails) {
            try {
                // Check if video already exists in our database
                const existingVideo = await db.collection('videos')
                    .where('youtubeId', '==', youtubeItem.id.videoId)
                    .get();
                
                if (!existingVideo.empty) {
                    return; // Video already exists
                }
                
                // Prepare video data for Firestore
                const videoData = {
                    youtubeId: youtubeItem.id.videoId,
                    videoUrl: `https://www.youtube.com/embed/${youtubeItem.id.videoId}?autoplay=1&mute=1&controls=0`,
                    caption: youtubeItem.snippet.title,
                    description: youtubeItem.snippet.description,
                    thumbnail: youtubeItem.snippet.thumbnails.high.url,
                    creatorUsername: youtubeItem.snippet.channelTitle,
                    creatorAvatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(youtubeItem.snippet.channelTitle)}&background=random`,
                    channelId: youtubeItem.snippet.channelId,
                    music: 'Original Sound',
                    likes: Math.floor(Math.random() * 10000),
                    comments: Math.floor(Math.random() * 500),
                    shares: Math.floor(Math.random() * 1000),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    source: 'youtube',
                    isAI: true,
                    duration: videoDetails.duration,
                    viewCount: videoDetails.viewCount,
                    country: appState.country
                };
                
                // Add to Firestore
                await db.collection('videos').add(videoData);
                
                console.log('Added new video:', youtubeItem.snippet.title);
            } catch (error) {
                console.error('Error processing YouTube video:', error);
            }
        }

        // Get additional details about a YouTube video
        async function getYouTubeVideoDetails(videoId) {
            try {
                const url = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id=${videoId}&key=${YOUTUBE_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    return {
                        duration: data.items[0].contentDetails.duration,
                        viewCount: data.items[0].statistics.viewCount
                    };
                }
                return { duration: 'PT1M', viewCount: '0' };
            } catch (error) {
                console.error('Error getting video details:', error);
                return { duration: 'PT1M', viewCount: '0' };
            }
        }

        // Load videos for the current tab
        async function loadVideosForTab(tab) {
            try {
                const videoFeed = document.getElementById('videoFeed');
                videoFeed.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
                
                let query;
                
                if (tab === 'for-you') {
                    // For You tab - show popular videos for user's country
                    query = db.collection('videos')
                        .where('country', '==', appState.country)
                        .orderBy('likes', 'desc')
                        .limit(20);
                } else if (tab === 'following' && appState.currentUser) {
                    // Following tab - only show followed channels
                    if (appState.followedChannels.length === 0) {
                        videoFeed.innerHTML = '<div class="text-center p-4">Follow channels to see their content here</div>';
                        return;
                    }
                    
                    query = db.collection('videos')
                        .where('channelId', 'in', appState.followedChannels)
                        .orderBy('timestamp', 'desc')
                        .limit(20);
                } else {
                    videoFeed.innerHTML = '<div class="text-center p-4">Please sign in to view this tab</div>';
                    return;
                }
                
                const querySnapshot = await query.get();
                
                if (querySnapshot.empty) {
                    videoFeed.innerHTML = '<div class="text-center p-4">No videos found. Checking for new content...</div>';
                    return;
                }
                
                videoFeed.innerHTML = '';
                appState.videoCount = 0;
                
                querySnapshot.forEach((doc, index) => {
                    const videoData = doc.data();
                    
                    // Insert ad after every 3 videos
                    if (index > 0 && index % 3 === 0) {
                        createAdElement();
                    }
                    
                    createVideoElement(videoData, doc.id);
                    appState.videoCount++;
                });
                
                // Initialize video players
                initVideoPlayers();
            } catch (error) {
                console.error('Error loading videos:', error);
                document.getElementById('videoFeed').innerHTML = '<div class="text-center p-4">Error loading videos. Please try again later.</div>';
            }
        }

        // Create video element in the feed
        function createVideoElement(videoData, videoId) {
            const videoFeed = document.getElementById('videoFeed');
            
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-container';
            videoContainer.dataset.videoId = videoId;
            
            videoContainer.innerHTML = `
                <iframe class="video-player" 
                        src="${videoData.videoUrl}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen></iframe>
                <div class="video-info">
                    <div class="video-creator">
                        <img src="${videoData.creatorAvatar}" class="creator-avatar">
                        <span>@${videoData.creatorUsername}</span>
                    </div>
                    <p class="video-caption">${videoData.caption}</p>
                    <div class="video-music">
                        <i class="fas fa-music"></i>
                        <span>${videoData.music}</span>
                    </div>
                </div>
                <div class="video-actions">
                    <div class="channel-follow">
                        <img src="${videoData.creatorAvatar}" class="channel-avatar">
                        <div class="follow-button">+</div>
                    </div>
                    <button class="action-button like-button">
                        <div class="action-icon">
                            <i class="far fa-heart"></i>
                        </div>
                        <span class="action-count">${videoData.likes}</span>
                    </button>
                    <button class="action-button comment-button">
                        <div class="action-icon">
                            <i class="fas fa-comment-dots"></i>
                        </div>
                        <span class="action-count">${videoData.comments}</span>
                    </button>
                    <button class="action-button share-button">
                        <div class="action-icon">
                            <i class="fas fa-share"></i>
                        </div>
                        <span class="action-count">${videoData.shares}</span>
                    </button>
                </div>
            `;
            
            videoFeed.appendChild(videoContainer);
        }

        // Create ad element in the feed
        function createAdElement() {
            const videoFeed = document.getElementById('videoFeed');
            
            const adContainer = document.createElement('div');
            adContainer.className = 'ad-container';
            
            // In a real implementation, you would use Adsterra's ad code
            // This is a placeholder for demonstration
            adContainer.innerHTML = `
                <div class="ad-label">Sponsored</div>
                <div style="width: 100%; height: 80%; background-color: #333; display: flex; justify-content: center; align-items: center;">
                    <p>Adsterra Ad Content</p>
                </div>
            `;
            
            videoFeed.appendChild(adContainer);
        }

        // Initialize video players with intersection observer
        function initVideoPlayers() {
            const videoContainers = document.querySelectorAll('.video-container');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target.querySelector('iframe');
                    
                    if (entry.isIntersecting) {
                        // Play video by reloading the iframe with autoplay
                        const src = video.src;
                        video.src = src.includes('autoplay=1') ? src : src + '&autoplay=1';
                    } else {
                        // Pause video by removing autoplay
                        video.src = video.src.replace('&autoplay=1', '');
                    }
                });
            }, { threshold: 0.7 });
            
            videoContainers.forEach(container => {
                observer.observe(container);
            });
        }

        // Handle auth state changes
        function handleAuthStateChange(user) {
            if (user) {
                appState.currentUser = user;
                document.getElementById('authModal').style.display = 'none';
                
                // Load user's followed channels
                loadFollowedChannels();
                
                // Show onboarding if new user
                if (user.metadata.creationTime === user.metadata.lastSignInTime) {
                    showOnboardingScreen();
                } else {
                    // Show welcome message
                    showWelcomeMessage();
                }
            } else {
                appState.currentUser = null;
                appState.followedChannels = [];
                
                // Hide Following tab for non-logged-in users
                document.getElementById('following-tab').style.display = 'none';
                
                // If current tab is Following, switch to For You
                if (appState.currentTab === 'following') {
                    appState.currentTab = 'for-you';
                    document.querySelector('.tabs-container .tab.active').classList.remove('active');
                    document.querySelector(`.tabs-container .tab[data-tab="for-you"]`).classList.add('active');
                    loadVideosForTab('for-you');
                }
            }
        }

        // Load user's followed channels
        async function loadFollowedChannels() {
            if (!appState.currentUser) return;
            
            try {
                const snapshot = await db.collection('users')
                    .doc(appState.currentUser.uid)
                    .collection('followedChannels')
                    .get();
                
                appState.followedChannels = snapshot.docs.map(doc => doc.id);
                
                // Show Following tab if user is logged in
                document.getElementById('following-tab').style.display = 'block';
                
                // Reload videos if on Following tab
                if (appState.currentTab === 'following') {
                    loadVideosForTab('following');
                }
            } catch (error) {
                console.error('Error loading followed channels:', error);
            }
        }

        // Show onboarding screen for new users
        async function showOnboardingScreen() {
            try {
                // Load popular channels
                const snapshot = await db.collection('channels')
                    .orderBy('followers', 'desc')
                    .limit(15)
                    .get();
                
                const channelsGrid = document.getElementById('channelsGrid');
                channelsGrid.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const channel = doc.data();
                    const channelItem = document.createElement('div');
                    channelItem.className = 'channel-item';
                    channelItem.innerHTML = `
                        <img src="${channel.avatar}" class="channel-avatar-lg">
                        <div class="channel-name">${channel.name}</div>
                        <button class="follow-button-lg" data-channel-id="${doc.id}">Follow</button>
                    `;
                    channelsGrid.appendChild(channelItem);
                });
                
                // Show onboarding screen
                document.getElementById('onboardingScreen').style.display = 'block';
            } catch (error) {
                console.error('Error showing onboarding screen:', error);
                // Skip onboarding if there's an error
                showWelcomeMessage();
            }
        }

        // Show welcome message
        function showWelcomeMessage() {
            alert(`Welcome to VidFlow, ${appState.currentUser.displayName || 'User'}!`);
        }

        // Handle Google Sign-In
        function handleGoogleSignIn(response) {
            const credential = firebase.auth.GoogleAuthProvider.credential(response.credential);
            
            auth.signInWithCredential(credential)
                .then((result) => {
                    console.log('Google sign-in successful', result.user);
                })
                .catch((error) => {
                    console.error('Google sign-in error:', error);
                });
        }

        // Set up UI event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (this.dataset.tab === 'following' && !appState.currentUser) {
                        document.getElementById('authModal').style.display = 'flex';
                        return;
                    }
                    
                    document.querySelector('.tabs-container .tab.active').classList.remove('active');
                    this.classList.add('active');
                    
                    appState.currentTab = this.dataset.tab;
                    loadVideosForTab(appState.currentTab);
                });
            });

            // Navigation items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelector('.nav-item.active').classList.remove('active');
                    this.classList.add('active');
                    // In a full implementation, this would load the appropriate page
                });
            });

            // Like button handler (delegated)
            document.addEventListener('click', async function(e) {
                if (e.target.closest('.like-button')) {
                    if (!appState.currentUser) {
                        document.getElementById('authModal').style.display = 'flex';
                        return;
                    }
                    
                    const button = e.target.closest('.like-button');
                    const icon = button.querySelector('i');
                    const countElement = button.querySelector('.action-count');
                    const videoContainer = button.closest('.video-container');
                    const videoId = videoContainer.dataset.videoId;
                    
                    // Create tap effect
                    createTapEffect(e);
                    
                    if (icon.classList.contains('liked')) {
                        // Unlike
                        icon.classList.remove('liked', 'fas', 'text-danger');
                        icon.classList.add('far');
                        countElement.textContent = parseInt(countElement.textContent) - 1;
                        
                        // Update in Firestore
                        await db.collection('videos').doc(videoId).update({
                            likes: firebase.firestore.FieldValue.increment(-1)
                        });
                    } else {
                        // Like
                        icon.classList.add('liked', 'fas', 'text-danger');
                        icon.classList.remove('far');
                        countElement.textContent = parseInt(countElement.textContent) + 1;
                        
                        // Update in Firestore
                        await db.collection('videos').doc(videoId).update({
                            likes: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                }
                
                // Follow button handler
                if (e.target.closest('.follow-button') || e.target.closest('.follow-button-lg')) {
                    if (!appState.currentUser) {
                        document.getElementById('authModal').style.display = 'flex';
                        return;
                    }
                    
                    const button = e.target.closest('.follow-button') || e.target.closest('.follow-button-lg');
                    const channelId = button.dataset.channelId || 
                                    button.closest('.channel-follow').querySelector('.channel-avatar').src.split('name=')[1].split('&')[0];
                    
                    if (button.classList.contains('following')) {
                        // Unfollow
                        button.classList.remove('following');
                        if (button.classList.contains('follow-button-lg')) {
                            button.textContent = 'Follow';
                        } else {
                            button.textContent = '+';
                        }
                        
                        // Update in Firestore
                        await db.collection('users')
                            .doc(appState.currentUser.uid)
                            .collection('followedChannels')
                            .doc(channelId)
                            .delete();
                        
                        // Update local state
                        appState.followedChannels = appState.followedChannels.filter(id => id !== channelId);
                    } else {
                        // Follow
                        button.classList.add('following');
                        if (button.classList.contains('follow-button-lg')) {
                            button.textContent = 'Following';
                        } else {
                            button.textContent = '✓';
                        }
                        
                        // Update in Firestore
                        await db.collection('users')
                            .doc(appState.currentUser.uid)
                            .collection('followedChannels')
                            .doc(channelId)
                            .set({
                                followedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        
                        // Update local state
                        appState.followedChannels.push(channelId);
                    }
                    
                    // Reload Following tab if active
                    if (appState.currentTab === 'following') {
                        loadVideosForTab('following');
                    }
                }
                
                // Comment button handler
                if (e.target.closest('.comment-button')) {
                    if (!appState.currentUser) {
                        document.getElementById('authModal').style.display = 'flex';
                        return;
                    }
                    
                    const videoContainer = e.target.closest('.video-container');
                    const videoId = videoContainer.dataset.videoId;
                    
                    // Create tap effect
                    createTapEffect(e);
                    
                    // In a full implementation, this would show comments
                    alert(`Google comments system would load here for video ${videoId}`);
                }
                
                // Share button handler
                if (e.target.closest('.share-button')) {
                    if (!appState.currentUser) {
                        document.getElementById('authModal').style.display = 'flex';
                        return;
                    }
                    
                    const videoContainer = e.target.closest('.video-container');
                    const videoId = videoContainer.dataset.videoId;
                    
                    // Create tap effect
                    createTapEffect(e);
                    
                    // Share via WhatsApp
                    const shareUrl = `${window.location.origin}/video.html?id=${videoId}`;
                    const shareText = `Check out this video on VidFlow: ${shareUrl}`;
                    
                    if (navigator.share) {
                        navigator.share({
                            title: 'VidFlow Video',
                            text: 'Check out this video I found on VidFlow',
                            url: shareUrl
                        }).catch(err => {
                            console.log('Error sharing:', err);
                            window.open(`whatsapp://send?text=${encodeURIComponent(shareText)}`, '_blank');
                        });
                    } else {
                        window.open(`whatsapp://send?text=${encodeURIComponent(shareText)}`, '_blank');
                    }
                    
                    // Update share count
                    await db.collection('videos').doc(videoId).update({
                        shares: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    // Update UI
                    const countElement = e.target.closest('.share-button').querySelector('.action-count');
                    countElement.textContent = parseInt(countElement.textContent) + 1;
                }
                
                // Skip onboarding button
                if (e.target.closest('#skipButton')) {
                    document.getElementById('onboardingScreen').style.display = 'none';
                    showWelcomeMessage();
                }
            });
        }

        // Create tap effect animation
        function createTapEffect(event) {
            const tapEffect = document.createElement('div');
            tapEffect.className = 'tap-effect';
            
            tapEffect.style.left = `${event.clientX - 40}px`;
            tapEffect.style.top = `${event.clientY - 40}px`;
            
            document.body.appendChild(tapEffect);
            
            setTimeout(() => {
                tapEffect.classList.add('active');
                
                setTimeout(() => {
                    tapEffect.remove();
                }, 600);
            }, 10);
        }
    </script>
</body>
</html>
