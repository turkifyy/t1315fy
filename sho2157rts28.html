<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turkify Pro - منصة إدارة الروابط الاحترافية</title>
    
    <!-- Enhanced SEO Meta Tags -->
    <meta name="description" content="منصة Turkify Pro الاحترافية لإدارة وتحليل الروابط المختصرة مع ميزات متقدمة وتحليلات حقيقية">
    <meta name="keywords" content="روابط مختصرة, تحليلات, إدارة روابط, مسلسلات, أفلام, محتوى رقمي">
    <meta name="author" content="Turkify Pro">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://turkify.netlify.app/">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Turkify Pro - منصة إدارة الروابط الاحترافية">
    <meta property="og:description" content="منصة احترافية لإدارة الروابط المختصرة مع تحليلات متقدمة ونظام إدارة المحتوى">
    <meta property="og:image" content="https://turkify.netlify.app/assets/og-image.jpg">
    <meta property="og:url" content="https://turkify.netlify.app/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Turkify Pro">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Turkify Pro - منصة إدارة الروابط الاحترافية">
    <meta name="twitter:description" content="منصة احترافية لإدارة الروابط المختصرة مع تحليلات متقدمة">
    <meta name="twitter:image" content="https://turkify.netlify.app/assets/twitter-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <!-- CSS Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_ADSENSE_ID" crossorigin="anonymous"></script>
    
    <style>
        * {
            font-family: 'Tajawal', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Security: Disable right-click and inspect */
        html {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        :root {
            --primary-purple: #6f42c1;
            --primary-teal: #20c997;
            --primary-red: #dc3545;
            --gradient-bg: linear-gradient(135deg, var(--primary-purple), var(--primary-teal));
            --dark-bg: #1a1a2e;
            --card-bg: rgba(255, 255, 255, 0.95);
            --netflix-bg: #141414;
            --netflix-red: #e50914;
            --admin-gold: #ffd700;
        }
        
        body {
            background: var(--gradient-bg);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Enhanced Navbar */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(111, 66, 193, 0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        /* Login Required Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        /* Enhanced Hero Section */
        .hero-section {
            padding: 100px 0;
            text-align: center;
            color: white;
            position: relative;
        }
        
        .hero-title {
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #fff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2.5rem;
            margin: 1rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            transition: all 0.4s ease;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .stats-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
        }
        
        .stats-number {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-purple);
            margin-bottom: 0.5rem;
        }
        
        /* Enhanced Cards */
        .card-custom {
            background: var(--card-bg);
            border-radius: 20px;
            border: none;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            transition: all 0.4s ease;
            overflow: hidden;
        }
        
        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 60px rgba(0,0,0,0.15);
        }
        
        /* Enhanced Buttons */
        .btn-gradient {
            background: var(--gradient-bg);
            border: none;
            color: white;
            padding: 15px 35px;
            border-radius: 30px;
            font-weight: 600;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(111, 66, 193, 0.4);
            color: white;
        }
        
        /* Enhanced Form Controls */
        .form-control, .form-select {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
            transform: translateY(-2px);
        }
        
        /* Admin Badge */
        .admin-badge {
            background: linear-gradient(45deg, var(--admin-gold), #ffed4e);
            color: #333;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-left: 15px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }
        
        /* Enhanced Table */
        .table-enhanced {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .table-enhanced thead {
            background: var(--gradient-bg);
            color: white;
        }
        
        .table-enhanced tbody tr:hover {
            background: rgba(111, 66, 193, 0.08);
            transform: scale(1.01);
        }
        
        /* Content Type Badges */
        .content-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }
        
        .badge-series { background: #e74c3c; }
        .badge-movie { background: #9b59b6; }
        .badge-match { background: #2ecc71; }
        .badge-recipe { background: #f39c12; }
        .badge-game { background: #3498db; }
        .badge-app { background: #1abc9c; }
        .badge-channel { background: #e67e22; }
        .badge-reels { background: #e91e63; }
        
        /* Pagination */
        .pagination-custom {
            justify-content: center;
            margin-top: 30px;
        }
        
        .pagination-custom .page-link {
            border-radius: 10px;
            margin: 0 5px;
            border: none;
            color: var(--primary-purple);
            font-weight: 600;
        }
        
        .pagination-custom .page-link:hover {
            background: var(--primary-purple);
            color: white;
            transform: translateY(-2px);
        }
        
        /* Enhanced Modals */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            border-radius: 20px 20px 0 0;
            border-bottom: none;
        }
        
        /* Analytics Cards */
        .analytics-card {
            background: linear-gradient(135deg, rgba(111, 66, 193, 0.1), rgba(32, 201, 151, 0.1));
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 2px solid rgba(111, 66, 193, 0.2);
            transition: all 0.3s ease;
        }
        
        .analytics-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-purple);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-purple);
            margin-bottom: 10px;
        }
        
        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner-custom {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast Enhancements */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast-custom {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }
            
            .stats-card {
                margin: 0.5rem;
                padding: 1.5rem;
            }
            
            .card-custom {
                margin-bottom: 20px;
            }
            
            .btn-gradient {
                padding: 12px 25px;
                font-size: 0.9rem;
            }
        }
        
        /* Hidden Class */
        .hidden {
            display: none !important;
        }
        
        /* Live Indicator */
        .live-indicator {
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* Redirect Page Styles */
        .redirect-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            position: relative;
        }
        
        .redirect-navbar {
            background: rgba(0,0,0,0.95);
            padding: 20px 0;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        
        .countdown-header {
            background: rgba(229, 9, 20, 0.2);
            color: #e50914;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 700;
            border: 2px solid #e50914;
            font-size: 1.1rem;
        }
        
        .content-card {
            background: rgba(255,255,255,0.05);
            border-radius: 25px;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            margin: 40px 0;
        }
        
        .content-thumbnail {
            position: relative;
            width: 100%;
            height: 450px;
            overflow: hidden;
        }
        
        .thumbnail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .content-card:hover .thumbnail-image {
            transform: scale(1.05);
        }
        
        .content-type-badge {
            position: absolute;
            top: 25px;
            right: 25px;
            background: #e50914;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 5px 15px rgba(229, 9, 20, 0.4);
        }
        
        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.9);
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .play-overlay:hover {
            color: #e50914;
            transform: translate(-50%, -50%) scale(1.2);
            background: rgba(0,0,0,0.6);
        }
        
        .content-info {
            padding: 40px;
        }
        
        .content-title {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #e50914, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .episode-info {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .episode-badge {
            background: rgba(229, 9, 20, 0.2);
            color: #e50914;
            padding: 12px 20px;
            border-radius: 20px;
            border: 2px solid #e50914;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .next-episode-timer {
            color: #ffd700;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .content-description {
            font-size: 1.3rem;
            line-height: 1.8;
            color: rgba(255,255,255,0.85);
            margin-bottom: 30px;
        }
        
        .content-metadata {
            display: flex;
            gap: 30px;
            margin-bottom: 35px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            color: rgba(255,255,255,0.7);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .watch-button {
            background: #e50914;
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .watch-button:hover {
            background: #f40612;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(229, 9, 20, 0.4);
        }
        
        .share-button {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 18px 40px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .share-button:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }
        
        .redirect-text {
            text-align: center;
            font-size: 1.4rem;
            color: rgba(255,255,255,0.8);
            margin: 30px 0;
            padding: 25px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            border-left: 5px solid #e50914;
        }
        
        /* AdSense Ad Containers */
        .ad-container {
            margin: 30px 0;
            text-align: center;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .ad-label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
            margin-bottom: 10px;
        }
        
        /* Recommendations Grid */
        .recommendations-section {
            margin-top: 60px;
        }
        
        .recommendations-title {
            font-size: 2.2rem;
            margin-bottom: 30px;
            color: white;
            font-weight: 700;
        }
        
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }
        
        .recommendation-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .recommendation-card:hover {
            transform: translateY(-8px);
            background: rgba(255,255,255,0.1);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .rec-thumbnail {
            width: 100%;
            height: 160px;
            overflow: hidden;
        }
        
        .rec-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .recommendation-card:hover .rec-thumbnail img {
            transform: scale(1.1);
        }
        
        /* Auto-redirect Notice */
        .auto-redirect-notice {
            background: rgba(0,0,0,0.9);
            padding: 20px 0;
            text-align: center;
            border-top: 2px solid rgba(255,255,255,0.1);
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        
        /* Security Styles */
        .security-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,0,0,0.9);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            font-size: 2rem;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <!-- Security Overlay -->
    <div class="security-overlay" id="securityOverlay">
        <div class="text-center">
            <i class="fas fa-shield-alt fa-3x mb-3"></i>
            <h2>تم رصد محاولة غير مشروعة</h2>
            <p>سيتم إعادة توجيهك خلال 3 ثوانِ</p>
        </div>
    </div>
    
    <!-- Login Required Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <i class="fas fa-lock fa-3x text-primary mb-3"></i>
            <h3>مطلوب تسجيل الدخول</h3>
            <p class="text-muted mb-4">يجب تسجيل الدخول للوصول إلى منصة Turkify Pro</p>
            <button class="btn btn-gradient" id="loginRequiredBtn">
                <i class="fab fa-google me-2"></i>تسجيل الدخول بـ Google
            </button>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container"></div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner-custom"></div>
    </div>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#" style="color: var(--primary-purple);">
                <i class="fas fa-link me-2"></i>Turkify Pro
                <span class="badge bg-success ms-2">Professional</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#dashboard" id="dashboardNav">
                            <i class="fas fa-tachometer-alt me-1"></i>لوحة التحكم
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#analytics" id="analyticsNav">
                            <i class="fas fa-chart-line me-1"></i>التحليلات المتقدمة
                        </a>
                    </li>
                    <li class="nav-item" id="adminNavItem" class="hidden">
                        <a class="nav-link" href="#admin" id="adminNav">
                            <i class="fas fa-crown me-1"></i>لوحة الإدارة
                        </a>
                    </li>
                </ul>
                
                <div class="navbar-nav">
                    <div id="authButtons" class="d-flex align-items-center">
                        <button class="btn btn-gradient me-2" id="loginBtn">
                            <i class="fab fa-google me-2"></i>تسجيل دخول
                        </button>
                    </div>
                    
                    <div id="userMenu" class="dropdown hidden">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <span id="adminBadge" class="admin-badge hidden">
                                <i class="fas fa-crown me-1"></i>المدير الأساسي
                            </span>
                            <img id="userPhoto" src="" alt="User" class="rounded-circle me-2" width="40" height="40">
                            <span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="profileBtn">
                                <i class="fas fa-user me-2"></i>الملف الشخصي
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="settingsBtn">
                                <i class="fas fa-cog me-2"></i>الإعدادات
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">
                                <i class="fas fa-sign-out-alt me-2"></i>تسجيل خروج
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Hero Section -->
    <section class="hero-section" id="hero">
        <div class="container">
            <h1 class="hero-title">Turkify Pro</h1>
            <p class="hero-subtitle">منصة إدارة الروابط الاحترافية مع التحليلات المتقدمة والذكاء الاصطناعي</p>
            
            <!-- AdSense Banner Ad -->
            <div class="ad-container">
                <div class="ad-label">إعلان</div>
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-YOUR_ADSENSE_ID"
                     data-ad-slot="1234567890"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>
            
            <div class="row mt-5" id="statsSection">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="stats-number" id="totalLinks">
                            <i class="live-indicator"></i>0
                        </div>
                        <div class="text-muted">إجمالي الروابط</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="stats-number" id="totalClicks">
                            <i class="live-indicator"></i>0
                        </div>
                        <div class="text-muted">إجمالي النقرات</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="stats-number" id="todayClicks">
                            <i class="live-indicator"></i>0
                        </div>
                        <div class="text-muted">نقرات اليوم</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card">
                        <div class="stats-number" id="activeUsers">
                            <i class="live-indicator"></i>1
                        </div>
                        <div class="text-muted">المستخدمين النشطين</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Dashboard Section -->
    <section id="dashboard" class="py-5" style="background: rgba(255,255,255,0.1);">
        <div class="container">
            <div class="row">
                <!-- Enhanced Link Creation Form -->
                <div class="col-lg-4 mb-4">
                    <div class="card card-custom">
                        <div class="card-header" style="background: var(--gradient-bg); color: white;">
                            <h5 class="mb-0">
                                <i class="fas fa-plus-circle me-2"></i>إنشاء رابط احترافي
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="linkForm">
                                <!-- Content Type with Subcategories -->
                                <div class="mb-3">
                                    <label class="form-label">نوع المحتوى</label>
                                    <select class="form-select" id="contentType" required>
                                        <option value="">اختر نوع المحتوى</option>
                                        <optgroup label="🎬 ترفيه">
                                            <option value="series">مسلسل</option>
                                            <option value="movie">فيلم</option>
                                            <option value="reels">ريلز</option>
                                        </optgroup>
                                        <optgroup label="⚽ رياضة">
                                            <option value="match">مباراة</option>
                                        </optgroup>
                                        <optgroup label="🍳 طبخ">
                                            <option value="recipe">وصفة</option>
                                        </optgroup>
                                        <optgroup label="💻 تقنية">
                                            <option value="game">لعبة</option>
                                            <option value="app">تطبيق</option>
                                        </optgroup>
                                        <optgroup label="📺 قنوات">
                                            <option value="channel">قناة</option>
                                        </optgroup>
                                    </select>
                                </div>
                                
                                <!-- Content Subcategory -->
                                <div class="mb-3">
                                    <label class="form-label">التصنيف الفرعي</label>
                                    <select class="form-select" id="contentSubcategory">
                                        <option value="">اختر التصنيف الفرعي</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">اسم المحتوى</label>
                                    <input type="text" class="form-control" id="seriesName" placeholder="مثال: مسلسل الديوان" required>
                                </div>
                                
                                <!-- Episodes Field (Hidden by default) -->
                                <div class="mb-3 hidden" id="episodeFields">
                                    <label class="form-label">عدد الحلقات</label>
                                    <input type="number" class="form-control" id="totalEpisodes" min="1" placeholder="مثال: 30" value="1">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">الرابط الأصلي</label>
                                    <input type="url" class="form-control" id="originalUrl" placeholder="https://example.com" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">النطاق المخصص</label>
                                    <select class="form-select" id="customDomain">
                                        <option value="turkify.netlify.app">turkify.netlify.app</option>
                                        <option value="short.ly">short.ly</option>
                                        <option value="link.sa">link.sa</option>
                                        <option value="custom">نطاق مخصص</option>
                                    </select>
                                </div>
                                
                                <!-- Custom Domain Input -->
                                <div class="mb-3 hidden" id="customDomainInput">
                                    <label class="form-label">النطاق المخصص</label>
                                    <input type="text" class="form-control" id="customDomainValue" placeholder="yourdomain.com">
                                </div>
                                
                                <!-- Premium Features -->
                                <div class="card mt-3" style="background: #f8f9fa;">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-crown me-2"></i>الميزات الاحترافية
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Password Protection -->
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="passwordProtected">
                                            <label class="form-check-label" for="passwordProtected">
                                                حماية بكلمة مرور
                                            </label>
                                        </div>
                                        <input type="password" class="form-control mb-2 hidden" id="linkPassword" placeholder="كلمة المرور">
                                        
                                        <!-- Expiration Date -->
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="hasExpiration">
                                            <label class="form-check-label" for="hasExpiration">
                                                تاريخ انتهاء الصلاحية
                                            </label>
                                        </div>
                                        <input type="datetime-local" class="form-control mb-2 hidden" id="expirationDate">
                                        
                                        <!-- Click Limit -->
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="hasClickLimit">
                                            <label class="form-check-label" for="hasClickLimit">
                                                حد أقصى للنقرات
                                            </label>
                                        </div>
                                        <input type="number" class="form-control mb-2 hidden" id="clickLimit" placeholder="1000" min="1">
                                    </div>
                                </div>
                                
                                <!-- Social Media Preview -->
                                <div class="card mt-3" style="background: #e3f2fd;">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-share-alt me-2"></i>معاينة وسائل التواصل
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <label class="form-label">العنوان</label>
                                            <input type="text" class="form-control form-control-sm" id="socialTitle" placeholder="عنوان جذاب">
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">الوصف</label>
                                            <textarea class="form-control form-control-sm" id="socialDescription" rows="2" placeholder="وصف مختصر وجذاب"></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">رابط الصورة</label>
                                            <input type="url" class="form-control form-control-sm" id="socialImage" placeholder="https://example.com/image.jpg">
                                        </div>
                                        
                                        <!-- Live Preview -->
                                        <div class="mt-3" id="socialPreview">
                                            <small class="text-muted">معاينة مباشرة:</small>
                                            <div class="border rounded p-2 mt-1" style="background: white;">
                                                <div class="d-flex">
                                                    <img id="previewImage" src="" class="me-2" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; display: none;">
                                                    <div>
                                                        <div id="previewTitle" class="fw-bold text-dark" style="font-size: 0.9rem;">عنوان الرابط</div>
                                                        <div id="previewDescription" class="text-muted" style="font-size: 0.8rem;">وصف الرابط</div>
                                                        <div id="previewDomain" class="text-primary" style="font-size: 0.7rem;">turkify.netlify.app</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-gradient w-100 mt-4" id="createLinkBtn">
                                    <i class="fas fa-magic me-2"></i>إنشاء رابط احترافي
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Links Management -->
                <div class="col-lg-8 mb-4">
                    <div class="card card-custom">
                        <div class="card-header d-flex justify-content-between align-items-center" style="background: var(--gradient-bg); color: white;">
                            <h5 class="mb-0">
                                <i class="fas fa-list-alt me-2"></i>الروابط المُدارة
                                <span class="badge bg-light text-dark ms-2" id="linksCount">0</span>
                            </h5>
                            <div class="d-flex gap-2">
                                <!-- Advanced Search -->
                                <div class="input-group" style="width: 250px;">
                                    <input type="text" class="form-control" id="searchLinks" placeholder="بحث متقدم...">
                                    <button class="btn btn-outline-light" type="button" id="searchBtn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                
                                <!-- Filter Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-filter me-1"></i>تصفية
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" data-filter="all">جميع الروابط</a></li>
                                        <li><a class="dropdown-item" href="#" data-filter="series">المسلسلات</a></li>
                                        <li><a class="dropdown-item" href="#" data-filter="movie">الأفلام</a></li>
                                        <li><a class="dropdown-item" href="#" data-filter="active">النشطة</a></li>
                                        <li><a class="dropdown-item" href="#" data-filter="expired">المنتهية</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <!-- Time Range Filter -->
                            <div class="p-3 border-bottom">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <label class="form-label mb-0">تصفية حسب التاريخ:</label>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="btn-group btn-group-sm" role="group" id="timeFilter">
                                            <input type="radio" class="btn-check" name="timeRange" id="today" autocomplete="off" checked>
                                            <label class="btn btn-outline-primary" for="today">اليوم</label>
                                            
                                            <input type="radio" class="btn-check" name="timeRange" id="week" autocomplete="off">
                                            <label class="btn btn-outline-primary" for="week">الأسبوع</label>
                                            
                                            <input type="radio" class="btn-check" name="timeRange" id="month" autocomplete="off">
                                            <label class="btn btn-outline-primary" for="month">الشهر</label>
                                            
                                            <input type="radio" class="btn-check" name="timeRange" id="year" autocomplete="off">
                                            <label class="btn btn-outline-primary" for="year">السنة</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover table-enhanced mb-0">
                                    <thead>
                                        <tr>
                                            <th>المحتوى</th>
                                            <th>النوع</th>
                                            <th>الرابط المختصر</th>
                                            <th>النقرات <i class="live-indicator"></i></th>
                                            <th>التاريخ</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="linksTableBody">
                                        <!-- Links will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Enhanced Pagination -->
                            <nav aria-label="صفحات الروابط">
                                <ul class="pagination pagination-custom" id="linksPagination">
                                    <!-- Pagination will be generated here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Enhanced Analytics Section -->
    <section id="analytics" class="py-5 hidden">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <h2 class="text-white">
                    <i class="fas fa-chart-line me-2"></i>التحليلات المتقدمة
                    <i class="live-indicator"></i>
                </h2>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="analyticsRange" id="analytics24h" autocomplete="off" checked>
                    <label class="btn btn-outline-light" for="analytics24h">24 ساعة</label>
                    
                    <input type="radio" class="btn-check" name="analyticsRange" id="analytics7d" autocomplete="off">
                    <label class="btn btn-outline-light" for="analytics7d">7 أيام</label>
                    
                    <input type="radio" class="btn-check" name="analyticsRange" id="analytics30d" autocomplete="off">
                    <label class="btn btn-outline-light" for="analytics30d">30 يوم</label>
                    
                    <input type="radio" class="btn-check" name="analyticsRange" id="analytics1y" autocomplete="off">
                    <label class="btn btn-outline-light" for="analytics1y">سنة</label>
                </div>
            </div>
            
            <!-- Key Metrics -->
            <div class="row mb-5">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="analytics-card">
                        <i class="fas fa-mouse-pointer fa-2x text-primary mb-3"></i>
                        <div class="metric-value" id="analyticsClicks">0</div>
                        <div class="text-muted">النقرات الإجمالية</div>
                        <small class="text-success">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="clicksGrowth">+0%</span> من الفترة السابقة
                        </small>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="analytics-card">
                        <i class="fas fa-users fa-2x text-info mb-3"></i>
                        <div class="metric-value" id="analyticsVisitors">0</div>
                        <div class="text-muted">الزوار الفريدون</div>
                        <small class="text-success">
                            <i class="fas fa-arrow-up me-1"></i>
                            <span id="visitorsGrowth">+0%</span> من الفترة السابقة
                        </small>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="analytics-card">
                        <i class="fas fa-globe fa-2x text-warning mb-3"></i>
                        <div class="metric-value" id="analyticsCountries">0</div>
                        <div class="text-muted">الدول</div>
                        <small class="text-info">انتشار جغرافي واسع</small>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="analytics-card">
                        <i class="fas fa-percentage fa-2x text-success mb-3"></i>
                        <div class="metric-value" id="analyticsConversion">0%</div>
                        <div class="text-muted">معدل التحويل</div>
                        <small class="text-success">معدل ممتاز</small>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Charts -->
            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card card-custom">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-area me-2"></i>تحليل النقرات عبر الوقت
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="mainAnalyticsChart" height="400"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="card card-custom">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-globe-americas me-2"></i>التوزيع الجغرافي
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="geoChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="card card-custom">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-mobile-alt me-2"></i>الأجهزة والمنصات
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="card card-custom">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-tv me-2"></i>أنواع المحتوى الأكثر شيوعاً
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="contentTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Admin Dashboard Section -->
    <section id="admin" class="py-5 hidden">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-5">
                <h2 class="text-white">
                    <i class="fas fa-crown me-2"></i>لوحة الإدارة الرئيسية
                    <span class="badge bg-warning text-dark">مدير النظام</span>
                </h2>
                <button class="btn btn-gradient" id="systemHealthBtn">
                    <i class="fas fa-heartbeat me-2"></i>حالة النظام
                </button>
            </div>
            
            <!-- Admin Stats -->
            <div class="row mb-5">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="analytics-card border-warning">
                        <i class="fas fa-users fa-2x text-warning mb-3"></i>
                        <div class="metric-value" id="totalUsers">0</div>
                        <div class="text-muted">إجمالي المستخدمين</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="analytics-card border-info">
                        <i class="fas fa-link fa-2x text-info mb-3"></i>
                        <div class="metric-value" id="totalLinksAdmin">0</div>
                        <div class="text-muted">إجمالي الروابط</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="analytics-card border-success">
                        <i class="fas fa-dollar-sign fa-2x text-success mb-3"></i>
                        <div class="metric-value" id="estimatedRevenue">$0</div>
                        <div class="text-muted">الإيرادات المقدرة</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="analytics-card border-danger">
                        <i class="fas fa-shield-alt fa-2x text-danger mb-3"></i>
                        <div class="metric-value" id="securityIncidents">0</div>
                        <div class="text-muted">حوادث الأمان</div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Management Panels -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card card-custom">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-users-cog me-2"></i>إدارة المستخدمين
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>المستخدم</th>
                                            <th>الروابط</th>
                                            <th>النقرات</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableAdmin">
                                        <!-- Users will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="card card-custom">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>إعدادات النظام
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="systemSettingsForm">
                                <div class="mb-3">
                                    <label class="form-label">الحد الأقصى للروابط لكل مستخدم</label>
                                    <input type="number" class="form-control" id="maxLinksPerUser" value="100">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">مدة الاحتفاظ بالبيانات (أيام)</label>
                                    <input type="number" class="form-control" id="dataRetentionDays" value="365">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="maintenanceMode">
                                    <label class="form-check-label" for="maintenanceMode">
                                        وضع الصيانة
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-gradient">
                                    <i class="fas fa-save me-2"></i>حفظ الإعدادات
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Enhanced Modals -->
    
    <!-- Link Statistics Modal -->
    <div class="modal fade" id="linkStatsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--gradient-bg); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i>إحصائيات مفصلة
                        <i class="live-indicator"></i>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Stats Header -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="metric-value" id="modalTotalClicks">0</div>
                                <div class="text-muted">إجمالي النقرات</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="metric-value" id="modalUniqueVisitors">0</div>
                                <div class="text-muted">زوار فريدون</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="metric-value" id="modalConversionRate">0%</div>
                                <div class="text-muted">معدل التحويل</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="analytics-card">
                                <div class="metric-value" id="modalAvgTime">0s</div>
                                <div class="text-muted">متوسط الوقت</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time Range Selector -->
                    <div class="mb-4">
                        <div class="btn-group" role="group" id="modalTimeRange">
                            <input type="radio" class="btn-check" name="modalRange" id="modalDaily" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="modalDaily">يومي</label>
                            
                            <input type="radio" class="btn-check" name="modalRange" id="modalWeekly" autocomplete="off">
                            <label class="btn btn-outline-primary" for="modalWeekly">أسبوعي</label>
                            
                            <input type="radio" class="btn-check" name="modalRange" id="modalMonthly" autocomplete="off">
                            <label class="btn btn-outline-primary" for="modalMonthly">شهري</label>
                            
                            <input type="radio" class="btn-check" name="modalRange" id="modalYearly" autocomplete="off">
                            <label class="btn btn-outline-primary" for="modalYearly">سنوي</label>
                        </div>
                    </div>
                    
                    <!-- Charts Row -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h6>النقرات عبر الوقت</h6>
                            <canvas id="modalClicksChart"></canvas>
                        </div>
                        <div class="col-md-4">
                            <h6>التوزيع الجغرافي</h6>
                            <canvas id="modalGeoChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Recent Visits Table -->
                    <div class="mt-4">
                        <h6>الزيارات الحديثة</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>التاريخ والوقت</th>
                                        <th>الدولة</th>
                                        <th>المدينة</th>
                                        <th>الجهاز</th>
                                        <th>المتصفح</th>
                                        <th>نظام التشغيل</th>
                                        <th>المصدر</th>
                                    </tr>
                                </thead>
                                <tbody id="modalRecentVisits">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--gradient-bg); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-qrcode me-2"></i>رمز QR للرابط
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qrcode" class="mb-3"></div>
                    <p class="text-muted mb-3">امسح الرمز ضوئياً للوصول المباشر للرابط</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-gradient" id="downloadQR">
                            <i class="fas fa-download me-2"></i>تحميل PNG
                        </button>
                        <button class="btn btn-outline-primary" id="shareQR">
                            <i class="fas fa-share me-2"></i>مشاركة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Link Modal -->
    <div class="modal fade" id="editLinkModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--gradient-bg); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>تعديل الرابط
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editLinkForm">
                        <input type="hidden" id="editLinkId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">نوع المحتوى</label>
                                <select class="form-select" id="editContentType">
                                    <option value="series">مسلسل</option>
                                    <option value="movie">فيلم</option>
                                    <option value="match">مباراة</option>
                                    <option value="recipe">وصفة</option>
                                    <option value="game">لعبة</option>
                                    <option value="app">تطبيق</option>
                                    <option value="channel">قناة</option>
                                    <option value="reels">ريلز</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">التصنيف الفرعي</label>
                                <select class="form-select" id="editContentSubcategory">
                                    <option value="">اختر التصنيف</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">اسم المحتوى</label>
                            <input type="text" class="form-control" id="editSeriesName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">الرابط الأصلي</label>
                            <input type="url" class="form-control" id="editOriginalUrl" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">العنوان الاجتماعي</label>
                                <input type="text" class="form-control" id="editSocialTitle">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">رابط الصورة</label>
                                <input type="url" class="form-control" id="editSocialImage">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">الوصف الاجتماعي</label>
                            <textarea class="form-control" id="editSocialDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                            <button type="submit" class="btn btn-gradient">
                                <i class="fas fa-save me-2"></i>حفظ التغييرات
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--gradient-bg); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>تم بنجاح!
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                    <h4 id="successModalTitle">تم إنشاء الرابط بنجاح!</h4>
                    <p id="successModalMessage" class="text-muted">يمكنك الآن مشاركة الرابط أو عرض إحصائياته</p>
                    
                    <div class="mt-4" id="successModalActions">
                        <!-- Actions will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    
    <!-- Firebase v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4B73N1T483"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-4B73N1T483');
    </script>
    
    <!-- AdSense Initialization -->
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    
    <script>
        // Security: Disable right-click and developer tools
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && (e.key === 'i' || e.key === 'j' || e.key === 'u' || e.key === 's')) {
                e.preventDefault();
                showSecurityAlert();
            }
            if (e.key === 'F12') {
                e.preventDefault();
                showSecurityAlert();
            }
        });
        
        function showSecurityAlert() {
            document.getElementById('securityOverlay').style.display = 'flex';
            setTimeout(() => {
                window.location.href = '/';
            }, 3000);
        }
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC5VmidRUmMF6W3vvl44zznScS1gn2GHn0",
            authDomain: "turkify-redirect.firebaseapp.com",
            projectId: "turkify-redirect",
            storageBucket: "turkify-redirect.appspot.com",
            messagingSenderId: "986441766029",
            appId: "1:986441766029:web:dd6a13879306472e43bec4"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global Variables
        let currentUser = null;
        let userLinks = [];
        let isAdmin = false;
        let currentPage = 1;
        let linksPerPage = 10;
        let filteredLinks = [];
        let currentFilter = 'all';
        let currentTimeRange = 'today';
        
        // Content Type Subcategories
        const subcategories = {
            series: ['دراما', 'كوميديا', 'أكشن', 'رومانسي', 'تاريخي', 'خيال علمي'],
            movie: ['أكشن', 'كوميديا', 'دراما', 'رعب', 'مغامرات', 'وثائقي'],
            match: ['كرة قدم', 'كرة سلة', 'تنس', 'سباحة', 'ألعاب قوى', 'أخرى'],
            recipe: ['حلويات', 'أطباق رئيسية', 'مقبلات', 'مشروبات', 'سلطات', 'معجنات'],
            game: ['أكشن', 'مغامرات', 'رياضة', 'استراتيجية', 'محاكاة', 'تعليمية'],
            app: ['إنتاجية', 'ترفيه', 'تعليم', 'صحة', 'مالية', 'تواصل اجتماعي'],
            channel: ['أخبار', 'ترفيه', 'تعليم', 'رياضة', 'طبخ', 'تقنية'],
            reels: ['كوميديا', 'رقص', 'طبخ', 'موضة', 'تعليمي', 'رياضة']
        };
        
        // Authentication State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await checkAdminStatus(user);
                hideLoginOverlay();
                showUserMenu(user);
                await loadUserData();
                startRealTimeUpdates();
                showSuccessModal('مرحباً بك!', 'تم تسجيل الدخول بنجاح', [
                    '<button class="btn btn-gradient" data-bs-dismiss="modal">ابدأ الآن</button>'
                ]);
            } else {
                currentUser = null;
                isAdmin = false;
                showLoginOverlay();
                showAuthButtons();
                stopRealTimeUpdates();
            }
        });
        
        // Show/Hide Login Overlay
        function showLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
        
        function hideLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'none';
        }
        
        // Admin Status Check
        async function checkAdminStatus(user) {
            try {
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                if (!adminDoc.exists) {
                    // Check if this is the first user
                    const usersSnapshot = await db.collection('users').get();
                    if (usersSnapshot.empty) {
                        isAdmin = true;
                        // Create admin document
                        await db.collection('admins').doc(user.uid).set({
                            email: user.email,
                            role: 'super_admin',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Create user document
                        await db.collection('users').doc(user.uid).set({
                            email: user.email,
                            displayName: user.displayName,
                            photoURL: user.photoURL,
                            isAdmin: true,
                            linksCount: 0,
                            totalClicks: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Create system settings
                        await db.collection('settings').doc('system').set({
                            maxLinksPerUser: 100,
                            dataRetentionDays: 365,
                            maintenanceMode: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        isAdmin = false;
                        // Create regular user document
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (!userDoc.exists) {
                            await db.collection('users').doc(user.uid).set({
                                email: user.email,
                                displayName: user.displayName,
                                photoURL: user.photoURL,
                                isAdmin: false,
                                linksCount: 0,
                                totalClicks: 0,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                } else {
                    isAdmin = true;
                }
                
                // Show/hide admin navigation
                if (isAdmin) {
                    document.getElementById('adminNavItem').classList.remove('hidden');
                    document.getElementById('adminBadge').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
                isAdmin = false;
            }
        }
        
        // Helper Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function showToast(message, type = 'success', duration = 5000) {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const iconMap = {
                success: 'check-circle',
                danger: 'exclamation-triangle',
                warning: 'exclamation-circle',
                info: 'info-circle'
            };
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast toast-custom align-items-center text-bg-${type} border-0 show`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${iconMap[type]} me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                if (document.getElementById(toastId)) {
                    toastContainer.removeChild(toast);
                }
            }, duration);
        }
        
        function showSuccessModal(title, message, actions = []) {
            document.getElementById('successModalTitle').textContent = title;
            document.getElementById('successModalMessage').textContent = message;
            document.getElementById('successModalActions').innerHTML = actions.join('');
            
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }
        
        function showUserMenu(user) {
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userMenu').classList.remove('hidden');
            document.getElementById('userName').textContent = user.displayName || user.email;
            document.getElementById('userPhoto').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=6f42c1&color=fff`;
        }
        
        function showAuthButtons() {
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userMenu').classList.add('hidden');
        }
        
        // Content Type Management
        document.getElementById('contentType').addEventListener('change', function() {
            const contentType = this.value;
            const episodeFields = document.getElementById('episodeFields');
            const subcategorySelect = document.getElementById('contentSubcategory');
            
            // Show/hide episode fields for series
            if (contentType === 'series') {
                episodeFields.classList.remove('hidden');
                document.getElementById('totalEpisodes').required = true;
            } else {
                episodeFields.classList.add('hidden');
                document.getElementById('totalEpisodes').required = false;
            }
            
            // Update subcategories
            subcategorySelect.innerHTML = '<option value="">اختر التصنيف الفرعي</option>';
            if (subcategories[contentType]) {
                subcategories[contentType].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
        });
        
        // Custom Domain Toggle
        document.getElementById('customDomain').addEventListener('change', function() {
            const customInput = document.getElementById('customDomainInput');
            if (this.value === 'custom') {
                customInput.classList.remove('hidden');
                document.getElementById('customDomainValue').required = true;
            } else {
                customInput.classList.add('hidden');
                document.getElementById('customDomainValue').required = false;
            }
        });
        
        // Premium Features Toggles
        document.getElementById('passwordProtected').addEventListener('change', function() {
            const passwordField = document.getElementById('linkPassword');
            if (this.checked) {
                passwordField.classList.remove('hidden');
                passwordField.required = true;
            } else {
                passwordField.classList.add('hidden');
                passwordField.required = false;
            }
        });
        
        document.getElementById('hasExpiration').addEventListener('change', function() {
            const expirationField = document.getElementById('expirationDate');
            if (this.checked) {
                expirationField.classList.remove('hidden');
                expirationField.required = true;
            } else {
                expirationField.classList.add('hidden');
                expirationField.required = false;
            }
        });
        
        document.getElementById('hasClickLimit').addEventListener('change', function() {
            const clickLimitField = document.getElementById('clickLimit');
            if (this.checked) {
                clickLimitField.classList.remove('hidden');
                clickLimitField.required = true;
            } else {
                clickLimitField.classList.add('hidden');
                clickLimitField.required = false;
            }
        });
        
        // Live Social Preview
        function updateSocialPreview() {
            const title = document.getElementById('socialTitle').value || 'عنوان الرابط';
            const description = document.getElementById('socialDescription').value || 'وصف الرابط';
            const image = document.getElementById('socialImage').value;
            const domain = document.getElementById('customDomain').value === 'custom' ? 
                document.getElementById('customDomainValue').value : 
                document.getElementById('customDomain').value;
            
            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewDescription').textContent = description;
            document.getElementById('previewDomain').textContent = domain || 'turkify.netlify.app';
            
            const previewImage = document.getElementById('previewImage');
            if (image && isValidUrl(image)) {
                previewImage.src = image;
                previewImage.style.display = 'block';
            } else {
                previewImage.style.display = 'none';
            }
        }
        
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // Attach preview update listeners
        ['socialTitle', 'socialDescription', 'socialImage', 'customDomain', 'customDomainValue'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateSocialPreview);
            }
        });
        
        // Authentication Functions
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('loginRequiredBtn').addEventListener('click', login);
        
        async function login() {
            try {
                showLoading();
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Login error:', error);
                showToast('خطأ في تسجيل الدخول: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                showToast('تم تسجيل الخروج بنجاح');
                location.reload();
            } catch (error) {
                showToast('خطأ في تسجيل الخروج: ' + error.message, 'danger');
            }
        });
        
        // Enhanced Link Creation
        document.getElementById('linkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) {
                showLoginOverlay();
                return;
            }
            
            try {
                showLoading();
                
                const contentType = document.getElementById('contentType').value;
                const contentSubcategory = document.getElementById('contentSubcategory').value;
                const seriesName = document.getElementById('seriesName').value.trim();
                const originalUrl = document.getElementById('originalUrl').value.trim();
                const customDomain = document.getElementById('customDomain').value === 'custom' ? 
                    document.getElementById('customDomainValue').value : 
                    document.getElementById('customDomain').value;
                const totalEpisodes = contentType === 'series' ? parseInt(document.getElementById('totalEpisodes').value) : 1;
                
                // Validate inputs
                if (!contentType || !seriesName || !originalUrl) {
                    showToast('يرجى ملء جميع الحقول المطلوبة', 'warning');
                    return;
                }
                
                if (!isValidUrl(originalUrl)) {
                    showToast('يرجى إدخال رابط صحيح', 'danger');
                    return;
                }
                
                // Generate unique short code
                const shortCode = generateShortCode();
                
                // Prepare link data
                const linkData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    contentType: contentType,
                    contentSubcategory: contentSubcategory,
                    seriesName: seriesName,
                    originalUrl: originalUrl,
                    customDomain: customDomain || 'turkify.netlify.app',
                    shortCode: shortCode,
                    totalEpisodes: totalEpisodes,
                    
                    // Social media data
                    socialTitle: document.getElementById('socialTitle').value.trim(),
                    socialDescription: document.getElementById('socialDescription').value.trim(),
                    socialImage: document.getElementById('socialImage').value.trim(),
                    
                    // Premium features
                    passwordProtected: document.getElementById('passwordProtected').checked,
                    password: document.getElementById('passwordProtected').checked ? 
                        document.getElementById('linkPassword').value : null,
                    hasExpiration: document.getElementById('hasExpiration').checked,
                    expirationDate: document.getElementById('hasExpiration').checked ? 
                        firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('expirationDate').value)) : null,
                    hasClickLimit: document.getElementById('hasClickLimit').checked,
                    clickLimit: document.getElementById('hasClickLimit').checked ? 
                        parseInt(document.getElementById('clickLimit').value) : null,
                    
                    // Analytics
                    clicks: 0,
                    uniqueVisitors: 0,
                    conversionRate: 0,
                    avgTimeSpent: 0,
                    
                    // Status
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add to Firestore
                const docRef = await db.collection('links').add(linkData);
                
                // Update user stats
                await db.collection('users').doc(currentUser.uid).update({
                    linksCount: firebase.firestore.FieldValue.increment(1),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Track in Google Analytics
                gtag('event', 'link_created', {
                    'event_category': 'links',
                    'event_label': contentType,
                    'value': 1
                });
                
                // Generate short URL for display
                const shortUrl = `https://${linkData.customDomain}/sho2157rts.html?${contentType}=${encodeURIComponent(seriesName)}&id=${docRef.id}`;
                
                // Show success modal
                showSuccessModal(
                    'تم إنشاء الرابط بنجاح!',
                    'يمكنك الآن مشاركة الرابط أو عرض إحصائياته',
                    [
                        `<button class="btn btn-gradient me-2" onclick="copyToClipboard('${shortUrl}')">
                            <i class="fas fa-copy me-1"></i>نسخ الرابط
                        </button>`,
                        `<button class="btn btn-outline-primary me-2" onclick="generateQR('${shortUrl}')">
                            <i class="fas fa-qrcode me-1"></i>رمز QR
                        </button>`,
                        `<button class="btn btn-outline-info" onclick="showLinkStats('${docRef.id}')">
                            <i class="fas fa-chart-bar me-1"></i>الإحصائيات
                        </button>`
                    ]
                );
                
                // Reset form
                document.getElementById('linkForm').reset();
                updateSocialPreview();
                
                // Hide optional fields
                document.getElementById('episodeFields').classList.add('hidden');
                document.getElementById('customDomainInput').classList.add('hidden');
                document.getElementById('linkPassword').classList.add('hidden');
                document.getElementById('expirationDate').classList.add('hidden');
                document.getElementById('clickLimit').classList.add('hidden');
                
            } catch (error) {
                console.error('Error creating link:', error);
                showToast('خطأ في إنشاء الرابط: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        });
        
        function generateShortCode(length = 8) {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Load User Data with Real-time Updates
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                showLoading();
                
                // Load user links with real-time listener
                db.collection('links')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        userLinks = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        applyFilters();
                        updateStatistics();
                        renderLinksTable();
                        updatePagination();
                    });
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('خطأ في تحميل البيانات: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }
        
        // Enhanced Filtering System
        function applyFilters() {
            let filtered = [...userLinks];
            
            // Apply content type filter
            if (currentFilter !== 'all') {
                if (currentFilter === 'active') {
                    filtered = filtered.filter(link => link.isActive);
                } else if (currentFilter === 'expired') {
                    const now = new Date();
                    filtered = filtered.filter(link => 
                        link.expirationDate && link.expirationDate.toDate() < now
                    );
                } else {
                    filtered = filtered.filter(link => link.contentType === currentFilter);
                }
            }
            
            // Apply time range filter
            const now = new Date();
            let startDate = new Date();
            
            switch (currentTimeRange) {
                case 'today':
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'year':
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
                default:
                    startDate = new Date(0); // All time
            }
            
            filtered = filtered.filter(link => {
                if (!link.createdAt) return true;
                const createdDate = link.createdAt.toDate ? link.createdAt.toDate() : new Date(link.createdAt);
                return createdDate >= startDate;
            });
            
            filteredLinks = filtered;
            currentPage = 1; // Reset to first page
        }
        
        // Enhanced Search Function
        document.getElementById('searchLinks').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                applyFilters();
            } else {
                filteredLinks = userLinks.filter(link => 
                    link.seriesName.toLowerCase().includes(searchTerm) ||
                    link.contentType.toLowerCase().includes(searchTerm) ||
                    link.contentSubcategory?.toLowerCase().includes(searchTerm) ||
                    link.originalUrl.toLowerCase().includes(searchTerm)
                );
            }
            
            currentPage = 1;
            renderLinksTable();
            updatePagination();
        });
        
        // Filter Event Listeners
        document.querySelectorAll('[data-filter]').forEach(filter => {
            filter.addEventListener('click', function(e) {
                e.preventDefault();
                currentFilter = this.dataset.filter;
                applyFilters();
                renderLinksTable();
                updatePagination();
            });
        });
        
        // Time Range Filter
        document.querySelectorAll('input[name="timeRange"]').forEach(radio => {
            radio.addEventListener('change', function() {
                currentTimeRange = this.id;
                applyFilters();
                renderLinksTable();
                updatePagination();
            });
        });
        
        // Enhanced Links Table Rendering
        function renderLinksTable() {
            const tbody = document.getElementById('linksTableBody');
            tbody.innerHTML = '';
            
            // Update links count
            document.getElementById('linksCount').textContent = filteredLinks.length;
            
            if (filteredLinks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            <i class="fas fa-link fa-4x mb-3 text-muted"></i>
                            <h5>لا توجد روابط</h5>
                            <p>لم يتم العثور على روابط تطابق المعايير المحددة</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * linksPerPage;
            const endIndex = startIndex + linksPerPage;
            const pageLinks = filteredLinks.slice(startIndex, endIndex);
            
            pageLinks.forEach(link => {
                const row = document.createElement('tr');
                row.className = 'align-middle';
                
                const createdDate = link.createdAt ? 
                    (link.createdAt.toDate ? link.createdAt.toDate() : new Date(link.createdAt)).toLocaleDateString('ar-SA') : 
                    'غير معروف';
                
                const customDomain = link.customDomain || 'turkify.netlify.app';
                const shortUrl = `https://${customDomain}/sho2157rts.html?${link.contentType}=${encodeURIComponent(link.seriesName)}&id=${link.id}`;
                
                // Episode info for series
                let episodeInfo = '';
                if (link.contentType === 'series' && link.totalEpisodes > 1) {
                    const currentEp = calculateCurrentEpisode(link.createdAt, link.totalEpisodes);
                    episodeInfo = `<br><small class="text-muted">الحلقة ${currentEp}/${link.totalEpisodes}</small>`;
                }
                
                // Status badge
                let statusBadge = '';
                const now = new Date();
                const isExpired = link.expirationDate && link.expirationDate.toDate() < now;
                const isClickLimitReached = link.hasClickLimit && link.clicks >= link.clickLimit;
                
                if (isExpired) {
                    statusBadge = '<span class="badge bg-danger">منتهي الصلاحية</span>';
                } else if (isClickLimitReached) {
                    statusBadge = '<span class="badge bg-warning">حد النقرات مكتمل</span>';
                } else if (!link.isActive) {
                    statusBadge = '<span class="badge bg-secondary">معطل</span>';
                } else {
                    statusBadge = '<span class="badge bg-success">نشط</span>';
                }
                
                // Content type badge
                const contentTypeBadge = `<span class="content-badge badge-${link.contentType}">${getContentTypeLabel(link.contentType)}</span>`;
                
                // Premium features indicators
                let premiumIndicators = '';
                if (link.passwordProtected) {
                    premiumIndicators += '<i class="fas fa-lock text-warning ms-1" title="محمي بكلمة مرور"></i>';
                }
                if (link.expirationDate) {
                    premiumIndicators += '<i class="fas fa-clock text-info ms-1" title="له تاريخ انتهاء"></i>';
                }
                if (link.hasClickLimit) {
                    premiumIndicators += '<i class="fas fa-hashtag text-primary ms-1" title="له حد نقرات"></i>';
                }
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div>
                                <strong>${link.seriesName}</strong>
                                ${episodeInfo}
                                ${premiumIndicators}
                                ${link.contentSubcategory ? `<br><small class="text-muted">${link.contentSubcategory}</small>` : ''}
                            </div>
                        </div>
                    </td>
                    <td>${contentTypeBadge}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <code class="me-2 text-truncate" style="max-width: 180px; font-size: 0.8rem;">${shortUrl}</code>
                            <button class="btn btn-sm btn-outline-primary copy-btn me-1" onclick="copyToClipboard('${shortUrl}', this)" title="نسخ">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="text-center">
                            <span class="badge bg-primary">${link.clicks || 0}</span>
                            <small class="text-muted d-block">زوار: ${link.uniqueVisitors || 0}</small>
                            <small class="text-success">${((link.clicks || 0) / Math.max(link.uniqueVisitors || 1, 1) * 100).toFixed(1)}% تحويل</small>
                        </div>
                    </td>
                    <td>
                        <small>${createdDate}</small>
                        ${link.expirationDate ? `<br><small class="text-muted">ينتهي: ${link.expirationDate.toDate().toLocaleDateString('ar-SA')}</small>` : ''}
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-info" onclick="showLinkStats('${link.id}')" title="الإحصائيات المفصلة">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="generateQR('${shortUrl}')" title="رمز QR">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editLink('${link.id}')" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm ${link.isActive ? 'btn-outline-secondary' : 'btn-outline-success'}" 
                                    onclick="toggleLinkStatus('${link.id}')" 
                                    title="${link.isActive ? 'تعطيل' : 'تفعيل'}">
                                <i class="fas fa-${link.isActive ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLink('${link.id}')" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Pagination System
        function updatePagination() {
            const totalPages = Math.ceil(filteredLinks.length / linksPerPage);
            const pagination = document.getElementById('linksPagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('li');
            prevBtn.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevBtn.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">السابق</a>`;
            pagination.appendChild(prevBtn);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                const firstPage = document.createElement('li');
                firstPage.className = 'page-item';
                firstPage.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)">1</a>`;
                pagination.appendChild(firstPage);
                
                if (startPage > 2) {
                    const dots = document.createElement('li');
                    dots.className = 'page-item disabled';
                    dots.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(dots);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('li');
                pageBtn.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageBtn.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(pageBtn);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('li');
                    dots.className = 'page-item disabled';
                    dots.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(dots);
                }
                
                const lastPage = document.createElement('li');
                lastPage.className = 'page-item';
                lastPage.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>`;
                pagination.appendChild(lastPage);
            }
            
            // Next button
            const nextBtn = document.createElement('li');
            nextBtn.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextBtn.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">التالي</a>`;
            pagination.appendChild(nextBtn);
        }
        
        function changePage(page) {
            const totalPages = Math.ceil(filteredLinks.length / linksPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderLinksTable();
            updatePagination();
        }
        
        // Helper Functions
        function getContentTypeLabel(type) {
            const labels = {
                series: 'مسلسل',
                movie: 'فيلم',
                match: 'مباراة',
                recipe: 'وصفة',
                game: 'لعبة',
                app: 'تطبيق',
                channel: 'قناة',
                reels: 'ريلز'
            };
            return labels[type] || type;
        }
        
        function calculateCurrentEpisode(createdAt, totalEpisodes) {
            if (!totalEpisodes || totalEpisodes <= 1) return 1;
            
            const now = new Date();
            const created = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
            
            // Convert to Saudi timezone (UTC+3)
            const saudiOffset = 3 * 60 * 60 * 1000;
            const saudiNow = new Date(now.getTime() + saudiOffset);
            const saudiCreated = new Date(created.getTime() + saudiOffset);
            
            // Set to 11 PM for episode change
            saudiNow.setHours(23, 0, 0, 0);
            if (now.getHours() < 23) {
                saudiNow.setDate(saudiNow.getDate() - 1);
            }
            
            // Calculate days difference
            const diffTime = saudiNow - saudiCreated;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Calculate current episode (1-based)
            const currentEpisode = (diffDays % totalEpisodes) + 1;
            return Math.max(1, currentEpisode);
        }
        
        // Copy to Clipboard with Visual Feedback
        function copyToClipboard(text, button = null) {
            navigator.clipboard.writeText(text).then(() => {
                if (button) {
                    const icon = button.querySelector('i');
                    const originalClass = icon.className;
                    
                    button.classList.add('btn-success');
                    button.classList.remove('btn-outline-primary');
                    icon.className = 'fas fa-check';
                    
                    setTimeout(() => {
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-primary');
                        icon.className = originalClass;
                    }, 2000);
                }
                showToast('تم نسخ الرابط بنجاح');
            }).catch(() => {
                showToast('فشل في نسخ الرابط', 'danger');
            });
        }
        
        // QR Code Generation
        function generateQR(url) {
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            
            QRCode.toCanvas(qrDiv, url, {
                width: 250,
                height: 250,
                margin: 3,
                color: {
                    dark: '#000',
                    light: '#fff'
                }
            }, (error) => {
                if (error) {
                    showToast('خطأ في إنشاء رمز QR', 'danger');
                } else {
                    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
                    modal.show();
                }
            });
        }
        
        // Link Management Functions
        async function toggleLinkStatus(linkId) {
            try {
                const link = userLinks.find(l => l.id === linkId);
                if (!link) return;
                
                await db.collection('links').doc(linkId).update({
                    isActive: !link.isActive,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`تم ${!link.isActive ? 'تفعيل' : 'تعطيل'} الرابط بنجاح`);
            } catch (error) {
                showToast('خطأ في تغيير حالة الرابط: ' + error.message, 'danger');
            }
        }
        
        async function deleteLink(linkId) {
            if (!confirm('هل أنت متأكد من حذف هذا الرابط؟ سيتم حذف جميع الإحصائيات المرتبطة به.')) return;
            
            try {
                showLoading();
                
                // Delete link
                await db.collection('links').doc(linkId).delete();
                
                // Delete associated visits
                const visitsSnapshot = await db.collection('visits').where('linkId', '==', linkId).get();
                const batch = db.batch();
                visitsSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Update user stats
                await db.collection('users').doc(currentUser.uid).update({
                    linksCount: firebase.firestore.FieldValue.increment(-1),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('تم حذف الرابط بنجاح');
                
            } catch (error) {
                console.error('Error deleting link:', error);
                showToast('خطأ في حذف الرابط: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }
        
        function editLink(linkId) {
            const link = userLinks.find(l => l.id === linkId);
            if (!link) return;
            
            document.getElementById('editLinkId').value = linkId;
            document.getElementById('editContentType').value = link.contentType;
            document.getElementById('editSeriesName').value = link.seriesName;
            document.getElementById('editOriginalUrl').value = link.originalUrl;
            document.getElementById('editSocialTitle').value = link.socialTitle || '';
            document.getElementById('editSocialDescription').value = link.socialDescription || '';
            document.getElementById('editSocialImage').value = link.socialImage || '';
            
            // Update subcategories for edit modal
            const subcategorySelect = document.getElementById('editContentSubcategory');
            subcategorySelect.innerHTML = '<option value="">اختر التصنيف</option>';
            if (subcategories[link.contentType]) {
                subcategories[link.contentType].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    option.selected = sub === link.contentSubcategory;
                    subcategorySelect.appendChild(option);
                });
            }
            
            const modal = new bootstrap.Modal(document.getElementById('editLinkModal'));
            modal.show();
        }
        
        document.getElementById('editLinkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                showLoading();
                
                const linkId = document.getElementById('editLinkId').value;
                const updates = {
                    contentType: document.getElementById('editContentType').value,
                    contentSubcategory: document.getElementById('editContentSubcategory').value,
                    seriesName: document.getElementById('editSeriesName').value.trim(),
                    originalUrl: document.getElementById('editOriginalUrl').value.trim(),
                    socialTitle: document.getElementById('editSocialTitle').value.trim(),
                    socialDescription: document.getElementById('editSocialDescription').value.trim(),
                    socialImage: document.getElementById('editSocialImage').value.trim(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('links').doc(linkId).update(updates);
                
                showSuccessModal('تم التحديث!', 'تم تحديث الرابط بنجاح');
                bootstrap.Modal.getInstance(document.getElementById('editLinkModal')).hide();
                
            } catch (error) {
                console.error('Error updating link:', error);
                showToast('خطأ في تحديث الرابط: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        });
        
        // Enhanced Statistics
        async function updateStatistics() {
            try {
                if (!currentUser) return;
                
                const totalLinks = userLinks.length;
                const totalClicks = userLinks.reduce((sum, link) => sum + (link.clicks || 0), 0);
                
                // Get today's clicks
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const todayVisitsSnapshot = await db.collection('visits')
                    .where('userId', '==', currentUser.uid)
                    .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(today))
                    .get();
                
                const todayClicks = todayVisitsSnapshot.size;
                
                // Update UI with live indicators
                document.getElementById('totalLinks').innerHTML = `<i class="live-indicator"></i>${totalLinks}`;
                document.getElementById('totalClicks').innerHTML = `<i class="live-indicator"></i>${totalClicks}`;
                document.getElementById('todayClicks').innerHTML = `<i class="live-indicator"></i>${todayClicks}`;
                
            } catch (error) {
                console.error('Error updating statistics:', error);
            }
        }
        
        // Advanced Link Statistics Modal
        async function showLinkStats(linkId) {
            try {
                showLoading();
                
                const link = userLinks.find(l => l.id === linkId);
                if (!link) return;
                
                // Load visits for this link
                const visitsSnapshot = await db.collection('visits')
                    .where('linkId', '==', linkId)
                    .orderBy('timestamp', 'desc')
                    .limit(500)
                    .get();
                
                const visits = visitsSnapshot.docs.map(doc => doc.data());
                
                // Calculate metrics
                const totalClicks = visits.length;
                const uniqueVisitors = new Set(visits.map(v => v.ip || v.userId)).size;
                const conversionRate = totalClicks > 0 ? ((uniqueVisitors / totalClicks) * 100).toFixed(1) : 0;
                const avgTimeSpent = visits.reduce((sum, v) => sum + (v.timeSpent || 0), 0) / Math.max(visits.length, 1);
                
                // Update modal stats
                document.getElementById('modalTotalClicks').textContent = totalClicks;
                document.getElementById('modalUniqueVisitors').textContent = uniqueVisitors;
                document.getElementById('modalConversionRate').textContent = conversionRate + '%';
                document.getElementById('modalAvgTime').textContent = Math.round(avgTimeSpent) + 's';
                
                // Render recent visits
                renderRecentVisits(visits.slice(0, 20));
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('linkStatsModal'));
                modal.show();
                
                // Create charts
                createLinkCharts(visits);
                
            } catch (error) {
                console.error('Error loading link stats:', error);
                showToast('خطأ في تحميل الإحصائيات: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }
        
        function renderRecentVisits(visits) {
            const tbody = document.getElementById('modalRecentVisits');
            tbody.innerHTML = '';
            
            if (visits.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-3">
                            لا توجد زيارات بعد
                        </td>
                    </tr>
                `;
                return;
            }
            
            visits.forEach(visit => {
                const row = document.createElement('tr');
                const date = visit.timestamp ? 
                    (visit.timestamp.toDate ? visit.timestamp.toDate() : new Date(visit.timestamp)).toLocaleString('ar-SA') :
                    'غير معروف';
                
                row.innerHTML = `
                    <td><small>${date}</small></td>
                    <td><span class="badge bg-secondary">${visit.country || 'Unknown'}</span></td>
                    <td>${visit.city || 'Unknown'}</td>
                    <td><i class="fas fa-${getDeviceIcon(visit.device)} me-1"></i>${visit.device || 'Unknown'}</td>
                    <td>${visit.browser || 'Unknown'}</td>
                    <td>${visit.os || 'Unknown'}</td>
                    <td>${visit.source || 'Direct'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function getDeviceIcon(device) {
            const icons = {
                'Mobile': 'mobile-alt',
                'Tablet': 'tablet-alt',
                'Desktop': 'desktop'
            };
            return icons[device] || 'question';
        }
        
        function createLinkCharts(visits) {
            // Time-based chart
            const timeData = processVisitsData(visits);
            const ctx1 = document.getElementById('modalClicksChart');
            if (ctx1) {
                new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: timeData.labels,
                        datasets: [{
                            label: 'النقرات',
                            data: timeData.data,
                            borderColor: '#6f42c1',
                            backgroundColor: 'rgba(111, 66, 193, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Geographic chart
            const geoData = processGeoData(visits);
            const ctx2 = document.getElementById('modalGeoChart');
            if (ctx2) {
                new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: geoData.labels,
                        datasets: [{
                            data: geoData.data,
                            backgroundColor: [
                                '#6f42c1', '#20c997', '#fd7e14', '#dc3545', '#6c757d'
                            ]
                        }]
                    },
                    options: { 
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        function processVisitsData(visits) {
            const data = {};
            visits.forEach(visit => {
                if (visit.timestamp) {
                    const date = visit.timestamp.toDate ? visit.timestamp.toDate() : new Date(visit.timestamp);
                    const key = date.toLocaleDateString('ar-SA');
                    data[key] = (data[key] || 0) + 1;
                }
            });
            
            // Sort by date
            const sortedKeys = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));
            
            return {
                labels: sortedKeys,
                data: sortedKeys.map(key => data[key])
            };
        }
        
        function processGeoData(visits) {
            const data = {};
            visits.forEach(visit => {
                const country = visit.country || 'Unknown';
                data[country] = (data[country] || 0) + 1;
            });
            
            // Get top 5 countries
            const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            return {
                labels: sorted.map(item => item[0]),
                data: sorted.map(item => item[1])
            };
        }
        
        // Real-time Updates
        function startRealTimeUpdates() {
            // Update statistics every 3 minutes
            setInterval(updateStatistics, 3 * 60 * 1000);
            
            // Update page title with click count
            setInterval(() => {
                const totalClicks = userLinks.reduce((sum, link) => sum + (link.clicks || 0), 0);
                document.title = `Turkify Pro (${totalClicks} نقرة)`;
            }, 30000);
        }
        
        function stopRealTimeUpdates() {
            // Clear any intervals if needed
        }
        
        // Navigation System
        document.getElementById('dashboardNav').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('dashboard');
        });
        
        document.getElementById('analyticsNav').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('analytics');
            loadGlobalAnalytics();
        });
        
        document.getElementById('adminNav')?.addEventListener('click', (e) => {
            e.preventDefault();
            if (isAdmin) {
                showSection('admin');
                loadAdminData();
            }
        });
        
        function showSection(sectionId) {
            const sections = ['hero', 'dashboard', 'analytics', 'admin'];
            
            sections.forEach(section => {
                const element = document.getElementById(section);
                if (element) {
                    if (section === sectionId || (sectionId === 'dashboard' && section === 'hero')) {
                        element.classList.remove('hidden');
                        element.style.display = 'block';
                    } else {
                        element.classList.add('hidden');
                        element.style.display = 'none';
                    }
                }
            });
            
            // Update active nav
            document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
            document.getElementById(sectionId + 'Nav')?.classList.add('active');
        }
        
        // Global Analytics
        async function loadGlobalAnalytics() {
            if (!currentUser) return;
            
            try {
                showLoading();
                
                // Load visits for all user links
                const visitsSnapshot = await db.collection('visits')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(1000)
                    .get();
                
                const visits = visitsSnapshot.docs.map(doc => doc.data());
                
                // Update analytics metrics
                const totalClicks = visits.length;
                const uniqueVisitors = new Set(visits.map(v => v.ip || v.userId)).size;
                const countries = new Set(visits.map(v => v.country)).size;
                const conversionRate = totalClicks > 0 ? ((uniqueVisitors / totalClicks) * 100).toFixed(1) : 0;
                
                document.getElementById('analyticsClicks').textContent = totalClicks;
                document.getElementById('analyticsVisitors').textContent = uniqueVisitors;
                document.getElementById('analyticsCountries').textContent = countries;
                document.getElementById('analyticsConversion').textContent = conversionRate + '%';
                
                // Create charts
                createGlobalAnalyticsCharts(visits);
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('خطأ في تحميل التحليلات: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }
        
        function createGlobalAnalyticsCharts(visits) {
            // Main analytics chart
            const timeData = processVisitsData(visits);
            const ctx = document.getElementById('mainAnalyticsChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timeData.labels.slice(-30), // Last 30 days
                        datasets: [{
                            label: 'النقرات اليومية',
                            data: timeData.data.slice(-30),
                            borderColor: '#6f42c1',
                            backgroundColor: 'rgba(111, 66, 193, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // Geographic chart
            createGeoChart(visits);
            createDeviceChart(visits);
            createContentTypeChart(visits);
        }
        
        function createGeoChart(visits) {
            const geoData = processGeoData(visits);
            const ctx = document.getElementById('geoChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: geoData.labels,
                        datasets: [{
                            data: geoData.data,
                            backgroundColor: [
                                '#6f42c1', '#20c997', '#fd7e14', '#dc3545', '#6c757d'
                            ]
                        }]
                    },
                    options: { 
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        function createDeviceChart(visits) {
            const deviceData = {};
            visits.forEach(visit => {
                const device = visit.device || 'Unknown';
                deviceData[device] = (deviceData[device] || 0) + 1;
            });
            
            const ctx = document.getElementById('deviceChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(deviceData),
                        datasets: [{
                            data: Object.values(deviceData),
                            backgroundColor: ['#6f42c1', '#20c997', '#fd7e14', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
        
        function createContentTypeChart(visits) {
            // Group visits by content type (from links)
            const typeData = {};
            visits.forEach(visit => {
                const link = userLinks.find(l => l.id === visit.linkId);
                if (link) {
                    const type = getContentTypeLabel(link.contentType);
                    typeData[type] = (typeData[type] || 0) + 1;
                }
            });
            
            const ctx = document.getElementById('contentTypeChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(typeData),
                        datasets: [{
                            data: Object.values(typeData),
                            backgroundColor: [
                                '#e74c3c', '#9b59b6', '#2ecc71', '#f39c12', 
                                '#3498db', '#1abc9c', '#e67e22', '#e91e63'
                            ]
                        }]
                    },
                    options: { 
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        // Admin Dashboard
        async function loadAdminData() {
            if (!isAdmin) return;
            
            try {
                showLoading();
                
                // Load all users
                const usersSnapshot = await db.collection('users').get();
                const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load all links
                const linksSnapshot = await db.collection('links').get();
                const allLinks = linksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update admin stats
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalLinksAdmin').textContent = allLinks.length;
                
                // Calculate estimated revenue (example: $0.01 per click)
                const totalClicks = allLinks.reduce((sum, link) => sum + (link.clicks || 0), 0);
                const estimatedRevenue = (totalClicks * 0.01).toFixed(2);
                document.getElementById('estimatedRevenue').textContent = ' + estimatedRevenue;
                
                // Render users table
                renderUsersTable(users);
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                showToast('خطأ في تحميل بيانات الإدارة: ' + error.message, 'danger');
            } finally {
                hideLoading();
            }
        }
        
        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableAdmin');
            tbody.innerHTML = '';
            
            users.slice(0, 10).forEach(user => { // Show first 10 users
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || user.email)}" 
                                 class="rounded-circle me-2" width="30" height="30">
                            <div>
                                <small class="fw-bold">${user.displayName || user.email}</small>
                                ${user.isAdmin ? '<br><span class="badge bg-warning">مدير</span>' : ''}
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-primary">${user.linksCount || 0}</span></td>
                    <td><span class="badge bg-success">${user.totalClicks || 0}</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-info" onclick="viewUserDetails('${user.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${!user.isAdmin ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="suspendUser('${user.id}')">
                                    <i class="fas fa-ban"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Handle URL Redirection
        function handleRedirection() {
            const urlParams = new URLSearchParams(window.location.search);
            const linkId = urlParams.get('id');
            
            if (linkId) {
                redirectToLink(linkId);
            }
        }
        
        async function redirectToLink(linkId) {
            try {
                // Get link document
                const linkDoc = await db.collection('links').doc(linkId).get();
                
                if (!linkDoc.exists) {
                    showNotFoundPage();
                    return;
                }
                
                const linkData = linkDoc.data();
                
                // Check if link is active
                if (!linkData.isActive) {
                    showInactiveLinkPage();
                    return;
                }
                
                // Check expiration
                if (linkData.expirationDate && linkData.expirationDate.toDate() < new Date()) {
                    showExpiredLinkPage();
                    return;
                }
                
                // Check click limit
                if (linkData.hasClickLimit && linkData.clicks >= linkData.clickLimit) {
                    showClickLimitReachedPage();
                    return;
                }
                
                // Get visitor information
                const visitorInfo = await getVisitorInfo();
                
                // Record visit
                await recordVisit(linkId, linkData, visitorInfo);
                
                // Calculate final URL for series
                let finalUrl = linkData.originalUrl;
                let episodeNumber = 1;
                
                if (linkData.contentType === 'series' && linkData.totalEpisodes > 1) {
                    episodeNumber = calculateCurrentEpisode(linkData.createdAt, linkData.totalEpisodes);
                }
                
                // Show enhanced landing page
                showEnhancedLandingPage(linkData, finalUrl, episodeNumber, visitorInfo);
                
            } catch (error) {
                console.error('Redirection error:', error);
                showErrorPage();
            }
        }
        
        async function getVisitorInfo() {
            try {
                // Get IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                
                // Get location info from IPinfo
                const locationResponse = await fetch(`https://ipinfo.io/${ipData.ip}/json`);
                const locationData = await locationResponse.json();
                
                // Get device info
                const userAgent = navigator.userAgent;
                let device = 'Desktop';
                let os = 'Unknown';
                let browser = 'Unknown';
                
                // Device detection
                if (/Mobile|Android|iPhone|iPad/.test(userAgent)) {
                    device = 'Mobile';
                } else if (/Tablet|iPad/.test(userAgent)) {
                    device = 'Tablet';
                }
                
                // OS detection
                if (userAgent.includes('Windows')) os = 'Windows';
                else if (userAgent.includes('Mac')) os = 'macOS';
                else if (userAgent.includes('Android')) os = 'Android';
                else if (userAgent.includes('iPhone')) os = 'iOS';
                else if (userAgent.includes('Linux')) os = 'Linux';
                
                // Browser detection
                if (userAgent.includes('Chrome')) browser = 'Chrome';
                else if (userAgent.includes('Firefox')) browser = 'Firefox';
                else if (userAgent.includes('Safari')) browser = 'Safari';
                else if (userAgent.includes('Edge')) browser = 'Edge';
                
                return {
                    ip: ipData.ip,
                    country: locationData.country || 'Unknown',
                    city: locationData.city || 'Unknown',
                    region: locationData.region || 'Unknown',
                    device,
                    os,
                    browser,
                    timezone: locationData.timezone || 'Unknown'
                };
            } catch (error) {
                console.error('Error getting visitor info:', error);
                return {
                    ip: 'Unknown',
                    country: 'Unknown',
                    city: 'Unknown',
                    region: 'Unknown',
                    device: 'Unknown',
                    os: 'Unknown',
                    browser: 'Unknown',
                    timezone: 'Unknown'
                };
            }
        }
        
        async function recordVisit(linkId, linkData, visitorInfo) {
            try {
                // Record visit in visits collection
                await db.collection('visits').add({
                    linkId: linkId,
                    userId: linkData.userId,
                    ...visitorInfo,
                    source: document.referrer || 'Direct',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    timeSpent: 0,
                    userAgent: navigator.userAgent
                });
                
                // Increment click count
                await db.collection('links').doc(linkId).update({
                    clicks: firebase.firestore.FieldValue.increment(1),
                    lastClickAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Track in Google Analytics
                gtag('event', 'link_click', {
                    'event_category': 'clicks',
                    'event_label': linkData.contentType,
                    'value': 1
                });
                
        // Enhanced Landing Page with Content Type Templates
        async function showEnhancedLandingPage(linkData, finalUrl, episodeNumber, visitorInfo) {
            const contentType = linkData.contentType;
            const seriesName = linkData.seriesName;
            
            // Get similar content recommendations
            const recommendations = await getSimilarContent(linkData);
            
            // Generate redirect text based on content type
            let redirectText = '';
            if (contentType === 'series') {
                redirectText = `سيتم توجيهك لمشاهدة الحلقة ${episodeNumber} من المسلسل:<br><strong>${seriesName}</strong>`;
            } else {
                redirectText = `سيتم توجيهك إلى ${getContentTypeLabel(contentType)}:<br><strong>${seriesName}</strong>`;
            }
            
            // Get template based on content type
            const template = getContentTypeTemplate(contentType);
            
            document.body.innerHTML = `
                <div class="redirect-page ${template.pageClass}">
                    <!-- Header -->
                    <nav class="redirect-navbar">
                        <div class="container">
                            <a href="/" class="navbar-brand">
                                <i class="fas fa-link me-2"></i>Turkify Pro
                            </a>
                            <div class="countdown-header" id="redirectCountdown">التوجيه خلال: 15</div>
                        </div>
                    </nav>
                    
                    <!-- AdSense Top Banner -->
                    <div class="ad-container">
                        <div class="ad-label">إعلان</div>
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-YOUR_ADSENSE_ID"
                             data-ad-slot="1234567890"
                             data-ad-format="auto"
                             data-full-width-responsive="true"></ins>
                    </div>
                    
                    <!-- Main Content Card -->
                    <div class="main-content">
                        <div class="container">
                            <div class="content-card ${template.cardClass}">
                                <!-- Thumbnail -->
                                <div class="content-thumbnail">
                                    ${linkData.socialImage ? 
                                        `<img src="${linkData.socialImage}" alt="${linkData.socialTitle || seriesName}" class="thumbnail-image">` :
                                        `<div class="thumbnail-placeholder ${template.placeholderClass}">
                                            <i class="fas fa-${template.icon} fa-4x"></i>
                                        </div>`
                                    }
                                    <div class="content-type-badge ${template.badgeClass}">${getContentTypeLabel(contentType)}</div>
                                    <div class="play-overlay" onclick="redirectToContent('${finalUrl}')">
                                        <i class="fas fa-${template.playIcon} fa-3x"></i>
                                    </div>
                                    ${linkData.contentSubcategory ? `<div class="subcategory-badge">${linkData.contentSubcategory}</div>` : ''}
                                </div>
                                
                                <!-- Content Info -->
                                <div class="content-info">
                                    <h1 class="content-title ${template.titleClass}">${linkData.socialTitle || seriesName}</h1>
                                    
                                    ${contentType === 'series' ? `
                                        <div class="episode-info">
                                            <span class="episode-badge">الحلقة ${episodeNumber}</span>
                                            <span class="next-episode-timer">
                                                <i class="fas fa-clock me-1"></i>
                                                الحلقة القادمة خلال: <span id="midnightCountdown">${getTimeToMidnight()}</span>
                                            </span>
                                        </div>
                                    ` : ''}
                                    
                                    <p class="content-description">
                                        ${linkData.socialDescription || template.defaultDescription}
                                    </p>
                                    
                                    <!-- Metadata -->
                                    <div class="content-metadata">
                                        <span class="meta-item">
                                            <i class="fas fa-calendar me-1"></i>
                                            ${linkData.createdAt ? new Date(linkData.createdAt.toDate()).toLocaleDateString('ar-SA') : 'اليوم'}
                                        </span>
                                        <span class="meta-item">
                                            <i class="fas fa-eye me-1"></i>
                                            ${linkData.clicks || 0} مشاهدة
                                        </span>
                                        <span class="meta-item">
                                            <i class="fas fa-globe me-1"></i>
                                            ${visitorInfo.country}
                                        </span>
                                        <span class="meta-item">
                                            <i class="fas fa-mobile-alt me-1"></i>
                                            ${visitorInfo.device}
                                        </span>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="action-buttons">
                                        <button class="watch-button ${template.buttonClass}" onclick="redirectToContent('${finalUrl}')">
                                            <i class="fas fa-${template.playIcon} me-2"></i>
                                            ${template.buttonText}
                                        </button>
                                        <button class="share-button" onclick="shareContent()">
                                            <i class="fas fa-share me-2"></i>
                                            مشاركة
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Redirect Text (Requirement 23) -->
                            <div class="redirect-text">
                                📊 ${redirectText}
                            </div>
                            
                            <!-- AdSense Middle Banner -->
                            <div class="ad-container">
                                <div class="ad-label">إعلان</div>
                                <ins class="adsbygoogle"
                                     style="display:block"
                                     data-ad-client="ca-pub-YOUR_ADSENSE_ID"
                                     data-ad-slot="0987654321"
                                     data-ad-format="auto"
                                     data-full-width-responsive="true"></ins>
                            </div>
                            
                            <!-- Smart Recommendations -->
                            ${recommendations.length > 0 ? `
                                <div class="recommendations-section">
                                    <h3 class="recommendations-title">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        محتوى مشابه قد يعجبك
                                    </h3>
                                    <div class="recommendations-grid">
                                        ${recommendations.map(rec => `
                                            <div class="recommendation-card" onclick="window.open('https://${rec.customDomain}/sho2157rts.html?${rec.contentType}=${encodeURIComponent(rec.seriesName)}&id=${rec.id}', '_blank')">
                                                <div class="rec-thumbnail">
                                                    ${rec.socialImage ? 
                                                        `<img src="${rec.socialImage}" alt="${rec.seriesName}">` :
                                                        `<div class="rec-placeholder"><i class="fas fa-${getContentIcon(rec.contentType)}"></i></div>`
                                                    }
                                                    <div class="rec-type-badge">${getContentTypeLabel(rec.contentType)}</div>
                                                </div>
                                                <div class="rec-info">
                                                    <h4>${rec.seriesName}</h4>
                                                    <p>${rec.contentSubcategory || getContentTypeLabel(rec.contentType)}</p>
                                                    <span class="rec-views">${rec.clicks || 0} مشاهدة</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Auto-redirect Notice -->
                    <div class="auto-redirect-notice">
                        <div class="container">
                            <p><i class="fas fa-info-circle me-2"></i>سيتم التوجيه تلقائياً خلال 15 ثانية للحصول على أفضل تجربة مشاهدة</p>
                        </div>
                    </div>
                </div>
                
                <style>
                ${template.customCSS}
                
                .subcategory-badge {
                    position: absolute;
                    bottom: 20px;
                    right: 20px;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 5px 12px;
                    border-radius: 15px;
                    font-size: 0.8rem;
                }
                
                .rec-type-badge {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 10px;
                    font-size: 0.7rem;
                }
                
                .redirect-text {
                    text-align: center;
                    font-size: 1.4rem;
                    color: rgba(255,255,255,0.9);
                    margin: 30px 0;
                    padding: 25px;
                    background: rgba(0,0,0,0.4);
                    border-radius: 15px;
                    border-left: 5px solid #e50914;
                    backdrop-filter: blur(10px);
                }
                </style>
            `;
            
            // Initialize AdSense ads
            (adsbygoogle = window.adsbygoogle || []).push({});
            (adsbygoogle = window.adsbygoogle || []).push({});
            
            // Initialize countdown timers
            startRedirectCountdown(finalUrl, 15); // 15 seconds instead of 2
            if (contentType === 'series') {
                startMidnightCountdown();
            }
        }
        
        // Content Type Templates (Requirement 21)
        function getContentTypeTemplate(contentType) {
            const templates = {
                series: {
                    pageClass: 'netflix-style',
                    cardClass: 'series-card',
                    placeholderClass: 'series-placeholder',
                    badgeClass: 'series-badge',
                    titleClass: 'series-title',
                    buttonClass: 'series-button',
                    icon: 'tv',
                    playIcon: 'play',
                    buttonText: 'مشاهدة الحلقة',
                    defaultDescription: 'استمتع بمشاهدة أحدث حلقات هذا المسلسل المميز',
                    customCSS: `
                        .netflix-style { background: linear-gradient(135deg, #141414 0%, #000000 100%); }
                        .series-card { border: 2px solid #e50914; }
                        .series-placeholder { background: linear-gradient(135deg, #e50914, #b81d24); }
                        .series-badge { background: #e50914; }
                        .series-title { color: #e50914; }
                        .series-button { background: #e50914; }
                        .series-button:hover { background: #f40612; }
                    `
                },
                movie: {
                    pageClass: 'cinema-style',
                    cardClass: 'movie-card',
                    placeholderClass: 'movie-placeholder',
                    badgeClass: 'movie-badge',
                    titleClass: 'movie-title',
                    buttonClass: 'movie-button',
                    icon: 'film',
                    playIcon: 'play',
                    buttonText: 'مشاهدة الفيلم',
                    defaultDescription: 'استمتع بمشاهدة هذا الفيلم الرائع بأعلى جودة',
                    customCSS: `
                        .cinema-style { background: linear-gradient(135deg, #2c1810 0%, #8b4513 100%); }
                        .movie-card { border: 2px solid #ffd700; }
                        .movie-placeholder { background: linear-gradient(135deg, #ffd700, #ffed4e); }
                        .movie-badge { background: #ffd700; color: #000; }
                        .movie-title { color: #ffd700; }
                        .movie-button { background: #ffd700; color: #000; }
                        .movie-button:hover { background: #ffed4e; }
                    `
                },
                match: {
                    pageClass: 'sports-style',
                    cardClass: 'sports-card',
                    placeholderClass: 'sports-placeholder',
                    badgeClass: 'sports-badge',
                    titleClass: 'sports-title',
                    buttonClass: 'sports-button',
                    icon: 'futbol',
                    playIcon: 'play',
                    buttonText: 'مشاهدة المباراة',
                    defaultDescription: 'شاهد المباراة مباشرة بأفضل جودة ممكنة',
                    customCSS: `
                        .sports-style { background: linear-gradient(135deg, #006400 0%, #228b22 100%); }
                        .sports-card { border: 2px solid #32cd32; }
                        .sports-placeholder { background: linear-gradient(135deg, #32cd32, #90ee90); }
                        .sports-badge { background: #32cd32; }
                        .sports-title { color: #32cd32; }
                        .sports-button { background: #32cd32; }
                        .sports-button:hover { background: #90ee90; }
                    `
                },
                recipe: {
                    pageClass: 'cooking-style',
                    cardClass: 'recipe-card',
                    placeholderClass: 'recipe-placeholder',
                    badgeClass: 'recipe-badge',
                    titleClass: 'recipe-title',
                    buttonClass: 'recipe-button',
                    icon: 'utensils',
                    playIcon: 'play',
                    buttonText: 'شاهد الوصفة',
                    defaultDescription: 'تعلم كيفية تحضير هذه الوصفة اللذيذة خطوة بخطوة',
                    customCSS: `
                        .cooking-style { background: linear-gradient(135deg, #8b4513 0%, #daa520 100%); }
                        .recipe-card { border: 2px solid #ff6347; }
                        .recipe-placeholder { background: linear-gradient(135deg, #ff6347, #ffa500); }
                        .recipe-badge { background: #ff6347; }
                        .recipe-title { color: #ff6347; }
                        .recipe-button { background: #ff6347; }
                        .recipe-button:hover { background: #ffa500; }
                    `
                },
                game: {
                    pageClass: 'gaming-style',
                    cardClass: 'game-card',
                    placeholderClass: 'game-placeholder',
                    badgeClass: 'game-badge',
                    titleClass: 'game-title',
                    buttonClass: 'game-button',
                    icon: 'gamepad',
                    playIcon: 'play',
                    buttonText: 'العب الآن',
                    defaultDescription: 'استمتع بتجربة لعب ممتعة ومثيرة',
                    customCSS: `
                        .gaming-style { background: linear-gradient(135deg, #4b0082 0%, #8a2be2 100%); }
                        .game-card { border: 2px solid #00ffff; }
                        .game-placeholder { background: linear-gradient(135deg, #00ffff, #00bfff); }
                        .game-badge { background: #00ffff; color: #000; }
                        .game-title { color: #00ffff; }
                        .game-button { background: #00ffff; color: #000; }
                        .game-button:hover { background: #00bfff; }
                    `
                },
                app: {
                    pageClass: 'app-style',
                    cardClass: 'app-card',
                    placeholderClass: 'app-placeholder',
                    badgeClass: 'app-badge',
                    titleClass: 'app-title',
                    buttonClass: 'app-button',
                    icon: 'mobile-alt',
                    playIcon: 'download',
                    buttonText: 'تحميل التطبيق',
                    defaultDescription: 'حمل التطبيق واستمتع بمميزات رائعة',
                    customCSS: `
                        .app-style { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
                        .app-card { border: 2px solid #007bff; }
                        .app-placeholder { background: linear-gradient(135deg, #007bff, #0056b3); }
                        .app-badge { background: #007bff; }
                        .app-title { color: #007bff; }
                        .app-button { background: #007bff; }
                        .app-button:hover { background: #0056b3; }
                    `
                },
                channel: {
                    pageClass: 'broadcast-style',
                    cardClass: 'channel-card',
                    placeholderClass: 'channel-placeholder',
                    badgeClass: 'channel-badge',
                    titleClass: 'channel-title',
                    buttonClass: 'channel-button',
                    icon: 'broadcast-tower',
                    playIcon: 'play',
                    buttonText: 'مشاهدة القناة',
                    defaultDescription: 'شاهد أفضل البرامج على هذه القناة المميزة',
                    customCSS: `
                        .broadcast-style { background: linear-gradient(135deg, #2d1b4e 0%, #8b4789 100%); }
                        .channel-card { border: 2px solid #ff69b4; }
                        .channel-placeholder { background: linear-gradient(135deg, #ff69b4, #ff1493); }
                        .channel-badge { background: #ff69b4; }
                        .channel-title { color: #ff69b4; }
                        .channel-button { background: #ff69b4; }
                        .channel-button:hover { background: #ff1493; }
                    `
                },
                reels: {
                    pageClass: 'reels-style',
                    cardClass: 'reels-card',
                    placeholderClass: 'reels-placeholder',
                    badgeClass: 'reels-badge',
                    titleClass: 'reels-title',
                    buttonClass: 'reels-button',
                    icon: 'video',
                    playIcon: 'play',
                    buttonText: 'مشاهدة الريلز',
                    defaultDescription: 'شاهد مقاطع قصيرة ومسلية ومتنوعة',
                    customCSS: `
                        .reels-style { background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%); }
                        .reels-card { border: 2px solid #e1306c; }
                        .reels-placeholder { background: linear-gradient(135deg, #e1306c, #fd1d1d); }
                        .reels-badge { background: #e1306c; }
                        .reels-title { color: #e1306c; }
                        .reels-button { background: #e1306c; }
                        .reels-button:hover { background: #fd1d1d; }
                    `
                }
            };
            
            return templates[contentType] || templates.series;
        }
        
        // Get similar content recommendations
        async function getSimilarContent(currentLink) {
            try {
                // Get recommendations based on content type and subcategory
                let query = db.collection('links')
                    .where('contentType', '==', currentLink.contentType)
                    .where('isActive', '==', true)
                    .limit(8);
                
                const snapshot = await query.get();
                
                return snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(link => link.id !== currentLink.id)
                    .sort((a, b) => (b.clicks || 0) - (a.clicks || 0)) // Sort by popularity
                    .slice(0, 4);
            } catch (error) {
                console.error('Error getting recommendations:', error);
                return [];
            }
        }
        
        // Content type icon helper
        function getContentIcon(contentType) {
            const icons = {
                series: 'tv',
                movie: 'film',
                match: 'futbol',
                recipe: 'utensils',
                game: 'gamepad',
                app: 'mobile-alt',
                channel: 'broadcast-tower',
                reels: 'video'
            };
            return icons[contentType] || 'play';
        }
        
        // Time calculations
        function getTimeToMidnight() {
            const now = new Date();
            const midnight = new Date();
            midnight.setHours(23, 0, 0, 0); // 11 PM Saudi time
            
            if (now > midnight) {
                midnight.setDate(midnight.getDate() + 1);
            }
            
            const diff = midnight - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${hours}ساعة ${minutes}دقيقة`;
        }
        
        // Enhanced countdown with 15 seconds
        function startRedirectCountdown(finalUrl, seconds = 15) {
            let countdown = seconds;
            const countdownElement = document.getElementById('redirectCountdown');
            
            const timer = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    countdownElement.textContent = `التوجيه خلال: ${countdown}`;
                }
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    window.location.href = finalUrl;
                }
            }, 1000);
        }
        
        // Midnight countdown for next episode
        function startMidnightCountdown() {
            const updateCountdown = () => {
                const timeToMidnight = getTimeToMidnight();
                const element = document.getElementById('midnightCountdown');
                if (element) {
                    element.textContent = timeToMidnight;
                }
            };
            
            updateCountdown();
            setInterval(updateCountdown, 60000); // Update every minute
        }
        
        // Redirect function
        function redirectToContent(url) {
            window.location.href = url;
        }
        
        // Share function with native API
        function shareContent() {
            const title = document.querySelector('.content-title').textContent;
            const text = document.querySelector('.content-description').textContent;
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({ title, text, url });
            } else {
                copyToClipboard(url);
                showToast('تم نسخ الرابط للمشاركة');
            }
        }
        
        // Error pages
        function showNotFoundPage() {
            document.body.innerHTML = createErrorPage(
                '404',
                'الرابط غير موجود',
                'لم يتم العثور على الرابط المطلوب أو قد يكون تم حذفه',
                'العودة للرئيسية'
            );
        }
        
        function showInactiveLinkPage() {
            document.body.innerHTML = createErrorPage(
                'معطل',
                'الرابط غير نشط',
                'هذا الرابط معطل حالياً من قبل المنشئ',
                'العودة للرئيسية'
            );
        }
        
        function showExpiredLinkPage() {
            document.body.innerHTML = createErrorPage(
                'منتهي',
                'انتهت صلاحية الرابط',
                'انتهت صلاحية هذا الرابط ولا يمكن الوصول إليه',
                'العودة للرئيسية'
            );
        }
        
        function showClickLimitReachedPage() {
            document.body.innerHTML = createErrorPage(
                'مكتمل',
                'وصل الرابط للحد الأقصى',
                'وصل هذا الرابط للحد الأقصى من النقرات المسموحة',
                'العودة للرئيسية'
            );
        }
        
        function showErrorPage() {
            document.body.innerHTML = createErrorPage(
                'خطأ',
                'حدث خطأ غير متوقع',
                'حدث خطأ أثناء معالجة طلبك، يرجى المحاولة مرة أخرى',
                'إعادة المحاولة'
            );
        }
        
        function createErrorPage(code, title, message, buttonText) {
            return `
                <div class="redirect-page">
                    <div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
                        <div class="text-center">
                            <div class="error-icon mb-4">
                                <i class="fas fa-exclamation-triangle fa-5x text-warning"></i>
                            </div>
                            <h1 class="display-1 fw-bold text-white">${code}</h1>
                            <h2 class="text-white mb-3">${title}</h2>
                            <p class="text-muted mb-4">${message}</p>
                            <button class="btn btn-gradient" onclick="window.location.href='/'">
                                <i class="fas fa-home me-2"></i>${buttonText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme and security
            initializeTheme();
            
            // Check for redirect
            handleRedirection();
            
            // Set default section
            showSection('dashboard');
            
            // Initialize live preview
            updateSocialPreview();
            
            // Add performance monitoring
            trackPerformance();
        });
        
        function initializeTheme() {
            // Load saved theme preference
            const savedTheme = localStorage.getItem('turkify-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        
        function trackPerformance() {
            if ('performance' in window) {
                window.addEventListener('load', () => {
                    const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                    console.log(`Page loaded in ${loadTime}ms`);
                    
                    // Track in Google Analytics
                    gtag('event', 'page_load_time', {
                        'event_category': 'performance',
                        'value': loadTime
                    });
                });
            }
        }
        
        // Download QR functionality
        document.getElementById('downloadQR')?.addEventListener('click', () => {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'qr-code.png';
                link.href = canvas.toDataURL();
                link.click();
                showToast('تم تحميل رمز QR بنجاح');
            }
        });
        
        // Share QR functionality
        document.getElementById('shareQR')?.addEventListener('click', () => {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas && navigator.share) {
                canvas.toBlob(blob => {
                    const file = new File([blob], 'qr-code.png', { type: 'image/png' });
                    navigator.share({
                        title: 'رمز QR للرابط',
                        files: [file]
                    });
                });
            } else {
                showToast('المشاركة غير مدعومة في هذا المتصفح', 'warning');
            }
        });
        
        // Error handling and security
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            gtag('event', 'javascript_error', {
                'event_category': 'errors',
                'event_label': e.error?.message || 'Unknown error'
            });
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            gtag('event', 'promise_rejection', {
                'event_category': 'errors',
                'event_label': e.reason?.message || 'Unknown rejection'
            });
        });
        
        // Disable common hacking attempts
        window.addEventListener('beforeunload', () => {
            // Clear sensitive data
            if (currentUser) {
                sessionStorage.clear();
            }
        });
        
        // Social Media Card Generation (Requirement 15)
        function generateSocialCard(linkData) {
            const cardHTML = `
                <!DOCTYPE html>
                <html prefix="og: http://ogp.me/ns#">
                <head>
                    <meta charset="UTF-8">
                    <meta property="og:title" content="${linkData.socialTitle || linkData.seriesName}">
                    <meta property="og:description" content="${linkData.socialDescription || 'شاهد هذا المحتوى المميز على Turkify Pro'}">
                    <meta property="og:image" content="${linkData.socialImage || 'https://turkify.netlify.app/default-og-image.jpg'}">
                    <meta property="og:url" content="https://${linkData.customDomain}/sho2157rts.html?${linkData.contentType}=${encodeURIComponent(linkData.seriesName)}&id=${linkData.id}">
                    <meta property="og:type" content="video.other">
                    <meta property="og:site_name" content="Turkify Pro">
                    
                    <meta name="twitter:card" content="summary_large_image">
                    <meta name="twitter:title" content="${linkData.socialTitle || linkData.seriesName}">
                    <meta name="twitter:description" content="${linkData.socialDescription || 'شاهد هذا المحتوى المميز على Turkify Pro'}">
                    <meta name="twitter:image" content="${linkData.socialImage || 'https://turkify.netlify.app/default-twitter-image.jpg'}">
                    
                    <title>${linkData.socialTitle || linkData.seriesName} - Turkify Pro</title>
                    <meta name="description" content="${linkData.socialDescription || 'شاهد هذا المحتوى المميز على Turkify Pro'}">
                </head>
                <body>
                    <script>
                        window.location.href = "https://${linkData.customDomain}/sho2157rts.html?${linkData.contentType}=${encodeURIComponent(linkData.seriesName)}&id=${linkData.id}";
                    </script>
                </body>
                </html>
            `;
            
            return cardHTML;
        }
        
        // Auto-create Firestore indexes (Requirement 16)
        async function createFirestoreIndexes() {
            // This would typically be done via Firebase CLI or console
            // But we can ensure our queries are optimized
            console.log('Firestore indexes should be created for optimal performance:');
            console.log('1. links: userId, createdAt (descending)');
            console.log('2. links: contentType, isActive');
            console.log('3. visits: linkId, timestamp (descending)');
            console.log('4. visits: userId, timestamp (descending)');
        }
        
        // Initialize Firestore indexes on first load
        createFirestoreIndexes();
    </script>
</body>
</html>